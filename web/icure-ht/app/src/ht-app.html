<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/shadow.html">
<link rel="import" href="../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="elements/splash-screen/splash-screen.html">

<link rel="import" href="elements/ht-tools/ht-export-key.html">
<link rel="import" href="elements/ht-tools/ht-import-keychain.html">
<link rel="import" href="elements/ht-tools/ht-my-profile.html">
<link rel="import" href="elements/ht-app/ht-app-login-dialog.html">
<link rel="import" href="elements/ht-app/ht-app-register-keypair-dialog.html">
<link rel="import" href="elements/menu-bar/menu-bar.html">
<link rel="import" href="elements/menu-bar/menu-bar.html">

<link rel="import" href="elements/icc-x-api/icc-x-api.html">

<link rel="import" href="./app-theme.html">
<link rel="import" href="./shared-styles.html">


<dom-module id="ht-app">

	<template>
		<style include="shared-styles">
			:host {
				display: block;
			}

			app-header {
				color: var(--app-text-color-light);
				background-color: var(--app-primary-color-dark);
				/*
				@apply --shadow-elevation-4dp;
				@apply --padding-right-left-24;
				padding-right: 0;
				z-index:10;
				position:fixed;
				top:0;
				left:0;
				right:0;
				margin-bottom:30px;*/
				height:64px;


			}

			app-header paper-icon-button {
				--paper-icon-button-ink-color: white;
			}

			app-toolbar {
				padding-right: 0;
				height:64px;
			}

			.drawer-list {
				margin: 0 20px;
			}

			.drawer-list a {
				display: block;
				padding: 0 16px;
				text-decoration: none;
				color: var(--app-secondary-color);
				line-height: 40px;
			}

			.drawer-list a.iron-selected {
				color: black;

				font-weight: bold;
			}

			:host iron-pages {
				height: calc(100% - 64px);
			}

			:host app-header-layout {
				height: 100%;
			}

			menu-bar{
				display:flex;
				flex-flow: row nowrap;
				justify-content: flex-start;
				align-items: center;
				align-content: stretch;
				width:calc(100% - 70px);
				height:100%;
			}


			paper-button{
				color:white;
				margin-left:0;
				margin-right:20px;
				padding:26px 8px;
				height:100%;
				align-self: center;
				border-radius:0;
				--paper-button-ink-color: rgba(0,0,0,0);
				@apply --paper-font-body2;
				@apply --text-shadow;

			}

			paper-button.iron-selected{

				font-weight:bold;
				padding-bottom:26px;
				border-bottom:2px solid var(--app-secondary-color);
				transition:border-bottom .1s ease-in;

			}

			paper-button.iron-selected > iron-icon{
				color: var(--app-secondary-color);
			}

			iron-icon{
				max-height:20px;
				width:20px;
				margin-right:8px;
				color:rgba(255,255,255,0.5);
			}

			.icure-logo{
				float:right;
				height: 64px;
				margin-right:8px;
			}

			paper-menu-button {
				--paper-menu-dropdown-content: {
					width: 300px;
					margin-top: 48px;
				}
			}
		</style>

		<icc-x-api id="api" host="/rest/v1" fhc-host="https://fhcacc.icure.cloud" headers="[[headers]]" credentials="[[credentials]]"></icc-x-api>

		<ht-app-login-dialog id="loginDialog" credentials="[[credentials]]" on-login="login"></ht-app-login-dialog>
		<ht-app-register-keypair-dialog id="registerKeyPairDialog" api="[[api]]" user="[[user]]" message="[[registerKeyPairDialogMessage]]" on-file-selected="importPrivateKey" on-key-scanned="importScannedPrivateKey"></ht-app-register-keypair-dialog>
		<ht-export-key id="export-key" api="[[api]]" user="[[user]]"></ht-export-key>
		<ht-import-keychain id="ht-import-keychain" api="[[api]]" user="[[user]]"></ht-import-keychain>
		<ht-my-profile id="ht-my-profile" api="[[api]]" user="[[user]]"></ht-my-profile>


		<app-location route="{{route}}" use-hash-as-path="true"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>
		<app-route route="{{subroute}}" pattern="/:page" data="{{subrouteData}}"></app-route>

		<app-drawer-layout fullbleed>
			<!-- Main content -->
			<app-header-layout fullbleed>
				<app-header slot="header" fixed condenses effects="waterfall">
					<app-toolbar id="mainToolbar" class="" sticky>

						<!-- Toolbar icons -->
						<menu-bar style="margin-right:40px">
							<iron-selector selected="[[page]]" attr-for-selected="name" role="navigation">
								<paper-button name="main" on-tap="doRoute">
									<iron-icon class="iron-icon" icon="home"></iron-icon>
									Summary
								</paper-button>
								<paper-button name="pat" on-tap="doRoute">
									<iron-icon icon="vaadin:user-heart"></iron-icon>
									Patients
								</paper-button>
								<paper-button name="hcp" on-tap="doRoute">
									<iron-icon icon="vaadin:hospital"></iron-icon>
									HC parties
								</paper-button>
								<paper-button name="msg" on-tap="doRoute">
									<iron-icon icon="communication:email"></iron-icon>
									Messages
								</paper-button>
								<paper-button name="logout" on-tap="doRoute">
									<iron-icon icon="power-settings-new"></iron-icon>
									Log out
								</paper-button>
							</iron-selector>
						</menu-bar>
						<!-- Generator: Adobe Illustrator 21.1.0, SVG Export Plug-In  -->
						<svg version="1.1"
							 xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:a="http://ns.adobe.com/AdobeSVGViewerExtensions/3.0/"
							 x="0px" y="0px" width="92px" height="64px" viewBox="0 0 92 64" style="enable-background:new 0 0 92 64;" xml:space="preserve" class="icure-logo">
						<style type="text/css">
							.st1 {
								fill: #FFFFFF;
							}

							.st2 {
								fill: #66DEA1;
							}
						</style>
						<defs>
						</defs>
						<g>
							<g>
								<rect x="44.3" y="32.2" class="st1" width="1.3" height="12.6"/>
								<path class="st1" d="M45,27.6c-0.6,0-1,0.5-1,1.2c0,0.6,0.4,1.2,1,1.2h0c0.6,0,1-0.5,1-1.2C46,28.1,45.6,27.6,45,27.6z"/>
								<path class="st1" d="M60.2,43c-1,0.5-2.3,0.8-3.7,0.8c-4.3,0-6.9-2.9-6.9-7.7c0-5,2.6-8,7-8c1.3,0,2.5,0.3,3.4,0.7l0.1,0l0.4-1.2
									l-0.1,0c-0.4-0.2-1.7-0.8-3.8-0.8c-5,0-8.4,3.7-8.4,9.2c0,6.6,4.2,9,7.9,9c2.1,0,3.7-0.5,4.5-0.9l0.1,0L60.2,43L60.2,43z"/>
								<path class="st1" d="M72.3,41.7v-9.5H71V40c0,0.4-0.1,0.9-0.2,1.3c-0.5,1.1-1.6,2.4-3.4,2.4c-2,0-3-1.5-3-4.5v-7.1H63v7.3
									c0,5,2.9,5.6,4.1,5.6c1.9,0,3.3-1.2,4-2.3l0.1,2.1h1.3l0-0.1C72.3,43.8,72.3,42.9,72.3,41.7z"/>
								<path class="st1" d="M80.5,31.9c-1.4,0-2.7,1-3.3,2.6l0-2.3h-1.3l0,0.1C76,33.4,76,34.6,76,36v8.8h1.3v-6.9c0-0.5,0-0.9,0.1-1.2
									c0.3-2.1,1.5-3.4,3-3.4c0.2,0,0.4,0,0.5,0l0.1,0V32L81,32C80.9,31.9,80.7,31.9,80.5,31.9z"/>
								<path class="st1" d="M91.1,34.1c-0.8-1.4-2.1-2.2-3.8-2.2c-3.2,0-5.4,2.7-5.4,6.8c0,3.8,2.2,6.3,5.5,6.3c2.1,0,3.3-0.6,3.7-0.8
									l0.1,0L91,43.1l-0.1,0c-0.7,0.4-1.6,0.7-3.2,0.7c-1.3,0-4.3-0.5-4.4-5.3h8.6l0-0.1C92,38.1,92,38,92,37.6
									C92,37.1,91.9,35.5,91.1,34.1z M83.4,37.3c0.3-1.9,1.4-4.1,3.8-4.1c1,0,1.8,0.3,2.3,0.9c0.9,1,1.1,2.5,1.1,3.2H83.4z"/>
							</g>
							<path class="st2" d="M36.2,38.4c-0.4-4.3-2.9-6.6-7.4-6.6l-5.5,0c-0.2,0-0.4,0.1-0.5,0.3l-0.6,1.5l-1.9-8.4c0-0.3-0.3-0.5-0.6-0.5
								c-0.3,0-0.5,0.2-0.6,0.5l-2.3,10.4L15.4,29c0-0.3-0.3-0.5-0.6-0.5c-0.3,0-0.5,0.2-0.6,0.4L13,31.8H8.3V33h5.2
								c0.3,0,0.5-0.2,0.6-0.4l0.6-1.5l1.6,7.2c0.1,0.3,0.3,0.5,0.6,0.5c0.3,0,0.5-0.2,0.6-0.5l2.2-10.3l1.7,7.5c0,0.3,0.2,0.5,0.5,0.5
								c0.2,0.1,0.5-0.1,0.6-0.3l1.2-2.7l5.1,0c3.8,0,5.8,1.5,6.3,4.7c0.3,2-0.2,3.8-1.3,5.1c-1.2,1.4-3,2-5,1.9H8.8
								c-4.1,0-7.5-3.4-7.6-7.6C1,32.8,4,29.1,8,28.8c0.3,0,0.5-0.3,0.5-0.5c0.3-2.3,1.2-4.4,2.7-6c1.8-1.9,4.2-3,6.8-3c2.6,0,5,1.1,6.8,3
								c1.2,1.3,2.3,3.7,2.7,6.4l0,0.2l0.2,0c0.2,0,0.7-0.1,0.8-0.1l0.2,0l0-0.2c-0.5-3-1.6-5.6-3-7.1c-2-2.1-4.7-3.3-7.6-3.3
								c-2.9,0-5.6,1.2-7.6,3.3c-1.6,1.7-2.6,3.9-3,6.3C3.1,28.3-0.1,32.3,0,37c0.1,2.4,1,4.6,2.7,6.4C4.4,45.1,6.6,46,8.8,46l19.7,0
								c0.1,0,0.2,0,0.4,0c2.2,0,4.2-0.9,5.6-2.4C35.7,42.2,36.3,40.4,36.2,38.4z"/>
						</g>
						</svg>
						<paper-menu-button horizontal-align="right" close-on-activate>
							<paper-icon-button icon="icons:more-vert" slot="dropdown-trigger" alt="menu"></paper-icon-button>
							<paper-listbox slot="dropdown-content"  selected="1">
								<paper-item on-tap="_openExportKey">Transfer private key / Connect tablet</paper-item>
								<paper-item on-tap="_importKeychain">Import my eHealth keychain</paper-item>
								<hr>
								<paper-item on-tap="_myProfile">My profile</paper-item>
							</paper-listbox>
						</paper-menu-button>
						</div>
					</app-toolbar>

				</app-header>
				<iron-pages
						selected="[[view]]"
						attr-for-selected="name"
						fallback-selection="view404"
						role="main">
					<ht-main name="main" api="[[api]]" user="[[user]]"><splash-screen></splash-screen></ht-main>
					<ht-pat name="pat" api="[[api]]" user="[[user]]" route="{{subroute}}"><splash-screen></splash-screen></ht-pat>
					<ht-hcp name="hcp" api="[[api]]" user="[[user]]"><splash-screen></splash-screen></ht-hcp>
					<ht-msg name="msg" host="/rest/v1" headers="[[headers]]"><splash-screen></splash-screen></ht-msg>
					<ht-view404 name="view404"></ht-view404>
				</iron-pages>
			</app-header-layout>
		</app-drawer-layout>
	</template>

	<script>
		Polymer({
			is: 'ht-app',

			properties: {
				api: {
					type: Object,
					value: null
				},
				user: {
					type: Object,
					value: null
				},
				view: {
					type: String,
					reflectToAttribute: true,
					observer: '_viewChanged'
				},
				headers: {
					type: Object,
					value: {"Content-Type": "application/json"}
				},
				credentials: {
					type: Object,
					value: {logout: false}
				},
				lazyPages: {
					type: Object,
					value: {
						main: function() {
							import(/* webpackChunkName: "ht-main" */ './ht-main.html')
						},
						pat: function() {
							import(/* webpackChunkName: "ht-pat" */ './ht-pat.html')
						},
						hcp: function() {
							import(/* webpackChunkName: "ht-hcp" */ './ht-hcp.html')
						},
						msg: function() {
							import(/* webpackChunkName: "ht-msg" */ './ht-msg.html')
						},
						view404: function() {
							import(/* webpackChunkName: "ht-view404" */ './ht-view404.html')
						}
					}
				}
			},

			observers: [
				'_routePageChanged(routeData.page)'
			],

			ready: function () {
				let newHref = window.location.href.includes('#/') ? window.location.href : window.location.href.replace(/\/?#?$/,'/#')
				let fullHref = newHref.endsWith('/') ? newHref : newHref +'/'
				if (fullHref !== window.location.href) { window.location.href = fullHref }
				window.app = this
				this.set('api', this.$.api)
			},

			_routePageChanged: function (page) {
				if (page === 'logout') {
					sessionStorage.removeItem('auth')
					this.authenticated = false
					this.set('view', 'auth');
				} else {
					console.log("page is -> "+page)
					if (!this.authenticated && (!page || !page.startsWith('auth'))) {
						if (sessionStorage.getItem('auth')) {
							this.loginAndRedirect(page)
						} else {
							this.set('routeData.page', 'auth/'+ (!page ? 'main' : page.startsWith('logout') ? 'main' : page));
						}
					} else {
						this.set('view', page ? page.replace(/\/$/,'') : 'main')
					}
				}
			},

			_viewChanged: function (view) {
				if (view.startsWith('auth')) {
					this.$.loginDialog.opened = true
					return
				}
				if(this.lazyPages[view]){
					this.lazyPages[view]();
				} else {
					this._showPage404();
				}
			},

			_showPage404: function () {
				this.view = 'view404';
			},

			doRoute: function (e) {
				this.set('routeData.page', (e.target.getAttribute('name') || e.target.parentElement.getAttribute('name'))+"/")
			},

			_openExportKey: function() {
				this.$['export-key'].open()
			},

			_importKeychain: function() {
				this.$['ht-import-keychain'].open()
			},

			_myProfile: function() {
				this.$['ht-my-profile'].open()
			},

			loginAndRedirect: function(page) {
				const sAuth = JSON.parse(sessionStorage.getItem('auth'))
				if (!this.credentials || (!this.credentials.password && sAuth && sAuth.password) || (!this.credentials.appToken && sAuth && sAuth.appToken)) { this.set('credentials',sAuth) }
				if ((this.credentials.userId && this.credentials.appToken)) { this.set('headers.Authorization', 'Basic ' + btoa(this.credentials.userId + ':' + this.credentials.appToken)) }
				else if ((this.credentials.username && this.credentials.password)) { this.set('headers.Authorization', 'Basic ' + btoa(this.credentials.username + ':' + this.credentials.password + (this.credentials.twofa?'|'+this.credentials.twofa:''))) }

				//Be careful not to use this.api here as it might not have been defined yet
				this.$.api.user().getCurrentUser().then(u => {
					this.set('user', u)
					this.$.loginDialog.opened = false

					this.set('credentials.twofa',null)
					this.set('credentials.userId',u.id)
					this.set('credentials.appToken',u.applicationTokens && u.applicationTokens.ICC)

					if ((this.credentials.userId && this.credentials.appToken)) {
						this.set('credentials.password',null)
						this.set('headers.Authorization', 'Basic ' + btoa(this.credentials.userId + ':' + this.credentials.appToken))
					}
					sessionStorage.setItem('auth', JSON.stringify(this.credentials))

					if (!this.authenticated) {
						this.authenticated = true

						if (this.$.api.crypto().RSA.loadKeyPairNotImported(u.healthcarePartyId)) {
							if (this.credentials.ehpassword) {
								this.$.api.fhc().Stscontroller().uploadKeystoreUsingPOST(this.$.api.crypto().loadKeychainFromBrowserLocalStorage(this.user.healthcarePartyId)).then(res => {
									this.$.api.keystoreId = res.uuid
									this.$.api.hcparty().getHealthcareParty(u.healthcarePartyId).then(hcp =>
										this.$.api.fhc().Stscontroller().requestTokenUsingGET(this.credentials.ehpassword, hcp.ssin, this.$.api.keystoreId).then(res => {
											this.$.api.tokenId = res.tokenId
											this.$.api.token = res.token
										})
									)
								})
							}

							const destPage = page || (this.routeData && this.routeData.page === 'auth' && this.subrouteData && this.subrouteData.page ? this.subrouteData.page : 'main')
							if (!this.routeData || destPage !== this.routeData.page) {
								this.set('routeData.page', destPage);
							} else {
								this._routePageChanged(destPage)
							}
						} else {
							this.registerKeyPairDialogMessage = ""
							this.$.registerKeyPairDialog.opened = true
						}
					}
				}).catch(function (e) {
					this.authenticated = false
					sessionStorage.removeItem('auth')
					this.set("credentials.error", "Wrong user or password")
				}.bind(this))
			},

			login: function (event, loginObject) /* this is called from mouseDown with 2 arguments */ {
				this.set('credentials',loginObject && loginObject.credentials)
				this.loginAndRedirect(loginObject && loginObject.page)
			},

			importPrivateKey: function(e, selectedRsaFile) {
				selectedRsaFile && selectedRsaFile.name && this.api.crypto().loadKeyPairsInBrowserLocalStorage(this.user.healthcarePartyId, selectedRsaFile).then(function() {
					if (this.$.api.crypto().RSA.loadKeyPairNotImported(this.user.healthcarePartyId)) {
						this.$.registerKeyPairDialog.opened = false
						this.set("registerKeyPairDialogMessage","")
						this.set('routeData.page', 'main/');
					} else {
						this.set("registerKeyPairDialogMessage","Invalid key file")
						this.$.registerKeyPairDialog.reset()
					}
				}.bind(this)).catch(e => console.log(e))
			},

			importScannedPrivateKey: function(e, jwkKey) {
				this.api.crypto().loadKeyPairsAsJwkInBrowserLocalStorage(this.user.healthcarePartyId, jwkKey).then(function() {
					if (this.$.api.crypto().RSA.loadKeyPairNotImported(this.user.healthcarePartyId)) {
						this.$.registerKeyPairDialog.opened = false
						this.set("registerKeyPairDialogMessage","")
						this.set('routeData.page', 'main/');
					} else {
						this.set("registerKeyPairDialogMessage","Invalid key file")
						this.$.registerKeyPairDialog.reset()
					}
				}.bind(this)).catch(e => console.log(e))
			},

			togglePanel: function (e) {
			}
		})
	</script>
</dom-module>
