<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">

<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../qrcode-manager/qrcode-printer.html">

<dom-module id="ht-my-profile">
	<template>
		<style>
			paper-dialog {
				width: 60%;
				display:flex;
				flex-flow: row wrap;
				justify-content: space-between;
				align-items: flex-start;
			}
			paper-input{
				--paper-input-container-focus-color: var(--app-primary-color);
				font-size:var(--form-font-size);
			}

			.error {
				color: #e53935;
			}

			.buttons{
				width:100%;
			}

			.modal-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				color: var(--app-text-color);
				font-weight: 400;
				font-size: 14px;
				height: 40px;
				min-width: 100px;
				padding: 10px 1.2em;
				text-transform: capitalize;
			}

			.modal-button--save{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-secondary-color);
				color: var(--app-primary-color-dark);
				font-weight: 700;

			}
			.left-col, .right-col{
				flex-grow: 1;
				width: 50%;
				box-sizing: border-box;
			}
			#dialog{
				overflow: auto;
			}
			#printable {
				width: fit-content;
			}

			@media screen and (max-width:650px) {
				#dialog {
					height: 80vh;
				}
				div.left-col, div.right-col {
					width: 100%;
				}
			}

		</style>

		<paper-dialog id="dialog" opened="{{opened}}">
			<div class="left-col">
				<vaadin-form-layout>
					<paper-input colspan="2" label="Full name" value="{{user.name}}"></paper-input>
					<paper-input colspan="2" label="Group ID" value="{{user.groupId}}"></paper-input>
					<paper-input label="Login" value="{{user.login}}"></paper-input>
					<paper-input label="Email" value="{{user.email}}"></paper-input>
					<paper-input label="MedicalHouse" value="{{userMedicalHouseNihii}}"></paper-input>
					<paper-input label="Auto logout delay (minute)" type="number" min="0" value=""></paper-input>
					<paper-dropdown-menu id="preferredHub" label="[[localize('pre_hub','Preferred hub',language)]]">
						<paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{userPreferredHub}}">
							<paper-item name="rsb">[[localize('rsw','RSB',language)]]</paper-item>
							<paper-item name="rsw">[[localize('rsb','RSW',language)]]</paper-item>
							<paper-item name="vitalink">[[localize('vitalink','Vitalink',language)]]</paper-item>
						</paper-listbox>
					</paper-dropdown-menu>
					<paper-radio-group selected="{{userEHealthEnv}}">
						<paper-radio-button name="acc">[[localize('acc','Acceptance',language)]]</paper-radio-button>
						<paper-radio-button name="prd">[[localize('prd','Production',language)]]</paper-radio-button>
					</paper-radio-group>
					<template is="dom-repeat" items="[[currentRegs.rs]]" as="reg">
						[[_getOARegStatus(reg)]]
					</template>
                    <template is="dom-if" if="[[allEDmgRegistered]]">
                        <p>eDMG Registration Complete</p>
                    </template>
                    <template is="dom-if" if="[[!allEDmgRegistered]]">
					    <paper-input label="BIC" value="{{userBIC}}"></paper-input>
					    <paper-input label="IBAN" value="{{userIBAN}}"></paper-input>
                    </template>
					<paper-button on-tap="_registerToEDMG">[[localize('reg_dmg','Register to eDmg',language)]]</paper-button>
				</vaadin-form-layout>
			</div>
			<div class="right-col">
				<vaadin-form-layout>
					<paper-radio-group selected="{{hcp.languages.0}}">
						<paper-radio-button name="en">[[localize('eng','English',language)]]</paper-radio-button>
						<paper-radio-button name="fr">[[localize('fre','French',language)]]</paper-radio-button>
						<paper-radio-button name="nl">[[localize('dut','Dutch',language)]]</paper-radio-button>
					</paper-radio-group>
					<paper-input label="Password" value="{{userPassword}}" type="password"></paper-input>
					<paper-input label="Confirmation" value="{{userConfirmation}}" type="password"></paper-input>
					<template is="dom-if" if="[[_mismatch(userPassword,userConfirmation)]]">
						<div class="error">Passwords do not match</div>
					</template>
					<template is="dom-if" if="[[_tooShort(userPassword)]]">
						<div class="error">Passwords must be at least 8 characters</div>
					</template>
					<vaadin-checkbox colspan="2" checked="{{user.use2fa}}">[[localize('use_two_fac_aut','Use two factors Authentication',language)]]</vaadin-checkbox>
				</vaadin-form-layout>
				<div id="printable">
					<qrcode-printer i18n="[[i18n]]" language="[[language]]" resources="[[resources]]" id="qrcode" text="[[qrCode(user.login,user.secret)]]" size="[[qrCodeWidth]]" ecl="H"></qrcode-printer>
				</div>
			</div>
			<div class="buttons">
				<paper-button class="modal-button" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
				<paper-button class="modal-button modal-button--save" autofocus on-tap="confirm">[[localize('save','Save',language)]]</paper-button>
			</div>
		</paper-dialog>
	</template>
	<script>
        import * as models from 'icc-api/dist/icc-api/model/models';

        class HtExportKey extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
	static get is() {
		return 'ht-my-profile';
	}

	static get properties() {
		return {
			api: {
				type: Object,
				value: null
			},
			user: {
				type: Object,
				value: null
			},
			hcp: {
				type: Object,
				value: null
			},
			qrCodeWidth: {
				type: Number,
				value: 0
			},
			opened: {
				type: Boolean,
				value: false
			},
			verbose: {
				type: Boolean,
				value: true
            },
            userPassword: {
                type: String,
                value: null
            },
            userConfirmation: {
                type: String,
                value: null
            },
            userPreferredHub: {
                type: String,
                value: null
            },
            userEHealthEnv: {
                type: String,
                value: null
            },
            userIBAN: {
                type: String,
                value: null
            },
            userBIC: {
                type: String,
                value: null
            },
			userMedicalHouseNihii: {
			    type: String,
				value:null

			},
			listOAs: {
			    type: Array,
				value: ['100','200','300','400','500','600','900']
			},
			regStatus:{
			    type: Object,
				value: null
			},
            allEDmgRegistered:{
			    type: Boolean,
                value: false
            },
            currentRegs:{
			    type: Object,
				value : null
			}
        };
	}

	static get observers() {
		return ['apiReady(api,user,opened)', '_userChanged(user)'];
	}

	ready() {
		super.ready();
		this.addEventListener('iron-resize', () => this.onWidthChange());
	}

	showEHPreferrences(user)
	{
        const propHub = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.preferredhub') ||
            (this.user.properties[this.user.properties.length] = {
                type: {identifier: 'org.taktik.icure.user.preferredhub'},
                typedValue: {type: 'STRING', stringValue: 'rsw'}
            });
        this.set('userPreferredHub', propHub.typedValue.stringValue);

        const propEnv = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.eHealthEnv') ||
            (this.user.properties[this.user.properties.length] = {
                type: {identifier: 'org.taktik.icure.user.eHealthEnv'},
                typedValue: {type: 'STRING', stringValue: 'prd'}
            });
        this.set('userEHealthEnv', propEnv.typedValue.stringValue);

        const propMHNihii = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.medicalHouse.nihii') ||
            (this.user.properties[this.user.properties.length] = {
                type: {identifier: 'org.taktik.icure.user.medicalHouse.nihii'},
                typedValue: {type: 'STRING', stringValue: ''}
            });
        this.set('userMedicalHouseNihii', propMHNihii.typedValue.stringValue);

        const propBIC = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.BIC') ||
            (this.user.properties[this.user.properties.length] = {
                type: {identifier: 'org.taktik.icure.user.BIC'},
                typedValue: {type: 'STRING', stringValue: ''}
            });
        this.set('userBIC', propBIC.typedValue.stringValue);

        const propIBAN = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.IBAN') ||
            (this.user.properties[this.user.properties.length] = {
                type: {identifier: 'org.taktik.icure.user.IBAN'},
                typedValue: {type: 'STRING', stringValue: ''}
            });
        this.set('userIBAN', propIBAN.typedValue.stringValue);
	}

	_getOARegStatus(reg){
	   if (reg) {
			return reg.Registered ? reg.OA + ':OK ' : reg.OA + ':NOK ';
		} else {
			return ''
		}
    }

    _registerToEDMG(){
		//100,200,300,400,500,600,900
		let regs = this.getRegistrationStatus();
		regs.rs.map(reg =>{
            if(!reg.Registered) {
                this.registerToEDMGbyOA(reg).then(reg =>{
                    const idx = regs.rs.findIndex(r => r.OA === reg.OA);
                    if(idx >= 0){
                        regs.rs.splice(idx, 1, reg);
                    } else {
                        regs.rs.push(reg);
                    }
                    this.set('regStatus',JSON.stringify(regs));
                })
            }
        })
	}

	getRegistrationStatus(){

        const propRegStatus = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.eDMG.RegistrationStatus') ||
            (this.user.properties[this.user.properties.length] = {
                type: {identifier: 'org.taktik.icure.user.eDMG.RegistrationStatus'},
                typedValue: {type: 'JSON', stringValue: '{\"rs\":[]}'}
            });
		//'{"rs":[{"OA":"100","Comment":"","ErrorCode":""}]}'

        let OAStatus = {};
        if(propRegStatus && propRegStatus.typedValue) {
           OAStatus = JSON.parse(propRegStatus.typedValue.stringValue);
        }
        let regs = new models.ListOfIdsDto({rs: OAStatus.rs.map(r => r)}) || [];
        this.listOAs.map(itOA => {
            let reg = regs.rs.find(r => r.OA === itOA) || {OA : itOA, Registered: false, lastExecution: null, Comment : '', ErrorCode :  ''};
            const idx = regs.rs.findIndex(r => r.OA === itOA);
            if(idx >= 0){
                regs.rs.splice(idx, 1, reg);
            } else {
                regs.rs.push(reg);
			}
        })
        const unreg = regs.rs.find(r => r.Registered === false);
        this.set('allEDmgRegistered', unreg ? false : true);
        this.set('currentRegs', regs);
        let mytest = JSON.stringify(regs);
        return regs;
	}


	registerToEDMGbyOA(reg){
        if (this.api.tokenId) {

            return this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId)
                .then(hcp => {
                    return this.api.fhc().Dmgcontroller().registerDoctorUsingPOST(
                        this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                        hcp.nihii, hcp.ssin, hcp.firstName, hcp.lastName, reg.OA, this.userBIC, this.userIBAN);
                    }
                ).then(regResp => {
                        if (regResp) {
                            reg.Registered = true;
                            reg.lastExecution = (new Date).getTime();
                            reg.response = JSON.stringify(regResp);
                            return reg;
                        } else {
                            reg.Registered = true;
                            reg.lastExecution = (new Date).getTime();
                            reg.response = 'empty';
                            return reg;
                        }
                    }
                ).catch(function(error) {
                        reg.Comment = 'exception caugh:' + error;
                        reg.response = JSON.stringify(error);
                        reg.lastExecution = (new Date).getTime();
                        return Promise.resolve(reg);
                    }
                )
        } else {
            reg.Comment = 'err: no tokenid';
            return Promise.resolve(reg)
        }
	}

	_userChanged(user) {

	}

	_mismatch(a, b) {
	    return a && a !== b
	}

    _tooShort(a) {
        return a && a.length < 8
    }

    apiReady() {
        if (this.user && this.api && this.opened) {
            this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp => {
                if (!hcp.languages || !hcp.languages.length) {
                    hcp.languages = ['en'];
                }
                this.set('hcp', hcp);
            });
        }
    }

	qrCode(login, secret) {
		return login && secret ? `otpauth://totp/${login}:iCure-cloud?secret=${secret}&issuer=icure-cloud` : '';
	}

	attached() {
		super.attached();
		this.async(this.notifyResize, 1);
	}

	onWidthChange() {
		const offsetWidth = this.$.dialog.offsetWidth;
		const offsetHeight = this.$.dialog.offsetHeight;
		if (!offsetWidth || !offsetHeight) {
			return;
		}
		this.set('qrCodeWidth', Math.max(Math.min(offsetWidth / 2 - 64, 280), 120));
	}

	open() {
		this.$.dialog.open();
        this.showEHPreferrences(this.user);
        this.getRegistrationStatus();
	}

	close() {
		this.$.dialog.close();
	}

	confirm() {
	    if ((!this.userPassword || this.userPassword.length > 7) && this.userPassword === this.userConfirmation) {
	        this.user.passwordHash = this.userPassword || this.user.passwordHash
            let propHub = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.preferredhub')
			propHub.typedValue.stringValue = this.userPreferredHub;
            let propEnv = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.eHealthEnv')
            propEnv.typedValue.stringValue = this.userEHealthEnv;

            let propMHNihii = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.medicalHouse.nihii')
            propMHNihii.typedValue.stringValue = this.userMedicalHouseNihii;

            let propIBAN = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.IBAN')
            propIBAN.typedValue.stringValue = this.userIBAN;
            let propBIC = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.BIC')
            propBIC.typedValue.stringValue = this.userBIC;

            if(this.regStatus) {
                let propRegStatus = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.eDMG.RegistrationStatus')
                propRegStatus.typedValue.stringValue = this.regStatus;
            }
            this.api.user().modifyUser(this.user).then(
                user => this.dispatchEvent(new CustomEvent('user-saved', {detail: user, bubbles: true, composed: true}))
			).then(() => this.api.hcparty().modifyHealthcareParty(this.hcp)).finally(() => this.$.dialog.close())
        }
	}
}

customElements.define(HtExportKey.is, HtExportKey);
</script>
</dom-module>
