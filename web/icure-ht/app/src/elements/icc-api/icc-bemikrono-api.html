
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="icc-bemikrono-api">
	<template>
		<style>
		</style>

		<iron-ajax id="appointments" method="GET" headers="[[headers]]" url="/be_mikrono/appointments/byDate/{date}" handle-as="json"
				   on-error="handleError" with-credentials></iron-ajax>
		<iron-ajax id="appointments_1" method="GET" headers="[[headers]]" url="/be_mikrono/appointments/byPatient/{patientId}" handle-as="json"
				   on-error="handleError" with-credentials></iron-ajax>
		<iron-ajax id="register" method="PUT" headers="[[headers]]" url="/be_mikrono/user/{userId}/register" handle-as="json"
				   on-error="handleError" with-credentials></iron-ajax>
		<iron-ajax id="sendMessage" method="POST" headers="[[headers]]" url="/be_mikrono/sendMessage" handle-as="json"
				   on-error="handleError" with-credentials></iron-ajax>
		<iron-ajax id="setUserCredentials" method="PUT" headers="[[headers]]" url="/be_mikrono/user/{userId}/credentials" handle-as="json"
				   on-error="handleError" with-credentials></iron-ajax>
		<iron-ajax id="syncSince" method="POST" headers="[[headers]]" url="/be_mikrono/sync/{url}/{from}/{user}/{password}" handle-as="json"
				   on-error="handleError" with-credentials></iron-ajax>
		<iron-ajax id="updateIds" method="POST" headers="[[headers]]" url="/be_mikrono/updateIds/{url}/{user}/{password}" handle-as="json"
				   on-error="handleError" with-credentials></iron-ajax>
	</template>
</dom-module>

<script>
	(function () {
		Polymer({
			is: 'icc-bemikrono-api',
			properties: {
				headers: {
					type: Object,
					value: {"Content-Type": "application/json"}
				},
				host: {
					type: String
				}
			},
			behaviors: [],
			appointments: function (date) {
				var xhr = this.$.appointments

				xhr.url = this.host+"/be_mikrono/appointments/byDate/{date}".replace("{date}", date) + "?ts=" + (new Date).getTime()
				return xhr.generateRequest().completes.then(function (req) {
					return req.response
				})
			},
			appointments_1: function (patientId, from, from2) {
				var xhr = this.$.appointments_1

				xhr.url = this.host+"/be_mikrono/appointments/byPatient/{patientId}".replace("{patientId}", patientId) + "?ts=" + (new Date).getTime()  + (from ? "&from=" + from : "") + (from2 ? "&from2=" + from2 : "")
				return xhr.generateRequest().completes.then(function (req) {
					return req.response
				})
			},
			register: function (userId, body) {
				var xhr = this.$.register
				xhr.body = body
				xhr.url = this.host+"/be_mikrono/user/{userId}/register".replace("{userId}", userId) + "?ts=" + (new Date).getTime()
				return xhr.generateRequest().completes.then(function (req) {
					return req.response
				})
			},
			sendMessage: function (body) {
				var xhr = this.$.sendMessage
				xhr.body = body
				xhr.url = this.host+"/be_mikrono/sendMessage" + "?ts=" + (new Date).getTime()
				return xhr.generateRequest().completes.then(function (req) {
					return req.response
				})
			},
			setUserCredentials: function (userId, body) {
				var xhr = this.$.setUserCredentials
				xhr.body = body
				xhr.url = this.host+"/be_mikrono/user/{userId}/credentials".replace("{userId}", userId) + "?ts=" + (new Date).getTime()
				return xhr.generateRequest().completes.then(function (req) {
					return req.response
				})
			},
			syncSince: function (url, from, user, password) {
				var xhr = this.$.syncSince

				xhr.url = this.host+"/be_mikrono/sync/{url}/{from}/{user}/{password}".replace("{url}", url).replace("{from}", from).replace("{user}", user).replace("{password}", password) + "?ts=" + (new Date).getTime()
				return xhr.generateRequest().completes.then(function (req) {
					return req.response
				})
			},
			updateIds: function (url, user, password) {
				var xhr = this.$.updateIds

				xhr.url = this.host+"/be_mikrono/updateIds/{url}/{user}/{password}".replace("{url}", url).replace("{user}", user).replace("{password}", password) + "?ts=" + (new Date).getTime()
				return xhr.generateRequest().completes.then(function (req) {
					return req.response
				})
			},
			handleError: function (e) {
				if (e.detail.request.status === 401) this.fire('auth-failed')
				else this.fire('api-error', e)
			}
		});
	})();
</script>

@end
