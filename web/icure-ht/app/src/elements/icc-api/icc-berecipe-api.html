
	<link rel="import" href="../../../bower_components/polymer/polymer.html">
	<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

	<dom-module id="icc-berecipe-api">
		<template>
    		<style>
	    	</style>

				<iron-ajax id="createPrescription" method="POST" headers="[[headers]]" url="/be_recipe/{token}/{healthcarePartyId}/{patientId}" handle-as="json"
									 on-error="handleError" with-credentials></iron-ajax>
				<iron-ajax id="listFeedbacks" method="GET" headers="[[headers]]" url="/be_recipe/feedbacks/{token}" handle-as="json"
									 on-error="handleError" with-credentials></iron-ajax>
				<iron-ajax id="listOpenPrescriptions" method="GET" headers="[[headers]]" url="/be_recipe/{token}" handle-as="json"
									 on-error="handleError" with-credentials></iron-ajax>
				<iron-ajax id="listOpenPrescriptionsForPatient" method="GET" headers="[[headers]]" url="/be_recipe/list/{token}/{patientId}" handle-as="json"
									 on-error="handleError" with-credentials></iron-ajax>
				<iron-ajax id="revokePrescription" method="PUT" headers="[[headers]]" url="/be_recipe/revoke/{token}/{rid}" handle-as="json"
									 on-error="handleError" with-credentials></iron-ajax>
				<iron-ajax id="sendNotification" method="PUT" headers="[[headers]]" url="/be_recipe/notify/{token}/{patientId}/{rid}" handle-as="json"
									 on-error="handleError" with-credentials></iron-ajax>
				<iron-ajax id="updateFeedbackFlag" method="PUT" headers="[[headers]]" url="/be_recipe/update/{token}/{rid}" handle-as="json"
									 on-error="handleError" with-credentials></iron-ajax>
		</template>
	</dom-module>

	<script>
		(function () {
			Polymer({
				is: 'icc-berecipe-api',
				properties: {
					headers: {
						type: Object,
						value: {"Content-Type": "application/json"}
					},
					host: {
						type: String
					}
				},
				behaviors: [],
				createPrescription: function (token, healthcarePartyId, patientId, needsFeedback, prescriptionType, notification, executorId, deliverableDate, expirationDate, body) {
					var xhr = this.$.createPrescription
					xhr.body = body
					xhr.url = this.host+"/be_recipe/{token}/{healthcarePartyId}/{patientId}".replace("{token}", token).replace("{healthcarePartyId}", healthcarePartyId).replace("{patientId}", patientId) + "?ts=" + (new Date).getTime()  + (needsFeedback ? "&needsFeedback=" + needsFeedback : "") + (prescriptionType ? "&prescriptionType=" + prescriptionType : "") + (notification ? "&notification=" + notification : "") + (executorId ? "&executorId=" + executorId : "") + (deliverableDate ? "&deliverableDate=" + deliverableDate : "") + (expirationDate ? "&expirationDate=" + expirationDate : "")
					return xhr.generateRequest().completes.then(function (req) {
						return req.response
					})
				},
				listFeedbacks: function (token) {
					var xhr = this.$.listFeedbacks

					xhr.url = this.host+"/be_recipe/feedbacks/{token}".replace("{token}", token) + "?ts=" + (new Date).getTime()
					return xhr.generateRequest().completes.then(function (req) {
						return req.response
					})
				},
				listOpenPrescriptions: function (token) {
					var xhr = this.$.listOpenPrescriptions

					xhr.url = this.host+"/be_recipe/{token}".replace("{token}", token) + "?ts=" + (new Date).getTime()
					return xhr.generateRequest().completes.then(function (req) {
						return req.response
					})
				},
				listOpenPrescriptionsForPatient: function (token, patientId) {
					var xhr = this.$.listOpenPrescriptionsForPatient

					xhr.url = this.host+"/be_recipe/list/{token}/{patientId}".replace("{token}", token).replace("{patientId}", patientId) + "?ts=" + (new Date).getTime()
					return xhr.generateRequest().completes.then(function (req) {
						return req.response
					})
				},
				revokePrescription: function (token, rid, reason) {
					var xhr = this.$.revokePrescription

					xhr.url = this.host+"/be_recipe/revoke/{token}/{rid}".replace("{token}", token).replace("{rid}", rid) + "?ts=" + (new Date).getTime()  + (reason ? "&reason=" + reason : "")
					return xhr.generateRequest().completes.then(function (req) {
						return req.response
					})
				},
				sendNotification: function (token, patientId, rid, executorId, body) {
					var xhr = this.$.sendNotification
					xhr.body = body
					xhr.url = this.host+"/be_recipe/notify/{token}/{patientId}/{rid}".replace("{token}", token).replace("{patientId}", patientId).replace("{rid}", rid) + "?ts=" + (new Date).getTime()  + (executorId ? "&executorId=" + executorId : "")
					return xhr.generateRequest().completes.then(function (req) {
						return req.response
					})
				},
				updateFeedbackFlag: function (token, rid, feedbackFlag) {
					var xhr = this.$.updateFeedbackFlag

					xhr.url = this.host+"/be_recipe/update/{token}/{rid}".replace("{token}", token).replace("{rid}", rid) + "?ts=" + (new Date).getTime()  + (feedbackFlag ? "&feedbackFlag=" + feedbackFlag : "")
					return xhr.generateRequest().completes.then(function (req) {
						return req.response
					})
				},
				handleError: function (e) {
					if (e.detail.request.status === 401) this.fire('auth-failed')
					else this.fire('api-error', e)
				}
			});
		})();
	</script>

@end
