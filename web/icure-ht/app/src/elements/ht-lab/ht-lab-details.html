<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">



<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">


<link rel="import" href="../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../filter-panel/filter-panel.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">

<link rel="import" href="../dynamic-form/dynamically-loaded-form.html">
<link rel="import" href="../dynamic-form/dynamic-doc.html">
<link rel="import" href="../dynamic-form/entity-selector.html">



<dom-module id="ht-lab-details">
    <template>
        <style>
        </style>
        <div inner-h-t-m-l="[[attachmentFormated]]"></div>
    </template>
    <script>

		import jsPDF from 'jspdf/dist/jspdf.min';
		import _ from 'lodash/lodash';
		import JsBarcode from 'JsBarcode';
		import moment from 'moment/src/moment';
		import XML from 'parse-xml/dist/parse-xml';

		class HtLabDetails extends Polymer.TkLocalizerMixin(Polymer.Element) {
			static get is() {
				return 'ht-lab-details';
			}

			static get properties() {
				return {
					api: {
						type: Object
					},
					attachment:{
						type: String,
						value: null
					},
                    attachmentFormated:{
						type: String,
						value: null
					},
                    document:{
						type: Object,
                        value: null
                    }
				};
			}

			static get observers() {
				return ['_attachementLoaded(attachment,document)'];
			}

			constructor() {
				super();
			}

			ready(){
				super.ready();
			}

			_attachementLoaded(){

				if(!this.attachment && this.document){
					this.api.document().getAttachment(this.document.id, this.document.attachmentId, null)
                        .then(att => {
                            this.set("attachment", att);
                            this._attachementLoaded();
					    })
                }
                else if(this.attachment){
					if (this._checkXML(this.attachment)) {
						this.set("attachmentFormated", this.attachment);
					}
					if (this._checkHealthone(this.attachment)) {
						return this.set("attachmentFormated", this._parseHealthone(this.attachment));
					}
					this.set("attachmentFormated", this.attachment);
				}
            }

            _checkHealthone(lab){
				return lab.startsWith("A1");
            }

            _checkXML(lab){
				return lab.startsWith("<?xml");
            }

            _parseHealthone(lab){
				let result = "";
				let lines = lab.split(/\r?\n/);
				lines.forEach(line =>{
					let columns = line.split("\\");
					columns.splice(0,2)
                    result += columns.join(" ") + "<br/>";
                })
                return result;
            }

		}

		customElements.define(HtLabDetails.is, HtLabDetails);
    </script>
</dom-module>
