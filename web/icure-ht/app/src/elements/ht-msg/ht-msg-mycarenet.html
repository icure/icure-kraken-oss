<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter-mixin.html">
<link rel="import" href="../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">

<dom-module id="ht-msg-mycarenet">
    <template>
        <custom-style>
            <style include="shared-styles">

                :host {
                    display: block;
                    z-index:2;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                .invoice-panel {
                    height: 100%;
                    margin: 0;
                    grid-column: 2/2;
                    grid-row: 1/1;
                    padding: 0 24px;
                    display:flex;
                    flex-flow: column nowrap;
                    justify-content: space-between;
                }

                .grid-panel {
                    flex-basis: calc(100% - 60px);
                    height: calc(100% - 60px);
                    display: flex;
                    flex-flow: row nowrap;
                    box-sizing: border-box;
                    justify-content: space-between;
                }

                #messagesGrid {
                    flex-basis: calc(100% - 33vw - 24px);
                    height: calc(100% - 73px);
                    transition: .5s ease;
                }
                #messagesGrid.no-detail {
                    flex-basis: 100%;
                }

                #detailGrid {
                    flex-basis: 40%;
                    height: calc(100% - 197px);
                    position: fixed;
                    right: 24px;
                    width: 33vw;
                    transition: .5s ease;
                }

                #detailGrid.no-detail {
                    flex-basis: 0;
                    transform: translateX(100vw);
                }

                .invoice-panel .btns-container{
                    padding: 0;
                    flex-basis: 60px;
                    position: fixed;
                    right: 20px;
                    bottom: 15px;
                }

                .bottom-btn {
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                    background: var(--app-secondary-color);
                    color: var(--app-text-color);
                    font-weight: bold;
                    font-size: 12px;
                    height: 40px;
                    min-width: 100px;
                    @apply --shadow-elevation-2dp;
                    padding: 10px 1.2em;
                    text-transform: capitalize;
                }

                vaadin-grid{
                    height: 100%;
                }

                vaading-grid-column.icon-col {
                    width: 50px;
                }

            </style>
        </custom-style>
        <div class="invoice-panel">
            <div class="grid-panel">
                <div  id="messagesGrid" class$="[[detailPanelClass(tempoSubMessages)]]">
                    <paper-input id="filter" label="[[localize('fil','Filter',language)]]" value="{{leftFilterValue}}"
                                 on-keydown="refreshFilter">
                    </paper-input>
                    <vaadin-grid items="[[messages]]" active-item="{{activeItem}}" selected-items="{{selectedItems}}">
                        <vaadin-grid-selection-column id="msg-list-selection-column"></vaadin-grid-selection-column>
                        <vaadin-grid-column class="icon-col">
                            <template class="header">
                            </template>
                            <template>
                                <template is="dom-if" if="[[_isList(item)]]">
                                    <iron-icon class="icon type-icon" icon="list"></iron-icon>
                                </template>
                                <template is="dom-if" if="[[_isClosure(item)]]">
                                    <iron-icon class="icon type-icon" icon="close"></iron-icon>
                                </template>
                                <template is="dom-if" if="[[_isExtension(item)]]">
                                    <iron-icon class="icon type-icon" icon="add"></iron-icon>
                                </template>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">
                                <vaadin-grid-sorter path="">[[localize("dat","Date",language)]]</vaadin-grid-sorter>
                            </template>
                            <template>[[_formatDate(item.received)]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="oa-col">
                            <template class="header">
                                <vaadin-grid-sorter path="">[[localize("tel_type","Type",language)]]</vaadin-grid-sorter>
                            </template>
                            <template>
                                [[item.subject]]
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="oa-col">
                            <template class="header">
                                <vaadin-grid-sorter path="">[[localize("OA","OA",language)]]</vaadin-grid-sorter>
                            </template>
                            <template>[[item.fromAddress]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="ref-col">
                            <template class="header">
                                <vaadin-grid-sorter path="">[[localize("pati","Patient",language)]]</vaadin-grid-sorter>
                            </template>
                            <template>[[item.patient.lastName]] [[item.patient.firstName]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="invoice-col">
                            <template class="header">
                                <vaadin-grid-sorter path="">[[localize("data","Data",language)]]</vaadin-grid-sorter>
                            </template>
                            <template>[[_displayMetas(item.metas)]]</template>
                        </vaadin-grid-column>
                    </vaadin-grid>
                </div>
                <div id="detailGrid" class$="[[detailPanelClass(tempoSubMessages)]]">
                    <paper-input id="subFilter" label="[[localize('fil','Filter',language)]]" value="{{rightFilterValue}}"
                                 on-keydown="refreshSubFilter">
                    </paper-input>
                    <vaadin-grid items="[[subMessages]]">
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">
                                <vaadin-grid-sorter path="">[[localize("peri","Period",language)]]</vaadin-grid-sorter>
                            </template>
                            <template>[[_formatDate(item.from)]] - [[_formatDate(item.to)]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="ref-col">
                            <template class="header">
                                <vaadin-grid-sorter path="">Patient</vaadin-grid-sorter>
                            </template>
                            <template>[[item.lastName]] [[item.firstName]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="invoice-col">
                            <template class="header">
                                <vaadin-grid-sorter path="">[[localize("pay","Payment",language)]]</vaadin-grid-sorter>
                            </template>
                            <template>[[_formatPayments(item.payments)]]</template>
                        </vaadin-grid-column>
                    </vaadin-grid>
                </div>
            </div>
            <div class="btns-container">
                <paper-button class="bottom-btn" id="requestMessagesBtn" on-tap="requestMessages">[[localize('req_msg_lists','Request Messages Lists',language)]]
                </paper-button>
                <paper-button class="bottom-btn" id="getMessagesBtn" on-tap="getMessages">[[localize('get_msg','Get Messages',language)]]
                </paper-button>
            </div>
        </div>

    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models'

        class HtMsgMycarenet extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-mycarenet';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    hcp:{
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    selectedMessages: {
                        type: Object,
                        notify: true
                    },
                    activeItem: {
                        type: Object
                    },
                    messages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    subMessages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectList: {
                        type: Object
                    },
                    selectedItems :{
                        type: Object,
                        value: function () {
                            return [];
                        }
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        }
                    },
                    leftFilterValue :{
                        type : String
                    },
                    tempoMessages :{
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    tempoSubMessages :{
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    rightFilterValue :{
                        type : String
                    }
                };
            }

            constructor() {
                super();
            }

            static get observers() {
                return ['_selectedItemsChanged(selectedItems.*)'];
            }

            ready() {
                super.ready();
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(response =>{
                    this.set("hcp",response)
                    //this.getMessages()
                })
            }

            refresh() {
                this.api.message().findMessagesByTransportGuid('GMD:IN:*', null, null, 1000).then(msgsPl => {
                    const messages = msgsPl && msgsPl.rows || []

                    const ssins = _.uniq(_.compact((messages || []).map(msg => (msg.metas || {}).ssin)))
                    return (ssins.length ? this.api.patient().filterBy(undefined, undefined, 1000, 0, undefined, false,
                            {
                                filter: {
                                    $type: "PatientByHcPartyAndSsinsFilter",
                                    healthcarePartyId: user.healthcarePartyId,
                                    ssins: ssins
                                }
                            }
                        ) : Promise.resolve([])).then(patients => {
                            messages.forEach(msg => {
                                const ssin = (msg.metas || {}).ssin
                                if (ssin) {
                                    msg.patient = patients.rows.find(p => p.ssin === ssin)
                                }
                            })
                            return messages
                        })
                }).then(messages =>  {
                    this.set('messages', messages || [])
                    this.set('tempoMessages', messages || [])
                })
            }

            _displayMetas(metas) {
                if(_.isEmpty(metas) || metas.type==="list")return "";
                return metas.endOfPreviousDmg+' '+metas.previousHcp
            }

            _formatPayments(payments) {
                return payments && payments.map(p => this._formatDate(p.date)+`: ${p.amount} ${(p.currency="eur") ? "€" : p.currency}`+(p.ref ? `[${p.ref}]` : "")).join(', ')
            }

            detailPanelClass(subMessages) {
                return subMessages && subMessages.length ? '' : 'no-detail'
            }

            _selectedItemsChanged() {
                if (!this.selectedItems || !this.selectedItems.length) {
                    this.set('subMessages', [])
                    this.set('tempoSubMessages', [])
                    return
                }
                Promise.all(this.selectedItems.filter(item => this._isList(item)).map(msg => this.api.document().findByMessage(this.user.healthcarePartyId, msg).then(
                    docs => Promise.all(docs.map(d => this.api.document().getAttachment(d.id, d.attachmentId).then(a => {
                        try {
                            return JSON.parse(new Uint8Array(a).reduce((data, byte) => data + String.fromCharCode(byte), ''))
                        } catch (e) {
                            console.log(e)
                        }
                    }))).then( lists => {
                        const inscriptions = _.flatMap(_.compact(lists.map(l => l && l.inscriptions)))
                        const ssins =  _.uniq(_.compact(inscriptions.filter(i => !i.lastName && i.inss)))

                        return (ssins.length ? this.api.patient().filterBy(undefined, undefined, 1000, 0, undefined, false,
                            {
                                filter: {
                                    $type: "PatientByHcPartyAndSsinsFilter",
                                    healthcarePartyId: user.healthcarePartyId,
                                    ssins: ssins
                                }
                            }
                        ) : Promise.resolve([])).then(patients => {
                            lists.forEach(l => {
                                l.inscriptions.forEach( i => {
                                const ssin = i.inss
                                if (ssin && !i.lastName) {
                                    const pat =  patients.find(p => p.ssin === ssin)
                                    i.firstName = pat.firstName
                                    i.lastName = pat.lastName
                                }
                                i.payments = (i.payment1Amount ? [
                                            {
                                                amount: i.payment1Amount,
                                                currency: i.payment1Currency,
                                                date: i.payment1Date,
                                                ref: i.payment1Ref
                                            }
                                        ]
                                        : []
                                ).concat(
                                    i.payment2Amount ? [
                                            {
                                                amount: i.payment2Amount,
                                                currency: i.payment2Currency,
                                                date: i.payment2Date,
                                                ref: i.payment2Ref
                                            }
                                        ]
                                        : []
                                )
                                })
                            })
                            return lists
                        })
                    })))).then(listsOfLists => {
                    this.set('subMessages', _.flatMap(_.flatMap(listsOfLists), x => x.inscriptions))
                    this.set('tempoSubMessages', _.flatMap(_.flatMap(listsOfLists), x => x.inscriptions))
                })
            }

            getMessages() {
                this.api.fhc().Dmgcontroller().getDmgMessagesUsingPOST(this.api.keystoreId,this.api.tokenId,this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName,"", [])
                    .then(list => this.api.message().processDmgMessagesList(this.user,this.hcp,list,this.api.document()))
                    .then(([ackHashes, dmgHashes]) => Promise.all([
                        //this.api.fhc().Dmgcontroller().confirmAcksUsingPOST(this.api.keystoreId, this.api.tokenId,this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName, ackHashes),
                        //this.api.fhc().Dmgcontroller().confirmDmgMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName, dmgHashes)
                    ]))
            }

            requestMessages(){
                this.api.fhc().Dmgcontroller().postDmgsListRequestUsingPOST(this.api.keystoreId,this.api.tokenId,this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName)
                    .then(response =>{
                        console.log(response)
                    })
            }

            _formatDate(val){
                return this.api.moment(val).format("DD/MM/YYYY")
            }

            refreshFilter(){
                setTimeout(function () {
                    const currentValue = this.leftFilterValue
                    setTimeout(function () {
                        console.log(currentValue,this.leftFilterValue)
                        if (currentValue === this.leftFilterValue) {
                            console.log("Triggering search for " + this.leftFilterValue)
                            this.set("messages",this.tempoMessages);
                            const regexYear = new RegExp('^[0-9]{4}$');
                            const regexFullDate = new RegExp('^[0-9]{2}[.\-/][0-9]{2}[.\-/][0-9]{4}$');
                            const regexMonthDate = new RegExp('^[0-9]{2}[.\-/][0-9]{4}$');
                            const regexOa= new RegExp('^[1-6|9]00$');
                            (this.leftFilterValue.length===4 && regexYear.test(this.leftFilterValue)) ? this.set("messages",this.tempoMessages.filter(message => this.api.moment(message.received).isSame(moment(this.leftFilterValue),"year"))) :
                            (this.leftFilterValue.length>=8 && regexFullDate.test(this.leftFilterValue)) ? this.set("messages",this.tempoMessages.filter(message => this.api.moment(message.received).isSame(moment(this.leftFilterValue,'DD-MM-YYYY')||moment(this.leftFilterValue,'DD/MM/YYYY')||moment(this.leftFilterValue,'DD.MM.YYYY'),"day"))) :
                            (this.leftFilterValue.length>=6 && regexMonthDate.test(this.leftFilterValue)) ? this.set("messages",this.tempoMessages.filter(message => this.api.moment(message.received).isSame(moment(this.leftFilterValue,'MM-YYYY')||moment(this.leftFilterValue,'MM/YYYY')||moment(this.leftFilterValue,'MM.YYYY'),"month"))) :
                            (this.leftFilterValue.length===3 && regexOa.test(this.leftFilterValue)) ? this.set("messages",this.tempoMessages.filter(message => (message.fromAddress===this.leftFilterValue))) :
                            this.set("messages",this.tempoMessages.filter(message => message.subject.toLowerCase().includes(this.leftFilterValue.toLowerCase()) || ((message.patient) &&((message.patient.firstName.includes(this.leftFilterValue)) || (message.patient.lastName.includes(this.leftFilterValue))))))
                        } else {
                            console.log("Skipping search for " + this.leftFilterValue + " != " + currentValue)
                        }
                    }.bind(this), 500) //Wait for the user to stop typing
                }.bind(this), 100)
            }


            refreshSubFilter(){
                setTimeout(function () {
                    let currentValue = this.rightFilterValue

                    setTimeout(function () {
                        if (currentValue === this.rightFilterValue) {
                            console.log("Triggering search for " + this.rightFilterValue)

                            console.log(this.tempoSubMessages)
                            const regexYear = new RegExp('^[0-9]{4}$');
                            const regexFullDate = new RegExp('^[0-9]{2}[.\-/][0-9]{2}[.\-/][0-9]{4}$');
                            const regexMonthDate = new RegExp('^[0-9]{2}[.\-/][0-9]{4}$');
                            //console.log(this.tempoSubMessages.filter(message => (message.lastName+" "+message.firstName+" "+message.lastName).toLowerCase().includes(this.rightFilterValue.toLowerCase()) || (this._formatPayments(message.payments)).toLowerCase().includes(this.rightFilterValue.toLowerCase())))
                            (regexFullDate.test(this.rightFilterValue)) ? this.set("subMessages",this.tempoSubMessages.filter(message => (moment(this.rightFilterValue,'DD-MM-YYYY')||moment(this.rightFilterValue,'DD/MM/YYYY')||moment(this.rightFilterValue,'DD.MM.YYYY')).isBetween(this.api.moment(message.from),this.api.moment(message.to),"day","[]"))) :
                            (regexMonthDate.test(this.rightFilterValue)) ? this.set("subMessages",this.tempoSubMessages.filter(message => (moment(this.rightFilterValue,'MM-YYYY')||moment(this.rightFilterValue,'MM/YYYY')||moment(this.rightFilterValue,'MM.YYYY')).isBetween(this.api.moment(message.from),this.api.moment(message.to),"month","[]"))) :
                            (regexYear.test(this.rightFilterValue)) ? this.set("subMessages",this.tempoSubMessages.filter(message => moment(this.rightFilterValue).isBetween(this.api.moment(message.from),this.api.moment(message.to),"year","[]"))) :
                            this.set("subMessages",this.tempoSubMessages.filter(message => (message.lastName+" "+message.firstName+" "+message.lastName).toLowerCase().includes(this.rightFilterValue.toLowerCase()) || (this._formatPayments(message.payments)).toLowerCase().includes(this.rightFilterValue.toLowerCase())))
                        } else {
                            console.log("Skipping search for " + this.rightFilterValue + " != " + currentValue)
                        }
                    }.bind(this), 500) //Wait for the user to stop typing
                }.bind(this), 100)
            }


            _isList(item){
                return (_.isEmpty(item.metas) && item.subject.includes("List")) || item.metas.type==="list";
            }

            _isClosure(item){
                return (_.isEmpty(item.metas) && item.subject.includes("Closure")) || item.metas.type==="closure";
            }

            _isExtension(item){
                return (_.isEmpty(item.metas) && item.subject.includes("Extension")) || item.metas.type==="extension";
            }
        }

        customElements.define(HtMsgMycarenet.is, HtMsgMycarenet);
    </script>
</dom-module>
