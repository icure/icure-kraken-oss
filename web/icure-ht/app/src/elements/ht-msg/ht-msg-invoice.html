<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter-mixin.html">
<link rel="import" href="../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">

<dom-module id="ht-msg-invoice">
    <template>
        <custom-style>
            <style include="shared-styles">

                :host {
                    display: block;
                    z-index:2;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                vaadin-grid {
                    /*height: calc(100% - 41px - 32px - 32px);*/
                    height: auto;
                    width: 100vw;
                    /*width: calc(100vw - 16%);*/
                    box-shadow: var(--app-shadow-elevation-1);
                    border: none;
                    box-sizing: border-box;
                }

                vaadin-grid.material {
                    outline: 0 !important;
                    font-family: Roboto, sans-serif;
                    background: rgba(0, 0, 0, 0);
                    border: none;
                    --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                    --vaadin-grid-cell: {
                        padding: 8px;
                    };

                    --vaadin-grid-header-cell: {
                        height: 48px;
                        padding: 11.2px;
                        color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                        font-size: 12px;
                        background: rgba(0, 0, 0, 0);
                        border-top: 0;
                    };

                    --vaadin-grid-body-cell: {
                        height: 48px;
                        color: rgba(0, 0, 0, var(--dark-primary-opacity));
                        font-size: 13px;
                    };

                    --vaadin-grid-body-row-hover-cell: {
                        background-color: var(--paper-grey-200);
                    };

                    --vaadin-grid-body-row-selected-cell: {
                        background-color: var(--paper-grey-100);
                    };

                    --vaadin-grid-focused-cell: {
                        box-shadow: none;
                        font-weight: bold;
                    };

                }

                vaadin-grid.material .cell {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    padding-right: 56px;
                    height: 100%;
                }

                vaadin-grid.material .cell.last {
                    padding-right: 24px;
                    text-align: center;
                }

                vaadin-grid.material .cell.numeric {
                    text-align: right;
                }

                vaadin-grid.material paper-checkbox {
                    --primary-color: var(--paper-indigo-500);
                    margin: 0 24px;
                }

                vaadin-grid.material vaadin-grid-sorter {
                    --vaadin-grid-sorter-arrow: {
                        display: none !important;
                    };
                }

                vaadin-grid.material vaadin-grid-sorter .cell {
                    flex: 1;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                vaadin-grid.material vaadin-grid-sorter iron-icon {
                    transform: scale(0.8);
                }

                vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                    color: rgba(0, 0, 0, var(--dark-disabled-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction] {
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                    transform: scale(0.8) rotate(180deg);
                }

                vaadin-grid.material::slotted(div) {
                    outline: 0 !important;
                    background: red;
                }

                .invoice-panel{
                    height: 100%;
                    width: 100%;
                    padding: 0 20px;
                    box-sizing: border-box;
                }

                .recipient-col{
                    min-width: 75px;
                    width:  5%;
                }

                .oa-col{
                    min-width: 25px;
                }

                .ref-col{
                    min-width: 75px;
                }

                .invoice-col{
                    min-width: 40px;
                }

                .month-col{
                    min-width: 40px;
                }

                .invoiceDate-col{
                    min-width: 50px;
                }

                .invAmount-col{
                    min-width: 50px;
                }

                .accAmount-col{
                    min-width: 50px;
                }

                .refAmount-col{
                    min-width: 50px;
                }

                .stat-col{
                    min-width: 50px;
                }

                .reject-col{
                    min-width: 100px;
                }

                .payRef-col{
                    min-width: 50px;
                }

                .payDate-col{
                    min-width: 40px;
                }

                .payTot-col{
                    min-width: 40px;
                }

                .payBank-col{
                    min-width: 50px;
                }

                .payPaid-col{
                    min-width: 50px;
                }

                .facture-title {
                    padding: 15px;
                    font-size: 25px;
                    text-transform: capitalize;
                    margin: 0;
                    color: #212121;
                    height: 25px;
                    line-height: 25px;
                }

                /*
                vaadin-grid#messagesGrid,
                vaadin-grid#invoiceGrid {
                    height: calc(100vh - 185px);
                }
                */
                @media screen and (max-width:1025px){
                    .invoice-panel {
                        left: 0;
                        width: 100%;
                    }
                }
                .gridContainer{
                    height: calc(100vh - 190px);
                    overflow-y: hidden;
                    overflow-x: hidden;
                    box-shadow: var(--app-shadow-elevation-1);
                }
                .gridContainer.grid-pending {
                    height: calc(100vh - 190px - 25px);
                }

                .pendingStatus{
                    height: 8px;
                    width: 8px;
                    color: var(--app-status-color-pending);
                }

                #pendingDetailDialog{
                    height: calc(100vh - 40px);
                    width: calc(85% - 40px);
                    z-index: 1100;
                    position: fixed;
                    top: 64px;
                }

                #pendingGridDetail{
                    height: calc(100% - 185px);
                    padding: 0;
                    width: 100%;
                }

                .invoice-status {
                    font-size: 24px;
                    text-transform: capitalize;
                    padding-top: 5px;
                }

                .unlockBtn {
                    height: 12px;
                    width: 12px;
                }

                .hidden {
                    display: none;
                }

                #messagesGridContainer {
                    overflow: hidden;
                }

                .invoiceContainer{
                    overflow-x: hidden;
                    overflow-y: hidden;
                    height: calc(100vh - 185px);
                    box-shadow: var(--app-shadow-elevation-1);
                }
                .invoiceSubContainerBig{
                   height: 100%;
                }

                .invoiceSubContainerMiddle{
                    /*height: 50%;*/
                    height: calc(100vh - 185px);
                    transition: all .5s ease;
                }
                .invoiceSubContainerMiddle vaadin-grid {
                    /*height: 100%;*/
                }
                .invoiceSubContainerMiddle.half {
                    height: 49%;
                }

                .invoiceDetailContainer{
                    height: 50%;
                    opacity: 0;
                    transition: all .75s ease-out;
                    overflow-y: auto;
                }
                .invoiceDetailContainer.open {
                    opacity: 1;
                    width: 100%;
                    height: 37%;
                }

                #helpdeskInfoDialog{
                    position: fixed;
                    display: block;
                    top: 50vh;
                    left: 50%;
                    transform: translate(-50%,-50%);
                    height: 80vh;
                    width: 40vw;
                    max-width: none !important;
                    max-height: none !important;
                    overflow-y: auto;
                }

                tr.hidden {
                    display: none !important;
                }

                .mb0 {
                    margin-bottom: 0;
                }

                #pendingDetailDialog {
                    max-height: 80vh;
                }

                .helpdeskIcon{
                    height: 12px;
                    width: 12px;
                }

                iron-collapse-button {
                    height: 45px;
                    line-height: 45px;
                    background: var(--app-background-color-dark);
                    display: initial;
                }

                #invoiceCollapser {
                    display: block;
                    background: white;
                    height: calc(100% - 75px);
                    overflow-y: auto;
                }

                h3.header {
                    margin: 0 auto
                }
                #collapse-grid .recipient-col {
                    background: grey;
                }

                .rejectionReason-col{
                    overflow: hidden;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    max-width: 100%;
                }

                .containScroll {
                    overflow: auto;
                    height: 100%;
                }

                .scrollBox {
                    width: 100%;
                    overflow: hidden;
                    height: 100%;
                }
                .scrollBox > #messagesGrid {
                    width: 100%;
                    height: 100%;
                }

            </style>
        </custom-style>
        <div class="invoice-panel">
            <div id="batchStatus" class="invoice-status">
                [[_displayInvoiceStatus(invoicesStatus)]]
            </div>
            <template is="dom-if" if="[[statusPending]]">
                <paper-input id="filter" label="[[localize('sch','Rechercher',language)]]" value="{{filterInput}}" on-keyup="refreshFilter" param="invoiceGrid" where="pendings">></paper-input>
            </template>
            <template is="dom-if" if="[[!statusPending]]">
                <paper-input id="filter" label="[[localize('sch','Rechercher',language)]]" value="{{filterInputInvoices}}" on-keyup="refreshFilter" param="messagesGrid" where="notPendings"></paper-input>
            </template>

            <template is="dom-if" if="[[statusPending]]">
                <div class="gridContainer grid-pending">
                    <div class="containScroll">
                        <vaadin-grid id="noscroll" class="pendingTable" class="force-sizer" theme="force-sizer">
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.sentMediumType">Type</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="patient.insurance.code">Mutuelle</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.invoiceReference">N° facture</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.patient.firstName">Patient</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="patient.ssin">Niss</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.invoiceDate">Date facture</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column-group>
                                <template class="header hasBorder">Montants</template>
                                <vaadin-grid-column class="recipient-col">
                                    <template class="header border-left">
                                        <vaadin-grid-sorter path="invoice.reimbursement">OA</vaadin-grid-sorter>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column class="recipient-col">
                                    <template class="header">
                                        <vaadin-grid-sorter path="invoice.patientIntervention">Patient</vaadin-grid-sorter>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column class="recipient-col">
                                    <template class="header">
                                        <vaadin-grid-sorter path="invoice.doctorSupplement">Supplément</vaadin-grid-sorter>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column class="recipient-col border-right">
                                    <template class="header border-right">
                                        <vaadin-grid-sorter path="invoice.totalAmount">Total</vaadin-grid-sorter>
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid-column-group>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.statut">Statut</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header"></template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                        <template is="dom-repeat" items="[[toggledDatas]]">
                            <iron-collapse-button>
                                <div slot="collapse-trigger" class="flex header">
                                    <vaadin-grid id="collapse-grid">
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">[[localize('grp','Groupe',language)]] <iron-icon icon="unfold-more"></iron-icon></template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header"><h3 class="header">OA: [[item.code]]</h3></template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <!--<template class="header">[[localize('tot_sub','Sous-total',language)]] :</template>-->
                                        </vaadin-grid-column>
                                        <vaadin-grid-column-group>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header"><small>[[item.sum.oa]]€</small></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header"><small>[[item.sum.pat]]€</small></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header"><small>[[item.sum.sup]]€</small></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col border-right">
                                                <template class="header"><small>[[item.sum.tot]]€</small></template>
                                            </vaadin-grid-column>
                                        </vaadin-grid-column-group>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                </div>
                                <div slot="collapse-content">
                                    <vaadin-grid id="invoiceGrid" class="invoiceGrid" items="[[item.pat]]" multi-sort="[[multiSort]]" active-item="{{activeGridItem}}" on-tap="_showPendingDetail">
                                        <vaadin-grid-column class="recipient-col">
                                            <!--<template>[[item.invoice.sentMediumType]]</template>-->
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template>
                                                [[item.insuranceCode]]
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template>[[item.invoiceReference]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template>[[item.patient]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template>[[item.ssin]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template>[[returnDate(item.invoiceDate)]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column-group>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="border-left">[[_formatAmount(item.reimbursement)]]€</template>
                                                <!--<template class="footer">[[_formatAmount(totalPendingInvoices.totalReimbursement)]]€</template>-->
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col">
                                                <template>[[_formatAmount(item.patientIntervention)]]€</template>
                                                <!--<template class="footer">[[_formatAmount(totalPendingInvoices.totalPatientIntervention)]]€</template>-->
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col">
                                                <template>[[_formatAmount(item.doctorSupplement)]]€</template>
                                                <!--<template class="footer">[[_formatAmount(totalPendingInvoices.totalDoctorSupplement)]]€</template>-->
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col border-right">
                                                <template class="border-right">[[_formatAmount(item.totalAmount)]]</template>
                                                <!--<template class="footer">[[_formatAmount(totalPendingInvoices.totalAmount)]]€</template>-->
                                            </vaadin-grid-column>
                                        </vaadin-grid-column-group>
                                        <vaadin-grid-column class="recipient-col">
                                            <template>
                                                <iron-icon icon="vaadin:circle" class="pendingStatus"></iron-icon>
                                                [[item.statut]]
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template>
                                                <iron-icon icon="vaadin:unlock" class="unlockBtn" on-tap="_unlockInvoice" data-item$="[[item.invoice]]"></iron-icon>
                                            </template>
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                    <vaadin-grid items="toggledDatas">
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="footer">[[localize('tot_sub','Sous-total',language)]] :</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column-group>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="footer"><b>[[item.sum.oa]]€</b></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="footer"><b>[[item.sum.pat]]€</b></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="footer"><b>[[item.sum.sup]]€</b></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col border-right">
                                                <template class="footer"><b>[[item.sum.tot]]€</b></template>
                                            </vaadin-grid-column>
                                        </vaadin-grid-column-group>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                </div>
                            </iron-collapse-button>
                        </template>
                        <vaadin-grid>
                            <vaadin-grid-column class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="footer">[[localize('tot_global','Total',language)]] :</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column-group>
                                <vaadin-grid-column class="recipient-col">
                                    <template class="footer">[[_formatAmount(totalPendingInvoices.totalReimbursement)]]€</template>
                                </vaadin-grid-column>
                                <vaadin-grid-column class="recipient-col">
                                    <template class="footer">[[_formatAmount(totalPendingInvoices.totalPatientIntervention)]]€</template>
                                </vaadin-grid-column>
                                <vaadin-grid-column class="recipient-col">
                                    <template class="footer">[[_formatAmount(totalPendingInvoices.totalDoctorSupplement)]]€</template>
                                </vaadin-grid-column>
                                <vaadin-grid-column class="recipient-col border-right">
                                    <template class="footer">[[_formatAmount(totalPendingInvoices.totalAmount)]]€</template>
                                </vaadin-grid-column>
                            </vaadin-grid-column-group>
                            <vaadin-grid-column class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                </div>
                <paper-button on-tap="receiveInvoices" class="modal-button">Recevoir</paper-button>
                <paper-button on-tap="sendInvoices" class="modal-button">Envoyer</paper-button>
            </template>

                <template is="dom-if" if="[[!statusPending]]">
                    <div class="gridContainer">
                        <!--<paper-input id="filter" label="[[localize('fil','Filter',language)]]" value="{{filterInputInvoices}}" on-keyup="refreshFilter" param="messagesGrid"></paper-input>-->
                        <div class="invoiceContainer">
                            <div id="messagesGridContainer" class="invoiceSubContainerMiddle">
                                <template is="dom-if" if="[[isProcess(invoicesStatus.*)]]">
                                    <div class="scrollBox">
                                        <vaadin-grid id="messagesGrid" class="processTable" items="[[messagesByStatus(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]" active-item="{{activeGridItem}}" on-tap="_showDetail">
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcp">Prestataire</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcp]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="oa-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.oa">OA</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.oa]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="ref-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcpReference">Réf. du médecin</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcpReference]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invoice-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceNumber">N° envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceNumber]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="month-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceMonth">Mois fact.</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceMonth]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invoiceDate-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceDate">Date d'envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceDate]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoicedAmount"> Montant facturé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.invoicedAmount)]]€</template>
                                                <template class="footer">[[_invoicedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="accAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant accepté</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.acceptedAmount)]]€</template>
                                                <template class="footer">[[_acceptedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="refAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Montant refusé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.refusedAmount)]]€</template>
                                                <template class="footer">[[_refusedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="stat-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Statut</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceStatus]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="payPaid-col">
                                                <template class="header"></template>
                                                <template>
                                                    <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogSupp"></iron-icon>
                                                </template>
                                            </vaadin-grid-column>
                                        </vaadin-grid>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[isArchOrAcc(invoicesStatus.*)]]">
                                    <div class="scrollBox">
                                        <vaadin-grid id="messagesGrid" class="archiveAndAccepted" items="[[messagesByStatus(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]" active-item="{{activeGridItem}}" on-tap="_showDetail">
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcp">Prestataire</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcp]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="oa-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.oa">OA</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.oa]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="ref-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcpReference">Réf. du médecin</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcpReference]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invoice-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceNumber">N° envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceNumber]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="month-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceMonth">Mois fact.</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceMonth]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invoiceDate-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceDate">Date d'envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceDate]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoicedAmount"> Montant facturé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.invoicedAmount)]]€</template>
                                                <template class="footer">[[_invoicedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="accAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant accepté</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.acceptedAmount)]]€</template>
                                                <template class="footer">[[_acceptedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="refAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Montant refusé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.refusedAmount)]]€</template>
                                                <template class="footer">[[_refusedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="stat-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Statut</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceStatus]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="payPaid-col">
                                                <template class="header"></template>
                                                <template>
                                                    <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogSupp"></iron-icon>
                                                </template>
                                            </vaadin-grid-column>
                                        </vaadin-grid>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[isArchOrAcc(invoicesStatus.*)]]">
                                    <vaadin-grid id="messagesGrid" items="[[messagesByStatus(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]" active-item="{{activeGridItem}}" on-tap="_showDetail">
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.hcp">Prestataire</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.hcp]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="oa-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.oa">OA</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.oa]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="ref-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.hcpReference">Réf. du médecin</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.hcpReference]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="invoice-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.invoiceNumber">N° envoi</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.invoiceNumber]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="month-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.invoiceMonth">Mois fact.</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.invoiceMonth]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="invoiceDate-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.invoiceDate">Date d'envoi</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.invoiceDate]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="invAmount-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.invoicedAmount"> Montant facturé</vaadin-grid-sorter>
                                            </template>
                                            <template>[[_formatAmount(item.messageInfo.invoicedAmount)]]€</template>
                                            <template class="footer">[[_invoicedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="accAmount-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant accepté</vaadin-grid-sorter>
                                            </template>
                                            <template>[[_formatAmount(item.messageInfo.acceptedAmount)]]€</template>
                                            <template class="footer">[[_acceptedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="refAmount-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.refusedAmount">Montant refusé</vaadin-grid-sorter>
                                            </template>
                                            <template>[[_formatAmount(item.messageInfo.refusedAmount)]]€</template>
                                            <template class="footer">[[_refusedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="stat-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.refusedAmount">Statut</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.invoiceStatus]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="reject-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.rejectionReason">Motif rejet</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.rejectionReason]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="ref-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.hcpReference">Réf. du médecin</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.hcpReference]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="invoice-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.invoiceNumber">N° envoi</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.invoiceNumber]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="month-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.invoiceMonth">Mois fact.</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.invoiceMonth]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="invoiceDate-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.invoiceDate">Date d'envoi</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.invoiceDate]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="invAmount-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.invoicedAmount"> Montant facturé</vaadin-grid-sorter>
                                            </template>
                                            <template>[[_formatAmount(item.messageInfo.invoicedAmount)]]€</template>
                                            <template class="footer">[[_invoicedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="accAmount-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant accepté</vaadin-grid-sorter>
                                            </template>
                                            <template>[[_formatAmount(item.messageInfo.acceptedAmount)]]€</template>
                                            <template class="footer">[[_acceptedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="refAmount-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.refusedAmount">Montant refusé</vaadin-grid-sorter>
                                            </template>
                                            <template>[[_formatAmount(item.messageInfo.refusedAmount)]]€</template>
                                            <template class="footer">[[_refusedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="stat-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.refusedAmount">Statut</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.invoiceStatus]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="reject-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="messageInfo.rejectionReason">Motif rejet</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.messageInfo.rejectionReason]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column-group class="hasBorder">
                                            <template class="header hasBorder">Informations de paiement</template>
                                            <vaadin-grid-column class="payRef-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.paymentReference">Réf</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.paymentReference]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="payDate-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.paymentDate">Date</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.paymentDate]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="payTot-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.amountPaid">Montant</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.amountPaid]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="payBank-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.paymentAccount">Compte bancaire</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.paymentAccount]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="payPaid-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.paidAmount">Payé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.paidAmount]]</template>
                                            </vaadin-grid-column>
                                        </vaadin-grid-column-group>
                                        <vaadin-grid-column class="payPaid-col">
                                            <template class="header"></template>
                                            <template>
                                                <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogSupp"></iron-icon>
                                            </template>
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                </template>
                                <template is="dom-if" if="[[isReject(invoicesStatus.*)]]">
                                    <div class="scrollBox">
                                        <vaadin-grid id="messagesGrid" class="rejectedTable" items="[[messagesByStatus(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]" active-item="{{activeGridItem}}" on-tap="_showDetail">
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcp">Prestataire</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcp]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="oa-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.oa">OA</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.oa]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="ref-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcpReference">Réf. du médecin</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcpReference]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invoice-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceNumber">N° envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceNumber]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="month-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceMonth">Mois fact.</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceMonth]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invoiceDate-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceDate">Date d'envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceDate]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="invAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoicedAmount"> Montant facturé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.invoicedAmount)]]€</template>
                                                <template class="footer">[[_invoicedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="accAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant accepté</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.acceptedAmount)]]€</template>
                                                <template class="footer">[[_acceptedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="refAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Montant refusé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.messageInfo.refusedAmount)]]€</template>
                                                <template class="footer">[[_refusedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="stat-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Statut</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceStatus]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="reject-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.rejectionReason">Motif rejet</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.rejectionReason]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="payPaid-col">
                                                <template class="header"></template>
                                                <template>
                                                    <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogSupp"></iron-icon>
                                                </template>
                                            </vaadin-grid-column>
                                        </vaadin-grid>
                                    </div>
                                </template>
                            </div>
                            <template is="dom-if" if="[[ifInvoiceSelected]]">
                                <h4 class="mb0">Détail des envois selectionnés</h4>
                                <paper-input id="filter" label="[[localize('fil','Filter',language)]]" value="{{selectedInputDetail}}" on-keyup="refreshFilter" param="selectedInputDetail" where="invoiceSelected"></paper-input>
                                <div id="invoiceDetailContainer" class="invoiceDetailContainer">
                                    <vaadin-grid id="invoiceGridDetail" items="[[invoicesFromBatch]]" active-item="{{activeDetailGridItem}}" on-tap="">
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="invoiceReference">N° fact.</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.invoiceReference]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="patient">Patient</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.patient]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="ssin">Niss</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.ssin]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="invoicingCode">Nmcl</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.invoicingCode]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="invoiceDate">Date presta.</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.invoiceDate]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column-group>
                                            <template class="header hasBorder">Montant</template>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="invoicedAmount">Facturé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.invoicedAmount)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="acceptedAmount">Accepté</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.acceptedAmount)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="refusedAmount">Refusé</vaadin-grid-sorter>
                                                </template>
                                                <template>[[_formatAmount(item.refusedAmount)]]€</template>
                                            </vaadin-grid-column>
                                        </vaadin-grid-column-group>
                                        <vaadin-grid-column class="rejectionReason-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="rejectionReason">Motif de rejet</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.rejectionReason]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="paid">Payé</vaadin-grid-sorter>
                                            </template>
                                            <template>[[_formatAmount(item.paid)]]€</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="status">Statut</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.status]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column class="recipient-col">
                                            <template class="header">Info helpdesk</template>
                                            <template>
                                                <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogDet"></iron-icon>
                                            </template>
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

            </div>

            <paper-dialog id="pendingDetailDialog">
                <div>
                    Details of invoice n° [[activeGridItem.invoice.invoiceReference]]
                    <paper-input label="Patient" value="[[activeGridItem.patient.firstName]] [[activeGridItem.patient.lastName]]"readonly></paper-input>
                    <paper-input label="Mutuelle" value="[[activeGridItem.insurance.code]]"readonly></paper-input>
                </div>
                    <vaadin-grid id="pendingGridDetail" items="[[activeGridItem.invoice.invoicingCodes]]">
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">Date</template>
                            <template>[[returnDate(item.dateCode)]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">Code</template>
                            <template>[[item.code]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">Libellé</template>
                            <template>[[item.label]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">PR</template>
                            <template>[[item.relatedCode]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">Tp</template>
                            <template>[[item.insuranceJustification]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">N° engagement</template>
                            <template>[[item.contract]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column-group class="hasBorder">
                            <template class="header">Montants</template>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">OA</template>
                                <template>[[item.reimbursement]]</template>
                                <template class="footer">0.00€</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">Patient</template>
                                <template>[[item.patientIntervention]]</template>
                                <template class="footer">0.00€</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">Supplément</template>
                                <template>[[item.doctorSupplement]]</template>
                                <template class="footer">0.00€</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">Total</template>
                                <template>[[item.totalAmount]]</template>
                                <template class="footer">0.00€</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                    </vaadin-grid>
            </paper-dialog>
        </div>

        <paper-dialog id="helpdeskInfoDialog">
            <paper-input class="flex-container-nmcl-row" label="OA" value="[[infoHelpdesk.messageInfo.oa]]" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="Inami tiers facturant" value="[[hcp.nihii]]" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="N° envoi" value="[[infoHelpdesk.messageInfo.invoiceNumber]]" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="Mois et année de facturation" value="[[infoHelpdesk.messageInfo.invoiceMonth]]" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="Date d'envoi du fichier" value="[[_dateFormat(infoHelpdesk.message.sent)]]" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="Date dernière réponse OA" value="" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="Type dernière réponse OA" value="" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="Montant facturé" value="[[infoHelpdesk.messageInfo.invoicedAmount]]" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="Nom du soft" value="TOPAZ" class="" readOnly></paper-input>
            <paper-input class="flex-container-nmcl-row" label="N° de tél de contact médecin" value="[[mobile]]" class="" readOnly></paper-input>
            <template is="dom-if" if="[[isCompleteHelpDesk]]">
                <paper-input class="flex-container-nmcl-row" label="Patient" value="[[infoHelpdeskDet.patient]]" class="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row" label="Niss" value="[[infoHelpdeskDet.ssin]]" class="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row" label="Prestation" value="[[infoHelpdeskDet.invoiceDate]]" class="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row" label="Date de la prestation" value="[[_dateFormat(infoHelpdeskDet.invoiceDate)]]" class="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row" label="Montant facturé" value="[[infoHelpdeskDet.invoicedAmount]]" class="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row" label="Montant accepté" value="[[infoHelpdeskDet.acceptedAmount]]" class="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row" label="Montant refusé" value="[[infoHelpdeskDet.refusedAmount]]" class="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row" label="Motif(s) de rejet" value="[[infoHelpdeskDet.rejectionReason]]" class="" readOnly></paper-input>
            </template>
        </paper-dialog>
    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models'

        class HtMsgInvoice extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-invoice';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    hcp: {
                        type : Object
                    },
                    selectedMessages: {
                        type: Object,
                        notify: true
                    },
                    activeItem: {
                        type: Object
                    },
                    messages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectList: {
                        type: Object
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        }
                    },
                    totalPendingInvoices:{
                        type: Object,
                        value : () => ({
                            totalReimbursement:          Number(0.00).toFixed(2),
                            totalAmount:                 Number(0.00).toFixed(2),
                            totalPatientIntervention:    Number(0.00).toFixed(2),
                            totalDoctorSupplement:       Number(0.00).toFixed(2)
                        })
                    },
                    invoicesStatus: {
                        type: String,
                        observer: '_invoicesStatusChanged'
                    },
                    statusPending:{
                        type: Boolean,
                        value: true
                    },
                    selectedPendingInvoices:{
                        type: Object,
                        value : () => ({})
                    },
                    selectedInvoicesByStatus:{
                        type: Object,
                        value : () => ({})
                    },
                    multiSort:{
                        type: Boolean,
                        value: true
                    },
                    activeGridItem:{
                        type: Object,
                        value: function () {
                            return [];
                        }
                    },
                    filterValue:{
                        type: String,
                        value: ""
                    },
                    filterPath:{
                        type:String,
                        value: "invoice.patient.firstName"
                    },
                    btnSelectionPatient: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    showInactive: {
                        type: Boolean,
                        value: false
                    },
                    ifInvoiceSelected: {
                        type: Boolean,
                        value: true
                    },
                    level :{
                        type : Number,
                        value : 0
                    },
                    expanded : {
                        type : Boolean,
                        value : true
                    },
                    invoicesFromBatch:{
                        type: Object,
                        value: function () {
                            return [];
                        }
                    },
                    infoHelpdesk:{
                        type : Object
                    },
                    isCompleteHelpDesk:{
                        type: Boolean
                    },
                    infoHelpdeskDet:{
                        type: Object
                    },
                    mobile :{
                        type: String
                    },
                    displayedYear: {
                        type: Number,
                        value: () => Number(moment().format('YYYY'))
                    },
                    processing:{
                        type: Boolean,
                        value: false
                    },
                    archOrAcc:{
                        type: Boolean,
                        value:false
                    }
                };
            }

            constructor() {
                super();
            }

            static get observers() {
                return ['_invoicesChange(invoices.*)'];
            }

            ready() {
                super.ready();
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(response =>{
                    this.set("hcp",response)
                    this.getMessage()
                })
            }

            fetchPendingMessages(){

                this.api.invoice().listToInsurancesUnsent(this.user.id)
                    .then(invoices => Promise.all(invoices.filter(i => i.printedDate && i.sentMediumType === "efact").map(inv => this.api.crypto().extractCryptedFKs(inv, this.user.healthcarePartyId).then(ids => [inv, ids[0]]))))
                    .then(invAndIdsPat =>
                        this.api.patient().getPatients(new models.ListOfIdsDto({ids: _.uniq(invAndIdsPat.map(x => x[1]))})).then(pats => invAndIdsPat.map(it => [it[0], pats.find(p => p.id === it[1])]))
                    ).then(invAndPats =>
                        this.api.insurance().getInsurances(new models.ListOfIdsDto({ids : _.uniq(_.flatten(invAndPats).filter(i => i.insurabilities).map(i => i.insurabilities[0].insuranceId))})).then(ins => invAndPats.map(it => [it[0], it[1], ins.find(i => i.id === it[1].insurabilities[0].insuranceId)]))
                    ).then(invAndPatsAndInsurances => _.flatMap(invAndPatsAndInsurances, ([inv, pat, ins]) => {
                        return ({
                            patient: pat.lastName+" "+pat.firstName,
                            invoiceId: inv.id,
                            sentMediumType: inv.sentMediumType,
                            insuranceCode: ins.code,
                            invoiceReference: inv.invoiceReference,
                            patientSsin: pat.ssin,
                            invoiceDate: inv.invoiceDate,
                            reimbursement: inv.invoicingCodes ? inv.invoicingCodes.reduce((tot, m) => tot + Number(m.reimbursement), 0).toFixed(2) : 0.00,
                            patientIntervention: inv.invoicingCodes ? inv.invoicingCodes.reduce((tot, m) => tot + Number(m.patientIntervention), 0).toFixed(2) : 0.00,
                            totalAmount: inv.invoicingCodes ? inv.invoicingCodes.reduce((tot, m) => tot + Number(m.totalAmount), 0).toFixed(2) : 0.00 ,
                            doctorSupplement: inv.invoicingCodes ? inv.invoicingCodes.reduce((tot, m) => tot + Number(m.doctorSupplement), 0).toFixed(2) : 0.00,
                            statut : "Pending",
                            hasChildren : false,
                            uuid : inv.id,
                            parentUuid : ins.code.charAt(0)
                    })
                }))
                .then(invoiceStruct => {
                    this.set('selectedPendingInvoices', invoiceStruct)
                    this.set("totalPendingInvoices.totalPatientIntervention",this.selectedPendingInvoices ? this.selectedPendingInvoices.reduce((tot, m) => tot + Number(m.patientIntervention), 0).toFixed(2) : 0.00)
                    this.set("totalPendingInvoices.totalDoctorSupplement",this.selectedPendingInvoices ? this.selectedPendingInvoices.reduce((tot, m) => tot + Number(m.doctorSupplement), 0).toFixed(2) : 0.00)
                    this.set("totalPendingInvoices.totalReimbursement",this.selectedPendingInvoices ? this.selectedPendingInvoices.reduce((tot, m) => tot + Number(m.reimbursement), 0).toFixed(2) : 0.00)
                    this.set("totalPendingInvoices.totalAmount",this.selectedPendingInvoices ? this.selectedPendingInvoices.reduce((tot, m) => tot + Number(m.totalAmount), 0).toFixed(2) : 0.00)
                    this._toggleDataProvider(this.selectedPendingInvoices)
                })


            }

            dispatchMessages() {
                this.set("messagesProcessed", this.allMessages.filter(m => (m.message.status & (1 << 15 | 1 << 16 | 1 << 17)) === 0))
                this.set("messagesAccepted", this.allMessages.filter( m => (m.message.status & (1 << 15 | 1 << 16 )) !== 0))
                this.set("messagesRejected", this.allMessages.filter( m => (m.message.status & (1 << 17)) !== 0))

                this.initializeBatchCounter(this.allMessages.filter(m => (m.message.status & (1 << 15 | 1 << 16 | 1 << 17)) === 0).length, this.allMessages.filter( m => (m.message.status & (1 << 15 | 1 << 16 )) !== 0).length, this.allMessages.filter( m => (m.message.status & (1 << 17)) !== 0).length)
            }

            fetchMessages() {
                this.api.message().findMessagesByTransportGuid("EFACT:BATCH:*")
                    .then(messages => {
                        const filteredMessages = messages.rows.filter(msg => msg.transportGuid && msg.responsible === this.hcp.id && msg.transportGuid.startsWith("EFACT:BATCH:" + this.displayedYear))
                        this.api.insurance().getInsurances(new models.ListOfIdsDto({ids: _.uniq(filteredMessages.map(m => m.recipients[0]))})).then(insurances => {
                            this.set('allMessages', filteredMessages.map(m => ({
                                message: m,
                                messageInfo: {
                                    messageType: m.subject,
                                    hcp: this.hcp.firstName + " " + this.hcp.lastName,
                                    oa: insurances.find(i => i.id === m.recipients[0]).code,
                                    hcpReference: "",
                                    invoiceNumber: m.externalRef,
                                    invoiceMonth: "",
                                    invoiceDate: "",
                                    invoicedAmount: "0",
                                    acceptedAmount: "0",
                                    refusedAmount: "0",
                                    invoiceStatus: "",
                                    rejectionReason: "",
                                    paymentReference: "",
                                    paymentDate: "",
                                    amountPaid: "0",
                                    paymentAccount: "",
                                    paidAmount: "0"
                                }
                            })))

                            Promise.all(this.allMessages.map(mm =>
                                this.api.document().findByMessage(this.user.healthcarePartyId, mm.message)
                                    .then(docs => {
                                        const jsonDoc = docs.find(d => d.mainUti === "public.json" && _.endsWith(d.name, '_records'))

                                        return jsonDoc ? this.api.document().getAttachment(jsonDoc.id, jsonDoc.attachmentId, jsonDoc.secretForeignKeys).then(a => {
                                            const zone200 = a.find(enr => enr.zones.find(z => z.zone == "200"))
                                            const zone300 = a.find(enr => enr.zones.find(z => z.zone == "300"))
                                            const zone400 = a.find(enr => enr.zones.find(z => z.zone == "400"))
                                            const zone500 = a.find(enr => enr.zones.find(z => z.zone == "500"))
                                            const enr10 = a.find(enr => enr.zones.find(z => z.zone == "1" && z.value == "10"))


                                            // STATUS_SUBMITTED 				= 1 << 8; envoyé
                                            // STATUS_RECEIVED 				    = 1 << 9; ta ck reçu
                                            // STATUS_ACCEPTED_FOR_TREATMENT 	= 1 << 10; 93100
                                            // STATUS_ACCEPTED 				    = 1 << 11; 92098 / 920900
                                            // STATUS_REJECTED 				    = 1 << 12; 920999 / 920909

                                            // STATUS_TACK 					    = 1 << 13;
                                            // STATUS_MASKED 					= 1 << 14;

                                            // STATUS_SUCCESS 					= 1 << 15;
                                            // STATUS_WARNING 					= 1 << 16; Partiellement accepte
                                            // STATUS_ERROR 					= 1 << 17;

                                            let invoiceStatus
                                            let rejectionReason
                                            if (zone200 && zone300) {
                                                const invoiceType = zone200.zones.find(z => z.zone === "200") ? zone200.zones.find(z => z.zone === "200").value : ""

                                                switch (invoiceType) {
                                                    case "920999" :
                                                        invoiceStatus = "Rejected";
                                                        rejectionReason = "Blocking error";
                                                        break
                                                    case '920099' :
                                                        invoiceStatus = "Rejected";
                                                        invoiceStatus = "More than 5% error";
                                                        break
                                                    case '931000' :
                                                        invoiceStatus = "Pending";
                                                        invoiceStatus = "Acknowledgment of receipt";
                                                        break
                                                    case '920098' :
                                                        invoiceStatus = "Accepted";
                                                        rejectionReason = "";
                                                        break
                                                    case '920900' :
                                                        invoiceStatus = "Accepted";
                                                        rejectionReason = "";
                                                        break
                                                    default :
                                                        invoiceStatus = ""
                                                        break
                                                }
                                            }

                                            return (zone200 && zone300) ?
                                                ({
                                                    message: mm.message,
                                                    messageInfo: {
                                                        messageType: zone200.zones.find(z => z.zone === "200") ? zone200.zones.find(z => z.zone === "200").value : "",
                                                        hcp: this.hcp.firstName + " " + this.hcp.lastName,
                                                        oa: zone500.zones.find(z => z.zone === "501") ? (zone500.zones.find(z => z.zone === "501").value).charAt(0) + "00" : "",
                                                        hcpReference: enr10.zones.find(z => z.zone === "28") ? enr10.zones.find(z => z.zone === "28").value : "",
                                                        invoiceNumber: zone300.zones.find(z => z.zone === "301") ? zone300.zones.find(z => z.zone === "301").value : "",
                                                        invoiceMonth: zone300.zones.find(z => z.zone === "300") ? zone300.zones.find(z => z.zone === "300").value : "",
                                                        invoiceDate: zone300.zones.find(z => z.zone === "302") ? zone300.zones.find(z => z.zone === "302").value : "",
                                                        invoicedAmount: zone500.zones.find(z => z.zone === "508") ? (Number(zone500.zones.find(z => z.zone === "508").value) / 100).toFixed(2) : "0.00",
                                                        acceptedAmount: zone500.zones.find(z => z.zone === "520") ? (Number(zone500.zones.find(z => z.zone === "520").value) / 100).toFixed(2) : "0.00",
                                                        refusedAmount: zone500.zones.find(z => z.zone === "522") ? (Number(zone500.zones.find(z => z.zone === "522").value) / 100).toFixed(2) : "0.00",
                                                        invoiceStatus: invoiceStatus,
                                                        rejectionReason: rejectionReason,
                                                        paymentReference: zone400.zones.find(z => z.zone === "423") ? zone400.zones.find(z => z.zone === "423").value : "",
                                                        paymentDate: "",
                                                        amountPaid: "0.00",
                                                        paymentAccount: enr10.zones.find(z => z.zone === "36") ? enr10.zones.find(z => z.zone === "36").value : "",
                                                        paidAmount: ""
                                                    }
                                                }) : mm
                                        }) : mm
                                    }))).then(msgsStructs => {
                                this.set('allMessages', msgsStructs)
                                this.dispatchMessages()
                            })

                        })
                    })
            }


            getMessage(){
                this.fetchPendingMessages()
                this.fetchMessages()
            }



            _toggleDataProvider(input) {
                let inputList = input
                let mutGroups = []
                inputList.map(patient => {
                    const thisMutGrp = // set this pat insurance code grp
                        (patient.insuranceCode < 200) ? "100" :
                        (patient.insuranceCode < 300) ? "200" :
                        (patient.insuranceCode < 400) ? "300" :
                        (patient.insuranceCode < 500) ? "400" :
                        (patient.insuranceCode < 600) ? "500" :
                        (patient.insuranceCode < 700) ? "600" :
                        "900"
                    let grpExists = false
                    mutGroups.map(grp=> { if (grp.code === thisMutGrp) { // check if grp exists
                        grpExists = true
                    }})
                    if (!grpExists) { mutGroups.push({ // else create object
                        code: thisMutGrp,pat: [],sum:{oa:0,pat:0,sup:0,tot:0}
                    })}
                    mutGroups.map(grp=>{ if (grp.code === thisMutGrp) { // get into this grp
                        (grp.pat).push(patient) // add the patient
                    }})
                }) // inputList map end

                mutGroups.sort((a, b)=>{return a.code-b.code})
                this.set('toggledDatas', mutGroups ) // this.set end
                for (let grp of mutGroups) {
                    console.log("grp",grp)
                    let totPat = 0
                    for (let pat of grp.pat){
                        console.log(">pat",pat)
                        grp.sum.oa += Number(pat.reimbursement)
                        grp.sum.pat += Number(pat.patientIntervention)
                        grp.sum.sup += Number(pat.doctorSupplement)
                        grp.sum.tot += Number(pat.totalAmount)
                        totPat++
                    }
                    // const totEntr = this.localize('entr','Entries',language)
                    // const totWord = this.localize('tot','Total',language)
                    // grp.code = `${grp.code} (${totPat} ${totEntr}), OA : ${grp.sum.oa}€ - Patient : ${grp.sum.pat}€ - Sup : ${grp.sum.sup}€ - ${totWord} : ${grp.sum.tot}€`
                }
            } // provider end

            calculateTotalPendingInvoices(){

                let total = {
                    totalReimbursement :          Number(0.00),
                    totalAmount :                 Number(0.00),
                    totalPatientIntervention :    Number(0.00),
                    totalDoctorSupplement :       Number(0.00),
                }

                this.selectedPendingInvoices.map(invoice => {
                    total.totalReimbursement          += Number(invoice.totalInvoice.reimbursement)
                    total.totalAmount                 += Number(invoice.totalInvoice.totalAmount)
                    total.totalPatientIntervention    += Number(invoice.totalInvoice.patientIntervention)
                    total.totalDoctorSupplement       += Number(invoice.totalInvoice.doctorSupplement)
                })

                this.set('totalPendingInvoices', total)

            }

            _invoicesStatusChanged(){
                this.invoicesStatus === "pending" ? this.set('statusPending', true) : this.set('statusPending', false)
                this.set('processing',this.isProcess())
                this.set('archOrAcc',!(this.isProcess()||this.isReject()))
            }

            messagesByStatus() {
                return this.invoicesStatus === "process" ? this.messagesProcessed :
                    this.invoicesStatus === "accept" ? this.messagesAccepted :
                        this.invoicesStatus === "reject" ? this.messagesRejected : []
            }

            _invoicedAmount() {
                return this.messagesByStatus() ? this._formatAmount( (this.messagesByStatus().reduce((tot, m) => tot + Number(m.messageInfo.invoicedAmount), 0).toFixed(2) ) ) :0
            }

            _acceptedAmount() {
                return this.messagesByStatus() ? this._formatAmount( (this.messagesByStatus().reduce((tot, m) => tot + Number(m.messageInfo.acceptedAmount), 0).toFixed(2) ) ): 0
            }

            _refusedAmount() {
                return this.messagesByStatus() ? this._formatAmount( (this.messagesByStatus().reduce((tot, m) => tot + Number(m.messageInfo.refusedAmount), 0).toFixed(2) ) ) : 0
            }

            _displayInvoiceStatus(status){

               return this.localize(status, this.language)

                //this.shadowRoot.getElementById("batchStatus").classList.add("")
            }

            returnDate(dateAsLong){
                return dateAsLong ? ("" + dateAsLong).replace(/([0-9]{4})([0-9]{2})([0-9]{2})/, '$3/$2/$1') : 'N/A'
            }

            _formatAmount(amount){
                return this.findAndReplace(((Number(amount).toFixed(2)).toString()),'.',',')
            }

            findAndReplace(string, target, replacement) {
                for (let i = 0; i < string.length; i++) { string = string.replace(target, replacement); }
                return string;
            }

            refreshFilter(e){
                const param = e.target.getAttribute('param')
                console.log("refresh, param",param)
                const where = this.invoicesStatus // pending, process, reject, accept, archive
                const str =
                    (param == "invoiceGrid") ? this.filterInput:
                    (param == "messagesGrid") ? this.filterInputInvoices :
                    this.selectedInputDetail
                setTimeout(function () {
                    let arrList =
                        (param == "invoiceGrid") ? this.shadowRoot.querySelectorAll("."+param) :
                        (param == "selectedInputDetail") ? this.shadowRoot.querySelectorAll("#invoiceDetailContainer #invoiceGridDetail") :
                        this.shadowRoot.querySelectorAll(".scrollBox")
                    console.log("arrList a",param,arrList)
                    if (param == "messagesGrid") {
                        let temp
                        const selected =
                            (where == "process") ? "processTable" :
                            (where == "reject") ? "rejectedTable" :
                            "archiveAndAccepted"
                        Array.prototype.slice.call(arrList).map(list=> {
                            console.log("list", list)
                            if (list.querySelector("."+selected) ) {
                                temp = list.querySelectorAll("."+selected)
                            }
                        })
                        arrList = temp
                    }
                    console.log("arrList b",param,arrList)
                    Array.prototype.slice.call(arrList).map(table=>{
                        console.log("before exec",str,table)
                        this.executeSearch(str,table)
                    })
                }.bind(this), 500)
            }

            executeSearch(str,param) {
                console.log("exec",str,param)
                const grid = param
                const tbody = grid.shadowRoot.querySelector("#scroller #table tbody")
                const trs = tbody.querySelectorAll("tr")
                console.log("tbody trs",tbody,trs)
                let input = (str.includes(":") ) ? this.treatQuery(str) : str
                input = (this.checkFilters(input)).toString().toLowerCase()
                if (trs.length){
                    let keepList = []
                    Array.prototype.slice.call(trs).map(row=>{
                        let cells = row.querySelectorAll("td"), toHide = true
                        cells.forEach(that=>{
                            const test = (that._content.innerText).toString().toLowerCase()
                            if (test.includes(input)) {
                                toHide = false
                            }
                        })
                        if (toHide) {
                            row.hidden = true
                        } else {
                            keepList.push(row)
                            row.hidden = false
                        }
                    })
                    let showCount = 0
                    keepList.map(showMe=>{
                        showMe.style.transform = "translateY("+ (showCount*48) +"px)"
                        showMe.style.height = "48px"
                        showMe.style.lineHeight = "24px"
                        showCount++
                    })
                } // endif
            }

            checkFilters(str) { // will (set the path type for vaadin filter and) format search output
                let searchType = "invoice.patient.firstName"
                let output = str
                if (str.length) {
                    if (!isNaN(str)) { // is a number
                        searchType =
                            (str.toString().length == 11) ? "patient.ssin" : // NISS (length must be 11)
                            (str.length == 8) ? "invoice.invoiceReference" : // bill number
                            (str >= 1930 && str <= (new Date().getFullYear() + 100)) ? "invoice.invoiceDate" : // year (from 1930 to now +100yr)
                            ((typeof str == "float") || str.includes(".")) ? "invoice.totalAmount" : // float amount
                            (str.length == 3 && (100 <= str && str <= 999) ) ? "patient.insurance.code" : // Insurance code
                            "invoice.invoiceReference"
                        // format output ->
                        if (searchType == "patient.ssin") { output = this.findAndReplace(output,'.',''); }
                        if (searchType == "invoice.totalAmount") { output = this.findAndReplace(output.toString(),'.',',') }
                    } else { // is a string
                        searchType =
                            (/(^([0-2][0-9]|(3)[0-1])[.\- /](((0)[0-9])|((1)[0-2]))[.\- /]\d{4}$)/.test(str) || /(^([0-2][0-9]|(3)[0-1])[.\- /](((0)[0-9])|((1)[0-2]))[.\- /]\d{2}$)/.test(str) ) ? "invoice.invoiceDate" :
                            (/(^[0-9]{2}[.\- /]{0,1}[0-9]{2}[.\- /]{0,1}[0-9]{2}[.\- /]{0,1}[0-9]{3}[.\- /]{0,1}[0-9]{2}$)/.test(str)) ? "patient.ssin" :
                            (str.includes(" ") ) ? "invoice.patient.firstName" :
                            (str.includes("€") || str.includes(".") || str.includes(",")) ? "invoice.totalAmount" :
                            "invoice.patient.firstName"
                        // format output ->
                        if (searchType == "invoice.totalAmount") { output = this.findAndReplace(output,'€',''); output = this.findAndReplace(output,'.',','); }
                        if (searchType == "patient.ssin") { output = this.findAndReplace(output,' ',''); output = this.findAndReplace(output,'-',''); output = this.findAndReplace(output,'/',''); output = this.findAndReplace(output,'.',''); }
                        if (searchType == "invoice.invoiceDate") { output = this.fourNumYears(output) }
                    }
                }
                return output
            }
            fourNumYears(input) {
                const aa = input.slice(0,2),bb = input.slice(3,5)
                let cccc = input.slice(6,11)
                cccc = (cccc.toString().length == 2) ? cccc = "20"+cccc : cccc
                return `${aa}/${bb}/${cccc}`
            }
            treatQuery(query) { // mainly used for numbers
                let search = (query.substr(query.indexOf(':')+1, query.length) ).toString()
                search =(search.includes(':')) ? this.findAndReplace(search,':',' ') : search
                return search
            }

            _invoicesChange(){
                this.calculateTotalPendingInvoices()
            }

            sendInvoices(){
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp=> {
                    let prom = Promise.resolve()
                    _.chain(this.selectedPendingInvoices)
                        .groupBy(fact => fact.insurance.parent)
                        .toPairs().value()
                        .forEach(([fedId,invoices]) => {
                            prom = prom.then(() => this.api.message().sendBatch(this.user, hcp, fedId, invoices.map(iv=>({invoiceDto:iv.invoice, patientDto:iv.patient})), this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, this.api.fhc().Efactcontroller(), this.api.document()))
                        })
                })
                this.getPendingInvoices()
            }

            _showPendingDetail(){
                this.$.pendingDetailDialog.open()
            }

            _unlockInvoice(e){
                e.stopPropagation()

                if(e.target.dataset.item){
                    const invoice = JSON.parse(e.target.dataset.item)
                    delete(invoice.printedDate)

                    this.api.invoice().modifyInvoice(invoice).then(() => this.getMessage())
                }
            }

            SEG_getErrSegment_200(zones){
                var erreur = '';

                //Erreur sur le nom du message
                if(zones.find(z => z.zone === "2001") != '00'){
                    if(zones.find(z => z.zone === "2001") == '10'){
                        erreur += 'Nom du message => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2001") == '11'){
                        erreur += 'Nom du message => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "2001") == '20'){
                        erreur += 'Nom du message => Codification inconnue<br>';
                    }else if(zones.find(z => z.zone === "2001") == '21'){
                        erreur += 'Nom du message => Message non autorisé pour cet émetteur<br>';
                    }else if(zones.find(z => z.zone === "2001") == '22'){
                        erreur += 'Nom du message => # de 920000<br>';
                    }
                }

                //Erreur sur le n° de version du message
                if(zones.find(z => z.zone === "2011") != '00'){
                    if(zones.find(z => z.zone === "2011") == '10'){
                        erreur += 'N° version mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2011") == '11'){
                        erreur += 'N° version mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2011") == '20'){
                        erreur += 'N° version mess => N° de version n\'est plus d\'application<br>';
                    }else if(zones.find(z => z.zone === "2011") == '21'){
                        erreur += 'N° version mess => N° de version pas encore d\'application<br>';
                    }else if(zones.find(z => z.zone === "2011") == '30'){
                        erreur += 'N° version mess => N° de version non autorisé pour ce flux<br>';
                    }
                }

                //Erreur sur le type de message
                if(zones.find(z => z.zone === "2021") != '00'){
                    if(zones.find(z => z.zone === "2021") == '10'){
                        erreur += 'Type de mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2021") == '11'){
                        erreur += 'Type de mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2021") == '20'){
                        erreur += 'Type de mess => Valeur non permise<br>';
                    }else if(zones.find(z => z.zone === "2021") == '30'){
                        erreur += 'Type de mess => Message test dans un buffer de production (1er car zone 107 = P)<br>';
                    }else if(zones.find(z => z.zone === "2021") == '31'){
                        erreur += 'Type de mess => Message de production dans un buffer de test (1er car zone 107 = T)<br>';
                    }
                }

                //Erreur sur le statut du message
                if(zones.find(z => z.zone === "2031") != '00'){
                    if(zones.find(z => z.zone === "2031") == '10'){
                        erreur += 'Statut mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2031") == '20'){
                        erreur += 'Statut mess => Valeur non permise<br>';
                    }
                }

                //Erreur sur la référence message institution ou prestataire de soins
                if(zones.find(z => z.zone === "2041") != '00'){
                    if(zones.find(z => z.zone === "2041") == '10'){
                        erreur += 'Réf mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2041") == '11'){
                        erreur += 'Réf mess => Erreur format<br>';
                    }
                }

                //Erreur sur la référence message O.A
                if(zones.find(z => z.zone === "2051") != '00'){
                    if(zones.find(z => z.zone === "2051") == '10'){
                        erreur += 'Réf mess OA => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2051") == '11'){
                        erreur += 'Réf mess OA => Erreur format<br>';
                    }
                }

                return erreur;
            }

            SEG_getErrSegment_300(zones){
                var erreur = '';

                //Erreur sur l'année et le mois de facturation
                if(zones.find(z => z.zone === "3001") != '00'){
                    if(zones.find(z => z.zone === "3001") == '10'){
                        erreur += 'Année mois fact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3001") == '11'){
                        erreur += 'Année mois fact => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3001") == '20'){
                        erreur += 'Année mois fact => Valeur non permise<br>';
                    }
                }

                //Erreur sur le n° d'envoi
                if(zones.find(z => z.zone === "3011") != '00'){
                    if(zones.find(z => z.zone === "3011") == '10'){
                        erreur += 'N° envoi => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3011") == '11'){
                        erreur += 'N° envoi => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3011") == '40'){
                        erreur += 'N° envoi => Signalisation de double fichier de facturation transmis<br>';
                    }
                }

                //Erreur sur la date de création de la facture
                if(zones.find(z => z.zone === "3021") != '00'){
                    if(zones.find(z => z.zone === "3021") == '10'){
                        erreur += 'Date création facture => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3021") == '11'){
                        erreur += 'Date création facture => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3021") == '20'){
                        erreur += 'Date création facture => Date > date du jour<br>';
                    }else if(zones.find(z => z.zone === "3021") == '21'){
                        erreur += 'Date création facture => Date invraisemblable ( date < 01/01/2002)<br>';
                    }
                }


                //Erreur sur le n° de version des instruction
                if(zones.find(z => z.zone === "3041") != '00'){
                    if(zones.find(z => z.zone === "3041") == '10'){
                        erreur += 'N° version instruction => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3041") == '11'){
                        erreur += 'N° version instruction => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3041") == '20'){
                        erreur += 'N° version instruction => Valeur non permise<br>';
                    }else if(zones.find(z => z.zone === "3041") == '21'){
                        erreur += 'N° version instruction => Incompatibilité avec valeur reprise en zone 202<br>';
                    }
                }

                //Erreur sur le nom de la personne de contact
                if(zones.find(z => z.zone === "3051") != '00'){
                    if(zones.find(z => z.zone === "3051") == '10'){
                        erreur += 'Nom personne de contact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3051") == '11'){
                        erreur += 'Nom personne de contact => Erreur format<br>';
                    }
                }

                //Erreur sur le prenom de la personne de contact
                if(zones.find(z => z.zone === "3061") != '00'){
                    if(zones.find(z => z.zone === "3061") == '10'){
                        erreur += 'Prénom personne de contact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3061") == '11'){
                        erreur += 'Prénom personne de contact => Erreur format<br>';
                    }
                }

                //Erreru sur le n° de tel de contact
                if(zones.find(z => z.zone === "3071") != '00'){
                    if(zones.find(z => z.zone === "3071") == '10'){
                        erreur += 'N° téléphone => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3071") == '11'){
                        erreur += 'N° téléphone => Erreur format<br>';
                    }
                }

                //Erreur sur le type de la facture
                if(zones.find(z => z.zone === "3081") != '00'){
                    if(zones.find(z => z.zone === "3081") == '10'){
                        erreur += 'Type de la facture => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3081") == '11'){
                        erreur += 'Type de la facture => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3081") == '20'){
                        erreur += 'Type de la facture => Valeur non permise en fonction du secteur qui émet la facturation';
                    }
                }

                //Erreur sur le type de facturation
                if(zones.find(z => z.zone === "3091") != '00'){
                    if(zones.find(z => z.zone === "3091") == '10'){
                        erreur += 'Type de facturation => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3091") == '11'){
                        erreur += 'Type de facturation => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3091") == '20'){
                        erreur += 'Type de facturation => Valeur non permise en fonction du secteur qui émet la facturation';
                    }else if(zones.find(z => z.zone === "3091") == '30'){
                        erreur += 'Type de facturation => Valeur # de 1 ou 2 alors que la zone 308 = 3';
                    }
                }

                return erreur;

            }

            SEG_getErrSegment_400(zones){
                var erreur = '';

                //Erreur sur le type de record
                if(zones.find(z => z.zone === "4001") != '00'){
                    if(zones.find(z => z.zone === "4001") == '10'){
                        erreur +='Type de record => Zone obligatoire<br>';
                    }else if(zones.find(z => z.zone === "4001") == '11'){
                        erreur += 'Type de record => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4001") == '20'){
                        erreur += 'Type de record => Valeur non permise<br>';
                    }
                }

                //Erreur sur le num de mut
                if(zones.find(z => z.zone === "4011") != '00'){
                    if(zones.find(z => z.zone === "4011") == '10'){
                        erreur += 'N° de mutualité => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4011") == '11'){
                        erreur +='N° de mutualité => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4011") == '20'){
                        erreur +='N° de mutualité => Numéro inconnu ou codification erronée<br>';
                    }else if(zones.find(z => z.zone === "4011") == '21'){
                        erreur += 'N° de mutualité => N° de mutualité non retrouvé dans le détail de la facturation<br>';
                    }
                }

                //Erreur sur le num fact
                if(zones.find(z => z.zone === "4021") != '00'){
                    if(zones.find(z => z.zone === "4021") == '10'){
                        erreur +='N° de facture récapitulative => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4021") == '11'){
                        erreur += 'N° de facture récapitulative => Erreur de format<br>';
                    }
                }

                //Erreur sur le signe montant a ou montant demande a
                if(zones.find(z => z.zone === "4041") != '00'){
                    if(zones.find(z => z.zone === "4041") == '11'){
                        erreur += 'Montant demandé cpt a => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4041") == '40'){
                        erreur += 'Montant demandé cpt a => Erreur code signe (# de + ou -)<br>';
                    }else if(zones.find(z => z.zone === "4041") == '41'){
                        erreur +='Montant demandé cpt a => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "4041") == '20'){
                        erreur += 'Montant demandé cpt a => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant b ou montant demande b
                if(zones.find(z => z.zone === "4061") != '00'){
                    if(zones.find(z => z.zone === "4061") == '11'){
                        erreur += 'Montant demandé cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4061") == '15'){
                        erreur +='Montant demandé cpt b => Zone # de 0 si l\'émetteur n\est pas une institution hospitalière - Zone signe # de «blanc» et émetteur de la facturation # d’une institution hospitalière<br>';
                    }else if(zones.find(z => z.zone === "4061") == '40'){
                        erreur +='Montant demandé cpt b => Erreur code signe (# de + ou -)';
                    }else if(zones.find(z => z.zone === "4061") == '41'){
                        erreur +='Montant demandé cpt b => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "4061") == '20'){
                        erreur +='Montant demandé cpt b => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant a + b ou montant demande a + b
                if(zones.find(z => z.zone === "4081") != '00'){
                    if(zones.find(z => z.zone === "4081") == '11'){
                        erreur +='Total montant demandés cpt a + cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4081") == '20'){
                        erreur +='Total montant demandé cpt a + cpt b => Montant # somme des montants cpt a et cpt b<br>';
                    }else if(zones.find(z => z.zone === "4081") == '40'){
                        erreur +='Total montant demandé cpt a + cpt b => Erreur code signe (# de + ou -)<br>';
                    }
                }

                //Erreur sur le nb d'enreg
                if(zones.find(z => z.zone === "4091") != '00'){
                    if(zones.find(z => z.zone === "4091") == '10'){
                        erreur += 'Nb de records détail => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4091") == '11'){
                        erreur +='Nb de records détail => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4091") == '20'){
                        erreur += 'Nb de records détail => Somme erronée<br>';
                    }
                }

                //Erreur sur le num de controle par mutualite si 95 ou num de controle de l'envoi si 96
                if(zones.find(z => z.zone === "4101") != '00'){
                    if(segment.substr(0,2) == '95'){
                        if(zones.find(z => z.zone === "4101") == '10'){
                            erreur += 'N° de contrôle par mutualité => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "4101") == '11'){
                            erreur +='N° de contrôle par mutualité => Erreur de format<br>';
                        }
                    }else if(segment.substr(0,2) == '96'){
                        if(zones.find(z => z.zone === "4101") == '10'){
                            erreur += 'N° de contrôle de l\'envoi => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "4101") == '11'){
                            erreur +='N° de contrôle de l\'envoi => Erreur de format<br>';
                        }
                    }
                }

                return erreur;
            }

            SEG_getErrSegment_500(zones){
                var erreur = '';

                //Erreur sur le type de record
                if(zones.find(z => z.zone === "5001") != '00'){
                    if(zones.find(z => z.zone === "5001") == '10'){
                        erreur +='Type de record => Zone obligatoire<br>';
                    }else if(zones.find(z => z.zone === "5001") == '11'){
                        erreur += 'Type de record => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5001") == '20'){
                        erreur += 'Type de record => Valeur non permise<br>';
                    }
                }

                //Erreur sur le num de mut
                if(zones.find(z => z.zone === "5011") != '00'){
                    if(zones.find(z => z.zone === "5011") == '10'){
                        erreur += 'N° de mutualité => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5011") == '11'){
                        erreur +='N° de mutualité => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5011") == '20'){
                        erreur +='N° de mutualité => Numéro inconnu ou codification erronée<br>';
                    }else if(zones.find(z => z.zone === "5011") == '21'){
                        erreur += 'N° de mutualité => N° de mutualité non retrouvé dans le détail de la facturation<br>';
                    }
                }

                //Erreur sur le num fact
                if(zones.find(z => z.zone === "5021") != '00'){
                    if(zones.find(z => z.zone === "5021") == '10'){
                        erreur +='N° de facture récapitulative => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5021") == '11'){
                        erreur += 'N° de facture récapitulative => Erreur de format<br>';
                    }
                }

                //Erreur sur le signe montant a ou montant demande a
                if(zones.find(z => z.zone === "5041") != '00'){
                    if(zones.find(z => z.zone === "5041") == '11'){
                        erreur += 'Montant demandé cpt a => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5041") == '40'){
                        erreur += 'Montant demandé cpt a => Erreur code signe (# de + ou -)<br>';
                    }else if(zones.find(z => z.zone === "5041") == '41'){
                        erreur +='Montant demandé cpt a => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "5041") == '20'){
                        erreur += 'Montant demandé cpt a => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant b ou montant demande b
                if(zones.find(z => z.zone === "5061") != '00'){
                    if(zones.find(z => z.zone === "5061") == '11'){
                        erreur += 'Montant demandé cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5061") == '15'){
                        erreur +='Montant demandé cpt b => Zone # de 0 si l\'émetteur n\est pas une institution hospitalière - Zone signe # de «blanc» et émetteur de la facturation # d’une institution hospitalière<br>';
                    }else if(zones.find(z => z.zone === "5061") == '40'){
                        erreur +='Montant demandé cpt b => Erreur code signe (# de + ou -)';
                    }else if(zones.find(z => z.zone === "5061") == '41'){
                        erreur +='Montant demandé cpt b => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "5061") == '20'){
                        erreur +='Montant demandé cpt b => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant a + b ou montant demande a + b
                if(zones.find(z => z.zone === "5081") != '00'){
                    if(zones.find(z => z.zone === "5081") == '11'){
                        erreur +='Total montant demandés cpt a + cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5081") == '20'){
                        erreur +='Total montant demandé cpt a + cpt b => Montant # somme des montants cpt a et cpt b<br>';
                    }else if(zones.find(z => z.zone === "5081") == '40'){
                        erreur +='Total montant demandé cpt a + cpt b => Erreur code signe (# de + ou -)<br>';
                    }
                }

                //Erreur sur le nb d'enreg
                if(zones.find(z => z.zone === "5091") != '00'){
                    if(zones.find(z => z.zone === "5091") == '10'){
                        erreur += 'Nb de records détail => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5091") == '11'){
                        erreur +='Nb de records détail => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5091") == '20'){
                        erreur += 'Nb de records détail => Somme erronée<br>';
                    }
                }

                //Erreur sur le num de controle par mutualite si 95 ou num de controle de l'envoi si 96
                if(zones.find(z => z.zone === "5101") != '00'){
                    if(segment.substr(0,2) == '95'){
                        if(zones.find(z => z.zone === "5101") == '10'){
                            erreur += 'N° de contrôle par mutualité => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "5101") == '11'){
                            erreur +='N° de contrôle par mutualité => Erreur de format<br>';
                        }
                    }else if(segment.substr(0,2) == '96'){
                        if(zones.find(z => z.zone === "5101") == '10'){
                            erreur += 'N° de contrôle de l\'envoi => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "5101") == '11'){
                            erreur +='N° de contrôle de l\'envoi => Erreur de format<br>';
                        }
                    }
                }

                return erreur;
            }

            extractErrorMessage(errorDetail) {
                const e = errorDetail
                return e &&
                ((e.rejectionCode1 && e.rejectionCode1 !== "000000") ||
                    e.rejectionDescr1 ||
                    (e.rejectionCode2 && e.rejectionCode2 !== "000000") ||
                    e.rejectionDescr2 ||
                    (e.rejectionCode3 && e.rejectionCode3 !== "000000") ||
                    e.rejectionDescr3)
                    ? _.compact([
                        e.rejectionCode1 || (e.rejectionDescr1 && e.rejectionDescr1.trim().length)
                            ? `${e.rejectionCode1 || "XXXXXX"}: ${e.rejectionDescr1 || "-"}`
                            : null,
                        e.rejectionCode2 || (e.rejectionDescr2 && e.rejectionDescr2.trim().length)
                            ? `${e.rejectionCode2 || "XXXXXX"}: ${e.rejectionDescr2 || "-"}`
                            : null,
                        e.rejectionCode3 || (e.rejectionDescr3 && e.rejectionDescr3.trim().length)
                            ? `${e.rejectionCode3 || "XXXXXX"}: ${e.rejectionDescr3 || "-"}`
                            : null
                    ]) : null
            }


            _showDetail() {

                if (this.activeGridItem && this.activeGridItem.message){
                    this.shadowRoot.getElementById("messagesGridContainer").classList.add("half")
                    this.shadowRoot.getElementById("invoiceDetailContainer").classList.add("open")

                    const invoiceIds = this.activeGridItem.message.invoiceIds

                    this.api.invoice().getInvoices(new models.ListOfIdsDto({ids: invoiceIds.map(i => i)}))
                        .then(invoices => Promise.all(invoices.map(inv => this.api.crypto().extractCryptedFKs(inv, this.user.healthcarePartyId).then(ids => [inv, ids[0]]))))
                        .then(invAndIdsPat =>
                            this.api.patient().getPatients(new models.ListOfIdsDto({ids: _.uniq(invAndIdsPat.map(x => x[1]))})).then(pats => invAndIdsPat.map(it => [it[0], pats.find(p => p.id === it[1])]))
                        )
                        .then(invAndPats => _.flatMap(invAndPats, ([inv, pat]) => inv.invoicingCodes.map(code => ({
                                invoiceReference: inv.invoiceReference,
                                patient: pat.lastName + " " + pat.firstName,
                                ssin: pat.ssin,
                                invoicingCode: code.code,
                                invoiceDate: inv.invoiceDate,
                                invoicedAmount: code.reimbursement,
                                acceptedAmount: "0.00",
                                refusedAmount: "0.00",
                                rejectionReason: inv.error,
                                paid: false,
                                status: ""
                            })))
                        )
                        .then(infos => this.set('invoicesFromBatch', _.flatten(infos)))
                        .then(() => this.api.message().getChildren(this.activeGridItem.message.id))
                        .then((msgs) => Promise.all(_.map(msgs.filter(m => m.subject && ['920999','920099'].includes(m.subject.substr(0,6))), (msg => this.api.document().findByMessage(this.user.healthcarePartyId, msg)))))
                        .then((docs) => Promise.all(_.flatMap(docs).filter(d => !_.endsWith(d.name, '_parsed_records') && _.endsWith(d.name, '_records') && d.mainUti === "public.json").map(d => this.api.document().getAttachment(d.id, d.attachmentId))))
                        .then((attachs) => {
                            attachs.forEach( a => {
                                if (typeof a === "string"){
                                    try {
                                        let readyToParse = a.replace(/\\n/g, "\\n").replace(/\\'/g, "\\'").replace(/\\"/g, '\\"').replace(/\\&/g, "\\&").replace(/\\r/g, "\\r").replace(/\\t/g, "\\t").replace(/\\b/g, "\\b").replace(/\\f/g, "\\f")
                                        readyToParse = readyToParse.replace(/[\u0000-\u0019]+/g,"")
                                        a = JSON.parse(readyToParse)
                                    } catch (ignored) {}
                                }

                                const zone200 = a.find(enr => enr.zones.find(z => z.zone == "200"))
                                const zone300 = a.find(enr => enr.zones.find(z => z.zone == "300"))
                                const zone400 = a.find(enr => enr.zones.find(z => z.zone == "400"))
                                const zone500 = a.find(enr => enr.zones.find(z => z.zone == "500"))

                                let invoiceStatus
                                if(zone200 && zone300){
                                    const invoiceType = zone200.zones.find(z => z.zone === "200") ? zone200.zones.find(z => z.zone === "200").value : ""

                                    switch(invoiceType){
                                        case '920999' : invoiceStatus = "Rejected"; break;
                                        case '920099' : invoiceStatus = "Rejected"; break;
                                        case '931000' : invoiceStatus = "Receveid"; break;
                                        case '920098' : invoiceStatus = "Accepted"; break;
                                        case '920900' : invoiceStatus = "Accepted"; break;
                                        default : invoiceStatus = ""; break;
                                    }
                                }

                                let globalError = _.uniq([zone200 && this.SEG_getErrSegment_200(zone200.zones),
                                    zone300 && this.SEG_getErrSegment_300(zone300.zones),
                                    zone400 && this.SEG_getErrSegment_400(zone400.zones),
                                    zone500 && this.SEG_getErrSegment_500(zone500.zones)]
                                    .concat(a.map(r=> r.errorDetail && this.extractErrorMessage(r.errorDetail))).filter(x => x && x.length))

                                this.set('invoicesFromBatch', _.clone(this.invoicesFromBatch.map(i=>{
                                    i.rejectionReason = i.rejectionReason && i.rejectionReason.length ? i.rejectionReason : _.flatten(globalError);
                                    return i
                                })))

                                console.log(this.invoicesFromBatch)

                            })
                        })

                } else {
                    this.shadowRoot.getElementById("messagesGridContainer").classList.remove("half")
                    this.shadowRoot.getElementById("invoiceDetailContainer").classList.remove("open")
                }
            }

            _openHelpDeskDialogSupp(e){
                e.stopPropagation();
                this.set("infoHelpdesk",JSON.parse(e.target.dataset.item))
                this.set("isCompleteHelpDesk",false)
                this.set("mobile",this.hcp.addresses[0].telecoms.find(tel => tel.telecomType==='mobile').telecomNumber)

                this.$["helpdeskInfoDialog"].open()
            }

            _openHelpDeskDialogDet(e){
                e.stopPropagation();
                this.set("infoHelpdesk", this.activeGridItem)
                this.set("isCompleteHelpDesk",true)
                this.set("infoHelpdeskDet",JSON.parse(e.target.dataset.item))
                this.set("mobile",this.hcp.addresses[0].telecoms.find(tel => tel.telecomType==='mobile').telecomNumber)

                this.$["helpdeskInfoDialog"].open()
            }

            receiveInvoices() {
                this.api.fhc().Efactcontroller().loadMessagesUsingGET(this.hcp.nihii, this.language, this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, this.hcp.ssin, this.hcp.firstName, this.hcp.lastName).then(response => {
                    let prom = Promise.resolve()
                    response.forEach(message => {
                        // console.log(message)

                        prom = prom.then(() =>
                            new Promise((resolve) => {
                                if (message.detail) {
                                    this.api.message().processEfactMessage(this.user, this.hcp, message, this.api.document())
                                        .then(msg => msg ? resolve(message) : resolve())
                                        .catch(e => {
                                            // console.log(e)
                                            resolve()
                                        })
                                } else if (message.tack) {
                                    this.api.message().processTack(this.user, this.hcp, message)
                                        .then(rcpt => rcpt ? resolve(message) : resolve())
                                        .catch(e => {
                                            // console.log(e)
                                            resolve()
                                        })
                                }
                            })
                        )
                    })

                    prom = prom.then(treatedMessages => {
                        let sprom = Promise.resolve()
                        _.chunk(treatedMessages, 20).forEach(chunk => {
                            const tacks = chunk.filter(x => x && x.tack)
                            const responses = chunk.filter(x => x && x.detail)

                            sprom = sprom
                                //.then(() =>this.api.fhc().Efactcontroller().confirmAcksUsingPUT(this.hcp.nihii, this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, this.hcp.ssin, this.hcp.firstName, this.hcp.lastName, tacks.map(t => t.hashValue)))
                                //.then(() => this.api.fhc().Efactcontroller().confirmMessagesUsingPUT(this.hcp.nihii, this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, this.hcp.ssin, this.hcp.firstName, this.hcp.lastName, responses.map(t => t.hashValue)))
                        })
                        return sprom
                    })
                })
            }

            _dateFormat(date) {
                return date ? this.api.moment(date).format('DD/MM/YYYY') : '';
            }

            isProcess(){
                return this.invoicesStatus === "process"
            }

            isReject(){
                return this.invoicesStatus === "reject"
            }

            isArchOrAcc(){
                return !(this.invoicesStatus === "reject" || this.invoicesStatus === "process")

            }

            initializeBatchCounter(processedCounter, accpetedCounter, rejectedCounter){
                this.dispatchEvent(new CustomEvent('initialize-batch-counter', { bubbles: true, composed: true, detail: { pending: this.selectedPendingInvoices.length ? this.selectedPendingInvoices.length : 0, processing: processedCounter, rejected: rejectedCounter, accepted: accpetedCounter, archived: 0} }));
            }

        }

        customElements.define(HtMsgInvoice.is, HtMsgInvoice);
    </script>
</dom-module>
