<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">



<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">


<link rel="import" href="../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../filter-panel/filter-panel.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">

<link rel="import" href="../dynamic-form/dynamically-loaded-form.html">
<link rel="import" href="../dynamic-form/dynamic-doc.html">
<link rel="import" href="../dynamic-form/entity-selector.html">

<!--<link rel="import" href="../ht-lab/ht-lab-details.html">-->



<dom-module id="ht-msg-detail">
	<template>
		<style>
			.notification-panel {
				position: fixed;
				top:50%;
				right: 0;
				z-index:1000;
				color: white;
				font-size: 13px;
				background: rgba(255, 0, 0, 0.55);
				height: 96px;
				padding: 0 8px 0 12px;
				border-radius: 3px 0 0 3px;
				overflow: hidden;
				white-space: nowrap;
				width: 0;
				opacity: 0;
			}

			.notification {
				animation: notificationAnim 7.5s ease-in;
			}

			@keyframes notificationAnim {
				0%{
					width: 0;
					opacity: 0;
				}
				5%{
					width: 440px;
					opacity: 1;
				}
				7%{
					width: 420px;
					opacity: 1;
				}
				95%{
					width: 420px;
					opacity: 1;
				}
				100%{
					width: 0;
					opacity: 0;
				}
			}

			.prescription-progress-bar {
				width: calc( 100% - 40px );
			}

			.details-panel {
				box-sizing: border-box;
				grid-column: 3 / span 1;
				grid-row: 1 / span 1;
				background: var(--app-background-color-light);
				padding: 5px;
				display: flex;
				overflow: auto;
				flex-flow: column nowrap;
				align-items: flex-start;
				z-index: 0;
                height: calc(100vh - 27%);
				width: 100%;
			}

			.contact-title{
				display:block;
				@apply --paper-font-body2;
				@apply --padding-32;
				padding-bottom:8px;
				padding-top: 32px;
			}
			/*.contact-title:first-child{
				padding-top:0;
			}*/
			.pat-details-card > .card-content {
				padding: 16px 16px 32px !important;
			}

			.pat-details-card {
				width: 100%;
				padding: 10px 15px;
                height: calc(80vh - 20%);
			}

			.horizontal {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				flex-basis: 100%;
			}

			.justified {
				justify-content: space-between;
			}

			.pat-details-input {
				flex-grow: 1;
				margin: 16px;
			}

			input {
				border: none;
				width: 100%;
			}

			paper-dialog {
				margin: 0;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 48px);
				padding-bottom: 32px;
			}

			paper-dialog {
				min-width:30%;
			}

			.extra-info{
				color:var(--app-text-color-disabled);
				font-style: italic;
				font-size: 80%;
			}

			vaadin-upload{
				margin:16px;
				min-height:280px;
				background: var(--app-background-color);
				--vaadin-upload-buttons-primary: {
					padding:16px;
				};
				--vaadin-upload-button-add: {
					background: var(--app-secondary-color);
					color:var(--app-text-color);
				};
				--vaadin-upload-file-progress: {
					--paper-progress-active-color:var(--app-secondary-color);
				};
				--vaadin-upload-file-commands: {
					color: var(--app-primary-color);
				}

			}

			.close-button-icon{
				position: absolute;
				top: 0;
				right: 0;
				margin: 0;
				transform: translate(50%, -50%);
				height: 32px;
				width: 32px;
				padding: 8px;
				background: var(--app-primary-color);
			}

			paper-dialog {
				width: 80%;
			}

			vaadin-grid {
				height:100%;
				--vaadin-grid-body-row-hover-cell: {
					/* background-color: var(--app-primary-color); */
					color: white;
				};
				--vaadin-grid-body-row-selected-cell: {
					background-color: var(--app-primary-color);
					color: white;
				};
			}

			paper-input{
				--paper-input-container-focus-color: var(--app-primary-color);
			}

			.modal-title{
				background:  var(--app-background-color-dark);
				margin-top: 0;
				padding: 16px 24px;
			}

			.modal-subtitle{
				display: inline-flex;
				margin-top: 16px;
			}

			.modal-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				color: var(--app-text-color);
				font-weight: 400;
				font-size: 14px;
				height: 40px;
				min-width: 100px;
				padding: 10px 1.2em;
				text-transform: capitalize;
			}

			.modal-button--save{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-secondary-color);
				color: var(--app-primary-color-dark);
				font-weight: 700;
			}

			.modal-button--delete{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-background-color-light);
				color: var(--app-primary-color-dark);
				font-weight: 700;
			}

			filter-panel{
				flex-grow: 9;
				/* --panel-width: 60%; */
			}

			.layout-bar{
				flex-grow: 1;
				display: inline-flex;
				flex-flow: row nowrap;
				align-items: center;
				justify-content: space-around;
				height:48px;
				background: var(--app-secondary-color);
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.layout-bar .list, .layout-bar .graphique, .layout-bar .doc{
				height: 32px;
				width: 32px;
				padding: 5px;
				color: var(--app-primary-color-dark);
			}

			.layout-bar .table{
				height: 30px;
				width: 30px;
				padding: 0;
				color: var(--app-primary-color-dark);
			}

			.floating-action-bar{
				display: flex;
				position: absolute;
				height: 40px;
				bottom: 16px;
				background: var(--app-secondary-color);
				border-radius: 3px;
				grid-column: 3/3;
				grid-row: 1/1;
				z-index: 1000;
				left: 50%;
				transform: translate(-50%, 0);
				box-shadow: var(--app-shadow-elevation-2);
			}

			.add-forms-container {
				position: absolute;
				bottom: 48px;
				left: 0;
				background-color: var(--app-background-color-light);
				opacity: .8;
				padding: 8px 0;
				border-radius: 2px;
				max-width: 253px;
			}
			.floating-action-bar paper-fab-speed-dial-action {
				--paper-fab-speed-dial-action-label-background: transparent;
				--paper-fab-iron-icon: {
					transform: scale(0.8);

				};
				--paper-fab: {
					background: var(--app-primary-color-dark);
				}
			}

			.floating-action-bar paper-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				background: var(--app-secondary-color);
				color: var(--app-text-color);
				font-weight: bold;
				font-size: 12px;
				height: 40px;
				min-width: 130px;
				padding: 10px 1.2em;
				border-radius: 0;
				margin:0;
			}

			.floating-action-bar paper-button:hover{
				background: var(--app-dark-color-faded);
    			transition: var(--transition_-_transition);
			}

			.floating-action-bar paper-button:not(:first-child){
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.close-add-forms-btn{
				background: var(--app-secondary-color-dark) !important;
			}

			.floating-action-bar iron-icon{
				box-sizing: border-box;
				padding: 2px;
				margin-right: 8px;
			}

			.horizontal{
				flex-flow: row nowrap;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 48px);
				padding-bottom: 32px;
			}

			.annexe-card{
				padding: 5px;
				width: 100%;
				margin-bottom: 15px;
			}

			.img-container img{
				max-width: 100%;
			}

            .action-buttons {
                width: 100%;
                margin-bottom: 15px;
            }
            .action-buttons > .buttons {
                float: left;
            }
            .action-buttons > .del-button {
                float: right;
            }

            .clearb {
                clear: both;
            }
            .inlined {
                float: left;
                width: 30%;
                margin: 0 1%;
            }

            .read-txt {
                min-height: 80px;
                width: 100%;
                overflow-y: scroll;
            }

            .attached {
                height: 18%;
                position: fixed;
                bottom: 0;
                right: 0;
                width: 42%;
                padding: 10px;
                overflow-y: auto;
                border-top: 2px solid var(--app-background-color-dark);
                box-sizing: border-box;
            }

            #patientSelection{
                max-width: 100px;
            }

            #comboPatientSelecter{
                width: 100%;
            }

		</style>
		<template is="dom-if" if="[[messages]]">
			<div id="main-details-panel" class="details-panel" on-dragover="_onDrag">
                <div class="action-buttons">
                    <div class="buttons">
                        <paper-button class="modal-button--save"  msgId$='[[msg.id]]' ><iron-icon icon="check-box-outline-blank"></iron-icon>[[localize('markread','Mark as read',language)]]</paper-button>
                        <paper-button class="modal-button--save"  msgId$='[[msg.id]]' ><iron-icon icon="forward"></iron-icon>[[localize('forward','Forward',language)]]</paper-button>
                        <paper-button class="modal-button--save"  msgId$='[[msg.id]]' ><iron-icon icon="reply"></iron-icon>[[localize('reply','Reply',language)]]</paper-button>
                    </div>
                    <div class="del-button">
                        <paper-button class="modal-button--delete" on-tap="_removeMsg"  msgId$='[[msg.id]]' ><iron-icon icon="delete-forever"></iron-icon>[[localize('del','Delete',language)]]</paper-button>
                    </div>
                </div>
					<template is="dom-repeat" items="[[messages]]" as="msg">
							<paper-card class="pat-details-card" >
                                <div>
                                    <paper-input class="inlined" readonly value="[[localize('from','From',language)]] : [[msg.fromAddress]]"></paper-input>
                                    <paper-input class="inlined" readonly value="[[localize('to','To',language)]] : [[msg.toAddresses]]"></paper-input>
                                    <paper-input class="inlined" readonly value="[[localize('dat','Date',language)]]: [[_timeFormat(msg.received)]]"></paper-input>
                                </div>
                                <paper-input class="clearb subject" readonly value="[[localize('sub','Subject',language)]]: [[msg.subject]]"></paper-input>

								<template is="dom-if" if="[[msg.body]]">
                                    <iron-autogrow-textarea class="read-txt" readonly placeholder="no content" value="[[msg.body]]"></iron-autogrow-textarea>
                                </template>

                            </paper-card>
                    </template>
            </div>

            <div class="attached">
                <h3>Pièces jointes</h3>
                <template is="dom-repeat" items="[[selectedDocuments]]">
                    <template is="dom-if" if="[[!_isEqualTo(item.documentLocation,'body')]]">
                        <paper-card class="annexe-card">
                            <span>[[item.name]]</span>
                            <iron-icon icon="file-download" on-tap="_download" dataUrl$='[[item.dataUrl]]' name$='[[item.name]]'></iron-icon>
                            <template is="dom-if" if="[[_imageMimeType(item.mainUti, item.otherUtis.*, item.dataUrl)]]" >
                                <div class="img-container">
                                    <img src$="[[item.dataUrl]]">
                                </div>
                                <vaadin-button id="todayButton" part="today-button" on-tap="selectPatientForImport" docId$="[[item.id]]" attachmentId$="[[item.attachmentId]]" mainUti$="[[item.mainUti]]" otherUtis$="[[item.otherUtis.*]]" dataUrl$="[[item.dataUrl]]">import</vaadin-button>
                            </template>
                            <template is="dom-if" if="[[_pdfMimeType(item.mainUti, item.otherUtis.*, item.dataUrl)]]">
                                <pdf-element src="[[item.dataUrl]]" elevation="5" downloadable height="900" fit-width enable-text-selection></pdf-element>
                                <vaadin-button id="todayButton" part="today-button" on-tap="selectPatientForImport" docId$="[[item.id]]" attachmentId$="[[item.attachmentId]]" mainUti$="[[item.mainUti]]" otherUtis$="[[item.otherUtis.*]]" dataUrl$="[[item.dataUrl]]">import</vaadin-button>
                            </template>
                            <template is="dom-if" if="[[_xmlMimeType(item.mainUti, item.otherUtis.*, item.dataUrl)]]">
                                <div>
                                    <span>[[mimeType(item.mainUti)]] [[type]]</span>
                                    <vaadin-button id="todayButton" part="today-button" on-tap="_getAttachment" id$="[[item.id]]" attachmentId$="[[item.attachmentId]]">details</vaadin-button>
                                    <vaadin-button id="todayButton" part="today-button" on-tap="selectPatientForImport" docId$="[[item.id]]" attachmentId$="[[item.attachmentId]]" mainUti$="[[item.mainUti]]" otherUtis$="[[item.otherUtis.*]]" dataUrl$="[[item.dataUrl]]">import</vaadin-button>
                                </div>
                                <template is="dom-if" if="[[showDetail]]">
                                    <div>[[documentAttachment]]</div>
                                    <!--TODO: format annexe on display-->
                                    <!--<ht-lab-details api="[[api]]" attachment="[[documentAttachment]]"></ht-lab-details>-->
                                </template>
                            </template>
                            <template is="dom-if" if="[[_textType(item.mainUti, item.otherUtis.*)]]">
                                <div>
                                    <span>[[mimeType(item.mainUti)]] [[type]]</span>
                                    <vaadin-button id="todayButton" part="today-button" on-tap="_getAttachment" id$="[[item.id]]" attachmentId$="[[item.attachmentId]]">details</vaadin-button>
                                    <vaadin-button id="todayButton" part="today-button" on-tap="selectPatientForImport" docId$="[[item.id]]" attachmentId$="[[item.attachmentId]]" mainUti$="[[item.mainUti]]" otherUtis$="[[item.otherUtis.*]]" dataUrl$="[[item.dataUrl]]">import</vaadin-button>
                                </div>
                                <template is="dom-if" if="[[showDetail]]">
                                    <div>[[documentAttachment]]</div>
                                    <!--TODO: format annexe on display-->
                                    <!--<ht-lab-details api="[[api]]" attachment="[[documentAttachment]]"></ht-lab-details>-->
                                </template>
                            </template>
                        </paper-card>
                    </template>
                </template>
            </div>
		</template>

        <paper-dialog id="patientSelection">
            <h3 class="modal-subtitle">[[localize('selPatAssign','Select the patient to assign',language)]]</h3>
            <div>
                <vaadin-combo-box id="comboPatientSelecter" label="[[localize('sch','Search',language)]]" filter="{{patientFilter}}" filtered-items="[[patientList]]" item-label-path="displayName"
                                  allow-custom-value on-change="_AddSSIN">
                    <template>[[item.displayName]]</template>
                </vaadin-combo-box>
            </div>
            <div>
                <paper-button class="modal-button" on-tap="_cancelImportAnnexe">[[localize('can','Cancel',language)]]</paper-button>
                <paper-button class="modal-button--save" on-tap="importAnnexe">[[localize('set','Set',language)]]</paper-button>
            </div>

        </paper-dialog>

    </template>
	<script>

import jsPDF from 'jspdf/dist/jspdf.min';
import _ from 'lodash/lodash';
import JsBarcode from 'JsBarcode';
import moment from 'moment/src/moment';
import XML from 'parse-xml/dist/parse-xml';

class HtMsgDetail extends Polymer.TkLocalizerMixin(Polymer.Element) {
	static get is() {
		return 'ht-msg-detail';
	}

	static get properties() {
		return {
			contacts: {
				type: Array,
				value: function () {
					return [];
				}
			},
			api: {
				type: Object
			},
			user: {
				type: Object
			},
			credentials:{
				type: Object
			},
			currentContact: {
				type: Object,
				value: null
			},
            selectMessage: {
			    type: Object
			},
			messages: {
			    type: Object,
				value: null
			},
			selectedDocuments:{
				type: Object
			},
			documentAttachment:{
				type: String,
				value: null
			},
			showDetail:{
				type: Boolean,
				value: false
			}
		};
	}

	static get observers() {
		return ['_focusChanged(selectMessage, selectMessage.*)',
			'_patientFilterChanged(patientFilter)'];
	}

	constructor() {
		super();
	}

	ready(){
		super.ready();
	}

    _focusChanged(){
	    if(this.selectMessage.selection.item){
            this.selectMessage.selection.item.body = [];
	        let tempSelect = this.selectMessage.selection.item;
        	this.api.document().findByMessage(this.user.healthcarePartyId, tempSelect)
				.then(docs => { if(docs.length) {
					return docs.filter(doc => doc.id && doc.attachmentId && doc.secretForeignKeys)
						.map(doc => this.api.document().getAttachment(doc.id, doc.attachmentId, null)
							.then(a =>
								// With encryption key
								// this.getDataUrls(doc)
								// .then(dataUrl => {
								// 	doc.dataUrl = dataUrl;
								// 	if(this._isEqualTo(doc.documentLocation,'body')) tempSelect.body = a;
								// 	else this.set('documentAttachment', a);
								// 	return doc
								// })

								//Without encryption key
								{
									doc.dataUrl = this.getDataUrls(doc)
									if(this._isEqualTo(doc.documentLocation,'body')) tempSelect.body = a;
									return doc
								}
							)
					)
				}

	    	}).then(docs =>{
	    		if(docs && docs.length){
                    Promise.all(docs).then(docs=>{
                        this.set('messages', [tempSelect]);
                        this.set("selectedDocuments", docs);
                        this.getChildren(tempSelect.id)
                    })
				}
				else{
					this.set('messages', [tempSelect]);
					this.set("selectedDocuments", []);
					this.getChildren(tempSelect.id)
                }
            })
	    }else{
			this.set('messages', null);
		}
	}

	getChildren(item){
        this.api.message().getChildren(item).then(function(m) {
			if(m.length){
                m.map(r => r.body = []);
                this.api.document().findByMessage(this.user.healthcarePartyId, m).then(docs => {
                    docs.length?
                    	docs.map(doc => this.api.document().getAttachment(doc.id,doc.attachmentId, doc.secretForeignKeys).then(a => {m.map(r => {r.body.push(a);this.messages.push(r)});}))
						:m.map(r => this.messages.push(r));
                    this.set('messages',this.messages)
                    m.map(r => this.getChildren(r));
                })
			}
        }.bind(this))
	}

	// With encryption key
	// getDataUrls(doc){
	// 	return this.api.crypto().decryptAndImportAesHcPartyKeysInDelegations(this.user.healthcarePartyId, doc.encryptionKeys && Object.keys(doc.encryptionKeys).length ? doc.encryptionKeys : doc.delegations)
	// 				.then(decryptedAndImportedAesHcPartyKeys => {
	// 					let collatedAesKeys = {};
	// 					decryptedAndImportedAesHcPartyKeys.forEach(k => collatedAesKeys[k.delegatorId] = k.key);
	// 					return this.api.crypto().decryptDelegationsSFKs((doc.encryptionKeys && Object.keys(doc.encryptionKeys).length? doc.encryptionKeys: doc.delegations)[this.user.healthcarePartyId], collatedAesKeys, doc.id)
	// 						.then(enckeys =>
	// 							this._xmlMimeType(doc.mainUti, doc.otherUtis, this.dataUrl)?
	// 								this.api.document().getAttachment(doc.id, doc.attachmentId, enckeys).then(att => {
	// 									let xml = XML.parseXml(att);
	// 									if(xml.kmehrmessage && xml.kmehrmessage.header && xml.kmehrmessage.header.standard &&
	// 										xml.kmehrmessage.header.standard.specialisation &&
	// 										xml.kmehrmessage.header.standard.specialisation.cd &&
	// 										xml.kmehrmessage.header.standard.specialisation.cd.S){
	// 										this.set("type",xml.kmehrmessage.header.standard.specialisation.cd.S);
	// 									}else{
	// 										this.set("type","Non Valid Type")
	// 									}
	// 								})
	// 								: (doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, enckeys))
	// 						);
	// 				})
	// }

	//Without encryption key
	getDataUrls(doc){
		this.set("type","");
		 if (this._xmlMimeType(doc.mainUti, doc.otherUtis, this.dataUrl)){
			 return this.api.document().getAttachment(doc.id, doc.attachmentId, null).then(att => {
				let xml = XML.parseXml(att);
				if(xml.kmehrmessage && xml.kmehrmessage.header && xml.kmehrmessage.header.standard &&
					xml.kmehrmessage.header.standard.specialisation &&
					xml.kmehrmessage.header.standard.specialisation.cd &&
					xml.kmehrmessage.header.standard.specialisation.cd.S){
					this.set("type",xml.kmehrmessage.header.standard.specialisation.cd.S);
				}else{
					this.set("type","Non Valid Type")
				}
				return att
			})
		}else {
			return (doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, null));
		}
	}

	_removeMsg(e){
		let msgId = e.target.getAttribute('msgId');
		let transportGuid = e.target.getAttribute('transportGuid');
		this.set('messages', null);

		this.api.message().findMessagesByTransportGuid(transportGuid, null, null, 1)
			.then(msg => {
				let m = msg.rows[0];
				if(m.transportGuid.startsWith("BIN")){
		this.api.message().deleteMessages(msgId)
						.then(() => this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } })));
				} else {
					m.transportGuid = "BIN" + m.transportGuid;
					this.api.message().modifyMessage(m)
						.then(() => this.dispatchEvent(new CustomEvent('item-delete', {detail: {selection: {item: "Refresh"}}})));
				}
			})
	}

	_imageMimeType(uti, utis, dataUrl) {
		return dataUrl && (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m && (m.startsWith('image/') || m === 'public/jpeg'));
	}

	_pdfMimeType(uti, utis, dataUrl) {
		return dataUrl && (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m === 'application/pdf');
	}

	_xmlMimeType(uti, utis) {
		return (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m === 'text/xml' || m === 'application/xml');
	}

	_textType(uti, utis){
		return (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m === 'text/plain');
	}

	_isEqualTo(title, string) {
		return title == string;
	}

	mimeType(u){
		return this.api.document().mimeType(u)
	}

	_timeFormat(date) {
		return date && this.api.moment(date).format('DD/MM/YYYY') || '';
	}

	_download(e){
		let dataUrl = e.target.getAttribute('dataUrl');
		let name = e.target.getAttribute('name');

		if(!dataUrl) dataUrl = "data:," + this.documentAttachment;

		console.log("annexe data");
		console.log(dataUrl);
		console.log(name);

		var a = document.createElement('a');
		a.href = dataUrl;
		a.target = '_parent';
		a.download = decodeURIComponent(name);


		let htMsgDetail = this.shadowRoot.querySelector('#main-details-panel');

		htMsgDetail.appendChild(a);
		a.click();
		a.parentNode.removeChild(a);

	}

	_getAttachment(e){
		let id = e.target.getAttribute('id');
		let attachmentId = e.target.getAttribute('attachmentId');
		this.api.document().getAttachment(id, attachmentId, null).then(att => this.set("documentAttachment",att));
		this.showDetail = !this.showDetail
	}

	selectPatientForImport(e){
		let patSel = this.$.patientSelection;
		patSel.docId = e.target.getAttribute('docId');
		patSel.attachmentId = e.target.getAttribute('attachmentId');
		patSel.mainUti = e.target.getAttribute('mainUti');
		patSel.otherUtis = e.target.getAttribute('otherUtis');
		patSel.dataUrl = e.target.getAttribute('dataUrl');
		patSel.open();
    }

	importAnnexe(e){
		let patSel = this.$.patientSelection;
		patSel.close();
		let selectedPatient = this.$.comboPatientSelecter.selectedItem
        this.api.patient().getPatient(selectedPatient && selectedPatient.id ? selectedPatient.id : e.target.getAttribute('patientId')).then(patient =>{
            let id           = (patSel && patSel.docId        ? patSel.docId        : e.target.getAttribute('docId'));
            let attachmentId = (patSel && patSel.attachmentId ? patSel.attachmentId : e.target.getAttribute('attachmentId'));
            let mainUti      = (patSel && patSel.mainUti      ? patSel.mainUti      : e.target.getAttribute('mainUti'));
            let otherUtis    = (patSel && patSel.otherUtis    ? patSel.otherUtis    : e.target.getAttribute('otherUtis'));
            let dataUrl      = (patSel && patSel.dataUrl      ? patSel.dataUrl      : e.target.getAttribute('dataUrl'));

            // IMG, PDF
            if(this._imageMimeType(mainUti, otherUtis, dataUrl) || this._pdfMimeType(mainUti, otherUtis, dataUrl)){
                this.api.document().getDocument(id).then(doc => {
                    let srv = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: doc.id, stringValue: doc.name }]]), label: 'document'});
                    this.api.contact().newInstance(this.user, patient, {
                        created: new Date().getTime() ,
                        modified: new Date().getTime() ,
                        author: this.user.healthcarePartyId,
                        responsible: this.user.healthcarePartyId,
                        openingDate: moment().format('YYYYMMDD') || '',
                        closingDate: moment().format('YYYYMMDD') || '',
                        encounterType: {type: "CD-TRANSACTION", version: "1.13", code: "result"},
                        descr: "Lab " + new Date().getTime(),
                        subContacts: [{ status: 64, services: [{ serviceId: srv.id }] }],
                        services: [srv]
                    }).then(c=>{
                        this.api.contact().createContact(c).then(c => {
                            this.api.form().newInstance(this.user, patient, {
                                contactId: c.id,
                                descr: "Lab " + new Date().getTime(),
                            }).then(f => this.api.form().createForm(f))
                        });
                    })
                })
            }
            // XML
            else if(this._xmlMimeType(mainUti, otherUtis)){
                let xml = XML.parseXml(this.documentAttachment);
                if (xml.kmehrmessage && xml.kmehrmessage.header && xml.kmehrmessage.header.standard &&
                    xml.kmehrmessage.header.standard.specialisation &&
                    xml.kmehrmessage.header.standard.specialisation.cd){
                    // SMF
                    if(xml.kmehrmessage.header.standard.specialisation.cd.value === "gpsoftwaremigration"){
						this.api.bekmehr().importSmf(doc.id, "", patient.id, this.user.language, xml).then(
							contacts => contacts.forEach(contact =>
								contact.ctcs.forEach(ctc => this.api.contact().initDelegationsAndEncryptionKeys(this.user, this.patient, ctc)
									.then(c => {
										console.log(c);
										return c
									})
								)
							)
						)
                    }
                    //	PMF
                    else if(xml.kmehrmessage.header.standard.specialisation.cd.value === "gppatientmigration"){
						// this.api.bekmehr().importPmf(doc.id, "", patient.id, this.user.language, xml).then(
						// 	contacts => contacts.forEach(contact =>
						// 		contact.ctcs.forEach(ctc => this.api.contact().initDelegationsAndEncryptionKeys(this.user, this.patient, ctc)
						// 			.then(c => {
						// 				console.log(c);
						// 				return c
						// 			})
						// 		)
						// 	)
						// )
                    }
                }
            }
            // TEXT
            else if(this._textType(mainUti, otherUtis))
				this.api.document().getAttachment(id, attachmentId, null).then(att =>
					(this._checkHealthone() || this._checkMedidoc()) ?
						this.api.contact().newInstance(this.user, patient, {
							created: new Date().getTime(),
							modified: new Date().getTime(),
							author: this.user.healthcarePartyId,
							responsible: this.user.healthcarePartyId,
							openingDate: moment().format('YYYYMMDD') || '',
							closingDate: moment().format('YYYYMMDD') || '',
							encounterType: {type: "CD-TRANSACTION", version: "1.13", code: "labresult"},
							descr: "Lab " + new Date().getTime(),
							subContacts: []
						}).then(c =>
							this.api.contact().createContact(c).then(c =>
								this.api.form().newInstance(this.user, patient, {
									contactId: c.id,
									descr: "Lab " + new Date().getTime(),
								}).then(f => this.api.form().createForm(f)).then(f =>
									this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp => {
										this.api.beresultimporticc.doImport(id, this.user.healthcarePartyId, hcp.languages.find(e => !!e) || "en", "***", f.id, null, c)
											.then(c => {
												console.log("Contact id " + c.id)
												return c
											})
									})
								)
							)
						) : att
				)
		});
	}

	_checkHealthone(){
		return this.documentAttachment.startsWith("A1");
	}

	_checkMedidoc(){
		let p1 = "^#A.*$";
		let p2 = "^#R[a-zA-Z]*\\s*$";
		let p3 = "^#A/\\s*$";
		let p4 = "^#R/\\s*$";
		let p5 = "^#/[0-9]*\\s*$";
		let hasAHash = false;
        let hasAHashSlash = false;
        let hasRHash = false;
        let hasRHashSlash = false;
        let hasFinalTag = false;

		let text = this.documentAttachment;
		if (text != null) {
			lines = text.includes("\r\n") ? text.split("\r\n") : text.split("\n")

			lines.forEach(line =>{
				if (line.match(p1)) hasAHash = true;
				if (line.match(p2)) hasRHash = true;
				if (line.match(p3) && hasAHash) hasAHashSlash = true;
				if (line.match(p4) && hasRHash) hasRHashSlash = true;
				if (line.match(p5)) hasFinalTag = true;
            })

		}
		return hasAHash && hasAHashSlash && hasRHash && hasRHashSlash && hasFinalTag;
    }

	_patientFilterChanged(filter){
		if(filter && filter.length > 1) {
			this.api.patient().findByNameBirthSsinAuto(this.user.healthcarePartyId, filter, null, null, 100, "asc")
				.then(patients => {
					console.log(patients);
					let filtredpatients = patients.rows.filter(pat => pat.ssin)
						.map(pat => {
							let newPat = {};
							newPat.id = pat.id
							newPat.firstName = pat.firstName ? pat.firstName : "";
							newPat.lastName = pat.lastName ? pat.lastName : "";
							newPat.ssin = pat.ssin ? pat.ssin : "";
							newPat.displayName = newPat.firstName + " " + newPat.lastName + " " + newPat.ssin;
							return newPat
						})
					this.set("patientList", _.uniqBy(filtredpatients, 'displayName'))
				})
		}
		else{
			this.set("patientList", [])
		}
	}

	_cancelImportAnnexe(){
		let patSel = this.$.patientSelection;
		patSel.docId = undefined;
		patSel.attachmentId = undefined;
		patSel.mainUti = undefined;
		patSel.otherUtis = undefined;
		patSel.dataUrl = undefined;
		this.$.comboPatientSelecter.selectedValue = "";
		patSel.close();
    }
}

customElements.define(HtMsgDetail.is, HtMsgDetail);
</script>
</dom-module>
