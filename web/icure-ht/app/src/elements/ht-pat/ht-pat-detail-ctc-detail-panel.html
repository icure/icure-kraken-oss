<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">


<link rel="import" href="../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../filter-panel/filter-panel.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">

<link rel="import" href="../dynamic-form/dynamically-loaded-form.html">
<link rel="import" href="dialogs/ht-pat-invoicing-dialog.html">
<link rel="import" href="ht-pat-detail-table.html">
<link rel="import" href="ht-pat-detail-list.html">
<link rel="import" href="../dynamic-form/dynamic-doc.html">
<link rel="import" href="../dynamic-form/entity-selector.html">
<link rel="import" href="../ht-spinner/ht-spinner.html">


<dom-module id="ht-pat-detail-ctc-detail-panel">
	<template>
		<style>
			.notification-panel {
				position: fixed;
				top:50%;
				right: 0;
				z-index:1000;
				color: white;
				font-size: 13px;
				background: rgba(255, 0, 0, 0.55);
				height: 96px;
				padding: 0 8px 0 12px;
				border-radius: 3px 0 0 3px;
				overflow: hidden;
				white-space: nowrap;
				width: 0;
				opacity: 0;
			}

			.notification {
				animation: notificationAnim 7.5s ease-in;
			}

			@keyframes notificationAnim {
				0%{
					width: 0;
					opacity: 0;
				}
				5%{
					width: 440px;
					opacity: 1;
				}
				7%{
					width: 420px;
					opacity: 1;
				}
				95%{
					width: 420px;
					opacity: 1;
				}
				100%{
					width: 0;
					opacity: 0;
				}
			}

			.prescription-progress-bar {
				width: calc( 100% - 40px );
			}

			.details-panel {
				/*width: calc(50% + 1px);*/
				height: 100%;
				background: var(--app-background-color-light);
				/*position: fixed;*/
				top: 64px;
				width:100%;
				/*left: calc(50% - 1px);
				grid-column: 3 / 3;
				grid-row:1 / 1;*/
				z-index:1;
			}

			.contact-card-frame {
				padding-bottom: 24px;
			}

			.contact-title{
				display:block;
				@apply --paper-font-body2;
				@apply --padding-32;
				padding-bottom:8px;
				padding-top: 16px;
			}
			/*.contact-title:first-child{
				padding-top:0;
			}*/
			.pat-details-card > .card-content {
				padding: 16px 16px 32px !important;
			}

			.pat-details-card {
				width: calc(100% - 64px);
				margin: 0 32px 32px;
			}

			.horizontal {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				flex-basis: 100%;
			}

			.justified {
				justify-content: space-between;
			}

			.pat-details-input {
				flex-grow: 1;
				margin: 16px;
			}

			input {
				border: none;
				width: 100%;
			}

			paper-dialog {
				margin: 0;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 80px);
				padding-bottom: 32px;
			}

			paper-dialog {
				min-width:30%;
			}

			.extra-info{
				color:var(--app-text-color-disabled);
				font-style: italic;
				font-size: 80%;
			}

			vaadin-upload{
				margin:16px;
				min-height:280px;
				background: var(--app-background-color);
				--vaadin-upload-buttons-primary: {
					padding:16px;
				};
				--vaadin-upload-button-add: {
					background: var(--app-secondary-color);
					color:var(--app-text-color);
				};
				--vaadin-upload-file-progress: {
					--paper-progress-active-color:var(--app-secondary-color);
				};
				--vaadin-upload-file-commands: {
					color: var(--app-primary-color);
				}

			}

			.close-button-icon{
				position: absolute;
				top: 0;
				right: 0;
				margin: 0;
				transform: translate(50%, -50%);
				height: 32px;
				width: 32px;
				padding: 8px;
				background: var(--app-primary-color);
			}

			paper-dialog {
				width: 80%;
			}

			vaadin-grid {
				max-height:100%;
				border: none;
				--vaadin-grid-body-row-hover-cell: {
					/* background-color: var(--app-primary-color); */
					color: white;
				};
				--vaadin-grid-body-row-selected-cell: {
					background-color: var(--app-primary-color);
					color: white;
				};
			}

			paper-input{
				--paper-input-container-focus-color: var(--app-primary-color);
			}

			.modal-title{
				background:  var(--app-background-color-dark);
				margin-top: 0;
				padding: 16px 24px;
			}

			.modal-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				color: var(--app-text-color);
				font-weight: 400;
				font-size: 14px;
				height: 40px;
				min-width: 100px;
				padding: 10px 1.2em;
				text-transform: capitalize;
			}

			.modal-button--save{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-secondary-color);
				color: var(--app-primary-color-dark);
				font-weight: 700;
				text-transform: capitalize;
			}

			filter-panel{
				flex-grow: 9;
				/* --panel-width: 60%; */
			}

			.layout-bar{
				flex-grow: 1;
				display: inline-flex;
				flex-flow: row nowrap;
				align-items: center;
				justify-content: space-around;
				height:48px;
				background: var(--app-secondary-color);
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.layout-bar .list, .layout-bar .graphique, .layout-bar .doc, .layout-bar .table {
				height: 32px;
				width: 32px;
				color: var(--app-text-color-disabled);
			}

			.layout-bar .list{
				padding: 0;
			}

			.layout-bar .doc{
				padding: 4px;
			}

			.layout-bar .table{
				padding: 6px;
			}

			.icn-selected {
				color: var(--app-primary-color-dark) !important;
			}

			.floating-action-bar{
				display: flex;
				position: absolute;
				height: 40px;
				bottom: 16px;
				background: var(--app-secondary-color);
				border-radius: 3px;
				grid-column: 3/3;
				grid-row: 1/1;
				z-index: 1000;
				left: 50%;
				transform: translate(-50%, 0);
				box-shadow: var(--app-shadow-elevation-2);
			}
			/* // WIP Axel FIOLLE
			@media screen and (max-width:1025px){*/
			/*.floating-action-bar {*/
			/*position: fixed;*/
			/*left: 0;*/
			/*bottom: 0;*/
			/*width: 100vw;*/
			/*transform: none;*/
			/*}*/
			/*}*/

			.add-forms-container {
				position: absolute;
				bottom: 48px;
				right: 0;
				background-color: var(--app-background-color-light);
				opacity: .8;
				padding: 8px 0;
				border-radius: 2px;
				max-width: 253px;
			}

			.floating-action-bar paper-fab-speed-dial-action {
				--paper-fab-speed-dial-action-label-background: transparent;
				--paper-fab-iron-icon: {
					transform: scale(0.8);

				};
				--paper-fab: {
					background: var(--app-primary-color-dark);
				}
			}

			.floating-action-bar paper-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				background: var(--app-secondary-color);
				color: var(--app-text-color);
				font-weight: bold;
				font-size: 12px;
				height: 40px;
				min-width: 130px;
				padding: 10px 1.2em;
				border-radius: 0;
				margin:0;
			}

			.floating-action-bar paper-button:hover{
				background: var(--app-dark-color-faded);
				transition: var(--transition_-_transition);
			}

			.floating-action-bar paper-button:not(:first-child){
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.close-add-forms-btn{
				background: var(--app-secondary-color-dark) !important;
			}

			.fleft {
				position: absolute;
				left: 8px;
			}

			.floating-action-bar iron-icon{
				box-sizing: border-box;
				padding: 2px;
				margin-right: 8px;
			}

			.horizontal{
				flex-flow: row nowrap;
			}

			.action-btn {
				white-space: nowrap;
			}

            ht-spinner.center {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translateX(-50%) translateY(-50%);
				height: 42px;
				width: 42px;
            }

			.paper-fab-container {
				position:relative;
			}

			#prose-editor {
				width: 90%;
				height: calc(90% - 64px);
				max-width: 1024px;
			}

			#prose-editor > prose-editor{
				height: calc(100% - 60px - 56px);
				width: 100%;
				display: block;
				padding: 0;
				margin: 0;
			}

			.endline {
				display: flex;
				flex-direction: row;
				margin: 0;
				border-top: 1px solid var(--app-background-color-dark);
			}

			paper-radio-group {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
			}

			paper-radio-group paper-radio-button {
				line-height: 48px;
			}

			.buttons{
				display: flex;
				flex-grow: 1;
				box-sizing: border-box;
				justify-content: flex-end;
				padding-top: 16px;
			}

			#dynamicallyListForm,
			#dynamicallyTableForm {
				display: flex;
				flex-direction: column;
				height: 100%;
			}

			@media screen and (max-width: 800px) {
				.endline {
					padding-bottom: 16px;
				}
				paper-radio-group, .buttons {
					flex-direction: column;
				}
				paper-radio-group paper-radio-button {
					line-height: normal;
				}
			}
		</style>

		<paper-item id="prescriptionError" class="notification-panel prescriptionError">
			<template is="dom-if" if="[[!api.tokenId]]">[[localize('you_mus_be_con_to_ehe_to_be_all_to_pre','You must be connected to eHealth to be allowed to prescribe',language)]]<br></template>
			<template is="dom-if" if="[[!_validSsin(patient.ssin)]]">[[localize('the_ni_of_the_pat_is_not_val_or_mis','The niss of the patient is not valid or missing ',language)]]([[patient.ssin]])<br></template>
			<template is="dom-if" if="[[!_hasDrugsToBePrescribed(servicesMap.*,currentContact,currentContact.services,currentContact.services.*)]]">[[localize('add_pre_dru_to_cur_con_to_pre','Add prescription drugs to current contact to prescribe',language)]]</template>
			<iron-icon icon="icons:warning"></iron-icon>
		</paper-item>

		<div class="details-panel" on-dragover="_onDrag">
			<div class="layout horizontal">
				<filter-panel id="serviceFilterPanel" items="[[detailPanelItems]]" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]"></filter-panel>
				<div class="layout-bar" >
					<paper-icon-button id="list_icn" class$="list [[_activeIconClass(list)]]" icon="icons:view-list" on-tap="_list"></paper-icon-button>
					<paper-icon-button id="table_icn" class$="table [[_activeIconClass(table)]]" icon="vaadin:table" on-tap="_table"></paper-icon-button>
					<paper-icon-button id="form_icn" class$="doc [[_activeIconClass(doc)]]" icon="icons:assignment" on-tap="_default"></paper-icon-button>

					<paper-tooltip for="list_icn" position="bottom" animation-delay="0">[[localize('lis_vie','List view',language)]]</paper-tooltip>
					<paper-tooltip for="table_icn" position="bottom" animation-delay="0">[[localize('tab_vie','Table view',language)]]</paper-tooltip>
					<paper-tooltip for="graph_icn" position="bottom" animation-delay="0">[[localize('gra','Graph view',language)]]</paper-tooltip>
					<paper-tooltip for="form_icn" position="bottom" animation-delay="0">[[localize('forms','Forms view',language)]]</paper-tooltip>
				</div>
			</div>
			<div class="contact-card-container">
				<ht-spinner class="center" active="[[isLoadingDoc]]"></ht-spinner>
				<template is="dom-if" if="[[list]]">
					<ht-pat-detail-list id="dynamicallyListForm" api="[[api]]" user="[[user]]" patient="[[patient]]" contact="[[dof.ctc]]" health-elements="[[healthElements]]"
										contacts="[[contacts]]" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]"></ht-pat-detail-list>
				</template>
				<template is="dom-if" if="[[table]]">
					<ht-pat-detail-table id="dynamicallyTableForm" api="[[api]]" user="[[user]]" patient="[[patient]]" contact="[[dof.ctc]]" health-elements="[[healthElements]]"
										 contacts="[[contacts]]" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]"></ht-pat-detail-table>
				</template>
				<template is="dom-if" if="[[graphique]]">
				</template>
				<template is="dom-if" if="[[doc]]">
					<div class="contact-card-frame">
					<template is="dom-repeat" items="[[contactsFormsAndDocuments]]" as="dof">
						<span class="contact-title">[[dof.ctc.descr]] ([[dof.ctc.openingDate]])</span>
						<template is="dom-if" if="[[dof.unmappedServices.length]]">
							<dynamically-loaded-form api="[[api]]" user="[[user]]" patient="[[patient]]" contact="[[dof.ctc]]"
													 current-contact="[[currentContact]]" form="[[_virtualForm(dof.unmappedServices)]]"
													 main-health-elements="[[mainHealthElements]]" health-elements="[[healthElements]]" contacts="[[allContacts]]"
													 services-map="[[servicesMap]]" i18n="[[i18n]]" language="[[language]]"
													 resources="[[resources]]"></dynamically-loaded-form>
						</template>
						<template id="formsRepeat" is="dom-repeat" items="[[dof.forms]]" as="form">
							<template is="dom-if" if="[[form.id]]">
								<dynamically-loaded-form id="dynamicallyLoadedForm" api="[[api]]" user="[[user]]" patient="[[patient]]" form-id="[[form.id]]" contact="[[dof.ctc]]"
														 current-contact="[[currentContact]]"
														 main-health-elements="[[mainHealthElements]]" health-elements="[[healthElements]]" contacts="[[allContacts]]"
														 services-map="[[servicesMap]]" i18n="[[i18n]]" language="[[language]]"
														 resources="[[resources]]" on-edit-form="edit" on-form-deleted="formDeleted" on-new-service="_newService"
														 on-data-change="_refreshFromServices" on-new-report="newReport" subcontact-type="[[subcontactType]]"></dynamically-loaded-form>
							</template>
							<template is="dom-repeat" items="[[form.docs]]">
								<dynamic-doc api="[[api]]" user="[[user]]" patient="[[patient]]" document-id="[[_documentId(item)]]" i18n="[[i18n]]" language="[[language]]"
											 resources="[[resources]]" title="[[item.label]]" downloadable="true" preview="true"></dynamic-doc>
							</template>
						</template>
					</template>
					</div>
				</template>
			</div>
			<div id="floating-action-bar" class="floating-action-bar">
				<template is="dom-if" if="[[_hasCurrentContact(contacts)]]">
					<template is="dom-if" if=[[!showAddFormsContainer]]>
						<paper-button class="add-forms-btn action-btn" on-tap="_toggleAddActions"><iron-icon icon="[[_actionIcon(showAddFormsContainer)]]" ></iron-icon>[[localize('add_for','Add forms',language)]]</paper-button>
					</template>
					<template is="dom-if" if=[[showAddFormsContainer]]>
						<div class="paper-fab-container">
							<paper-button class="close-add-forms-btn action-btn" on-tap="_toggleAddActions"><iron-icon icon="[[_actionIcon(showAddFormsContainer)]]" ></iron-icon>[[localize('clo','Close',language)]]</paper-button>
							<div class="add-forms-container">
								<!--<paper-fab-speed-dial-action icon="vaadin:chart-line" on-tap="addMedicalHistory">[[localize('med_his','Medical history',language)]]</paper-fab-speed-dial-action>-->
								<paper-fab-speed-dial-action icon="vaadin:doctor-briefcase" on-tap="addConsultation">[[localize('con','Consultation',language)]]</paper-fab-speed-dial-action>
								<paper-fab-speed-dial-action icon="vaadin:records" on-tap="addOther">[[localize('oth_for','Other form',language)]]</paper-fab-speed-dial-action>
								<paper-fab-speed-dial-action icon="editor:attach-file" on-tap="addDocument">[[localize('add_doc','Add document',language)]]</paper-fab-speed-dial-action>
							</div>
						</div>
					</template>
					<div id="prescribeBtnCtnr" on-tap="_displayPrescriptionError">
						<!--<paper-button id="prescribeBtn" class="prescribe-btn action-btn" on-tap="_prescribe" disabled="[[!_canPrescribe(api.tokenId,patient.ssin,servicesMap.*,currentContact.services.*,_drugsRefresher)]]">-->
						<paper-button id="prescribeBtn" class="prescribe-btn action-btn" on-tap="_prescribe">
							<iron-icon icon="vaadin:pills" ></iron-icon>
							[[localize('pre','Prescribe',language)]]
						</paper-button>
					</div>
					<div id="procedureBtnCtnr">
						<paper-button id="procedureBtn" class="procedure-btn action-btn" on-tap="_planAction">
							<iron-icon icon="vaadin:tools" ></iron-icon>
							[[localize('proc','Procedure',language)]]
						</paper-button>
					</div>
					<div id="invoicingBtnCtnr">
						<paper-button id="invoicingBtn" class="invoicing-btn ac.detail-panel div.paragraph-contenttion-btn"  on-tap="_invoicing">
							<iron-icon icon="vaadin:invoice" ></iron-icon>
							[[localize('inv','Invoice',language)]]
						</paper-button>
					</div>
				</template>
			</div>
			<paper-tooltip for="prescribeBtnCtnr" position="top">
				<template is="dom-if" if="[[_canPrescribe(api.tokenId,patient.ssin,servicesMap.*,currentContact,currentContact.services,currentContact.services.*)]]">[[localize('pre_thi_but_to_pre','Press this button to prescribe',language)]]<br></template>
				<template is="dom-if" if="[[!api.tokenId]]">[[localize('you_mus_be_con_to_ehe_to_be_all_to_pre','You must be connected to eHealth to be allowed to prescribe',language)]]<br></template>
				<template is="dom-if" if="[[!_validSsin(patient.ssin)]]">[[localize('the_ni_of_the_pat_is_not_val_or_mis','The niss of the patient is not valid or missing ',language)]]([[patient.ssin]])<br></template>
				<template is="dom-if" if="[[!_hasDrugsToBePrescribed(servicesMap.*,currentContact,currentContact.services,currentContact.services.*)]]">[[localize('add_pre_dru_to_cur_con_to_pre','Add prescription drugs to current contact to prescribe',language)]]</template>
			</paper-tooltip>
		</div>

		<entity-selector id="load-template-dialog" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]" columns="[[reportTemplatesSelectorColumns()]]" data-provider="[[reportTemplatesSelectorDataProvider()]]" on-entity-selected="_reportTemplateSelected"></entity-selector>
		<entity-selector id="add-form-dialog" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]" columns="[[formTemplatesSelectorColumns()]]" data-provider="[[formTemplatesSelectorDataProvider()]]" on-entity-selected="_addedFormSelected"></entity-selector>

		<paper-dialog id="upload-dialog">
			<h2>[[localize('upl_fil','Upload files',language)]]<span class="extra-info">(PDF, images and videos)</span></h2>
			<paper-fab class="close-button-icon" icon="icons:close" dialog-dismiss></paper-fab>
			<vaadin-upload id="vaadin-upload" no-auto files="{{files}}" accept="video/*,image/*,application/pdf,text/xml,application/xml,text/plain" target="[[api.host]]/document/{documentId}/attachment/multipart;jsessionid=[[api.sessionId]]" method="PUT" form-data-name="attachment" on-upload-success="_fileUploaded"></vaadin-upload>
		</paper-dialog>

		<paper-dialog id="loadingPrescriptionDialog">
			<h2>[[localize('loa_pre','Loading prescription...',language)]]</h2>
			<paper-progress class="prescription-progress-bar" indeterminate></paper-progress>
		</paper-dialog>

		<paper-dialog id="prescriptionDialog">
			<h2 class="modal-title">[[localize('pri_pre','Print prescription',language)]]</h2>
			<vaadin-grid id="entities-list" class="material" overflow="bottom" items=[[_drugsToBePrescribed(currentContact.services.*,_drugsOnPrescriptions.*,servicesMap.*,_drugsRefresher)]] active-item="{{activeDrug}}">
				<vaadin-grid-column width="100px">
					<template class="header">
						<vaadin-grid-sorter path="description">[[localize('dru_des','Drug descr.',language)]]</vaadin-grid-sorter>
					</template>
					<template>
						<div class="cell frozen">[[_drugDescription(item)]]</div>
					</template>
				</vaadin-grid-column>
				<vaadin-grid-column width="200px">
					<template class="header">
						Posology
					</template>
					<template>
						<div class="cell frozen">[[_drugPosology(item)]]</div>
					</template>
				</vaadin-grid-column>
				<template is="dom-repeat" items="[[_splitColumns(currentContact.services.*,_drugsOnPrescriptions,_drugsOnPrescriptions.*, servicesMap.*)]]" as="column" index-as="columnIndex">
					<vaadin-grid-column flex-grow="0" width="50px">
						<template class="header">
							[[_columnName(columnIndex)]]
						</template>
						<template>
							<vaadin-checkbox id="[[item.id]]:[[columnIndex]]" disabled="[[!_enabled(columnIndex,index,_drugsOnPrescriptions,_drugsOnPrescriptions.*)]]" checked="[[_drugOnPrescription(item,columnIndex)]]" on-checked-changed="_setDrugOnPrescription"></vaadin-checkbox>
						</template>
					</vaadin-grid-column>
				</template>
			</vaadin-grid>
			<div class="endline">
				<vaadin-date-picker id="deliveryDate" label="Date de délivrance" value="[[deliveryDateString]]" i18n="[[i18n]]"></vaadin-date-picker>
				<template is="dom-if" if="[[patient.ssin]] && [[api.tokenId]]">
					<paper-radio-group selected="{{selectedFormat}}">
						<paper-radio-button name="A4">Format A4</paper-radio-button>
						<paper-radio-button name="presc">Format prescription</paper-radio-button>
					</paper-radio-group>
				</template>
				<div class="buttons">
					<paper-button class="modal-button" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
					<paper-button class="modal-button modal-button--save" dialog-confirm autofocus on-tap="_printPrescriptions">[[localize('pri','Print',language)]]</paper-button>
				</div>
			</div>
		</paper-dialog>

		<ht-pat-invoicing-dialog id="invoicingForm" api="[[api]]" user="[[user]]" language="[[language]]" patient="[[patient]]" current-contact="[[currentContact]]" i18n="[[i18n]]" resources="[[resources]]"></ht-pat-invoicing-dialog>

		<paper-dialog id="prose-editor-dialog" no-cancel-on-outside-click no-cancel-on-esc-key>
			<h2 class="modal-title">New Report</h2>
			<prose-editor id="prose-editor" on-refresh-context="_refreshContext"></prose-editor>
			<div class="buttons">
				<div class="fleft">
					<paper-button class="modal-button" on-tap="saveTemplate">[[localize('sav_temp','Save template',language)]]</paper-button>
					<paper-button class="modal-button" on-tap="loadTemplate">[[localize('load_temp','Load template',language)]]</paper-button>
					<paper-button class="modal-button" on-tap="printDocument">[[localize('print','Print',language)]]</paper-button>
				</div>
				<paper-button class="modal-button" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
				<paper-button class="modal-button modal-button--save" dialog-confirm autofocus on-tap="saveDocument">[[localize('save','Save',language)]]</paper-button>
			</div>
		</paper-dialog>
		<canvas id="barCode"></canvas>
	</template>
	<script>

import _ from 'lodash/lodash';
import JsBarcode from 'JsBarcode';
import moment from 'moment/src/moment';
import '../prose-editor/prose-editor/prose-editor';
import mustache from "mustache/mustache.js";
import * as evaljs from "evaljs"

		class HtPatDetailCtcDetailPanel extends Polymer.TkLocalizerMixin(Polymer.Element) {
			static get is() {
				return 'ht-pat-detail-ctc-detail-panel';
			}

			static get properties() {
				return {
					contacts: {
						type: Array,
						value: function () {
							return [];
						},
						observer: '_contactsChanged'
					},
					allContacts: {
						type: Array,
						value: function () {
							return [];
						},
						observer: '_allContactsChanged'
					},
					servicesMap: {
						type: Object,
						value: null
					},
					api: {
						type: Object
					},
					list: {
						type: Boolean,
						value: false
					},
					table: {
						type: Boolean,
						value: false
					},
					graphique: {
						type: Boolean,
						value: false
					},
					doc: {
						type: Boolean,
						value: true
					},
					user: {
						type: Object
					},
					patient: {
						type: Object
					},
					currentContact: {
						type: Object,
						value: null
					},
					contactsFormsAndDocuments: {
						type: Array,
						value: function () {
							return [];
						}
					},
					healthElements: {
						type: Array,
						value: function () {
							return [];
						}
					},
					showDetailsFiltersPanel: {
						type: Boolean,
						value: false
					},
					detailPanelItems: {
						type: Array,
						value: function () {
							return [{ icon: "icure-svg-icons:laboratory",filter:[{type:'CD-ITEM',code:['parameter']}], title: {en: "Lab Results", fr:"Résultats du laboratoires", nl:"Lab Results"}, id: "LabResults" },
								{ icon: "icure-svg-icons:prescription", filter:[{type:'CD-ITEM',code:['treatment']}],  title: {en: "Prescription", fr:"Prescription", nl:"Prescription"}, id: "Prescription" },
								{ icon: "icure-svg-icons:blood-sugar", filter:[{type:'CD-PARAMETER',code:['bloodsugar']}],  title: {en: "BloodSugar", fr:"Analyse de sang", nl:"BloodSugar"}, id: "BloodSugar" },
								{ icon: "icure-svg-icons:blood-pressure", filter:[{type:'CD-PARAMETER',code:['sbp','dbp']}],  title: {en: "BloodPressure", fr:"Pression sanguine", nl:"BloodPressure"}, id: "BloodPressure" },
								{ icon: "icure-svg-icons:blood-pressure", filter:[{type:'CD-PARAMETER',code:['weight','height','bmi']}],  title: {en: "Biometries", fr:"Biométries", nl:"Biometries"}, id: "Biometry" }];
						}
					},

			files: {
				type: Array
			},
			_drugsOnPrescriptions: {
				type: Array
			},
			showAddFormsContainer: {
				type: Boolean,
				value: false
			},
			deliveryDateString: {
				type: String,
				value: moment().format("YYYY-MM-DD")
			},
			_drugsRefresher: {
			    type: Number,
				value: 0
			},
            hiddenSubContactsId: {
                type: Object,
                value: {}
            },
            isLoadingDoc: {
			    type: Boolean,
                value: false
            },
            globalHcp: {
			    type: Object,
                value: null
            },
            selectedFormat: {
			    type: String,
                value: 'A4'
            },
            subcontactType: {
                type: Array,
                value: () => []
            },
            proseJsonContent: {
                type: Object,
                value: null
            }
		};
	}

			static get observers() {
				return ['_filesChanged(files.*)','_setPrintSize(selectedFormat)'];
			}

			constructor() {
				super();
			}

	ready() {
	    super.ready();
        this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(tempHcp => this.set('globalHcp',tempHcp))
			.then(() => this.api.code().findPaginatedCodes('be', 'BE-CONTACT-TYPE', '')
            .then(ct =>this.set("subcontactType", _.orderBy(ct.rows, ['code'], ['asc']))))

				this.set('selectedFormat', localStorage.getItem('prefillFormat') ? localStorage.getItem('prefillFormat') : 'A4')
			}

			_activeIconClass(selected) {
				return selected ? 'icn-selected' : ''
			}

			_setPrintSize() {
				localStorage.setItem('prefillFormat', this.selectedFormat)
			}

			_onDrag(e) {
				if (this._hasCurrentContact(this.contacts) && e && e.dataTransfer && e.dataTransfer.items && _.find(e.dataTransfer.items, i => i.kind === 'file')) {
					this.addDocument();
				}
			}

			_toggleAddActions() {
				this.showAddFormsContainer = !this.showAddFormsContainer;
			}

			_refreshFromServices() {
				this.set('_drugsRefresher', this._drugsRefresher + 1)


			}

			_actionIcon(showAddFormsContainer) {
				return showAddFormsContainer ? 'icons:close' : 'icons:add';
			}

			shouldSave() {
				const dynamicallyLoadedForm = this.shadowRoot.querySelector('#dynamicallyLoadedForm');
				return dynamicallyLoadedForm && dynamicallyLoadedForm.shouldSave();
			}

			flushSave() {
				const dynamicallyLoadedForm = this.shadowRoot.querySelector('#dynamicallyLoadedForm');
				dynamicallyLoadedForm && dynamicallyLoadedForm.flushSave();
			}

			_documentId(svc) {
				const content = this.api.contact().preferredContent(svc, this.language)
				return content && content.documentId
			}

			_planAction() {
				this.dispatchEvent(new CustomEvent("plan-action", {composed: true, bubbles: true,detail: this.currentContact.services.filter(svc => svc.label==="Actes")[0]}))
			}

			_filesChanged() {
				if (!this.currentContact) {
					return;
				}
				const files = _.clone(this.files);
				const vaadinUpload = this.$['vaadin-upload'];

				Promise.all(files.filter(f => !f.attached).map(f => {
					f.attached = true;
					return this.api.document().newInstance(this.user, null, { documentType: 'result', mainUti: this.api.document().uti(f.type), name: f.name }).then(d => this.api.document().createDocument(d)).then(d => {
						f.doc = d;
						f.uploadTarget = (f.uploadTarget || vaadinUpload.target).replace(/\{documentId\}/, d.id);
						return f;
					});
				})).then(files => {
					files.length && vaadinUpload.uploadFiles(files);
				});
			}

			_fileUploaded(e) {
				if (!this.currentContact) {
					return;
				}
				const vaadinUpload = this.$['vaadin-upload'];
				const f = e.detail.file;
				const d = f.doc;

				let sc = this.currentContact.subContacts.find(sbc => (sbc.status || 0) & 64);
				if (!sc) {
					sc = { status: 64, services: [] };
					this.currentContact.subContacts.push(sc);
				}
				const svc = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: d.id, stringValue: f.name }]]), label: 'document' });
				this.currentContact.services.push(svc);
				sc.services.push({ serviceId: svc.id });
				if (!vaadinUpload.files.find(f => !f.complete && !f.error)) {
					this.saveCurrentContact().then(c => this._contactsChanged());
				}
				console.log(vaadinUpload.files)
			}

			_invoicing(){
				this.$.invoicingForm.open()
			}

			_ch4(){
				this.$.ch4Form.open()
			}

			addForm(templateGuid) {
				this.set('showAddFormsContainer', false);
				this.api.hcparty().getCurrentHealthcareParty().then(hcp => this.api.form().getFormTemplatesByGuid(templateGuid, ((hcp.specialityCodes||[])[0] && hcp.specialityCodes[0].code || 'deptgeneralpractice').replace(/persphysician/, 'deptgeneralpractice'))).then(formTemplates => {
					console.log("FTs: " + formTemplates.size + " FTs loaded");
					if (formTemplates[0] && formTemplates[0].id) {
						//Create a new form and link it to the currentContact
						this.api.form().newInstance(this.user, this.patient, { contactId: this.currentContact.id, formTemplateId: formTemplates[0].id, descr: formTemplates[0].name }).then(f => this.api.form().createForm(f)).then(f => {
							this.currentContact.subContacts.push({ formId: f.id, services: [] });
							return this.saveCurrentContact();
						}).then(c => this._contactsChanged());
					}
				}).catch(e => console.log("FTs: error " + e));
			}

			addConsultation() {
				this.set('showAddFormsContainer', false);
				const prefForms = this.user.properties.find(p => p.type.identifier === 'org.taktik.icure.preferred.forms');
				if (prefForms && prefForms.typedValue) {
					const formsMap = JSON.parse(prefForms.typedValue.stringValue);
					this.addForm(formsMap['org.taktik.icure.form.standard.consultation']);
				} else {
                    this.addForm("FFFFFFFF-FFFF-FFFF-FFFF-CONSULTATION");
				}
			}

			addMedicalHistory() {
				this.set('showAddFormsContainer', false);
				const prefForms = this.user.properties.find(p => p.type.identifier === 'org.taktik.icure.preferred.forms');
				if (prefForms && prefForms.typedValue) {
					const formsMap = JSON.parse(prefForms.typedValue.stringValue);
					this.addForm(formsMap['org.taktik.icure.form.standard.medicalhistory']);
				}
			}

			addOther() {
				this.set('showAddFormsContainer', false);
				this.$['add-form-dialog'].open();
			}

			addDocument() {
				this.set('showAddFormsContainer', false);
				this.$['upload-dialog'].open();
			}

			_validSsin(ssin) {
				return ssin && ssin.length > 9;
			}

			_hasDrugsToBePrescribed(ssin) {
				return this._drugsToBePrescribed().length > 0;
			}

			_canPrescribe(tokenId, ssin) {
				return tokenId && this._validSsin(ssin) && this._hasDrugsToBePrescribed();
			}

			_drugsToBePrescribed() {
				return this.api && this.currentContact && this.currentContact.services && this.currentContact.services.filter(s => s.tags.find(t => t.type === 'CD-ITEM' && t.code === 'treatment') && !s.endOfLife && !s.tags.find(t => t.type === 'CD-LIFECYCLE' && ['ordered', 'completed', 'delivered'].includes(t.code)) && this.api.contact().medicationValue(s, this.language)) || [];
			}

			_prescribe(e) {
				e.stopPropagation();
				this.$.prescriptionDialog.open();
			}

			hideAll() {
				this.set('list', false);
				this.set('table', false);
				this.set('doc', false);
				this.set('graphique', false);
			}

			_list(e) {
				this.hideAll();
				this.set('list', true);
			}

			_table(e) {
				this.hideAll();
				this.set('table', true);
			}

			_graphique(e) {
				this.hideAll();
				this.set('graphique', true);
			}

			_default(e) {
				this.hideAll();
				this.set('doc', true);
			}

			_drugDescription(svc) {
				return svc && this.api.contact().medication().medicationNameToString(this.api.contact().medicationValue(svc, this.language), this.language) || "N/A";
			}

			_drugPosology(svc) {
				return svc && this.api.contact().medication().posologyToString(this.api.contact().medicationValue(svc, this.language), this.language) || "N/A";
			}

			_safeDrugsOnPrescriptions() {
				return this._drugsOnPrescriptions || this._drugsToBePrescribed().map((s, idx) => ({ id: s.id, column: Math.floor(idx / 5) }));
			}

			_splitColumns() {
				const drugs = this._drugsToBePrescribed();
				const columns = this._safeDrugsOnPrescriptions().reduce((columns, mark) => {
					const id = mark.id;
					if (this.patient.ssin && this.api.tokenId) {
						const column = mark.column;
						(columns[column] || (columns[column] = [])).push(id)
					} else {
						(columns[0]).push(id)
					}
					return columns;
				}, [[]]);

				if (!columns.find(c => !c || !c.length) && columns.length < drugs.length) {
					columns.push([]);
				}
				return columns;
			}

			_drugOnPrescription(svc, index) {
				const col = this._splitColumns()[index];
				return svc && col && col.includes(svc.id);
			}

			_setDrugOnPrescription(e) {
				const id = e.target.id.split(':')[0];
				const column = parseInt(e.target.id.split(':')[1]);

				if (!id || id.length === 0 || !column && column !== 0) {
					return;
				}

				const current = this._safeDrugsOnPrescriptions().map(x => ({ id: x.id, column: x.column }));

				const mark = current.find(m => m.id === id);

				if (mark) {
					mark.column = column;
				} else {
					current.push({ id: id, column: column });
				}

				if (!_.isEqual(current, this._drugsOnPrescriptions)) {
					this.set('_drugsOnPrescriptions', current);
				}
			}

			_enabled(column, line) {
				if (line === undefined) {
					return true;
				}

				const dop = this._safeDrugsOnPrescriptions();
				if (dop.length < 5) {
					return true;
				}

				const sums = dop.reduce((sums, i) => {
					sums[i.column] = (sums[i.column] || 0) + 1;return sums;
				}, []);

				if ((sums[column] || 0) < 5) {
					return true;
				}

				const ids = this._drugsToBePrescribed().map(d => d.id);
				const id = ids[line];
				return dop.find(x => x.id === id && x.column === column) || false;
			}

			_displayPrescriptionError() {
				this.$.prescriptionError.classList.add("notification");
				setTimeout(() => this.$.prescriptionError.classList.remove("notification"), 8000);
			}

			isAuth() {
				return (this.patient.ssin && this.api.tokenId)
			}

			_pdfReport(drugsToBePrescribed,toPrint,size) {
				this.api.pdfReport(mustache.render(toPrint, null),{
					paperWidth: this.patient.ssin && this.api.tokenId && size == 'A4' ? 210 : 105,
					paperHeight: this.patient.ssin && this.api.tokenId && size == 'A4' ? 297 : 210,
					marginLeft: 5,
					marginRight: 5,
					marginTop: 5,
					marginBottom: 5
				})
						.then(data => {
							let blob = new Blob([data], {type: 'application/pdf'});
							let url = window.URL.createObjectURL(blob)
							let a = document.createElement("a");
							document.body.appendChild(a);
							a.style = "display: none;";
							a.href = url;
							a.download = "presc_" + this.patient.lastName+"_"+this.patient.firstName + "_" + moment() + ".pdf";
							a.click();
							window.URL.revokeObjectURL(url);
						}).finally(()=>{
					drugsToBePrescribed.forEach(s => {
						const tag = s.tags.find(t => t.type === 'CD-LIFECYCLE')
						if (tag) {
							tag.id = 'CD-LIFECYCLE|ordered|1';
							tag.code = 'ordered'
						} else {
							s.tags.push(this.api.code().normalize({id: 'CD-LIFECYCLE|ordered|1'}))
						}
					}) // forEach end
					this.saveCurrentContact().then(() => this._refreshFromServices())
				})
			}

			_printPrescriptions(e) {
				this.$.loadingPrescriptionDialog.open();
				const drugsToBePrescribed = this._drugsToBePrescribed();
				const splitColumns = this._splitColumns().filter(c => c && c.length > 0)
				const element = this.root.querySelector("#barCode");
				let rid = [] //this must be an array
				let toPrint = undefined
				this.set('selectedFormat', (this.patient.ssin && this.api.tokenId) ? this.selectedFormat : 'presc')
				if (this.patient.ssin && this.api.tokenId) { // if ehealth connected
					console.log("with recip-e")
					this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp => Promise.all(splitColumns.map(c => this.api.fhc().Recipecontroller().createPrescriptionUsingPOST(this.api.keystoreId, this.api.tokenId, "persphysician", hcp.nihii, hcp.ssin, hcp.lastName, this.api.credentials.ehpassword, {
						patient: this.patient,
						hcp: hcp,
						feedback: false,
						medications: drugsToBePrescribed.filter(s => c.includes(s.id)).map(s => this.api.contact().medicationValue(s, this.language)),
						deliveryDate: moment(this.deliveryDateString).format("YYYYMMDD")
					}).then(prescri => {
						rid.push(prescri.rid)
						drugsToBePrescribed.filter(s => c.includes(s.id)).map(s => this.api.contact().medicationValue(s, this.language)).map(mv => mv.prescriptionRID = prescri.rid)
					} )))) //push the presci.rid to the rid array
							.finally(()=>{
								toPrint = this._formatPrescriptionsBody(splitColumns,drugsToBePrescribed,this.patient,this.globalHcp,moment(this.deliveryDateString).format("YYYYMMDD"),element,rid)
								this._pdfReport(drugsToBePrescribed,toPrint,this.selectedFormat)
							})
				} else {
					console.log("no recip-e")
					toPrint = this._formatPrescriptionsBody(splitColumns,drugsToBePrescribed,this.patient,this.globalHcp,moment(this.deliveryDateString).format("YYYYMMDD"),element,rid)
					this._pdfReport(drugsToBePrescribed,toPrint,this.selectedFormat)
				}
				this.$.loadingPrescriptionDialog.close();
			} // print end

			_formatPrescriptionsBody(splitColumns,drugsToBePrescribed,patient,hcp,deliveryDate,element,rid) {
				console.log('_formatPrescriptionsBody, hello hcp is : ',hcp)
				let prescriToPrint = [], allPages = []
				let prescNum = 0, pageNum = 1

				splitColumns.forEach((c, idx) => {
					const colId = splitColumns.indexOf(c)
					console.log('c',c,'idx',idx,'colId',colId)
					JsBarcode(element, rid[colId] ? rid[colId] : hcp.nihii, {format: "CODE128A", displayValue: false, height: 75});
					const jpegUrl = element.toDataURL("image/jpeg");
					const ridIdx = (rid[colId] ? rid[colId] : hcp.nihii).split('').join('&nbsp;')
					prescNum += 1
					const prescriByPage = this.selectedFormat == 'A4' ? 2 : 1
					if (prescNum > prescriByPage * pageNum) { // if doesn't fit in page
						pageNum += 1 // add a page
					} // will be set on next page

					let prescArray = [], posology = {}
					_.flatMap(drugsToBePrescribed.filter(s => c.includes(s.id)), s => {
						const medicationApi = this.api.contact().medication();
						const med = this.api.contact().medicationValue(s, this.language);
						const medPoso = this.api.contact().medication().posologyToString(med, this.language) || "N/A";
						const medR = medicationApi.medicationNameToString(med, this.language)
						const medS = medicationApi.posologyToString(med, this.language)
						const thisMed = {'S': medS, 'R': medR, 'poso':medPoso};
						prescArray.push(thisMed) // add to the medications list
					}) // flatmap end
					console.log("prescArray",prescArray)

					let prescriContent = ""
					let articlePoso = []
					let articleMedWithPoso = []
					let medicName = ""
					prescArray.map(onePrescri => { // create prescription content
						prescriContent += `<article>
                    <p class="bigtxt"><span class="bold bigtxt">R/</span> ${onePrescri.R}</p>
                    <p class="bigtxt"><span class="bold bigtxt">S/</span> ${onePrescri.S}</p>
                </article>`;
						articlePoso.push(onePrescri.poso) // add posology to the list
						articleMedWithPoso.push({medR: onePrescri.R, poso: onePrescri.poso})//add medication with posology to the list
						medicName = onePrescri.R
					}) // map end
					const prescri = (this.patient.ssin && this.api.tokenId && rid[colId]) ? `<article class="prescription">
                <header>
                    <img src="${jpegUrl}" alt="code-bar">
                    <div class="barcode-num">${ridIdx}</div>
                    <hr>
                    <h2>Preuve de prescription électronique</h2>
                    <hr>
                    <p class="center">Veuillez présenter ce document au pharmacien pour scanner le code-barres et délivrer les médicaments prescrits</p>
                    <hr>
                    <div class="profile">
                        <small>Nom et prénom du prescripteur&nbsp;:</small>
                        <ul class="prescripteur-details">
                            <li><b>${hcp.firstName} ${hcp.lastName}</b></li>
                            <li><b>INAMI&nbsp;:</b> ${hcp.nihii}</li>
                        </ul>
                    </div>
                    <hr>
                    <div class="profile">
                        <small>Nom et prénom du patient&nbsp;:</small>
                        <ul class="patient-details">
                            <li><b>${this.patient.firstName} ${this.patient.lastName}</b></li>
                            <li><b>NISS&nbsp;:</b> ${this.patient.ssin}</li>
                        </ul>
                    </div>
                    <hr>
                </header>
                <h2>Contenu de la prescription électronique</h2>
                <hr>
                <div class="prescription-content">
                    ${prescriContent}
                </div>
                <footer>
                    <hr>
                    <p class="center">Aucun ajout manuscrit ne sera pris en compte</p>
                    <hr>
                    <small class="center">Date&nbsp;:</small>
                    <p class="center">${deliveryDate}</p>
                    <hr>
                    <small class="center">Délivrable à partir du&nbsp;:</small>
                    <p class="center">${deliveryDate}</p>
                </footer>
            </article>` : prescriContent; // create single prescription body
					prescriToPrint.push({name:medicName,'prescriBody':prescri,'page':pageNum,'posology':articlePoso, 'medWithPosology': articleMedWithPoso,'myRid':ridIdx, 'myJpegUrl':jpegUrl}) // add a prescription with its datas
				}) // splitCol forEach end
				console.log("prescriToPrint",prescriToPrint)

				console.log("allPages before map",allPages)
				prescriToPrint.map((prescri)=>{ // for every prescription found in list
					let singlePage = {body:'',poso:[],rid:'',jpegUrl: ''}
					singlePage.body += (prescri.prescriBody) // get the body
					singlePage.name = prescri.name
					singlePage.rid = prescri.myRid
					singlePage.jpegUrl = prescri.myJpegUrl
					prescri.medWithPosology.map((poso)=>{ // check if there's posology
						singlePage.poso.push(poso)
					})
					if (!allPages[prescri.page-1]) {
						allPages.push([singlePage]) // assign posology to prescription
					} else {
						allPages[prescri.page-1].push(singlePage)
					}
				})
				console.log("allPages after map",allPages)
				let onePageBody = ""
				allPages.map((onePage)=>{
					let posoByDay = { // make the arrays that will receive sorted posologies
								'byMoment':[],
								'byHour':[]
							},
							posoByWeek = [],
							posoByMonth = []
					if (typeof onePage == 'object') {
						let posoTable = ''
						let thatBody = ''
						onePage.map((onePrescription)=>{
							let singleName = onePrescription.name
							thatBody += onePrescription.body
							if (this.patient.ssin && this.api.tokenId && rid && rid.length>0) {
								onePrescription.poso.map((singlePoso)=>{posoTable += "<tr><td><b>"+singlePoso.medR+"</b></td><td>"+singlePoso.poso.toString()+"</td></tr>"}) // construct the posology body
							}
						})
						if (this.patient.ssin && this.api.tokenId && rid && rid.length>0) {
							const onePageBodyTop = `<div class="page"><main>${thatBody}</main><footer><table><thead><tr><td>Nom</td><td>Fréquence</td></tr></thead><tbody>`; // prepare the PDF's pages
							const onepageBodyBottom = `</tbody></table></footer></div>`;
							onePageBody += onePageBodyTop+posoTable+onepageBodyBottom;
						} else {
							onePageBody = `<div class="page">
                        <header id="header" class="flexbox vert bt center">
                            <div class="horiz">
                                <div class="cell br w50 p1025">
                                    <img class="codbar" src="${onePage[0].jpegUrl}" alt="code-bar">
                                    <span>${onePage[0].rid}</span>
                                </div>
                                <div class="cell w50">
                                    <p>Nom et prénom du prescripteur</p>
                                    <p class="bold">Dr. ${hcp.lastName} ${hcp.firstName}</p>
                                </div>
                            </div>
                        </header>
                        <div class="horiz w100">
                            <div class="vert bt bb flex1">
                                <p class="uppercase">À remplir par le prescripteur</p>
                                <p>Nom et prénom du bénéfiniciaire : <span class="bold">${this.patient.firstName} ${this.patient.lastName}</span></p>
                            </div>
                        </div>
                        <main id="main" class="flexbox flex1 horiz bb">
                            <div class="cell br w33">
                                <p>Réservé à la vignette de conditionnement</p>
                            </div>
                            <div class="cell">
                                ${thatBody}
                            </div>
                        </main>
                        <footer id="footer" class="flex horiz bb">
                            <div class="flex1 cell br w50">
                                <p class="title bold center w100">Cachet du prescripteur</p>
                                <ul>
                                    <li>Dr. ${hcp.lastName} ${hcp.firstName}</li>
                                    {{#hcp.addresses[0].street}}
                                        <li>$(hcp.addresses[0].street}{{#hcp.addresses[0].houseNumber}}, $(hcp.addresses[0].houseNumber}{{/hcp.addresses[0].houseNumber}}</li>
                                    {{/hcp.addresses[0].street}}
                                    {{#hcp.addresses[0].city}}
                                        <li class="uppercase">{{#hcp.addresses[0].postalCode}}$(hcp.addresses[0].postalCode} - {{/hcp.addresses[0].postalCode}} $(hcp.addresses[0].city}</li>
                                    {{/hcp.addresses[0].city}}
                                    {{#hcp.addresses[0].telecoms}}
                                        <li>{{telecomType}}$nbsp;: {{telecomNumber}}</li>
                                    {{/hcp.addresses[0].telecoms}}
                                    <li><span class="uppercase">INAMI</span>&nbsp;: ${hcp.nihii}</li>
                                </ul>
                            </div>
                            <div class="w50">
                                <div class="vert w100">
                                    <div class="cell bb center">
                                        <p class="mt0">Date et signature du prescripteur</p>
                                        <p>${deliveryDate}</p>
                                    </div>
                                    <div class="cell">
                                        <p class="center">Délivrable à partir de la date précisée ou à partir du&nbsp;:</p>
                                        <p class="signdate center bold w100">${deliveryDate}</p>
                                    </div>
                                </div>
                            </div>
                        </footer>
                        <aside>
                            <div class="horiz">
                                <p class="big uppercase center w100 bold fs1">Prescription de medicaments</p>
                            </div>
                        </aside>
                    </div>`;
						} // elif end

					}
				}) // allPage map end
				const toPrint = (this.patient.ssin && this.api.tokenId && rid && rid.length >0) ?
						`<html>
            <head><style>
            body {margin: 0;width: ${this.selectedFormat == 'A4' ? '210mm' : '105mm'};height: ${this.selectedFormat == 'A4' ? '297mm' : '210mm'};}
            body > div.page {display:block;size: A4;margin: 0;width: ${this.selectedFormat == 'A4' ? '210mm' : '105mm'};height: ${this.selectedFormat == 'A4' ? '297mm' : '210mm'};page-break-after: always;display:flex;flex-direction:column;}
            body > div.page:last-child {page-break-after: avoid;}
            body > div.page >main {display: flex;width: 100%;}
            body > div.page > main > article.prescription {padding-top: 15px;width: ${this.selectedFormat == 'A4' ? '105mm' : '100%'};height: ${this.selectedFormat == 'A4' ? '200mm' : '210mm'};overflow: hidden;font-size: 12px;display: flex;flex-direction: column;}
            body > div.page > main > article.prescription:first-child{border-right: ${this.selectedFormat == 'A4' ? '.5px dashed lightgrey' : 'none'};}
            body > div.page > main > article img {display: block;width: 95%;max-height:80px;margin: 0 auto;text-align: center;}
            body > div.page > main > article div.barcode-num {margin: 3px 25px 10px 25px;font-size: 1.2em;text-align: justify;}
            body > div.page > main > article div.barcode-num:after {content: "";display: inline-block;width: 100%;}
            body > div.page > main > article h2 {font-size: .9em;text-transform: uppercase;margin: 5px auto;text-align: center;}
            body > div.page > main > article header p.center {text-align: center;max-width: 80%;margin: 5px auto;}
            body > div.page > main > article .prescription-content p.center {margin:5px;text-align: center;}
            body > div.page > main > article small.center {text-align: center;width: 100%;display: block;margin: 0 auto;}
            body > div.page > main > article hr {border-top: 1px solid darkgrey;border-bottom: 0;margin: 0 10px;}
            body > div.page > main > article div.profile {margin: 0 25px;}
            body > div.page > main > article ul {padding-left: 0;list-style: none;margin-top: 2px;}
            body > div.page > main > article div.prescription-content {display: flex;padding: 0 25px;flex-direction: column;flex: 1;}
            body > div.page > main > article div.prescription-content > article {margin: 7.5px 0;}
            body > div.page > main > article footer p {text-align: center;margin: 2px 0;}
            body > div.page > footer {${this.selectedFormat != 'A4' ? 'display:none;' : ''}border-top: .5px dashed lightgrey;text-align:center;padding:25px 20px 0 20px;}
            body > div.page > footer table {width: 100%;border-collapse: collapse;border-top:1px solid black;}
            body > div.page > footer table:first-child {border-top:none;}
            body > div.page > footer table tr td {border-bottom:1px solid black;text-align: left;}
            body > div.page > footer table tr td:first-child {width:258px;border-right:1px solid black;}
            body > div.page > footer table tr td:not(:first-child){padding: 0 5px;}
            body > div.page > footer table thead {font-weight: bold;border-bottom: 2px solid black;}
            body > div.page > footer table thead tr td {text-align: center;background-color: lightgrey;}
        </style></head><body>${onePageBody}</body></html>`
						: // no eHe connection =
						`<html><head><style>
            /* body */
            body {margin: 0;padding: 0;}
            div.page {display:flex;flex-direction: column;margin: 0;padding:0;padding-top:20mm;width: 105mm;height:200mm;overflow:hidden;page-break-after:always;}
            div.page:last-child {page-break-after: avoid;}
            * {font-size:10px;font-family: Arial,sans-serif;}
            *.bigtxt {font-size:13px;}
            /* flex */
            *.flexbox, *.horiz, *.vert {display: flex;} *.horiz {flex-direction: row;} *.vert {flex-direction: column;} *.flex1 {flex:1;}
            /* elems */
            img.codbar {height:auto;width:100%;background: black;margin-bottom: 5px;} *.signdate {border-bottom: .25px dotted grey;} *.cell {padding: 5px; overflow: hidden;} article {margin-bottom: 15px;} article > p {margin: 0;}
            /* style */
            *.w100 {width:100%} *.w50 {width: 50%;} *.w40 {width:40%;} *.w33 {width: 33%;} *.w20 {width: 20%;}
            *.bold {font-weight: bold;} *.p1025 {padding: 10px 25px;} *.mt0 {margin-top: 0;}
            *.br {border-right: .25px solid black;} *.bt {border-top: .25px solid black} *.bb {border-bottom: .25px solid black}
            *.center {text-align: center;} *.capitalize {text-transform: capitalize;} *.uppercase{text-transform: uppercase;e}
            *.right {text-align: right;} *.fs1 {font-size: 1em;} ul {list-style: none; padding-left: 0}
        </style></head><body>${onePageBody}</body></html>`; // finalize PDF body
				console.log("toPrint",toPrint)
				return toPrint
			}

			_columnName(idx) {
				return `#${idx + 1}`;
			}

			saveCurrentContact() {
				return (this.currentContact.rev ? this.api.contact().modifyContactWithUser(this.user, this.currentContact) : this.api.contact().createContactWithUser(this.user, this.currentContact)).then(c=>this.api.register(c,'contact')).then(c => (this.currentContact.rev = c.rev) && c);
			}

    _reportTemplateSelected(e, reportTemplate) {
	    this.api.doctemplate().getAttachment(reportTemplate.id, reportTemplate.attachmentId).then(attach => {
	        const prose = this.root.querySelector("#prose-editor")
            prose.setJSONContent(this.api.crypto().utils.ua2utf8(attach))
			prose.applyContext((expr, template, ctx, cache) => {
			    return new Promise(function (resolve, reject) {
			        try {
                        const env = new evaljs.Environment(_.assign(ctx, {resolve, reject}));
                        const gen = (env.gen(expr)())
                        let status = {done: false}
                        while (!status.done) {
                            status = gen.next() //Execute lines one by one
                        }

                        if (status.value && status.value.asynchronous) {
                            //Wait for internal resolution
                        } else {
                            resolve(status.value)
                        }
                    } catch (e) {
                        reject(e)
					}
				})
			}, {
			    patient:this.patient,
			    contacts:this.contacts,
                healthElements:this.healthElements,
			    subContact:this.currentContact.subContacts,
                form:this.contactsFormsAndDocuments,
                servicesMap:this.servicesMap,
                user:this.user,
                hcp:this.user.healthcarePartyId,
                language: this.language
			})
		})
    }

	_addedFormSelected(e, formTemplate) {
		formTemplate && this.addForm(e.detail.guid);
	}

			edit(e, form) {
				if (!this.currentContact.subContacts.find(sc => sc.formId === form.id)) {
					this.push('currentContact.subContacts',{ formId: form.id, services: [], healthElementId: form.healthElementId, planOfActionId: form.planOfActionId });
				}
			}

			formDeleted(e, form) {
				this.saveCurrentContact().then(c => this._contactsChanged());
			}

			_hasCurrentContact() {
				return this.contacts.find(c => !c.closingDate) && true;
			}

			_newService(event, detail) {
				if (detail && detail.svc) {
					if (this.servicesMap[detail.svc.label]) {
						this.push(`servicesMap.${detail.svc.label}`, detail);
					} else {
						this.set(`servicesMap.${detail.svc.label}`, [detail]);
					}
				}
			}

			_allContactsChanged() {
				this.set('servicesMap', this.allContacts.reduce((map, ctc) => {
					const svcMap = ctc.subContacts.reduce((svcMap, subContact) => {
						subContact.services.reduce((svcMap, svcLink) => {
							(svcMap[svcLink.serviceId] || (svcMap[svcLink.serviceId] = [])).push(subContact);
							return svcMap;
						}, svcMap);
						return svcMap;
					}, {});

			ctc.services.reduce((map, svc) => {
				(map[svc.label] || (map[svc.label] = [])).push({ svc: svc, scs: svcMap[svc.id] || [], ctc: ctc });
				return map;
			}, map);

					Object.values(map).forEach(arr => arr.sort((a, b) => b.svc.modified - a.svc.modified));

					return map;
				}, {}));
			}

    _virtualForm(services) {
		return {id:null, template:{name:'Other services'}}
	}

	_contactsChanged() {
		this.set('contactsFormsAndDocuments', []);
		if (!this.contacts) {
			return;
		}

				this.set('isLoadingDoc',true)

		const seenForms = {}
		const formGroups = this.contacts.map(contact => ({
			ctc: contact,
			forms: _.sortBy((contact.subContacts.filter(sc => !(sc.formId && seenForms[sc.formId]) && !(sc.id && this.hiddenSubContactsId[sc.id])) || []).map(sc => {
				const serviceIds = sc.services.map(s => s.serviceId);
				return {
					id: sc.formId,
					docs: contact.services.filter(s => serviceIds.includes(s.id) && Object.values(s.content).filter(c => c.documentId).length)
				};
			}), f => -f.created),
			unmappedServices: _.sortBy(contact.services.filter(svc => !contact.subContacts.some(sc => sc.services.some(ssc => ssc.serviceId === svc.id))), 'created')
		}));

				const climbFormHierarchy = function (formIds, formsCache) {
					return (formIds.length ? this.api.form().getForms({ ids: formIds }) : Promise.resolve([])).then(forms => {
						forms.forEach(f => {
							formsCache[f.id] = f;
						});
						const formIds = _.uniq(_.flatten(formGroups.map(fg => fg.forms.filter(f => f.id).map(f => {
							const theForm = formsCache[f.id];
							if (theForm.parent) {
								f.id = theForm.parent;
							} else {
								f.form = formsCache[f.id];
							}
							return f;
						}).filter(f => !f.form).map(f => f.id))));

						return formIds.length ? climbFormHierarchy(formIds.filter(id => !formsCache[id]), formsCache) : formsCache;
					});
				}.bind(this);

				climbFormHierarchy(_.chain(formGroups).map(fg => fg.forms.filter(f => f.id).map(f => f.id)).flatten().uniq().value(), {}).then(() => {
					formGroups.forEach(fg => {
						fg.forms = _.chain(fg.forms.reduce((acc, form) => {
							const slot = acc.find(f => f.id === form.id);
							if (slot) {
								_.concat(slot.docs, form.docs);
							} else {
								acc.push(form);
							}
							return acc;
						}, [])).sortBy(f=>-f.created).value()
					});
					this.set('contactsFormsAndDocuments', _.sortBy(formGroups, fg => -fg.ctc.openingDate));
				}).finally(() => this.set('isLoadingDoc',false));
			}

			toggleDetailsFiltersPanel() {
				this.showDetailsFiltersPanel = !this.showDetailsFiltersPanel;
				this.root.querySelector('#detailsFiltersPanel').classList.toggle('filters-panel--collapsed');
			}

    loadTemplate() {
        this.$['load-template-dialog'].open();
    }

    reportTemplatesSelectorColumns() {
        return [{ key: 'group.name', title: 'Groupe' }, { key: 'name', title: 'Nom' }, { key: 'guid', title: 'GUID' }];
    }

    reportTemplatesSelectorDataProvider() {
        return {
            filter: function (filterValue, limit, offset, sortKey, descending) {
                const regExp = filterValue && new RegExp(filterValue, "i");

                const all = this.allTemplates || (this.allTemplates = Promise.all([
                    this.api.doctemplate().findDocumentTemplatesBySpeciality('deptgeneralpractice'),
                    this.api.doctemplate().findDocumentTemplates()
                ]).then( res => _.chain(res[0].concat(res[1])).uniqBy(x=>x.id).sortBy(['group','name']).value()))

                return all
                    .then(fts => {
                        const filtered = fts.filter(ft => !regExp || ft.name && ft.name.match(regExp) || ft.group && ft.group.name && ft.group.name.match(regExp) || ft.guid && ft.guid.match(regExp));
                        return { totalSize: filtered.length, rows: (descending ? _.reverse(_.sortBy(filtered, sortKey)) : _.sortBy(filtered, sortKey)).slice(0, limit) };
                    });
            }.bind(this)
        };
    }

	formTemplatesSelectorColumns() {
		return [{ key: 'group.name', title: 'Groupe' }, { key: 'name', title: 'Nom' }, { key: 'guid', title: 'GUID' }];
	}

    formTemplatesSelectorDataProvider() {
        return {
            filter: function (filterValue, limit, offset, sortKey, descending) {
                const regExp = filterValue && new RegExp(filterValue, "i");

                const all = this.allTemplates || (this.allTemplates = Promise.all([
                    this.api.form().findFormTemplates(),
                    this.api.form().findFormTemplatesBySpeciality(((this.api.hcParties[this.user.healthcarePartyId]||{}).specialityCodes||[])[0] || 'deptgeneralpractice')
                ]).then( res => _.chain(res[0].concat(res[1])).uniqBy(x=>x.id).sortBy(['group','name']).value()))

                return all
                        .then(fts => {
                            const filtered = fts.filter(ft => !regExp || ft.name && ft.name.match(regExp) || ft.group && ft.group.name && ft.group.name.match(regExp) || ft.guid && ft.guid.match(regExp));
                            return { totalSize: filtered.length, rows: (descending ? _.reverse(_.sortBy(filtered, sortKey)) : _.sortBy(filtered, sortKey)).slice(0, limit) };
                        });
            }.bind(this)
        };
    }

    refreshIcons() {
        Polymer.dom(this.root).querySelector("#serviceFilterPanel").refreshIcons();
    }



    saveDocument() {
        const prose = this.root.querySelector("#prose-editor");
    }


    _dropVarValuesFromProseDocumentJson( inputData ) {

        // First hit
        if(!_.trim(inputData)) inputData = this.proseJsonContent;

        // FZ: refaire avec while bon récursif, jusqu'à fin doc, drop all text values

        _.forEach(inputData.content, (v,k)=>{
            if(_.size(_.get(v, "content", {}))) {
                if( v.type === "variable" ) {
                    if(_.trim(_.get(v, "content[0].text", ""))) v.content[0].text = "";
                    return v;
                } else {
                    return this._dropVarValuesFromProseDocumentJson(v);
                }
            }
        })

    }


    saveTemplate() {
        const prose = this.root.querySelector("#prose-editor");

        this.proseJsonContent = prose.editorView.state.doc.toJSON();
        const proseJsonContentWithoutVars = this._dropVarValuesFromProseDocumentJson();

        console.log(proseJsonContent);
        console.log(proseJsonContentWithoutVars);

        /*
        this.api.message().newInstance(this.user).then(newMessageInstance=>{
            this.api.message().createMessage(_.merge( newMessageInstance, {transportGuid: "DOC:TEMPLATE:PRINT", recipients: [_.get(this.user, 'healthcarePartyId', _.trim(this.hcp.id))]} )).then(createMessageResponse => {
                this.api.document().newInstance(this.user,createMessageResponse,{documentType: 'report',mainUti: this.api.document().uti("prose/json"), name: "Give me a name"}).then(newDocumentResponse => {
                    this.api.document().createDocument(newDocumentResponse).then(createDocumentResponse => {
                        this.api.document().setAttachment(createDocumentResponse.id, null, proseContent).then(setAttachmentResponse => {

                            setAttachmentResponse

                        })
                    })
                })
            })
        });
        */
    }



    _refreshContext(e,eventDetails) {
        const prose = this.root.querySelector("#prose-editor")

        // eventDetails.name
        // eventDetails.expr

        prose.applyContext((expr, template, ctx, cache) => {
            return new Promise(function (resolve, reject) {
                try {
                    const env = new evaljs.Environment(_.assign(ctx, {resolve, reject}));
                    const gen = (env.gen(expr)())
                    let status = {done: false}
                    while (!status.done) {
                        status = gen.next() //Execute lines one by one
                    }

                    if (status.value && status.value.asynchronous) {
                        //Wait for internal resolution
                    } else {
                        resolve({ctx:status.value})
                    }
                } catch (e) {
                    reject(e)
                }
            })
        }, {
            patient:this.patient,
            contacts:this.contacts,
            healthElements:this.healthElements,
            subContact:this.currentContact.subContacts,
            form:this.contactsFormsAndDocuments,
            servicesMap:this.servicesMap,
            user:this.user,
            hcp:this.user.healthcarePartyId,
            language: this.language,
            dataProvider: this.editedReportDataProvider
        })
    }



	newReport(e) {
		this.editedReportDataProvider = e.detail.dataProvider
		this.$['prose-editor-dialog'].open()
        const prose = this.root.querySelector("#prose-editor")
        prose.set("dynamicVars", _.map(this.servicesMap, (v,k)=>{ return {name:k, expr: `dataProvider.getValue("${k}")`} }) );
	}



	_saveReport() {
		//Create document with attachment from prose-editor and ...
        const svc = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: d.id, stringValue: f.name }]]), label: 'document' });
        this.dispatchEvent(new CustomEvent('new-service', {
            detail: {
                ctc: this.currentContact,
                svc: svc,
                scs: this.currentContact.subContacts.filter(sc => sc.formId === this.editedReportDataProvider.getId())
            }, composed: true
        }));
    }



    _getPdfHeader() {

                return `<html>
                            <head>
                                <style>

                                    body {margin: 0;}
                                    @page {size: A4; margin: 0; }

                                    article.page {
                                        width: 210mm;
                                        height: 283mm;
                                        padding: 20px;
                                        overflow:hidden;
                                    }
                                    :host {
                                        background: 0 0;
                                        height: 100%;
                                        width: 100%;
                                        font-family: 'Roboto', sans-serif;
                                        font-size: 13px;
                                        min-height: 100vw;

                                    }

                                    .prose-editor-container{
                                        height: 100%;
                                        display: flex;
                                        flex-flow: column nowrap;
                                        justify-content: space-between;
                                    }

                                    .container {
                                        left: 50%;
                                        transform: translateX(-50%);
                                        position: absolute;
                                    }

                                    .page {
                                        padding: 20px;
                                        outline: 0;
                                        background: #fefefe;
                                        border-radius: 3px;
                                        box-shadow: 0 3px 3px 0 rgba(0, 0, 0, 0.14),
                                        0 3px 4px 0 rgba(0, 0, 0, 0.12),
                                        0 1px 8px 0 rgba(0, 0, 0, 0.20);

                                        width: 555px;
                                        min-height: 801px;
                                        transition: height .2s ease-in;

                                        font-family: 'Roboto', sans-serif;
                                        font-size: 11px;

                                        margin-bottom: 24px;
                                    }

                                    h1 {
                                        font-size: 1.8em;
                                        font-weight: bold;
                                    }

                                    h2 {
                                        font-size: 1.5em;
                                        font-weight: bold;
                                    }

                                    h3 {
                                        font-size: 1.3em;
                                        font-weight: bold;
                                    }

                                    h4 {
                                        font-size: 1em;
                                        font-weight: bold;
                                        text-decoration: underline;
                                    }


                                    h5 {
                                        font-size: 1em;
                                        text-decoration: underline;
                                    }

                                    #editor {
                                        outline: 0;
                                        padding: 20px;
                                    }

                                    .ProseMirror {
                                        outline: 0;
                                        position: relative;
                                        word-wrap: break-word;
                                        white-space: pre-wrap;
                                        -webkit-font-variant-ligatures: none;
                                        font-variant-ligatures: none;
                                    }

                                    .ProseMirror pre {
                                        white-space: pre-wrap;
                                    }

                                    .ProseMirror li {
                                        position: relative;
                                    }

                                    .ProseMirror .tableWrapper {
                                        overflow-x: auto;
                                    }
                                    .ProseMirror table {
                                        border-collapse: collapse;
                                        table-layout: fixed;
                                        width: 100%;
                                        overflow: hidden;
                                        margin: 0;
                                    }

                                    .ProseMirror td, .ProseMirror th {
                                        vertical-align: top;
                                        box-sizing: border-box;
                                        position: relative;
                                    }

                                    .ProseMirror .column-resize-handle {
                                        position: absolute;
                                        right: -2px; top: 0; bottom: 0;
                                        width: 4px;
                                        z-index: 20;
                                        background-color: #adf;
                                        pointer-events: none;
                                    }

                                    .ProseMirror.resize-cursor {
                                        cursor: ew-resize;
                                        cursor: col-resize;
                                    }

                                    /* Give selected cells a blue overlay */
                                    .ProseMirror .selectedCell:after {
                                        z-index: 2;
                                        position: absolute;
                                        content: "";
                                        left: 0; right: 0; top: 0; bottom: 0;
                                        background: rgba(200, 200, 255, 0.4);
                                        pointer-events: none;
                                    }

                                    .ProseMirror th, .ProseMirror td {
                                        min-width: 1em;
                                        border: 1px solid #ddd;
                                        padding: 3px 5px;
                                    }

                                    .ProseMirror-hideselection *::selection {
                                        background: transparent;
                                    }

                                    .ProseMirror-hideselection *::-moz-selection {
                                        background: transparent;
                                    }

                                    .ProseMirror-hideselection {
                                        caret-color: transparent;
                                    }

                                    .ProseMirror-selectednode {
                                        outline: 2px solid #8cf;
                                    }

                                    /* Make sure li selections wrap around markers */

                                    li.ProseMirror-selectednode {
                                        outline: none;
                                    }

                                    li.ProseMirror-selectednode:after {
                                        content: "";
                                        position: absolute;
                                        left: -32px;
                                        right: -2px;
                                        top: -2px;
                                        bottom: -2px;
                                        border: 2px solid #8cf;
                                        pointer-events: none;
                                    }

                                    paper-toolbar {
                                        --paper-toolbar-background: ligh-gray;
                                    }

                                    paper-dropdown-menu {
                                        display:block;
                                        width: 10%;
                                        height: 40px;
                                        margin: 0 4px;
                                        --paper-dropdown-menu-button: {
                                            height: 40px;
                                        };
                                        --paper-dropdown-menu-input: {
                                            height: 40px;
                                        };
                                        --paper-input-container: {
                                            height: 40px;
                                        };
                                        --paper-input-container-input: {
                                        }
                                        --paper-input-container-input-align: center;
                                    }

                                    .toolbar {
                                        width: 100%;
                                        height: 48px;
                                        min-height: 40px;
                                        overflow: hidden;
                                        border-bottom: 1px solid #e0e0e0;
                                        background: #fff;
                                        padding: 0;
                                        display: flex;
                                        flex-flow: row nowrap;
                                        align-items: center;
                                        justify-content: flex-start;
                                        box-sizing: border-box;
                                        padding: 0 8px;
                                    }

                                    .scroll-area {
                                        flex-grow: 1;
                                        width: 100%;
                                        height: 100%;
                                        overflow: auto;
                                        position: relative;
                                        background: var(--app-background-color);
                                        min-height:calc(100vh - 400px);
                                    }

                                    .status-bar {
                                        width: 100%;
                                        height: 38px;
                                        bottom: 0;
                                        overflow: hidden;
                                        padding-top: 5px;
                                        padding-bottom: 5px;

                                        border-top: 1px solid #e0e0e0;
                                        border-bottom: 1px solid #e0e0e0;
                                    }

                                    paper-icon-button:hover{
                                        color: var(--app-text-color);
                                        background: --app-background-color-dark;
                                    }

                                    paper-icon-button{
                                        color: var(--app-text-color-disabled);
                                        border-radius: 50%;
                                        transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
                                    }

                                    paper-icon-button[active] {
                                        color: var(--app-text-color);
                                    }

                                    paper-input.zoom {
                                        padding-left: 8px;
                                        width: 60px;
                                        height: 40px;
                                    }

                                    .divider{
                                        display: block;
                                        border-left: 1px solid #e0e0e0;
                                        height: 100%;
                                        margin: 0 4px;
                                        padding: 0;
                                    }

                                    .dropdown-content paper-item {
                                        cursor: pointer;
                                    }

                                    .ProseMirror table {
                                        margin: 0;
                                    }
                                    .ProseMirror th, .ProseMirror td {
                                        min-width: 1em;
                                        border: 1px solid #ddd;
                                        padding: 3px 5px;
                                    }
                                    .ProseMirror .tableWrapper {
                                        margin: 1em 0;
                                    }

                                </style>
                                </head>
                                <body>`
            }

    _getPdfFooter() {
        return "</body></html>";
    }


    printDocument() {

        const prose = this.root.querySelector("#prose-editor");
        const proseContent = prose.editorView.state.doc.toString();
        const proseContainer = prose.$.container;
        const proseHtmlContent = proseContainer.innerHTML;

        this.api.pdfReport(this._getPdfHeader() + proseHtmlContent + this._getPdfFooter() ).then(pdfFileContent =>{
            this.api.triggerFileDownload( pdfFileContent, "application/pdf", this.localize('rep',this.language) + '-' + this.user.healthcarePartyId + "-" + +new Date() );
        });


    }

}

		customElements.define(HtPatDetailCtcDetailPanel.is, HtPatDetailCtcDetailPanel);
	</script>
</dom-module>
