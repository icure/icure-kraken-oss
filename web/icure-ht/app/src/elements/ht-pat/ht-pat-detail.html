<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/maps-icons.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../filter-panel/filter-panel.html">

<link rel="import" href="../collapse-button/collapse-button.html">

<link rel="import" href="ht-pat-admin-card.html">
<link rel="import" href="ht-pat-detail-ctc-detail-panel.html">
<link rel="import" href="../icons/icure-icons.html">
<link rel="import" href="../../icd-styles.html">

<dom-module id="ht-pat-detail">
	<template>
		<style include="iron-flex iron-flex-alignment"></style>
		<!--suppress CssUnusedSymbol -->
		<style include="icd-styles">
			:host {
				height: 100%;
			}

			.container {
				width: 100%;
				height: calc(100vh - 64px);
				display:grid;
				grid-template-columns: 20% 30% 50%;
				grid-template-rows: 100%;
				position: fixed;
				top: 64px;
				left: 0;
				bottom: 0;
				right: 0;
			}

			.zone {
				height: 100%;
			}


			.sub-sublist{
				padding:0;

			}

			.sub-sublist > paper-item {
				max-height: 30px;
				font-size:12px;
			}

			.padding-0{
				padding:0;
			}

			.one-line-menu {
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				font-weight: 400;
				padding-left:0;
			}

			#first {
				height: calc(100% - 36px);
			}


			paper-fab {
				--paper-fab-mini: {
					height: 28px;
					width: 28px;
					padding: 4px;
				};

				margin-right: 4px;
			}

			.first-panel{
				/*width:20%;
				height:calc(100% - 64px);*/
				height:100%;
				background: var(--app-background-color-dark);
				/*position:fixed;*/
				top:64px;
				left:0;
				@apply --shadow-elevation-3dp;
				grid-column: 1 / 1;
				grid-row:1 / 1;
				z-index:3;
				overflow:hidden;
			}

			#_contacts_listbox {
				padding: 0;
			}

			paper-listbox{
				background:transparent;
				padding: 0;
			}

			paper-item{
				background:transparent;
				outline:0;
				--paper-item-selected:{

				};

				--paper-item-disabled-color:{
					color: red;
				};

				--paper-item-focused: {
					background:transparent;
				};
				--paper-item-focused-before: {
					background:transparent;
				};

			}

			paper-listbox {
				outline:0;
				--paper-listbox-selected-item: {
					color:var(--app-text-color-light);
					background:var(--app-primary-color);
				};
				--paper-listbox-disabled-color:{
					color: red;
				};
			}

			#adminFileMenu paper-item.iron-selected {
				color:var(--app-text-color-light);
				background:var(--app-primary-color);
				@apply --text-shadow;
			}

			paper-listbox.sub-sublist{
				--paper-listbox-selected-item: {
					color:var(--app-text-color-light);
					background:var(--app-primary-color-light);
				};
			}

			collapse-button {
				outline:0;
				--paper-listbox-selected-item: {
					color:var(--app-text-color-light);
					background:var(--app-primary-color);
				}
			}

			collapse-button > .menu-item.iron-selected {
				@apply --padding-right-left-16;
				color:var(--app-text-color-light);
				background:var(--app-primary-color);
				@apply --text-shadow;
			}

			paper-item.opened{
				padding-top: 8px;

			}
			.opened{
				color:var(--app-text-color);
				background:var(--app-text-color-light);
				border-radius:2px 2px 0 0;
				box-shadow: 0 4px 0 0 white,
							0 -2px 0 0 white,
							0 2px 2px 0 rgba(0, 0, 0, 0.14),
							0 1px 5px 0 rgba(0, 0, 0, 0.12),
							0 3px 1px -2px rgba(0, 0, 0, 0.2);

			}

			.opened.iron-selected{
				box-shadow: 0 4px 0 0 white,
							0 -2px 0 0 var(--app-primary-color),
							0 2px 2px 0 rgba(0, 0, 0, 0.14),
							0 1px 5px 0 rgba(0, 0, 0, 0.12),
							0 3px 1px -2px rgba(0, 0, 0, 0.2);
			}

			.sublist{
				background:var(--app-light-color);
				margin:0 0 8px -30px;
				padding:0;
				padding-bottom:4px;
				border-radius:0 0 2px 2px;
				@apply --shadow-elevation-2dp;
			}

			paper-item.sublist-footer {
				height:48px;
				font-weight: normal;
			}

			.sublist-footer paper-icon-button.menu-item-icon, .list-info paper-icon-button.menu-item-icon {
				padding: 2px;
				height: 24px;
				width:24px;
				-webkit-border-radius: 12px;
				-moz-border-radius: 12px;
				border-radius: 12px;
				background:var(--app-secondary-color);
				color:var(--app-text-color);
				margin-right:8px;
			}

			paper-item.list-info {
				font-weight: lighter;
				font-style: italic;
				height:48px;
			}

			.list-title {
				font-weight: bold;
			}

			.menu-item{
				@apply --padding-right-left-16;
				height:48px;
				@apply --paper-font-button;
				text-transform: inherit;
				justify-content: space-between;
				cursor: pointer;
				@apply --transition;
			}

			.sublist .menu-item {
				font-size: 13px;
				min-height:32px;
				height:32px;
			}

			.menu-item:hover{
				/*background: var(--app-dark-color-faded);*/
				@apply --transition;
			}

			.menu-item .iron-selected{
				background:var(--app-primary-color);

			}

			.menu-item .opened{
				background:white!important;
				width:80%;
				border-radius:2px;
			}

			.menu-item-icon--selected{
				width:0;
			}

			.opened .menu-item-icon--selected{
				width: 18px;
			}

			.opened > .menu-item-icon{
				transform: scaleY(-1);
			}

			paper-item.menu-item.opened {
				@apply --padding-right-left-16;
			}

			.submenu-item{
				cursor:pointer;
			}

			.submenu-item.iron-selected{
				background:var(--app-primary-color-light);
				color:var(--app-text-color-light);
				@apply --text-shadow;
			}

			.submenu-item-icon{
				height:14px;
				width:14px;
				color:var(--app-text-color-light);
				margin-right:10px;
			}


			.patient-info-container{
				height:96px;
				@apply --padding-right-left-32;
				cursor:pointer;
			}

			.patient-info-container:hover{
				background: var(--app-dark-color-faded);
				@apply --transition;
			}

			.patient-info{
				@apply --padding-left-16;
				display:flex;
				flex-direction:column;
				align-items: flex-start;
				justify-content: center;
			}
			.patient-name{
				font-weight:700;
				line-height:14px;
			}
			.patient-birthdate{
				font-size: 13px;
			}

			.btn-close{
				position: absolute;
				left: 26px;
				top: 18px;
				background:var(--app-secondary-color);
				color:var(--app-text-color);
				height:20px;
				width:20px;
				z-index: 4;
			}

			.btn-close:hover{
				@apply --transition;
				top: 17px;
				@apply --shadow-elevation-2dp;
			}

			.patient-picture-container{
				height:60px;
				width:60px;
				border-radius:50%;
				overflow: hidden;
			}

			.patient-picture-container img{
				width:100%;
				margin:50%;
				transform: translate(-50%,-50%);
			}

			.submenus-container{
				overflow-x: auto;
				height: 100%;
				margin-bottom:16px;
			}

			.add-btn-container{
				width:100%;
				display:none;
				/*display:flex;*/
				flex-direction: row;
				justify-content: center;
				align-items: center;
			}

			.add-btn{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				background:var(--app-secondary-color);
				color:var(--app-text-color);
				font-weight:bold;
				font-size:14px;
				height:40px;
				min-width:100px;
				@apply --shadow-elevation-2dp;
				padding: 10px 1.2em;
			}

			paper-item:hover .he-edit-btn-container {
				display:inline-flex;
			}

			paper-item.iron-selected .he-edit-btn-container {
				display:inline-flex;
			}

			.he-edit-btn-container{
				background: var(--app-text-color);
				border-radius: 14px;
				display: none;
				flex-flow: row-reverse wrap;
				justify-content: space-between;
				align-items: center;
				padding: 2px;
				width: 24px;
				height: 24px;
				overflow: hidden;
				transition: width .42s cubic-bezier(0.075, 0.82, 0.165, 1);
			}

			.he-edit-btn-container.open{
				width: 90px;
				display:inline-flex;
				flex-flow: row-reverse nowrap;
			}


			[hidden] {
				display:none!important;
			}

			.he-edit-btn{
				height: 24px;
				width: 24px;
				padding: 4px;
				color: var(--app-text-color-light);
				margin-right: 2px;
				margin-left: 2px;
				--paper-ink-color:var(--app-text-color-light);
			}

			.he-edit-btn-dark{
				color: var(--app-text-color);
				--paper-ink-color:var(--app-text-color);
			}
			/* END FIRST PANEL */

			/* SECOND PANEL  */
			.second-panel{
				/*width:30%;*/
				height:100%;
				background: var(--app-background-color);
				/*position:fixed;*/
				top:64px;
				left:20%;
				@apply --shadow-elevation-2dp;
				margin:0;
				grid-column: 2 / 2;
				grid-row:1 / 1;

				z-index:2;

			}

			paper-tooltip{
				top:2px!important;
				--paper-tooltip-background: var(--app-secondary-color);
				--paper-tooltip-text-color: var(--app-text-color);
				--paper-tooltip-opacity: 0.7;
				--paper-tooltip:{
					padding:2px 6px!important;
					height:10px!important;
					z-index:1000;
				}

			}

			.fit-bottom{
				bottom:0;
				left:20%!important;
				width:30%;
				height:48px;
				z-index:4;
				@apply --padding-right-left-32;
				display:flex;
				flex-direction: row;
				justify-content: center;
				flex-wrap: nowrap;
				padding-top:8px;
			}

			.selection-toast-button{
				height:32px;
				@apply --paper-font-button;
				text-transform:lowercase;
			}

			.selection-toast-icon{
				height:16px;
				margin-right:4px;
			}

			div.extraDialogFields {
				margin-top: 0;
			}

			.contact{
				margin: 0 32px 16px;
				background: var(--app-light-color);
				color:var(--app-text-color);
				outline:0;
				padding:0;
				align-items: flex-start !important;
				@apply --shadow-elevation-2dp;
				position:relative;
			}

			.contact.iron-selected{
				background: var(--app-primary-color);
				color:var(--app-light-color);
				@apply --text-shadow;
			}
			.contact h4{
				font-size:14px;
				font-weight: 600;
				margin:0;
				-webkit-user-select: none; /* Chrome/Safari */
				-moz-user-select: none; /* Firefox */
				-ms-user-select: none; /* IE10+ */

				/* Rules below not implemented in browsers yet */
				-o-user-select: none;
				user-select: none;

			}

			.contact .contact-text-row{
				width:calc(100% - 32px);
				display: flex;
				flex-flow: row wrap;
				justify-content: flex-start;
				align-items: center;
				@apply --padding-right-left-16;
			}

			.contact:nth-of-type(1) .contact-text-row p {
				padding-right: 32px;
			}

			.contact .contact-text-row:first-child, .contact .contact-text-row:last-child{
				height:24px;
			}
			/*.contact .contact-text-row:nth-child(2){
				height:48px;
			}*/

			.contact-text-row p {
				width: 100%;
				text-overflow: ellipsis;
				overflow-x: hidden;
				white-space: nowrap;
			}

			.contact-text-date{
				justify-content: space-between!important;
				position: relative;
				top: 0;
				left: 0;
				right: 0;
				background: rgba(0,0,0,.1);
				@apply --padding-right-left-16;
				color: var(--app-text-color-disabled);
				height:24px;
			}

			.contact label{
				font-size:12px;
				font-weight: 400;
				margin:0;
				display: block;

				-webkit-user-select: none; /* Chrome/Safari */
				-moz-user-select: none; /* Firefox */
				-ms-user-select: none; /* IE10+ */

				/* Rules below not implemented in browsers yet */
				-o-user-select: none;
				user-select: none;

			}

			.ICD-10{
				line-height: 12px;
				margin-right:4px;
			}

			.iron-selected .ICD-10{
				color: var(--app-light-color);
			}

			.iron-selected .ICD-10 span{
				background: var(--app-light-color);
			}
			.ICD-10:hover{
				font-weight:600;
			}

			.ICD-10:hover:before{
				height:8px;
				width:8px;
				margin-bottom:0;
				border-radius:4px;
			}

			.ICD-10 span{
				content: '';
				display: inline-block;
				height: 6px;
				width: 6px;
				border-radius: 3px;
				margin-right: 3px;
				margin-bottom: 1px;
			}

			.contact .ICD-10:not(:first-child) {
				margin-left: 4px;
			}

			.contact p{
				@apply --paper-font-body1;
				margin:0;
				-webkit-user-select: none; /* Chrome/Safari */
				-moz-user-select: none; /* Firefox */
				-ms-user-select: none; /* IE10+ */

				/* Rules below not implemented in browsers yet */
				-o-user-select: none;
				user-select: none;
			}

			.contact-icon{
				position: absolute;
				right: 8px;
				margin: auto;
				top: 38px;
			}

			paper-material.iron-selected > .contact-icon{
				color:var(--app-text-color-light);
			}

			paper-material.iron-selected > .contact-text > .contact-text-date{
				color:var(--app-text-color-light)!important;
			}

			.current-contact {
				color:var(--app-secondary-color-dark);
				margin-bottom: 16px;
			}


			.current-contact.iron-selected{
				border-bottom:1px solid var(--app-primary-color);
			}

			.contact--big{
				min-height: 96px;
				/*@apply --padding-16;*/
				/*border-bottom: 1px solid var(--app-background-color-dark);*/
			}

			.contact--small{
				min-height: 32px;
				/*@apply --padding-right-left-16;*/
				padding-bottom: 8px;
			}

			.contact--small .contact-text-row:nth-child(2){
				justify-content: space-between;
			}

			.contact--small .contact-text-row:last-child{
				display: none;
			}

			.contact--small .he-dots-container{
				display:none;
			}

			.he-dots-container{
				display:flex;
				flex-flow:row wrap;
				justify-content: flex-end;
			}

			.contact-year{
				display:block;
				@apply --paper-font-body2;
				@apply --padding-32;
				padding-bottom:8px;
			}
			.contact-year:first-child{
				padding-top:0;
			}

			.contact-text{
				background:transparent;
				flex-direction:column;
				justify-content: space-between;
				align-items: flex-start;
				width:100%;
				height: 100%;
				padding:0;
			}

			.contact-text:focus::before, .contact-text:focus::after{
				background:transparent;
			}

			.contacts-container{
				overflow-y: auto;
				height: calc(100% - 80px);
				padding-bottom: 32px;
			}

			.layout.vertical {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
				align-items: center;
				flex-wrap:nowrap;
			}

			.todo-list{
				border:1px dashed rgba(0,0,0,0.1);
				margin: 0 32px;
				border-radius:4px;
			}

			.todo-item{
				font-size:14px;
				--paper-item-min-height:32px;
				color:var(--app-text-color);
				display:flex;
				flex-flow: row wrap;
				align-items: center;
				justify-content: space-between;
			}

			.todo-item h4{
				margin:0.5em 0;
			}

			.todo-due-date{
				font-size:14px;
				font-weight:300;
				margin-right:4px;
			}

			.todo-actions paper-icon-button{
				height:24px;
				width:24px;
				padding:2px;
				--paper-icon-button-hover:{
					color:var(--app-secondary-color);
				};
			}

			.todo-item--late{
				color:var(--paper-red-500)
			}
			/* END SECOND PANEL */

			.second-third-panel{
				width:80%;
				height:calc(100% - 64px);
				background: var(--app-background-color);
				position:fixed;
				top:64px;
				right:0;
				z-index:2;
				overflow-y:scroll;
			}

			ht-pat-detail-ctc-detail-panel {
				grid-column: 3 / 3;
				grid-row: 1 / 1;
			}

			.statusContainer {
				display:inline-flex;
				flex-flow: row nowrap;
				justify-content: space-between;
				align-items: center;
				padding-top: 4px;
				padding-bottom: 4px;
				width: 100%;
				height: 24px;
				overflow: hidden;
			}

			#insuranceStatus, #hubStatus, #tlStatus, #consentStatus  {
				--paper-fab-background: var(--app-background-color-darker);
				--paper-fab-keyboard-focus-background: var(--app-background-color);
				color: var(--app-primary-color-dark);
				box-shadow: none;
				--paper-fab-iron-icon: {
					height:16px;
					width:16px;
				}

			}

			#insuranceStatus.medicalHouse {
				--paper-fab-background: #fcdf35;
			}

			#insuranceStatus.noInsurance, #hubStatus.noAccess, #tlStatus.noTl, #consentStatus.noConsent {
				--paper-fab-background: #ff4d4d;
			}

			#insuranceStatus.insuranceOk, #hubStatus.accessOk, #tlStatus.tlOk, #consentStatus.consentOk {
				--paper-fab-background: var(--app-secondary-color-highlight);
			}

			.display-left-menu{
				display:none;
				position:fixed;
				top: 50%;
				left: 0;
				z-index: 120;
				background: var(--app-background-color-dark);
				transform:translateY(-50%) rotate(0);
				border-radius:0 50% 50% 0;
				transition: transform 0.2s ease-in;

			}
			.display-left-menu.open{
				left:20%;
				border-radius:50% 0 0  50% ;
				transform:translateY(-50%) rotate(180deg);
				transition: transform 0.2s ease-in;
			}


			@media screen and (max-width:1025px){
				.container{
					grid-template-columns: 0% 40% 60%;

				}

				.container .fit-bottom{
					left:0%!important;
					width:40%;
				}
				.container.expanded{
					grid-template-columns: 20% 30% 50%;
				}

				.container.expanded .fit-bottom {
					left:20%!important;
					width:30%;
				}
				.selection-toast-button{
					@apply --paper-font-caption;
					text-transform:lowercase;
				}
				.second-third-panel{
					width:70%;
				}
				.patient-info-container{
					@apply --padding-right-left-16;
				}
				.patient-picture-container{
					display:none;
				}
				.btn-close{
					left: 8px;
   					top: 16px;
				}
				.display-left-menu{
					display:inherit;
				}
			}

			.extraDialogFields paper-input, .extraDialogFields tk-token-field{
				--paper-input-container-focus-color: var(--app-primary-color);
			}

			.toast-detector {
				position: relative;
				height: 48px;
				bottom:48px;
				width:100%;
			}
		</style>

		<div class="container">
			<template is="dom-if" if="[[isAdminSelected(selectedAdminFile)]]">
				<ht-pat-admin-card class="second-third-panel" id="pat-admin-card" api="[[api]]" user="[[user]]" patient="[[patient]]" language="[[language]]"></ht-pat-admin-card>
			</template>
			<paper-icon-button class="display-left-menu" icon="chevron-right" on-tap="_expandColumn"></paper-icon-button>
			<div class="first-panel">
				<paper-material class="zone compact-menu">
					<paper-listbox class="padding-0" id="adminFileMenu" selected-item="{{selectedAdminFile}}">
						<paper-item id="_admin_info" class="horizontal layout patient-info-container">
							<paper-fab class="btn-close" mini icon="close" on-tap="close"></paper-fab>
							<div class="patient-picture-container"><img src$="[[picture(patient)]]"></div>
							<div class="patient-info">
								<div class="patient-name">[[patient.firstName]] [[patient.lastName]]</div>
								<div class="patient-birthdate">°[[patient.dateOfBirth]]</div>
								<div class="statusContainer"><paper-fab id="insuranceStatus" mini icon="vaadin:handshake"></paper-fab><paper-fab id="consentStatus" mini icon="vaadin:clipboard-check"></paper-fab><paper-fab id="tlStatus" mini icon="vaadin:specialist"></paper-fab><paper-fab id="hubStatus" mini icon="vaadin:cluster"></paper-fab></div>
							</div>
						</paper-item>
						<paper-item class="menu-item" id="_complete_file">Complete file <iron-icon class="menu-item-icon" icon="icons:arrow-forward"></iron-icon></paper-item>
					</paper-listbox>
					<div class="submenus-container">
						<paper-listbox class="padding-0" id="mainMenu" selected-items="{{selectedMainElements}}" multi toggle-shift>
							<collapse-button>
								<paper-item slot="sublist-collapse-item" class="menu-trigger menu-item" id="_ht_active_hes" on-tap="toggleSelectAll" elevation="">
									<div class="one-line-menu list-title">
										<span>Active Health Problems</span>
									</div>
									<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu" hover="none"></paper-icon-button>
								</paper-item>
								<paper-listbox class="menu-content sublist" selected-items="{{selectedLocalize}}" multi toggle-shift>
									<template is="dom-if" if="[[!activeHealthElements.length]]">
										<paper-item class="menu-item  list-info"><div class="one-line-menu">No active health elements</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addHealthElement"></paper-icon-button></paper-item>
									</template>
									<template id="activeHesDomRepeat" is="dom-repeat" items="[[activeHealthElements]]" as="he">
										<collapse-button>
											<paper-item slot="sublist-collapse-item" id="[[getHeId(he)]]" class="menu-trigger menu-item" on-tap="toggleSelectAll">
												<div class="one-line-menu">
													<template is="dom-if" if="[[he.colour]]">
														<label class$="ICD-10 [[he.colour]]"><span></span></label>
													</template>
													[[he.descr]]
												</div>
												<div>
												<div class="he-edit-btn-container">
													<paper-icon-button id="he-edit-btn-edit_[[he.id]]" class="he-edit-btn" icon="create" on-tap="_toggleEditHE"></paper-icon-button>
													<paper-icon-button id="he-edit-btn-archive_[[he.id]]" class="he-edit-btn" icon="vaadin:safe" on-tap="_archive"></paper-icon-button>
													<paper-icon-button id="he-edit-btn-history_[[he.id]]" class="he-edit-btn" icon="assignment-return" on-tap="_inactivate"></paper-icon-button>

													<paper-tooltip position="top" for="he-edit-btn-edit_[[he.id]]">Edit</paper-tooltip>
													<paper-tooltip position="top" for="he-edit-btn-archive_[[he.id]]">Archive</paper-tooltip>
													<paper-tooltip position="top" for="he-edit-btn-history_[[he.id]]">Add to History</paper-tooltip>
												</div>
												<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
												</div>
											</paper-item>
											<paper-listbox class="menu-content sublist sub-sublist" selected-items="{{he.selectedItems}}" multi toggle-shift>
												<template is="dom-if" if="[[!he.plansOfAction.length]]">
													<paper-item class="submenu-item list-info"><div class="one-line-menu">No plan of action</div></paper-item>
												</template>
												<template is="dom-repeat" items="[[he.plansOfAction]]" as="poa">
													<paper-item class="submenu-item" id="_poa_[[poa.id]]">
														<span>[[poa.descr]]</span>
													</paper-item>
												</template>
											</paper-listbox>
										</collapse-button>
									</template>
									<template is="dom-if" if="[[activeHealthElements.length]]">
									<paper-item class="menu-item sublist-footer"><div class="one-line-menu">Add health element</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addHealthElement"></paper-icon-button></paper-item>
									</template>
								</paper-listbox>
							</collapse-button>
							<collapse-button>
								<paper-item slot="sublist-collapse-item" class="menu-trigger menu-item" id="_ht_inactive_hes" on-tap="toggleSelectAll" elevation="">
									<div class="one-line-menu list-title">
										<span>Medical antecedents</span>
									</div>
									<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
								</paper-item>
								<paper-listbox class="menu-content sublist" selected-items="{{selectedLocalize}}" multi toggle-shift>
									<template is="dom-if" if="[[!inactiveHealthElements.length]]">
										<paper-item class="menu-item list-info"><div class="one-line-menu">No medical antecedent</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addInactiveHealthElement"></paper-icon-button></paper-item>
									</template>
									<template id="inactiveHesDomRepeat" is="dom-repeat" items="[[inactiveHealthElements]]" as="he">
										<collapse-button>
											<paper-item slot="sublist-collapse-item" id="[[getHeId(he)]]" class="menu-trigger menu-item" on-tap="toggleSelectAll">
												<div class="one-line-menu">
													<template is="dom-if" if="[[he.colour]]">
														<label class$="ICD-10 [[he.colour]]"><span></span></label>
													</template>
													[[he.descr]]
												</div>
												<div>
													<div class="he-edit-btn-container">
														<paper-icon-button id="he-edit-btn-edit_[[he.id]]" class="he-edit-btn" icon="create" on-tap="_toggleEditHE"></paper-icon-button>
														<paper-icon-button id="he-edit-btn-archive_[[he.id]]" class="he-edit-btn" icon="vaadin:safe" on-tap="_archive"></paper-icon-button>
														<paper-icon-button id="he-edit-btn-active_[[he.id]]" class="he-edit-btn" icon="assignment-turned-in" on-tap="_activate"></paper-icon-button>

														<paper-tooltip position="top" for="he-edit-btn-edit_[[he.id]]">Edit</paper-tooltip>
														<paper-tooltip position="top" for="he-edit-btn-archive_[[he.id]]">Archive</paper-tooltip>
														<paper-tooltip position="top" for="he-edit-btn-active_[[he.id]]">Make Active</paper-tooltip>
													</div>
													<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
												</div>
											</paper-item>
											<paper-listbox class="menu-content sublist sub-sublist" selected-items="{{he.selectedItems}}" multi toggle-shift>
												<template is="dom-if" if="[[!he.plansOfAction.length]]">
													<paper-item class="submenu-item list-info"><div class="one-line-menu">No plan of action</div></paper-item>
												</template>
												<template is="dom-repeat" items="[[he.plansOfAction]]" as="poa">
													<paper-item class="submenu-item" id="_poa_[[poa.id]]">
														<span>[[poa.descr]]</span>
													</paper-item>
												</template>
											</paper-listbox>
										</collapse-button>
									</template>
									<template is="dom-if" if="[[inactiveHealthElements.length]]">
									<paper-item class="menu-item sublist-footer"><div class="one-line-menu">Add medical antecedent</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addInactiveHealthElement"></paper-icon-button></paper-item>
									</template>
								</paper-listbox>
							</collapse-button>
							<collapse-button>
								<paper-item slot="sublist-collapse-item" id="_svc_group_familyrisks" class="menu-trigger menu-item" on-tap="toggleSelectAll">
									<div class="one-line-menu list-title">
										Family risks
									</div>
									<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
								</paper-item>
								<paper-listbox class="menu-content sublist" multi toggle-shift selected-items="{{selectedFamily}}">
									<template is="dom-if" if="[[!familyrisks.length]]">
										<paper-item class="menu-item list-info"><div class="one-line-menu">No family risks</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addService" data-label="Family risk" data-tags="CD-ITEM|familyrisk|1.0"></paper-icon-button></paper-item>
									</template>
									<template is="dom-repeat" items="[[familyrisks]]" as="risk">
										<paper-item class="menu-item" id="_svc_[[risk.id]]">
											<span>[[shortServiceDescription(risk, language)]]</span>
										</paper-item>
									</template>
									<template is="dom-if" if="[[familyrisks.length]]">
									<paper-item class="menu-item sublist-footer"><div class="one-line-menu">Add family risk</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addService" data-label="Family risk" data-tags="CD-ITEM|familyrisk|1.0"></paper-icon-button></paper-item>
									</template>
								</paper-listbox>
							</collapse-button>
							</collapse-button>
							<collapse-button>
								<paper-item slot="sublist-collapse-item" id="_svc_group_risks" class="menu-trigger menu-item" on-tap="toggleSelectAll">
									<div class="one-line-menu list-title">
										Risks
									</div>
									<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
								</paper-item>
								<paper-listbox class="menu-content sublist" multi toggle-shift selected-items="{{selectedRisks}}">
									<template is="dom-if" if="[[!risks.length]]">
										<paper-item class="menu-item list-info"><div class="one-line-menu">No risks</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addService" data-label="Risks" data-tags="CD-ITEM|risk|1.0"></paper-icon-button></paper-item>
									</template>
									<template is="dom-repeat" items="[[risks]]" as="risk">
										<paper-item class="menu-item" id="_svc_[[risk.id]]">
											<span>[[shortServiceDescription(risk, language)]]</span>
										</paper-item>
									</template>
									<template is="dom-if" if="[[risks.length]]">
									<paper-item class="menu-item sublist-footer"><div class="one-line-menu">Add risk</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addService" data-label="Risks" data-tags="CD-ITEM|risk|1.0"></paper-icon-button></paper-item>
									</template>
								</paper-listbox>
							</collapse-button>
							<collapse-button>
								<paper-item slot="sublist-collapse-item" id="_svc_group_allergies" class="menu-trigger menu-item" on-tap="toggleSelectAll">
									<div class="one-line-menu list-title">
										Allergies
									</div>
									<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
								</paper-item>
								<paper-listbox class="menu-content sublist" multi toggle-shift selected-items="{{selectedAllergies}}">
									<template is="dom-if" if="[[!allergies.length]]">
										<paper-item class="menu-item list-info"><div class="one-line-menu">No allergies</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addService" data-label="Allergies" data-tags="CD-ITEM|allergy|1.0"></paper-icon-button></paper-item>
									</template>
									<template is="dom-repeat" items="[[allergies]]" as="allergy">
										<paper-item class="menu-item" id="_svc_[[allergy.id]]">
											<div class="one-line-menu">
												[[shortServiceDescription(allergy, language)]]
											</div>
										</paper-item>
									</template>
									<template is="dom-if" if="[[allergies.length]]">
										<paper-item class="menu-item sublist-footer"><div class="one-line-menu">Add allergy</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addService" data-label="Allergies" data-tags="CD-ITEM|allergy|1.0"></paper-icon-button></paper-item>
									</template>
								</paper-listbox>
							</collapse-button>
							<collapse-button>
								<paper-item slot="sublist-collapse-item" id="_svc_group_medications" class="menu-trigger menu-item" on-tap="toggleSelectAll">
									<div class="one-line-menu list-title">
										Medication
									</div>
									<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
								</paper-item>
								<paper-listbox class="menu-content sublist" multi toggle-shift selected-items="{{selectedAllergies}}">
									<template is="dom-if" if="[[!medications.length]]">
										<paper-item class="menu-item list-info"><div class="one-line-menu">No medications</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addService" data-label="Medications" data-tags="CD-ITEM|medication|1.0"></paper-icon-button></paper-item>
									</template>
									<template is="dom-repeat" items="[[medications]]" as="medication">
										<paper-item class="menu-item" id="_svc_[[medication.id]]">
											<div class="one-line-menu">
												[[shortServiceDescription(medication, language)]]
											</div>
										</paper-item>
									</template>
									<template is="dom-if" if="[[medications.length]]">
										<paper-item class="menu-item sublist-footer"><div class="one-line-menu">Add medication</div><paper-icon-button class="menu-item-icon" icon="icons:add" on-tap="_addService" data-label="Medications" data-tags="CD-ITEM|medication|1.0"></paper-icon-button></paper-item>
									</template>
								</paper-listbox>
							</collapse-button>
							<collapse-button>
								<paper-item slot="sublist-collapse-item" class="menu-trigger menu-item" id="_ht_archived_hes" on-tap="toggleSelectAll" elevation="">
									<div class="one-line-menu list-title">
										<span>Archive</span>
									</div>
									<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
								</paper-item>
								<paper-listbox class="menu-content sublist" selected-items="{{selectedLocalize}}" multi toggle-shift>
									<template is="dom-if" if="[[!archivedHealthElements.length]]">
										<paper-item class="menu-item list-info"><div class="one-line-menu">No archived health elements</div></paper-item>
									</template>
									<template id="archivedHesDomRepeat" is="dom-repeat" items="[[archivedHealthElements]]" as="he">
										<collapse-button>
											<paper-item slot="sublist-collapse-item" id="[[getHeId(he)]]" class="menu-trigger menu-item" on-tap="toggleSelectAll">
												<div class="one-line-menu">
													[[he.descr]]
												</div>
												<div>
													<div class="he-edit-btn-container">
														<paper-icon-button id="he-edit-btn-edit_[[he.id]]" class="he-edit-btn" icon="create" on-tap="_toggleEditHE"></paper-icon-button>
														<paper-icon-button id="he-edit-btn-history_[[he.id]]" class="he-edit-btn" icon="assignment-return" on-tap="_inactivate"></paper-icon-button>
														<paper-icon-button id="he-edit-btn-active_[[he.id]]" class="he-edit-btn" icon="assignment-turned-in" on-tap="_activate"></paper-icon-button>

														<paper-tooltip position="top" for="he-edit-btn-edit_[[he.id]]">Edit</paper-tooltip>
														<paper-tooltip position="top" for="he-edit-btn-history_[[he.id]]">Add to History</paper-tooltip>
														<paper-tooltip position="top" for="he-edit-btn-active_[[he.id]]">Make Active</paper-tooltip>
													</div>
													<paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" on-tap="toggleMenu"></paper-icon-button>
												</div>
											</paper-item>
											<paper-listbox class="menu-content sublist sub-sublist" selected-items="{{he.selectedItems}}" multi toggle-shift>
												<template is="dom-if" if="[[!he.plansOfAction.length]]">
													<paper-item class="menu-item list-info"><div class="one-line-menu">No plan of action</div></paper-item>
												</template>
												<template is="dom-repeat" items="[[he.plansOfAction]]" as="poa">
													<paper-item class="submenu-item" id="_poa_[[poa.id]]">
														<span>[[poa.descr]]</span>
													</paper-item>
												</template>
											</paper-listbox>
										</collapse-button>
									</template>
								</paper-listbox>
							</collapse-button>
						</paper-listbox>
					</div>
				</paper-material>
				<div class="add-btn-container"><paper-button class="add-btn" on-tap="_addHealthElement">Add Health Element</paper-button></div>

			</div>
			<template is="dom-if" if="[[!isAdminSelected(selectedAdminFile)]]">
				<div class="second-panel">
					<filter-panel id="contactFilterPanel" items="[[secondPanelItems]]" selected-icon="{{contactType}}" search-string="{{contactSearchString}}"></filter-panel>
					<div class="contacts-container" on-scroll="openToast">
						<paper-listbox id="_contacts_listbox" focused multi toggle-shift selectable="paper-material" selected-items="{{selectedContactItems}}">
							<template is="dom-if" if="[[events.length]]">
								<span class="contact-year" on-click="openToast">To Do</span>
								<paper-listbox id="_events_listbox" class="todo-list">
									<template is="dom-repeat" items="[[events]]" as="e">
										<paper-item id="_svc_[[e.id]]" class$="todo-item [[_lateEventCssClass(e)]]">
											<h4><label class="todo-due-date">[[_dateFormat(e.valueDate)]]</label>[[shortServiceDescription(e)]]</h4>
											<div class="todo-actions">
												<paper-icon-button icon="clear" on-tap="clearEvent"></paper-icon-button>
												<paper-icon-button icon="done" on-tap="completeEvent"></paper-icon-button>
											</div>
										</paper-item>
									</template>
								</paper-listbox>
							</template>
							<template is="dom-if" if="[[!events.length]]">
							</template>
							<template is="dom-repeat" items="[[contactYears]]" as="contactYear">
								<span class="contact-year" on-click="openToast">
									[[contactYear.year]]
								</span>
								<template is="dom-repeat" items="[[contactYear.contacts]]" as="contact" filter="[[contactFilter(selectedMainElements, selectedMainElements.*, timeSpanStart, timeSpanEnd, contactSearchString)]]" sort="compareContacts">
									<paper-material id="ctc_[[contact.id]]"
													elevation="0"
													class$="layout vertical contact [[_isLatestYearContact(contactYear, contactYears)]] [[_contactClasses(contact, contact.closingDate)]]"
													contact="[[contact]]"
													on-click="openToast">
										<paper-item class="contact-text">
											<div class="contact-text-row contact-text-date">
												<label>[[_timeFormat(contact.openingDate)]] ([[_shortId(contact.id)]])</label>
												<label>[[hcp(contact)]]</label>
											</div>
											<div class="contact-text-row grey">
												<h4>[[contact.userDescr]]</h4>
												<template is="dom-repeat" items="[[highlightedServiceLabels(user)]]"
														as="label">
													<p>
														<template is="dom-repeat" items="[[serviceDescriptions(contact,label)]]" as="svcDesc">
															<template is="dom-if" if="[[!index]]">[[label]]:</template>
															<template is="dom-if" if="[[index]]"> ,</template>
															[[svcDesc]]
														</template>
													</p>

												</template>
											</div>
											<div class="contact-text-row">
												<template is="dom-repeat" items="[[contact.healthElements]]" as="he">
													<label class$="ICD-10 [[he.colour]]"><span></span>[[he.descr]]</label>
												</template>
											</div>
										</paper-item>
										<template is="dom-if" if="[[!contact.closingDate]]">
											<paper-icon-button id="close-[[contact.id]]" class="menu-item-icon contact-icon" icon="icons:cancel" on-tap="closeContact"></paper-icon-button>
										</template>
									</paper-material>
								</template>
							</template>
						</paper-listbox>
					</div>
					<div class="toast-detector" on-mousemove="openToast"></div>
					<paper-toast id="selectionToast" class="fit-bottom">
						<paper-button class="selection-toast-button" name="select-today" role="button" tabindex="0"
									  animated aria-disabled="false" elevation="0" on-tap="_selectToday">
							<iron-icon class="selection-toast-icon" icon="icure-svg-icons:select-today"></iron-icon>
							Select Today
						</paper-button>
						<paper-button class="selection-toast-button" name="select-six-months" role="button" tabindex="0"
									  animated aria-disabled="false" elevation="0" on-tap="_select6Months">
							<iron-icon class="selection-toast-icon"
									   icon="icure-svg-icons:select-six-months"></iron-icon>
							Last 6 Months
						</paper-button>
						<paper-button class="selection-toast-button" name="select-all" role="button" tabindex="0"
									  animated aria-disabled="false" elevation="0" on-tap="_selectAll">
							<iron-icon class="selection-toast-icon" icon="icure-svg-icons:select-all"></iron-icon>
							Select All
						</paper-button>
					</paper-toast>
				</div>
				<ht-pat-detail-ctc-detail-panel contacts="[[selectedContacts]]" all-contacts="[[contacts]]" health-elements="[[_concat(activeHealthElements,inactiveHealthElements)]]" api="[[api]]" user="[[user]]" patient="[[patient]]" language="[[language]]" current-contact="[[currentContact]]" on-select-current-contact="_selectCurrentContact" on-change="formsChanged" on-health-elements-change="patientChanged"></ht-pat-detail-ctc-detail-panel>
			</template>

		</div>

		<entity-selector id="add-healthelement-dialog" columns="[[_healthElementsSelectorColumns()]]" data-provider="[[_healthElementsSelectorDataProvider()]]" on-entity-selected="_addedHealthElementSelected" entity-type="Health Problem" entity="{{heEntity}}" ok-label="Create">
			<div class="extraDialogFields" slot="suffix">
				<paper-input label="Health Problem" value="{{heEntity.descr}}"></paper-input>
				<tk-token-field label="Plans of action" value="{{heEntity.plansOfAction}}" data-value-path="id"  data-label-path="descr"></tk-token-field>
			</div>
		</entity-selector>

		<entity-selector id="edit-healthelement-dialog" columns="[[_healthElementsSelectorColumns()]]" data-provider="[[_healthElementsSelectorDataProvider()]]" on-entity-selected="_editedHealthElementSelected" entity-type="Health Problem" entity="{{heEntity}}" ok-label="Modify">
			<div class="extraDialogFields" slot="suffix">
				<paper-input label="Health Problem" value="{{heEntity.descr}}"></paper-input>
				<tk-token-field label="Plans of action" value="{{heEntity.plansOfAction}}" data-value-path="id"  data-label-path="descr"></tk-token-field>
			</div>
		</entity-selector>

		<entity-selector id="add-service-dialog" columns="[[_servicesSelectorColumns()]]" data-provider="[[_servicesSelectorDataProvider(editedSvcLabel)]]" on-entity-selected="_addedOrEditedServiceSelected" entity-type="[[editedSvcLabel]]" entity="{{svcEntity}}" ok-label="Create">
			<div class="extraDialogFields" slot="suffix">
				<paper-input label="Description" value="[[shortServiceDescription(svcEntity, language)}}" on-value-changed="_svcEntityContentChanged"></paper-input>
			</div>
		</entity-selector>

		<entity-selector id="edit-service-dialog" columns="[[_servicesSelectorColumns()]]" data-provider="[[_servicesSelectorDataProvider(editedSvcLabel)]]" on-entity-selected="_addedOrEditedServiceSelected" entity-type="[[editedSvcLabel]]" entity="{{svcEntity}}" ok-label="Modify">
			<div class="extraDialogFields" slot="suffix">
				<paper-input label="Description" value="[[shortServiceDescription(svcEntity, language)}}" on-value-changed="_svcEntityContentChanged"></paper-input>
			</div>
		</entity-selector>

	</template>
	<script>
		import moment from 'moment/src/moment'
		import _ from 'lodash/lodash'
		import styx from '../../../scripts/styx'

		Polymer({
			is: 'ht-pat-detail',
			properties: {
				api: {
					type: Object
				},
				language: {
					type: String,
					value: 'en'
				},
				user: {
					type: Object
				},
				patient: {
					type: Object,
					notify: true
				},
				patientInsurance: {
					type: Object,
					value: function() { return {} }
				},
				patientInsurability: {
					type: Object,
					value: function() { return {} }
				},
				selectedAdminFile: {
					type: Object,
					observer: 'selectedAdminFileChanged',
					value: null
				},
				selectedMainElements: {
					type: Array,
					observer: "selectedMainElementsChanged",
					value: function() { return [] }
				},
				selectedFamily: {
				    type: Array,
					value: function() { return [] }

				},
				events: {
					type: Array,
					value: function() { return [] }

				},
				selectedRisks: {
					type: Array,
					value: function() { return [] }

				},
				selectedAllergies: {
					type: Array,
					value: function() { return [] }

				},
				selectedLocalize: {
					type: Array,
					value: function() { return [] }
				},
				selected: {
				    type: Boolean,
					value: false
				},
				showFiltersPanel: {
				    type: Boolean,
					value: false
				},
				currentContact: {
					type: Object,
					value: null
				},
				contactSearchString: {
					type: String,
					value: null
				},
				showDetailsFiltersPanel: {
					type: Boolean,
					value: false
				},
				isLatestYear: {
				    type: Boolean,
					value: false
				},
				selectedContactItems: {
					type: Array,
					value: function() { return [] }
				},
				itemSelected: {
					type: Boolean,
					value: false
				},
				secondPanelItems: {
					type: Array,
					value: function() {
						return [{icon: "icure-svg-icons:laboratory", title: "Lab Results", id: "LabResults"},
						{icon:"icure-svg-icons:imaging", title:"Imaging", id:"Imaging"},
						{icon:"icure-svg-icons:stethoscope", title:"Consultation", id:"Consultation"},
						{icon:"editor:insert-drive-file", title:"Protocol", id:"Protocol"},
						{icon:"icure-svg-icons:prescription", title:"Prescription", id:"Prescription"},
						{icon:"icure-svg-icons:sent-reports", title:"Sent Reports", id:"SentReports"},
						{icon:"icure-svg-icons:received-reports", title:"Received Reports", id:"ReceivedReports"}]
				    }
				}
			},
			observers: [
				'patientChanged(api,user,patient)',
				'selectedMainElementsSpliced(selectedMainElements.splices)',
				'selectedContactItemsChanged(selectedContactItems.*)'
			],
			selectedContactItemsChanged: function() {
				this.set('selectedContacts',this.selectedContactItems.map(i=>i.contact))
			},
			_shortId:function(id) { return id && id.substr(0,8) },
			_timeFormat: function(date) {
				return this.api.moment(date).format(date > 99991231 ? 'DD/MM/YYYY HH:mm' : 'DD/MM/YYYY')
			},

			_dateFormat: function(date) {
				return this.api.moment(date).format('DD/MM/YYYY')
			},
			_contactClasses: function(contact) {
				return contact.closingDate ? '' : 'current-contact'
			},
			clearEvent: function(el) {
				const svcId = el.target.parentElement.parentElement.id.substr(5)
				const svc = this.get('events').find(s=>s.id === svcId)

				const t = svc.tags.find(t=>t.type==='CD-LIFECYCLE')
				if (t) {
					t.code = 'cancelled'
					if (!this.currentContact) { return }
					this.saveService(svc).then(c => this.filterEvents())
				}
			},
			completeEvent: function(el) {
				const svcId = el.target.parentElement.parentElement.id.substr(5)
				const svc = this.get('events').find(s=>s.id === svcId)

				const t = svc.tags.find(t=>t.type==='CD-LIFECYCLE')
				if (t) {
					t.code = 'completed'
					if (!this.currentContact) { return }
					this.saveService(svc).then(c => this.filterEvents())
				}
			},
			saveService: function(svc) {
				svc.modified = +new Date()
				if (!svc.id) { svc.id = this.api.crypto().randomUuid() }
				if (!svc.valueDate) { svc.valueDate = parseInt(moment().format('YYYYMMDDHHmmss')) }
				if (!svc.openingDate) { svc.openingDate = svc.valueDate }
				if (!svc.created) { svc.created = svc.modified }
				const ctc = this.api.contact().contactOfService(this.get('contacts'), svc.id) || this.currentContact
				let sc = this.currentContact.subContacts.find(sc=>sc.services.find(sId=>svc.id))
				if (!sc) {
					sc = ctc.subContacts.find(sc=>sc.services.find(sId=>svc.id)) || {}
					this.currentContact.subContacts.push((sc = {formId:sc.formId, planOfActionId:sc.planOfActionId, healthElementId:sc.healthElementId, services:[]}))
					sc.services.push({serviceId:svc.id})
				}
				const oldSvcIdx = this.currentContact.services.findIndex(s=>s.id === svc.id)
				if (oldSvcIdx>-1) {
					this.currentContact.services.splice(oldSvcIdx,1)
				}
				this.currentContact.services.push(svc)
				return this.saveCurrentContact()
			},
			saveCurrentContact: function() {
				return (this.currentContact.rev ? this.api.contact().modifyContact(this.currentContact) : this.api.contact().createContact(this.currentContact)).then(c => (this.currentContact.rev = c.rev) && c)
			},
			filterEvents: function() {
				this.set('events', _.sortBy(this.api.contact().filteredServices(this.contacts, s=>s.tags.find(t=>t.type==='CD-LIFECYCLE'&&t.code==='planned')),it=>-this.api.moment(it.valueDate)))
			},
			_lateEventCssClass: function(e) {
				return this.api.moment(e.valueDate).isBefore(moment()) ? 'todo-item--late' : ''
			},
			_isLatestYearContact(contactYear, contactYears){
				if(contactYear.year === contactYears[Object.keys(contactYears)[0]].year) {
					this.isLatestYear = true;
			        return "contact--big";
				} else {
					this.isLatestYear = false;
			        return "contact--small";
				}
			},
			openToast: function() {
				Polymer.dom(this.root).querySelector('#selectionToast').show();
			},

			toggleFiltersPanel: function(){
			    this.showFiltersPanel = !this.showFiltersPanel;
				this.root.querySelector('#filtersPanel').classList.toggle('filters-panel--collapsed');
			},
			selectedItemsSubmenu: function (list, selectedItems) {
			    if (!selectedItems || selectedItems.length===0) {
			        return 'icons:check-box-outline-blank';
				} else if( selectedItems.length < list.length) {
			        return 'icons:indeterminate-check-box';
				}
				else {
			        return 'icons:check-box'
				}
			},
			checkedUncheckedIcon: function(item, selectedItems) {
			    if(selectedItems && selectedItems.find(i=>i && i.id && i.id.endsWith(item.id))){
			     	return 'icons:check-box';
				} else {
			        return 'icons:check-box-outline-blank';
				}
			},
			patientChanged: function () {
				if (this.api && this.user && this.patient) {
					const patient = this.patient
					Promise.all([this.api.contact().findBy(this.user.healthcarePartyId, patient), this.api.helement().findBy(this.user.healthcarePartyId, patient)])
							.then( ([ctcs, hes]) => {
								const descrPattern = this.user.properties.find(p=>p.type.identifier === 'org.taktik.icure.preferred.contactDescription') || "{Motifs de contact}"
								const sorter = (x=>[-x.valueDate||-x.openingDate,-x.closingDate])
								const idServicesInHes = _.compact(hes.map(he=>he.idService))

								this.api.contact()
								  .filterServices(ctcs, s=>s.tags.find(c=>(c.type === 'CD-ITEM') && (c.code === 'healthelement' || c.code === 'healthissue')) && idServicesInHes.indexOf(s.id)<0)
								  .then(hesAsServices => {
									const combinedHes = _.sortBy(_.concat(hesAsServices.map(svc=> ({
										created:svc.created,
										modified:svc.modified,
										endOfLife:svc.endOfLife,
										author:svc.author,
										responsible:svc.responsible,
										codes:svc.codes,
										tags:svc.tags,
										valueDate:svc.valueDate,
										openingDate:svc.openingDate,
										closingDate:svc.closingDate,
										descr: this.shortServiceDescription(svc,this.language),
										idService:svc.id,
										status:svc.status,
										svc:svc,
										plansOfAction:[]})
									), hes.filter(it=>it.descr && !it.descr.startsWith('Etat g') && !it.descr.startsWith('Algemeen t') && it.descr !== 'INBOX')), sorter)

									combinedHes.forEach(e => {
									    e.selectedItems = []
									});

									this.api.code().icdChapters(_.compact(combinedHes.map(he=>he.codes.find(c=>c.type === 'ICD' || c.type === 'ICD10'))).map(x=>x.code)).then(codes => {
										codes.forEach(cc => {
											cc.healthElements = _.sortBy(combinedHes.filter(he => {
												let heIcd = he.codes.find(c => c.type === 'ICD' || c.type === 'ICD10')
												return heIcd && cc.subCodes.includes(heIcd.code)
											}), sorter)
											cc.healthElements.forEach((he)=>(he.colour = cc.descr.colour))
										})
										this.set('healthTopics', _.sortBy(codes.filter(ht=>ht.healthElements.length > 1), (it=>this.localize(it))))

										this.set('activeHealthElements',  _.sortBy(combinedHes.filter(it=>!it.closingDate), 'descr'));
										this.set('inactiveHealthElements',  _.sortBy(combinedHes.filter(it=>it.closingDate && ((it.status & 1) === 0)), 'descr'));
										this.set('archivedHealthElements',  _.sortBy(combinedHes.filter(it=>it.closingDate && ((it.status & 1) === 1)), 'descr'));
									})

									const unclosedContact = ctcs.find(c=>!c.closingDate)
									const allContacts = unclosedContact?ctcs.concat([unclosedContact]):ctcs
									const templateKeys = descrPattern.match(/\{.+?\}/g).map(s=>s.substring(1,s.length-1)).reduce((acc,s)=>{acc[s]=true; return acc},{})
									allContacts.forEach(ctc=>{
										ctc.healthElements = Object.values(ctc.subContacts.map(sc=>sc.planOfActionId && combinedHes.find(he=>he.plansOfAction.find(poa=>poa.id === sc.planOfActionId)) || sc.healthElementId && combinedHes.find(he=>he.id === sc.healthElementId)).reduce((acc,x)=>{x && x.id && (acc[x.id]=x); return acc},{}))
										ctc.userDescr = this.api.template(descrPattern, ctc.services.filter(s=>templateKeys[s.label]&&!s.endOfLife).reduce((acc,v)=>{acc[v.label]=!acc[v.label]?this.shortServiceDescription(v,this.language):(acc[v.label]+","+this.shortServiceDescription(v,this.language)); return acc}, {}))
										if (!ctc.userDescr || ctc.userDescr.length<3) {
											ctc.userDescr = ctc.descr
										}
									})


									;(unclosedContact && Promise.resolve(unclosedContact) || this.api.contact().new(this.user, patient, {descr: 'Contact du jour', userDescr: 'Contact du jour'})).then(newCtc => {
										const thisYear = moment().year()
										this.set('contacts',ctcs)
										this.set('currentContact', newCtc)
										this.set('contactYears', _.sortBy(_.values(_.reduce(ctcs, (acc, ctc) => {
											if (ctc.subContacts && ctc.subContacts.length || ctc.services.find(s=>_.values(s.content).find(this.contentHasData.bind(this)))) {
												let year = parseInt((ctc.openingDate || 2000).toString().substr(0, 4));
												const contacts = (acc[year] || (acc[year] = {year: year, contacts: []})).contacts
												if (!contacts.includes(ctc)) {
													contacts.push(ctc)
												}
											}
											return acc
										}, _.fromPairs([[thisYear,{year:thisYear, contacts:[newCtc]}]]))).map(x => {x.contacts = _.sortBy(x.contacts, sorter); return x}),x=>-x.year))
										this.filterEvents()
									});
								})

								this.api.contact().filterServices(ctcs, s=>s.tags.find(c=>c.type === 'CD-ITEM' && c.code === 'familyrisk')).then(familyrisks => this.set('familyrisks',_.sortBy(familyrisks, sorter)))
								this.api.contact().filterServices(ctcs, s=>s.tags.find(c=>c.type === 'CD-ITEM' && c.code === 'risk')).then(risks => this.set('risks',_.sortBy(risks, sorter)))
								this.api.contact().filterServices(ctcs, s=>s.tags.find(c=>c.type === 'CD-ITEM' && (c.code === 'allergy' || c.code === 'adr'))).then(allergies => this.set('allergies',_.sortBy(allergies, sorter)))
								this.api.contact().filterServices(ctcs, s=>s.tags.find(c=>c.type === 'CD-ITEM' && (c.code === 'medication'))).then(medications => this.set('medications',_.sortBy(medications, sorter)))

								this._updateFilterPanels();
							} )

					//eHealth stuff
					if (patient.ssin && this.api.tokenId) {
						this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then( hcp =>
							this.api.fhc().Geninscontroller().getGeneralInsurabilityUsingGET(patient.ssin, this.api.tokenId, this.api.keystoreId, this.api.credentials.ehpassword, hcp.nihii, hcp.ssin, hcp.lastName, "doctor", null, null).then(gi => {
								const genInsOk = (!gi.faultCode && gi.insurabilities && gi.insurabilities.length && gi.insurabilities[0].ct1 && !(gi.generalSituation && gi.generalSituation.length))
								const medicalHouse = gi.medicalHouseInfo && gi.medicalHouseInfo.medical&& this.api.before(gi.medicalHouseInfo.periodStart, +(new Date())) && (!gi.medicalHouseInfo.periodEnd || this.api.after(gi.medicalHouseInfo.periodEnd+(24*3600*1000), +(new Date())))

								this.$.insuranceStatus.classList.remove('medicalHouse')
								this.$.insuranceStatus.classList.remove('noInsurance')
								this.$.insuranceStatus.classList.remove('insuranceOk')

								this.$.insuranceStatus.classList.add(genInsOk ? medicalHouse ? 'medicalHouse' : 'insuranceOk' : 'noInsurance')
								Polymer.updateStyles(this.$.insuranceStatus)

								if (genInsOk) {
									//set gen ins info on patient
									const pi = patient.insurabilities && _.assign({},patient.insurabilities[0] || {})
									const ins = gi.insurabilities[0]
									this.api.insurance().listInsurancesByCode(ins.mutuality).then(out => {
										if (out && out.length) {
											pi.insuranceId = out[0].id
										}
										if (ins.ct1 && (pi.parameters.tc1 !== ins.ct1)) {
											pi.parameters = _.assign(pi.parameters || {}, {tc1: ins.ct1, preferentialstatus: parseInt(ins.ct1) % 2 === 1 ? 'true':'false'})
										}
										ins.ct2 && (pi.parameters.tc2 !== ins.ct2) && (pi.parameters = _.assign(pi.parameters || {}, {tc2: ins.ct2}));
										ins.paymentApproval ? (pi.parameters = _.assign(pi.parameters || {}, {paymentapproval: 'true'})) : (delete pi.parameters.paymentapproval);
										if (patient === this.patient) { this.set('patient.insurabilities.0', pi) }
									})
								}
							})
						)
					}
				}
			},
			unselectAdminFile: function() {
				this.$.adminFileMenu.select(null)
			},
			closeContact: function(e) {
				e.stopPropagation();
				e.preventDefault();
				const ctcId = e.target.id.substr(6)
				const year = this.contactYears.find(y => y.contacts.find(c => c.id === ctcId))
				const contact = year.contacts.find(c => c.id === ctcId)

				if (contact) {
					contact.closingDate = parseInt(moment().format('YYYYMMDDHHmmss'));
					(contact.rev ? this.api.contact().modifyContact(contact) : this.api.contact().createContact(contact)).then(c => (contact.rev = c.rev)
						&& this.notifyPath('contactYears.'+(this.contactYears.indexOf(year))+'.contacts.'+(year.contacts.indexOf(contact))+'.closingDate'))
					this.notifyPath('currentContact.closingDate')
				}
			},

			selectedMainElementsChanged: function(newSelection, oldSelection) {
				newSelection && newSelection.forEach(tgt=>{
					if (this.selectedAdminFile) {
						this.unselectAdminFile()
					}
					tgt.setAttribute("aria-selected",true)
					if (!tgt.classList.contains("iron-selected")) { tgt.classList.add("iron-selected") }
				})
				oldSelection && oldSelection.forEach(tgt=>{
					tgt.removeAttribute("aria-selected")
					if (tgt.classList.contains("iron-selected")) { tgt.classList.remove("iron-selected") }
				})
				this.updateContactYears()
				this._updateFilterPanels();
			},

			selectedMainElementsSpliced: function(changeRecord) {
				if (changeRecord) {
					changeRecord.indexSplices.forEach(function(s) {
						s.removed.forEach(function(tgt) {
							tgt.removeAttribute("aria-selected")
							if (tgt.classList.contains("iron-selected")) { tgt.classList.remove("iron-selected") }
						});
						for (var i=0; i<s.addedCount; i++) {
							let index = s.index + i;
							let tgt = s.object[index];
							if (this.selectedAdminFile) {
								this.unselectAdminFile()
							}
							tgt.setAttribute("aria-selected",true)
							if (!tgt.classList.contains("iron-selected")) { tgt.classList.add("iron-selected") }
						}
					}, this);
					this.updateContactYears()
				}
			},

			_archive: function(event,target) {
				const model = this.$.activeHesDomRepeat.modelForElement(event.target) || this.$.inactiveHesDomRepeat.modelForElement(event.target)
				if (model.he.id) {
					this.api.helement().getHealthElement(model.he.id).then(he => {
						if (!he.closingDate && he.closingDate !== 0) { he.closingDate = parseInt(moment().format('YYYYMMDDHHmmss')) }
						if ((he.status & 1) === 0) { he.status = he.status | 1 }
						this.api.helement().modifyHealthElement(he).then(() => { this.patientChanged() })
					})
				} else if (model.he.idService) {
					if (!this.currentContact) { return }
					const svc = model.he.svc

					if (!svc.closingDate && svc.closingDate !== 0) { svc.closingDate = parseInt(moment().format('YYYYMMDDHHmmss')) }
					if ((svc.status & 1) === 0) { svc.status = svc.status | 1 }
					this.saveService(svc).then(c => this.patientChanged())
				}
			},
			_activate: function(event,target) {
				const model = this.$.inactiveHesDomRepeat.modelForElement(event.target) || this.$.archivedHesDomRepeat.modelForElement(event.target)
				if (model.he.id) {
					this.api.helement().getHealthElement(model.he.id).then(he => {
						if (he.closingDate || he.closingDate === 0) { he.closingDate =  null }
						if ((he.status & 1) === 1) { he.status = he.status - 1 }
						this.api.helement().modifyHealthElement(he).then(he => { this.patientChanged() })
					})
				} else if (model.he.idService) {
					if (!this.currentContact) { return }
					const svc = model.he.svc

					if (svc.closingDate || svc.closingDate === 0) { svc.closingDate =  null }
					if ((svc.status & 1) === 1) { svc.status = svc.status - 1 }
					this.saveService(svc).then(c => this.patientChanged())
				}
			},
			_inactivate: function(event,target) {
				const model = this.$.activeHesDomRepeat.modelForElement(event.target) || this.$.archivedHesDomRepeat.modelForElement(event.target)
				if (model.he.id) {
					this.api.helement().getHealthElement(model.he.id).then(he => {
						if (!he.closingDate && he.closingDate !== 0) { he.closingDate =  parseInt(moment().format('YYYYMMDDHHmmss'))}
						if ((he.status & 1) === 1) { he.status = he.status - 1 }
						this.api.helement().modifyHealthElement(he).then(he => {
							this.patientChanged()
						})
					})
				} else if (model.he.idService) {
					if (!this.currentContact) { return }
					const svc = model.he.svc

					if (!svc.closingDate && svc.closingDate !== 0) { svc.closingDate = parseInt(moment().format('YYYYMMDDHHmmss')) }
					if ((svc.status & 1) === 1) { svc.status = svc.status - 1 }

					this.saveService(svc).then(c => this.patientChanged())
				}
			},
			_selectToday: function() {
				this.$.adminFileMenu.select(1)

				this.set('timeSpanStart', parseInt(moment().startOf('day').format('YYYYMMDD')))
				this.set('timeSpanEnd', null)

				this.updateContactYears()
			},


			_select6Months: function() {
				this.set('timeSpanStart', parseInt(moment().subtract(6, 'month').format('YYYYMMDD')))
				this.set('timeSpanEnd', null)

				this.updateContactYears()
			},

			_selectAll: function() {
				this.set('timeSpanStart', null)
				this.set('timeSpanEnd', null)

				this.updateContactYears()
			},

			_selectCurrentContact: function() {
				this.shadowRoot.querySelector('#_contacts_listbox').set('selectedValues',[0])
			},

			updateContactYears: function () {
				this.notifyPath('contactYears')
			},

			getHeId: function(he) {
				return he.id?`_he_${he.id}`:`_svc_${he.idService}`
			},

			extractDbObjectsIds: function(domElements) {
				if (!domElements || !domElements.length) { return {hes:[], poas:[]} }
				return {hes:_.flatMap(domElements,dom=>{
					return dom.id && dom.id.startsWith("_he_") ? [ "he:"+dom.id.substr(4) ] :
							dom.id && dom.id.startsWith("_svc_group_familyrisks") ? this.familyrisks.map(svc=>`svc:${svc.id}`) :
								dom.id && dom.id.startsWith("_svc_group_risks") ? this.risks.map(svc=>`svc:${svc.id}`) :
									dom.id && dom.id.startsWith("_svc_group_medications") ? this.medications.map(svc=>`svc:${svc.id}`) :
									dom.id && dom.id.startsWith("_svc_group_allergies") ? this.allergies.map(svc=>`svc:${svc.id}`) :
										dom.id && dom.id.startsWith("_svc_") ? [ "svc:"+dom.id.substr(5) ] : []
				}), poas:_.flatMap(domElements,dom=>{
					return dom.id && dom.id.startsWith("_he_") ? _.flatMap(this.activeHealthElements.filter(he=>he.id === dom.id.substr(4)),he => he.plansOfAction.map(poa=>poa.id)) : []
				})}
			},

			contactFilter: function() {
				return function (ctc) {
					const regExp = this.contactSearchString && new RegExp(this.contactSearchString, "i")
					const objectIds = this.extractDbObjectsIds(this.selectedMainElements)

					const heIds = objectIds.hes.filter(id => id && id.startsWith("he:")).map(id => id.substr(3))
					const poaIds = objectIds.poas
					const svcIds = objectIds.hes.filter(id => id && id.startsWith("svc:")).map(id => id.substr(4))

					return this.api.after(ctc.openingDate, this.timeSpanStart) && this.api.before(ctc.openingDate, this.timeSpanEnd)
						&& (!regExp || (ctc.subContacts.filter(sc => sc.descr && sc.descr.match(regExp) && sc.services.length).length || ctc.services.filter(s => this.shortServiceDescription(s, this.language).match(regExp)).length))
						&& ((!heIds.length && !poaIds.length && !svcIds.length)
						|| ctc.subContacts.filter(sc => ((sc.healthElementId && heIds.includes(sc.healthElementId) || sc.planOfActionId && poaIds.includes(sc.planOfActionId)) && sc.services.length)).length
						|| ctc.services.filter(s => svcIds.includes(s.id)).length)
						|| !ctc.closingDate
				}.bind(this)
			},

			compareContacts: function(a,b) {
				return b.created - a.created
			},

			close: function () {
				this.set('patient', null);
			},

			selectedAdminFileChanged: function(el) {
				if (el && this.selectedMainElements && this.selectedMainElements.length) {
					this.set("selectedMainElements",[])
				}
				this._updateFilterPanels();
			},

			_toggleEditHE: function(e){
				e.stopPropagation()
				e.preventDefault()

				let parentElement = e.target.parentElement
				if (parentElement.classList.contains('open')) {
					parentElement.classList.remove('open');
					const model = this.$.activeHesDomRepeat.modelForElement(e.target) || this.$.inactiveHesDomRepeat.modelForElement(e.target) || this.$.archivedHesDomRepeat.modelForElement(e.target)

					this.$['edit-healthelement-dialog'].set('entity', _.assign({plansOfAction:[]}, model.he))
					this.$['edit-healthelement-dialog'].set('filterValue', model.he.descr)
					this.$['edit-healthelement-dialog'].open()
				} else {
					parentElement.classList.add('open');
					setTimeout(()=>parentElement.classList.remove('open'),4000)
				}
			},

			toggleMenu: function(e) {
				e.stopPropagation()
				e.preventDefault()

				const styxdb = styx
				styx.parent(e.target,(el)=>el.tagName.toLowerCase()==='collapse-button').toggle()
				styx.parent(e.target,(el)=>el.tagName.toLowerCase()==='paper-item').classList.toggle('opened');

				this._updateFilterPanels();
			},

			getPaperItemParentForEvent: function (e) {
				let tgt = e.target;
				while (tgt.tagName.toLowerCase() !== 'paper-item') {
					tgt = tgt.parentElement
				}
				return tgt
			},

			selectTopMenu: function(e) {
				e.stopPropagation()
				e.preventDefault()
				let tgt = this.getPaperItemParentForEvent(e)
				if (e.detail.sourceEvent.metaKey) {
					if (this.selectedMainElements && !this.selectedMainElements.includes(tgt)) {
						this.push('selectedMainElements', tgt);
					}
				} else {
					this.selectedMainElements.forEach(el=>el.nextElementSibling && el.nextElementSibling.selectedValues && el.nextElementSibling.selectedValues.length && el.nextElementSibling.set && el.nextElementSibling.set('selectedValues', []))
					this.set('selectedMainElements',[tgt])
				}
			},

			unselectTopMenu: function(e) {
				e.stopPropagation()
				e.preventDefault()
				let tgt = this.getPaperItemParentForEvent(e)
				if (e.detail.sourceEvent.metaKey) {
					if (this.selectedMainElements && this.selectedMainElements.includes(tgt)) {
						let idx = this.selectedMainElements.indexOf(tgt)
						idx >= 0 && this.splice('selectedMainElements', idx, 1)
					}
				} else {
					this.selectedMainElements.forEach(el=>el.nextElementSibling && el.nextElementSibling.selectedValues && el.nextElementSibling.selectedValues.length && el.nextElementSibling.set && el.nextElementSibling.set('selectedValues', []))
					this.set('selectedMainElements',[])
				}
			},

			toggleTopMenu: function(e) {
				e.stopPropagation()
				e.preventDefault()
				let tgt = this.getPaperItemParentForEvent(e)

				if (e.detail.sourceEvent.metaKey) {
					if (this.selectedMainElements && this.selectedMainElements.includes(tgt)) {
						let idx = this.selectedMainElements.indexOf(tgt)
						idx >= 0 && this.splice('selectedMainElements', idx, 1)
					} else if (this.selectedMainElements) {
						this.push('selectedMainElements', tgt);
					}
				} else {
					this.selectedMainElements.forEach(el=>el.nextElementSibling && el.nextElementSibling.selectedValues && el.nextElementSibling.selectedValues.length && el.nextElementSibling.set && el.nextElementSibling.set('selectedValues', []))
					this.set('selectedMainElements',[tgt])
				}
			},

			toggleSelectAll: function(e){
				let paperListbox = this.getPaperItemParentForEvent(e).nextElementSibling;
				this.itemSelected = true;
				if (paperListbox.items.length) {
					if (paperListbox.selectedValues.length === paperListbox.items.length) {
						this.unselectTopMenu(e);
						paperListbox.set('selectedValues', []);
					} else {
						this.selectTopMenu(e);
						paperListbox.set('selectedValues', paperListbox.items.map((o, idx) => idx));
					}
				} else {
					this.toggleTopMenu(e);
				}
				this._updateFilterPanels();

			},

			isNotEmpty: function(a) {
				return a && a.length>0
			},

			isEmpty: function(a) {
				return !a || a.length===0
			},

			isAdminSelected: function(el) {
				return el && el.id === '_admin_info'
			},

			highlightedServiceLabels: function(user) {
				try {
					return user.properties.filter(p => p.type.identifier === 'org.taktik.icure.highlightedServiceLabels').map(p => JSON.parse(p.typedValue.stringValue))[0]
						|| ['Examen clinique', 'Diagnostics', 'Prescription']
				} catch (e) {}
				return ['Examen clinique', 'Diagnostics', 'Prescription']
			},

			hcp: function(ctc) {
				const usr = this.api.users && this.api.users[ctc.author]
				const hcp = usr ? this.api.hcParties[usr.healthcarePartyId] : null
				return (hcp && (hcp.lastName + " " + (hcp.firstName && hcp.firstName.length && (hcp.firstName.substr(0,1) + ".")))) || (usr && usr.login) || "N/A"
			},

			picture: function(pat) {
				if (!pat) { return require('../../../images/Male-128.jpg') }
				return pat.picture ? 'data:image/jpeg;base64,'+pat.picture : pat.gender === 'F' || pat.gender === 'f' ? require('../../../images/Female-128.jpg') : require('../../../images/Male-128.jpg')
			},

			serviceDescriptions : function(ctc, label) {
				return this.api && this.api.contact().services(ctc, label).filter(s=>!s.endOfLife).map(s=>this.shortServiceDescription(s, this.language)).filter(desc=>desc) || []
			},

			shortServiceDescription : function(svc, lng) {
				let rawDesc = svc && this.api && this.api.contact().shortServiceDescription(svc, lng)
				return rawDesc && (''+rawDesc) || ''
			},

			contentHasData: function(c) {
				return this.api && this.api.contact().contentHasData(c) || false
			},

			localize: function(e, lng) {
				return this.api && this.api.contact().localize(e, lng) || ""
			},

			_addHealthElement: function() {
				this.$['add-healthelement-dialog'].open()
				this.$['add-healthelement-dialog'].set('entity',{plansOfAction:[]})
			},

			_addInactiveHealthElement: function() {
				this.$['add-healthelement-dialog'].open()
				this.$['add-healthelement-dialog'].set('entity',{plansOfAction:[], closingDate:parseInt(moment().format('YYYYMMDDHHmmss'))})
			},


			_addService: function(e) {
				this.set('editedSvcLabel', e.target.dataset.label)
				this.$['add-service-dialog'].open()
				this.$['add-service-dialog'].set('entity',{'label':e.target.dataset.label, 'tags':e.target.dataset.tags.split(',').map(c=>({id:c, type:c.split('|')[0], code:c.split('|')[1], version:c.split('|')[2]}))})
			},


			_healthElementsSelectorColumns: function () {
				return [{key: 'descr', title: 'Description'}, {key: 'plansOfActionDescr', title: 'Plans of action'}]
			},

			_healthElementsSelectorDataProvider: function () {
				return {
					filter: function (filterValue, limit, offset, sortKey, descending) {
						const regExp = filterValue && new RegExp(filterValue, "i")

						return Promise.all([this.api.code().findPaginatedCodesByLabel('be','BE-THESAURUS','fr',filterValue,null,1000), this.api.entitytemplate().findEntityTemplates(this.user.id, 'org.taktik.icure.entities.HealthElementTemplate', null, true)])
							.then(results => {
								const codes = results[0]
								const entityTemplates = results[1]
								const filtered = _.flatten(entityTemplates.map(et => et.entity))
									.filter( he => [he].concat(he.plansOfAction || []).find(it => (it.descr && it.descr.match(regExp)) || (it.name && it.name.match(regExp))))
									.map(it => ({descr:it.descr || it.name, healthElement: it, plansOfAction: it.plansOfAction || [], plansOfActionDescr: (it.plansOfAction && it.plansOfAction.map(poa => poa.descr || poa.name) || []).join(',')}))
								.concat(codes.rows.map(code => ({descr:this.api.localize(code.label), codes: code.links, plansOfAction: [], plansOfActionDescr: 'N/A'})))
								return {totalSize: filtered.length, rows: (descending ? _.reverse(_.sortBy(filtered, sortKey)) : _.sortBy(filtered, sortKey)).slice(offset, limit)}
							})
					}.bind(this)
			    }
			},
			_addedHealthElementSelected: function(event, healthElement) {
				this.api.helement().new(this.user, this.patient, {
					descr: healthElement.descr,
					plansOfAction:(healthElement.plansOfAction||[]).map( poa => _.extend(poa, {id: this.api.crypto().randomUuid(), openingDate: parseInt(moment().format('YYYYMMDDHHmmss'))})),
					codes: (healthElement.codes || []).map( c => ({id: c, type: c.split(/\|/)[0], code: c.split(/\|/)[1], version: c.split(/\|/)[2]}) )
				}).then(he => this.api.helement().createHealthElement(he)).then(he => this.patientChanged())
			},
			_editedHealthElementSelected: function(event, healthElement) {
				this.api.helement().getHealthElement(event.id).then(he => {
					delete healthElement.plansOfActionDescr
					_.assign(he,healthElement)
					return he
				}).then(he => this.api.helement().modifyHealthElement(he)).then(he => this.patientChanged())
			},

			_servicesSelectorColumns: function () {
				return [{key:svc=>svc&&svc.content&&this.shortServiceDescription(svc,this.language)||'', sortKey: 'content.'+this.language+'.stringValue', title: 'Description'}, {key:svc=>svc && svc.codes && svc.codes.map(c=>(c.type||(c.id && c.id.split('|')[0]))+':'+(c.code||(c.id && c.id.split('|')[1]))).join(',') || '', sortKey: 'codes.0.code', title: 'Codes'}]
			},

			_servicesSelectorDataProvider: function (label) {
				return {
					filter: function (filterValue, limit, offset, sortKey, descending) {
						const regExp = filterValue && new RegExp(filterValue, "i")

						return this.api.code().findPaginatedCodesByLabel('be','BE-THESAURUS','fr',filterValue,null,1000)
							.then(results => {
								const filtered = results.rows.map(code => ({label:label, content:_.mapValues(code.label, v=>({stringValue:v})), codes: code.links && code.links.map(c=>({id:c, type:c.split('|')[0], code:c.split('|')[1], version:c.split('|')[2]})) || []}))
								return {totalSize: filtered.length, rows: (descending ? _.reverse(_.sortBy(filtered, sortKey)) : _.sortBy(filtered, sortKey)).slice(offset, limit)}
							})
					}.bind(this)
				}
			},
			_addedOrEditedServiceSelected: function(event, svc) {
				if (!this.currentContact) { return }
				this.saveService(svc).then(c => this.patientChanged())
			},
			_svcEntityContentChanged: function(e, value) {
				const svc = styx.parent(e.target,(el)=>el.tagName.toLowerCase()==='entity-selector').entity
				const content = (svc.content || (svc.content = {}))
				;(content[this.language] || (content[this.language] = {})).stringValue = value
			},

			_updateFilterPanels: function () {
				setTimeout(()=>{
					Polymer.dom(this.root).querySelector("#contactFilterPanel").refreshIcons()
					Polymer.dom(this.root).querySelector("ht-pat-detail-ctc-detail-panel").refreshIcons()
				},10)
			},

			_expandColumn: function(e){
				this.root.querySelector('.display-left-menu').classList.toggle('open');
				this.root.querySelector('.container').classList.toggle('expanded');
				this._updateFilterPanels()
			},

			_concat(a,b) {
				return (a||[]).concat(b||[])
			}

		});
	</script>
</dom-module>
