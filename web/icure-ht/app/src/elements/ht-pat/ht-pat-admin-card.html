<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/vaadin-tabs/vaadin-tabs.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">


<link rel="import" href="../dynamic-form/dynamic-form.html">

<dom-module id="ht-pat-admin-card">
	<template>
		<style include="iron-flex iron-flex-alignment"></style>
		<style>
			:host {
				height: 100%;
				padding-top:32px;
			}

			.container {
				width: 100%;
				height: 100%;
			}

			paper-material.card {
				background-color: #fff;
				padding: 10px;
				margin-left: 5px;
				margin-right: 5px;
				margin-bottom: 10px;
			}

			paper-input {
				padding-left: 5px;
				padding-right: 5px;
			}

            paper-input {
                --paper-input-container-focus-color: var(--app-primary-color);
                --paper-input-container-label: {
                    color: var(--app-text-color);
                    opacity: 1;
                };
                --paper-input-container-underline-disabled: {
                    border-bottom: 1px solid var(--app-text-color);

                };
                --paper-input-container-color: var(--app-text-color);
            }

			paper-dropdown-menu {
				padding-left: 5px;
				padding-right: 5px;
			}

            iron-pages {
                padding: 10px;
                width: 100%;
                height: calc(100% - 140px);
            }

            page>dynamic-form{
                width: 100%;
            }

            .adm-tab:focus>iron-icon{
                color: var(--app-secondary-color);
            }

            .adm-tab:before{
                color: var(--app-secondary-color);
                width: 80%;
            }


            :host #institution-list {
                height: calc(100% - 140px);
                outline: none;
            }

            #institution-list{
                width: 98%;
                padding: 5px;
                height: calc(100% - 140px);
            }

            .grid-institution{
                width: 100%;
                padding: 5px;
                height: calc(100% - 20px);
            }

            vaadin-grid.material {

                font-family: Roboto, sans-serif;
                --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                --vaadin-grid-cell: {
                    padding: 8px;
                };

                --vaadin-grid-header-cell: {
                    height: 64px;
                    color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                    font-size: 12px;
                };

                --vaadin-grid-body-cell: {
                    height: 48px;
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                    font-size: 13px;
                };

                --vaadin-grid-body-row-hover-cell: {
                    background-color: var(--paper-grey-200);
                };

                --vaadin-grid-body-row-selected-cell: {
                    background-color: var(--paper-grey-100);
                };

                --vaadin-grid-focused-cell: {
                    box-shadow: none;
                    font-weight: bold;
                };
            }

            vaadin-grid.material .cell {
                overflow: hidden;
                text-overflow: ellipsis;
                padding-right: 56px;
            }

            vaadin-grid.material .cell.last {
                padding-right: 24px;
            }

            vaadin-grid.material .cell.numeric {
                text-align: right;
            }

            vaadin-grid.material paper-checkbox {
                --primary-color: var(--paper-indigo-500);
                margin: 0 24px;
            }

            vaadin-grid.material vaadin-grid-sorter .cell {
                flex: 1;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            vaadin-grid.material vaadin-grid-sorter iron-icon {
                transform: scale(0.8);
            }

            vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                color: rgba(0, 0, 0, var(--dark-disabled-opacity));
            }

            vaadin-grid.material vaadin-grid-sorter[direction] {
                color: rgba(0, 0, 0, var(--dark-primary-opacity));
            }

            vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                transform: scale(0.8) rotate(180deg);
            }

            .buttons{
                position: absolute;
                bottom: 0;
                right: 12px;
            }

            #dialogAddInstitution{
                height: 400px;
                width: 600px;
            }

            .formAddStay{
                width: 100%;
                border-collapse: collapse;
            }

            .full-width{
                width: 100%;
            }

            .modal-button{
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
            }

            .modal-button--save{
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;

            }

            .administrative-panel {
                height: 100%;
                background: var(--app-background-color);
                top: 64px;
                left: 20%;
                @apply --shadow-elevation-2dp;
                margin: 0;
                grid-column: 2 / 4;
                grid-row: 1 / 1;
                z-index: 2;
                padding: 5px;

            }

            .add-btn-stay-container{
                display:table;
                margin: auto;
            }

            .btn{
                --paper-button-ink-color: var(--app-secondary-color-dark);
                background: var(--app-secondary-color);
                color: var(--app-text-color);
                font-weight: 700;
                font-size: 12px;
                height: 40px;
                min-width: 100px;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                padding: 10px 1.2em;
            }

            #institutionComment{
                height: 140px;
            }

            #add-person-to-care-team{
                height: 600px;
                width: 800px;
            }

            #add-new-person-to-care-team{
                height: 450px;
                width: 500px;
            }

            #internal-care-team-list{
                height: 250px;
            }

            #external-care-team-list{
                height: 250px;
            }

            #showHcpInfo{
                height: 600px;
                width: 700px;
                overflow: auto;
            }

            .iconHcpInfo{
                height: 18px;
            }

            .titleHcpInfo{
                height: 25px;
                width: auto;
                color: var(--app-secondary-color);
                background-color: var(--app-primary-color-dark);
                padding: 2px;
                margin-top: 5px;
            }

            .titleHcpInfo_Icon{
                height: 30px;
                width: 30px;
                float: left;
            }

            .titleHcpInfo_Txt{
                float: left;
                padding: 2px;
            }

            .indent{
                margin-left: 2%;
            }

            .label{
                font-weight: bold;
            }

            .hcpAdr{
                margin-bottom: 10px;
            }


        </style>
        <div class="administrative-panel">
            <vaadin-tabs selected="{{tabs}}">
                <vaadin-tab class="adm-tab"><iron-icon icon="vaadin:clipboard-text"></iron-icon>[[localize('adm_form','Administrative form',language)]]</vaadin-tab>
                <vaadin-tab class="adm-tab"><iron-icon icon="vaadin:family"></iron-icon>[[localize('adm_ctc_per','Contact persons',language)]]</vaadin-tab>
                <vaadin-tab class="adm-tab"><iron-icon icon="vaadin:users"></iron-icon>[[localize('adm_h_t','Care team',language)]]</vaadin-tab>
            </vaadin-tabs>

            <iron-pages selected="[[tabs]]" class="">
                <page>
                    <dynamic-form id="dynamic-form-administrative" api="[[api]]" user="[[user]]" template="[[patientForm]]" data-map="[[patientMap]]" data-provider="[[dataProvider]]" i18n="[[i18n]]" resources="[[resources]]" language="[[language]]"></dynamic-form>
                </page>
                <page>
                    <dynamic-form id="dynamic-form-partnerships" api="[[api]]" user="[[user]]" template="[[partnershipsContainerForm]]" data-map="[[patientMap]]" data-provider="[[dataProvider]]" i18n="[[i18n]]" resources="[[resources]]" language="[[language]]"></dynamic-form>
                </page>
                <page>
                    <div>
                        <h4>Prestataires de soins internes</h4>
                        <vaadin-grid id="internal-care-team-list" class="material" overflow="bottom" multi-sort="[[multiSort]]" items=[[currentInternalCareTeam]] active-item="{{selectedCareProvider}}" on-tap="showInfoSelectedHcp">
                            <vaadin-grid-column width="120px">
                                <template class="header">
                                    <vaadin-grid-sorter path="lastName">[[localize('las_nam','Last name',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen">[[item.firstName]]</div>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="120px">
                                <template class="header">
                                    <vaadin-grid-sorter path="firstName">[[localize('fir_nam','Last name',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen">[[item.lastName]]</div>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="80px">
                                <template class="header">
                                    <vaadin-grid-sorter path="nihii">[[localize('inami','Nihii',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen">[[item.nihii]]</div>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="80px">
                                <template class="header">
                                    <vaadin-grid-sorter path="speciality">[[localize('speciality','Speciality',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen">[[item.speciality]]</div>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="50px">
                                <template class="header">
                                    <vaadin-grid-sorter path="dmg">[[localize('adm_dmg','Dmg',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen"></div>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                    <div>
                        <h4>Prestataires de soins externes</h4>
                        <vaadin-grid id="external-care-team-list" class="material" overflow="bottom" multi-sort="[[multiSort]]" items="[[currentExternalCareTeam]]" active-item="{{selectedCareProvider}}" on-tap="showInfoSelectedHcp">
                            <vaadin-grid-column width="120px">
                                <template class="header">
                                    <vaadin-grid-sorter path="lastName">[[localize('las_nam','Last name',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen">[[item.firstName]]</div>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="120px">
                                <template class="header">
                                    <vaadin-grid-sorter path="firstName">[[localize('fir_nam','Last name',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen">[[item.lastName]]</div>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="80px">
                                <template class="header">
                                    <vaadin-grid-sorter path="nihii">[[localize('inami','Nihii',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen">[[item.nihii]]</div>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="80px">
                                <template class="header">
                                    <vaadin-grid-sorter path="speciality">[[localize('speciality','Speciality',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen">[[item.speciality]]</div>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="50px">
                                <template class="header">
                                    <vaadin-grid-sorter path="dmg">[[localize('adm_dmg','Dmg',language)]]</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <div class="cell frozen"></div>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                    <div class="buttons">
                        <paper-button on-tap="showAddPersonToCareTeam">Add</paper-button>
                    </div>
                </page>
            </iron-pages>
        </div>

        <paper-dialog id="add-person-to-care-team">
            <div>
                <h3>[[localize('add_per_to_car_tea','Last name',language)]]</h3>
            </div>
            <div>
                <vaadin-grid id="hcp-list" class="material" overflow="bottom" items=[[currentHcp]] active-item="{{selectedHcp}}">
                    <vaadin-grid-column width="100px">
                        <template class="header">
                        </template>
                        <template>
                            <vaadin-checkbox id="[[item.id]]" checked="[[_sharingHcp(item, currentHcp.*)]]" on-checked-changed="_checkHcp"></vaadin-checkbox>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="120px">
                        <template class="header">
                            <vaadin-grid-sorter path="lastName">[[localize('las_nam','Last name',language)]]</vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class="cell frozen">[[item.lastName]]</div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="120px">
                        <template class="header">
                            <vaadin-grid-sorter path="firstName">[[localize('fir_nam','First name',language)]]</vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class="cell frozen">[[item.firstName]]</div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="80px">
                        <template class="header">
                            <vaadin-grid-sorter path="nihii">[[localize('inami','Nihii',language)]]</vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class="cell frozen">[[item.nihii]]</div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="80px">
                        <template class="header">
                            <vaadin-grid-sorter path="speciality">[[localize('speciality','Speciality',language)]]</vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class="cell frozen">[[item.speciality]]</div>
                        </template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
                <paper-button class="modal-button" on-tap="showAddNewPersonToCareTeamForm">[[localize('new_per','New person',language)]]</paper-button>
                <paper-button class="modal-button--save" dialog-confirm autofocus on-tap="confirmSharing">[[localize('save','Save',language)]]</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="add-new-person-to-care-team">
            <div>
                <h3>Add new person to the care team</h3>
            </div>
            <div>
                <paper-input id="" label="Last name" value="{{newHcpCareTeam.LastName}}"></paper-input>
                <paper-input id="" label="First name" value="{{newHcpCareTeam.FirstName}}"></paper-input>
                <paper-input id="" label="Nihii" value="{{newHcpCareTeam.Nihii}}"></paper-input>
                <paper-input id="" label="Job" value="{{newHcpCareTeam.Job}}"></paper-input>
                <vaadin-checkbox id="" checked="[[newHcpCareTeam.Dmg]]"></vaadin-checkbox>
                <vaadin-date-picker id="" label="Date of signature" value="{{newHcpCareTeam.DateOfSignature}}" i18n="[[i18n]]"></vaadin-date-picker>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
                <paper-button class="modal-button--save" dialog-confirm autofocus on-tap="addNewPersonToCareTeam">[[localize('save','Save',language)]]</paper-button>
            </div>
        </paper-dialog>


        <paper-dialog id="showHcpInfo">
            <div>
                <div>
                   <div class="titleHcpInfo">
                       <div class="titleHcpInfo_Icon">
                            <iron-icon icon="vaadin:info-circle-o"></iron-icon>
                       </div>
                       <div class="titleHcpInfo_Txt">
                           [[localize('gen_info','General informations',language)]]
                       </div>
                   </div>
                   <div class="indent">
                        <div><span class="label">[[localize('las_nam','Last name',language)]]: </span>[[selectedPerson.lastName]]</div>
                        <div><span class="label">[[localize('fir_name','First name',language)]]:</span>[[selectedPerson.firstName]]</div>
                        <div><span class="label">Type:</span> [[selectedPerson.hcpType]]</div>
                        <div><span class="label">[[localize('inami','Nihii',language)]]: </span>[[selectedPerson.nihii]]</div>
                        <div><span class="label">[[localize('ssin','Ssin',language)]]: </span>[[selectedPerson.ssin]]</div>
                        <div><span class="label">[[localize('speciality','Speciality',language)]]: </span>[[selectedPerson.speciality]]</div>
                   </div>
                   <template is="dom-if" if="[[selectedPerson.addresses]]">
                        <div>
                            <div class="titleHcpInfo">
                                <div class="titleHcpInfo_Icon">
                                    <iron-icon class="iconHcpInfo" icon="vaadin:home-o"></iron-icon>
                                </div>
                                <div class="titleHcpInfo_Txt">
                                    [[localize('addresses','Addresses',language)]]
                                </div>
                            </div>
                            <div class="indent">
                                <template is="dom-repeat" items="[[selectedPerson.addresses]]" as="adr">
                                    <div class="hcpAdr">
                                        <div><span class="label">[[localize('street','Street',language)]]: </span>[[adr.street]]</div>
                                        <div><span class="label">[[localize('number','Number',language)]]: </span>[[adr.number]]</div>
                                        <div><span class="label">[[localize('postalCode','Postal code',language)]]: </span>[[adr.postalCode]]</div>
                                        <div><span class="label">[[localize('city','City',language)]]: </span>[[adr.city]]</div>

                                        <template is="dom-repeat" items="[[adr.telecoms]]" as="telecom">
                                            <div><span class="label">[[localize('tel_type','Telecom type',language)]]: </span>[[telecom.telecomType]]</div>
                                            <div><span class="label">[[localize('tel_num','Telecom number',language)]]: </span>[[telecom.telecomNumber]]</div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                   </template>
                </div>
                <template is="dom-if" if="[[selectedPerson.pphc.referralPeriods]]">
                    <div>
                        <div class="titleHcpInfo">
                            <div class="titleHcpInfo_Icon">
                                <iron-icon class="iconHcpInfo" icon="vaadin:clock"></iron-icon>
                            </div>
                            <div class="titleHcpInfo_Txt">
                                [[localize('ref_per','Referral periods',language)]]
                            </div>
                        </div>
                        <div class="indent">
                            <template is="dom-repeat" items="[[selectedPerson.pphc.referralPeriods]]" as="referralPeriod">
                                <div><span class="label">[[localize('startDate','Start date',language)]]: </span>[[_timeFormat(referralPeriod.startDate)]]</div>
                                <div><span class="label">[[localize('endDate','End date',language)]]: </span>[[_timeFormat(referralPeriod.endDate)]]</div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" dialog-dismiss>[[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>

        </template>

	<script>

class HtPatAdminCard extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([], Polymer.Element)) {
	static get is() {
		return 'ht-pat-admin-card';
	}

	static get properties() {
		return {
			api: {
				type: Object
			},
			patientForm: {
				type: Object,
				value: function () {
					return require('./rsrc/PatientAdministrativeForm.json');
				}
			},
			addressForm: {
				type: Object,
				value: function () {
					return require('./rsrc/PatientAddressForm.json');
				}
			},
			telecomForm: {
				type: Object,
				value: function () {
					return require('./rsrc/PatientTelecomForm.json');
				}
			},
			insuranceForm: {
				type: Object,
				value: function () {
					return require('./rsrc/PatientInsuranceForm.json');
				}
			},
            partnershipsForm: {
                type: Object,
                value: function () {
                    return require('./rsrc/PatientPartnershipsForm.json');
                }
            },
            partnershipsContainerForm: {
                type: Object,
                value: function () {
                  return require('./rsrc/PatientPartnershipsContainerForm.json');
                }
            },
            careTeamForm: {
                type: Object,
                value: function () {
                    return require('./rsrc/PatientCareTeamForm.json');
                }
            },
			user: {
				type: Object
			},
			patient: {
				type: Object,
				notify: true
			},
			patientMap: {
				type: Object
			},
			dataProvider: {
				type: Object,
				value: null
			},

			newHcpCareTeam:{
			    type: Object,
                value: {'LastName' : '', 'FirstName' : '', 'Nihii' : '', 'Job' : '', 'Dmg' : false, 'DateOfSignature' : ''}
            },

            currentInternalCareTeam:{
                type: Array,
                value: [],
                notify: true
            },

            currentExternalCareTeam:{
			    type: Array,
                value: [],
                notify: true
            },

            currentHcp:{
                type: Array,
                value: []
            },
            selectedCareProvider:{
                type: Object
            },
            selectedPerson:{
			    type: Object
            },
            hcpSelectedForTeam: {
                type: Object,
                notify: true,
                value: () => []
            },
		};
	}

	static get observers() {
		return ['patientChanged(api,user,patient)'];
	}

	constructor() {
		super();
	}

	detached() {
		this.flushSave();
	}

	ready(){
	    super.ready();
        this.initCurrentCareTeam();

    }

	patientChanged() {
		if (this.api && this.user && this.patient) {
			this.flushSave();

            if(this.patient.partnerships && this.patient.partnerships.length){
                Promise.all(this.patient.partnerships.map(ps =>{
                   return this.api.patient().getPatient(ps.partnerId).then(pps => {
                        const index = this.patient.partnerships.indexOf(ps)
                        this.set('patient.partnerships.'+index+'.partnerInfo', pps)
                    })
                })).then(() =>{
                    this.dataProvider = this.patientDataProvider(this.patient, '', this.patient && this.patient.id);
                    this.set('patientMap', _.cloneDeep(this.patient));

                    if(!this.root.activeElement){
                        this.$['dynamic-form-administrative'].loadDataMap();
                    }else{
                        this.$[this.root.activeElement.id].loadDataMap();
                    }
                })
            }else{
                this.dataProvider = this.patientDataProvider(this.patient, '', this.patient && this.patient.id);
                this.set('patientMap', _.cloneDeep(this.patient));

                if(!this.root.activeElement){
                    this.$['dynamic-form-administrative'].loadDataMap();
                }else{
                    this.$[this.root.activeElement.id].loadDataMap();
                }

            }
		}
	}


	scheduleSave(patient) {
		if (this.saveTimeout) {
			clearTimeout(this.saveTimeout);
		}

		this.saveAction = function () {


		    if(this.patient.partnerships){
		        const partnerships = this.patient.partnerships

                partnerships.map(partner => {
                    const mark = partnerships.find(fp => fp.partnerId === partner.partnerId)
                    const index = partnerships.indexOf(partner)
                    partner.partnerInfo.addresses = partner.addresses

                    if(!mark || !partner.partnerId){
                        //patient not present
                        partner.partnerInfo.active = false
                        partner.partnerInfo.id = partner.id
                        partner.partnerId = partner.id

                        this.api.patient().newInstance(this.user, partner.partnerInfo).then(np => {
                            this.api.patient().createPatient(np).then(np => {
                                this.set('patient.partnerships.' + index + '.partnerInfo', np)
                            })
                        })
                    }else{
                        //patient present
                        this.api.patient().modifyPatient(partner.partnerInfo).then(partner =>{
                            this.set('patient.partnerships.'+index+'.partnerInfo', partner)
                        })

                    }
                })
            }

			this.api.patient().modifyPatient(patient).then(p =>{
                this.patient && (this.patient.rev = p.rev)
			}).catch(e =>
                this.patient && this.api.patient().getPatient(this.patient.id).then(p => {
                    this.patient = p;
                    this.saveTimeout = undefined;
                    this.saveAction = undefined;
            }));
		}.bind(this);
		this.saveTimeout = setTimeout(this.saveAction, 10000);
	}

	flushSave() {
		if (this.saveTimeout) {
			clearTimeout(this.saveTimeout);
			this.saveAction();
		}
	}

	patientDataProvider(root, rootPath, id){


		const getValue = function (key) {
			return root ? _.get(root, key) : null;
		};
		const setValue = function (key, value) {
			if (root && _.get(root, key) !== value) {
				root === this.patient ? this.set('patient.' + key, value) : _.set(root, key, value);
				this.scheduleSave(this.patient);
			}
		}.bind(this);
		return {
			getStringValue: getValue,
			getNumberValue: getValue,
			getMeasureValue: getValue,
			getDateValue: getValue,
			getBooleanValue: key => root ? _.get(root, key) && _.get(root, key) !== 'false' : null,
			setStringValue: setValue,
			setNumberValue: setValue,
			setMeasureValue: setValue,
			setDateValue: setValue,
			setBooleanValue: setValue,
			getSubForms: key => {
				return (root[key] || []).map((a, idx) => {
					return {
					    dataMap: a,
                        dataProvider: this.patientDataProvider(a, (rootPath.length ? rootPath + '.' : '') + key + '.' + idx, a.id || (a.id = this.api.crypto().randomUuid())),
                        template: key === 'addresses' ? this.addressForm : key === 'telecoms' ? this.telecomForm : key === 'partnerships' ? this.partnershipsForm :  this.insuranceForm};
				});
			},
			getId: () => id,
			deleteSubForm: (key, id) => {
				this.flushSave();
				_.remove(root[key], root[key].find(a => a.id === id));
				this.$[this.root.activeElement.id].notify((rootPath.length ? rootPath + '.' : '') + key + '.*');
				this.scheduleSave(this.patient);
			},
			addSubForm: (key, guid) => {
				this.flushSave(); //Important
				(root[key] || (root[key] = [])).push({});
				this.$[this.root.activeElement.id].notify((rootPath.length ? rootPath + '.' : '') + key + '.*');
				this.scheduleSave(this.patient);

			},
			filter: (data, text, id) => {
				if (data.source === 'insurances') {
					return (text || '').length >= 2 ?
						(text.match(/^[0-9]+$/) ? this.api.insurance().listInsurancesByCode(text) : this.api.insurance().listInsurancesByName(text))
							.then(res => res.map(i => ({ 'id': i.id, 'name': this.localizeContent(i.name, this.language) }))) : id ? this.api.insurance().getInsurance(id)
							.then(i => ({ 'id': i.id, 'name': this.localizeContent(i.name, this.language) })) : Promise.resolve([]);
				} else if (data.source === 'users') {
				    const s = text && text.toLowerCase()
                    return Promise.resolve(s ? Object.values(this.api.users).filter(u=>(u.login && u.login.toLowerCase().includes(s.toLowerCase())) ||
                        (u.name && u.name.toLowerCase().includes(s.toLowerCase())) || (u.email && u.email.toLowerCase().includes(s.toLowerCase())))
						.map(u => ({id: u.id, name: u.name||u.login||u.email})):[])
                } else if (data.source === "codes" && data.types.length && text && text.length > 1) {
				    return id ? Promise.all(data.types.map(ct => this.api.code().getCodeWithParts(ct,id,'1'))).then(x => _.compact(x)[0]).then(c => ({id:c.code, name: c.label[typeLng]})) : Promise.all(data.types.map(ct => {
                        const typeLng = this.api.code().languageForType(ct.type, this.language)
                        const words = text.toLowerCase().split(/\s+/)
                        const sorter = x => [x.name && x.name.toLowerCase().startsWith(words[0]) ? 0 : 1, x.name]

                        return this.api.code().findPaginatedCodesByLabel('be', ct.type, typeLng, words[0], null, 200).then(results => _.sortBy(results.rows.filter(c => c.label[typeLng] && words.every(w => c.label[typeLng].toLowerCase().includes(w))).map(code => ({
                            id: code.code, name: code.label[typeLng]
                        })), sorter))
                    })).then(responses => _.flatMap(responses))
				}
                return Promise.resolve([])
			}
		};
	}

	localizeContent(e, lng) {
		return this.api && this.api.contact().localize(e, lng) || "";
	}

    showAddPersonToCareTeam(){
        this.$['add-person-to-care-team'].open()
        this.set('currentHcp', _.values(this.api.hcParties))
    }

    showAddNewPersonToCareTeamForm(){
        this.$['add-person-to-care-team'].close()
        this.$['add-new-person-to-care-team'].open()
    }

    addNewPersonToCareTeam(){

    }

    initCurrentCareTeam(){

        var internalTeam = []
        var externalTeam = []

        this.api.patient().getPatient(this.patient.id).then(patient => {

            const internalHcp = patient.delegations
            const externalHcp = patient.patientHealthCareParties

            //internal team
            Promise.all(
                _.keys(internalHcp).map(hcpId =>
                    this.api.hcparty().getHealthcareParty(hcpId).then(hcp =>
                        internalTeam.push(hcp)
                    )
                )
            ).then(() => this.set('currentInternalCareTeam', internalTeam))

            //external team
            Promise.all(
                externalHcp.map(patientHcp =>
                    this.api.hcparty().getHealthcareParty(patientHcp.healthcarePartyId).then(hcp =>
                        externalTeam.push(hcp)
                    )
                )
            ).then(() => this.set('currentExternalCareTeam', externalTeam))
        })


    }

    showInfoSelectedHcp(e){

	    this.$['showHcpInfo'].open()

        const pphcTab = this.patient.patientHealthCareParties
        const pphcTarget = pphcTab.find(pphc => pphc.healthcarePartyId === this.selectedCareProvider.id)

        //Comparer les dates pour le detenteur du dmg
        if(pphcTarget){
            pphcTarget.referralPeriods.map(rp => rp)
        }

        this.selectedCareProvider.pphc = pphcTarget
        this.set('selectedPerson', this.selectedCareProvider)

    }

    _timeFormat(date) {
        return date && this.api.moment(date).format(date > 99991231 ? 'DD/MM/YYYY HH:mm' : 'DD/MM/YYYY') || '';
    }

    _sharingHcp(item){
        if (item) {
            const mark = this.hcpSelectedForTeam.find(m => m.id === item.id)
            return mark && mark.check
        } else {
            return false
        }
    }

    _checkHcp(e){
        if (e.target.id !== "") {
            const mark = this.hcpSelectedForTeam.find(m => m.id === e.target.id)
            if (!mark) {
                this.push('hcpSelectedForTeam',{id:e.target.id, check:true})
            } else {
                mark.check = !mark.check
                this.notifyPath('hcpSelectedForTeam.*')
            }
        }

    }

    confirmSharing() {
        let pPromise = Promise.resolve([])
        const hcpId = this.user.healthcarePartyId

        pPromise = pPromise.then(pats =>
                this.api.patient().share(this.patient.id, hcpId, this.hcpSelectedForTeam.filter(hcp =>
                    hcp.check && hcp.id).map(hcp => hcp.id))
                    .then(pat => {
                            _.concat(pats, pat)
                            this.initCurrentCareTeam()
                        }
                    )
            )
        return pPromise
    }

}

customElements.define(HtPatAdminCard.is, HtPatAdminCard);
</script>
</dom-module>
