<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../../bower_components/vaadin-icons/vaadin-icons.html">

<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">

<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../../../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">


<link rel="import" href="../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../spinner-style.html">

<link rel="import" href="related-code-link.html">


<dom-module id="ht-pat-invoicing-dialog">
    <template>
        <style include="spinner-style">

            .invoice-item {
                height: 90px;
                width: auto;
                box-shadow: var(--shadow-elevation-3dp_-_box-shadow);
                margin-top: 12px;
            }

            .invoice-item:first-child{
                margin-top: 0;
            }

            .invoice-item-title {
                height: 20px;
                width: auto;
                background: rgba(0, 0, 0, .1);
            }

            #invoiceDialog {
                height: calc(100vh - 40px);
                width: calc(100% - 40px);
                z-index: 1100;
                display: grid;
                grid-template-columns: 20% 80%;
                grid-template-rows: 100%;
                position: fixed;
                top: 64px;
                left: 0;
                bottom: 0;
                right: 0;
            }

            .invoice-panel {
                height: 100%;
                background: var(--app-background-color-dark);
                box-shadow: var(--shadow-elevation-3dp_-_box-shadow);
                grid-column: 1/2;
                grid-row: 1/1;
                z-index: 3;
                overflow-y: auto;
                margin-top: 0px;
                padding: 24px;
                box-sizing: border-box;
            }

            .detail-panel {
                height: calc(100% - 80px);
                background: var(--app-background-color);
                /*box-shadow: var(--shadow-elevation-2dp_-_box-shadow);*/
                border-bottom: 1px solid var(--app-background-color-dark);
                margin: 0;
                grid-column: 2/2;
                grid-row: 1/1;
                z-index: 2;
                overflow-y: auto;
                padding: 24px;
                box-sizing: border-box;
            }

            .invoice-header {
                height: auto;
                width: auto;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
            }

            .invoice-nomenclature-code {
                height: auto;
                overflow-y: auto;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                margin-top: 24px;
            }

            .invoice-detail {
                min-height: 200px;
                height: auto;
                width: auto;
                overflow-y: auto;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                margin-top: 12px;
                margin-bottom: 12px;
            }

            .buttons {
                position: absolute;
                bottom: 20px;
                right: 22px;
            }

            .modal-button{
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--save{
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;
            }

            paper-input {
                --paper-input-container-focus-color: var(--app-secondary-color-dark);
                --paper-input-container-invalid-color: var(--app-error-color);
            }

            .flex-container {
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: flex-start;
            }

            .flex-container-nmcl {
                display: flex;
                flex-flow: row nowrap;
                align-items: flex-end;
            }

            .flex-container-nmcl-row {
                flex: 1;
                padding: 4px;
            }

            .flex-container-descr-nmcl-row {
                flex: 8;
                padding: 4px;
            }

            vaadin-text-field{
                padding: 0;
            }

            #invoice-type {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-mode {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-number {
                flex: 1;
                margin: 0;
                padding-top: 3px;
                --paper-input-container-underline: {
                    opacity: 0.42;
                }
            }

            #invoice-date {
                flex: 1;
                margin: 0;
                padding: 8px 8px 0;
            }

            #invoice-period {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-careProviderType {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-nihiiTrainee {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-thirdPartyJustification {
                flex: 3;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-dmg {
                flex: 1;
                margin: 0;
                padding: 3px 8px 0 8px;
                --paper-input-container-underline: {
                    opacity: 0.42;
                }
            }

            #invoice-creditNote {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            .title {
                height: 20px;
                color: var(--app-text-color);
                background-color: var(--app-background-color-dark);
                font-weight: 700;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
            }

            .title-txt {
                padding-left: 8px;
                width: 100%;
            }

            .invoice-nomenclature-code-container {
            }

            .nmcl-descr {
                overflow-y: hidden;
                height: 332px;
            }

            .nmcl-favorite {
                display: flex;
                height: 25px;
                padding: 5px;
            }

            .nmcl-favorite span{
                margin-right: 8px;
            }

            .invoice-nomenclature-code-option {
                display: flex;
                padding: 0 8px;
                flex-flow: row nowrap;
                align-items: center;
                justify-content: space-around;
                margin-bottom: 15px;
            }

            .nmcl-list {
                overflow-y: auto;
            }

            #nmclGrid {
                height: 202px;
            }

            #nmcl-search {
                flex: 1;
            }

            .invoice-item {
                background: var(--app-light-color);
                color: var(--app-text-color);
                outline: 0;
                padding: 0;
                align-items: flex-start !important;
                @apply --shadow-elevation-2dp;
                position: relative;
            }

            .invoice-item .label-container {
                display: flex;
                flex-flow: row nowrap;
            }

            .invoice-item.iron-selected {
                background: var(--app-primary-color);
                color: var(--app-light-color);
                @apply --text-shadow;
            }

            .invoice-item h4 {
                font-size: 14px;
                font-weight: 600;
                margin: 0;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */

                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;

            }

            .invoice-item .invoice-text-row {
                width: calc(100% - 32px);
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                font-size: 14px;
                @apply --padding-right-left-16;
            }

            .invoice-item:nth-of-type(1) .invoice-text-row p {
                padding-right: 32px;
            }

            .invoice-item .invoice-text-row:first-child, .invoice-item .invoice-text-row:last-child {
                height: 24px;
            }

            .invoice-item .colour-code:not(:first-child) {
                margin-left: 4px;
            }

            .invoice-item p {
                @apply --paper-font-body1;
                margin: 0;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */

                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;
            }

            .invoice-item--big {
                min-height: 96px;
                /*@apply --padding-16;*/
                /*border-bottom: 1px solid var(--app-background-color-dark);*/
            }

            .invoice-item--small {
                min-height: 32px;
                /*@apply --padding-right-left-16;*/
                padding-bottom: 8px;
            }

            .invoice-item--small .invoice-text-row:nth-child(2) {
                justify-content: space-between;
            }

            .invoice-item--small .invoice-text-row:last-child {
                display: none;
            }

            .invoice-item--small .he-dots-container {
                display: none;
            }

            .he-dots-container {
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-end;
            }

            paper-item {
                background: transparent;
                outline: 0;
                --paper-item-selected: {

                };

                --paper-item-disabled-color: {
                    color: red;
                };

                --paper-item-focused: {
                    background: transparent;
                };
                --paper-item-focused-before: {
                    background: transparent;
                };

            }

            .opened {
                color: var(--app-text-color);
                background: var(--app-text-color-light);
                border-radius: 2px 2px 0 0;
                box-shadow: 0 4px 0 0 white,
                0 -2px 0 0 white,
                0 2px 2px 0 rgba(0, 0, 0, 0.14),
                0 1px 5px 0 rgba(0, 0, 0, 0.12),
                0 3px 1px -2px rgba(0, 0, 0, 0.2);

            }

            paper-material.iron-selected > .invoice-text > .invoice-text-date {
                color: var(--app-text-color-light) !important;
            }

            .invoice-text {
                background: transparent;
                flex-direction: column;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
                height: 100%;
                padding: 0;
            }

            .invoice-text:focus::before, .invoice-text:focus::after {
                background: transparent;
            }

            .invoice-text-row p {
                width: 100%;
                text-overflow: ellipsis;
                overflow-x: hidden;
                white-space: nowrap;
            }

            .invoice-text-date {
                justify-content: space-between !important;
                position: relative;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, .1);
                @apply --padding-right-left-16;
                color: var(--app-text-color-disabled);
                height: 24px;
            }

            .invoice--big {
                min-height: 96px;
                /*@apply --padding-16;*/
                /*border-bottom: 1px solid var(--app-background-color-dark);*/
            }

            .invoice--small {
                min-height: 32px;
                /*@apply --padding-right-left-16;*/
                padding-bottom: 8px;
            }

            .invoice--small .invoice-text-row:nth-child(2) {
                justify-content: space-between;
            }

            .invoice--small .invoice-text-row:last-child {
                display: none;
            }

            .invoice--small .he-dots-container {
                display: none;
            }

            .he-dots-container {
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-end;
            }

            paper-listbox {
                outline: 0;
                --paper-listbox-selected-item: {
                    color: var(--app-text-color-light);
                    background: var(--app-primary-color);
                };
                --paper-listbox-disabled-color: {
                    color: red;
                };

                background: transparent;
                padding: 0;
            }

            #_invoice_listbox {
                padding: 0;
            }

            .layout.vertical {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                flex-wrap: nowrap;
            }

            .verifiedNmcl {
                color: var(--app-status-color-ok);
                height: 8px;
            }

            .unverifiedNmcl {
                color: var(--app-status-color-nok);
                height: 8px;
            }

            vaadin-grid.material {

                font-family: Roboto, sans-serif;
                --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                --vaadin-grid-cell: {
                    padding: 8px;
                };

                --vaadin-grid-header-cell: {
                    height: 64px;
                    color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                    font-size: 12px;
                };

                --vaadin-grid-body-cell: {
                    height: 48px;
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                    font-size: 13px;
                };

                --vaadin-grid-body-row-hover-cell: {
                    background-color: var(--paper-grey-200);
                };

                --vaadin-grid-body-row-selected-cell: {
                    background-color: var(--paper-grey-100);
                };

                --vaadin-grid-focused-cell: {
                    box-shadow: none;
                    font-weight: bold;
                };
            }

            vaadin-grid.material .cell {
                overflow: hidden;
                text-overflow: ellipsis;
            }

            vaadin-grid.material .cell.last {
                padding-right: 24px;
            }

            vaadin-grid.material .cell.numeric {
                text-align: right;
            }

            vaadin-grid.material paper-checkbox {
                --primary-color: var(--paper-indigo-500);
                margin: 0 24px;
            }

            vaadin-grid.material vaadin-grid-sorter .cell {
                flex: 1;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            vaadin-grid.material vaadin-grid-sorter iron-icon {
                transform: scale(0.8);
            }

            vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                color: rgba(0, 0, 0, var(--dark-disabled-opacity));
            }

            vaadin-grid.material vaadin-grid-sorter[direction] {
                color: rgba(0, 0, 0, var(--dark-primary-opacity));
            }

            vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                transform: scale(0.8) rotate(180deg);
            }

            .clearBtn {
                height: 16px;
                width: 16px;
            }

            .nmclFavoriteCode {
                background-color: var(--app-secondary-color-dark);
                margin: 0 5px 0 0;
                color: var(--app-text-color-light);
                height: 20px;
                font-size: 12px;
                min-width: initial;
                text-transform: none;
                padding-left: 8px;
            }

            .tarificationError {
                padding: 5px;
                width: auto;
                height: 20px;
                color: var(--app-error-color);
            }

            .tarificationBtnEnable {
                background: var(--app-secondary-color);
            }

            .tarificationBtnDisable {
                background-color: var(--app-background-color-darker);
            }

            .tarificationBtnEnableWithWarning {
                background-color: var(--app-status-color-pending);
            }

            .invoiceBtnDisable {
                background-color: var(--app-background-color-darker);
            }

            .invoiceBtnEnable {
                background: var(--app-secondary-color);
            }

            .infoDmg {
                height: 18px;
                width: 18px;
            }

            .invoiceDateInfo{
                font-size: 12px;
                display: flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: center;
            }

            .invoiceDateInfo span{
                margin-left: 4px;
            }

            .invoiceDateInfoIcon{
                height: 14px;
                width: 14px;
            }

            #relativeCodeDialog{
                height: 100px;
                width: 220px;
            }

            #eidDialog{
                height: 220px;
                width: 500px;
            }

            #containerEidDialog{
                heigth: 200px;
                width: auto;
                display: flex;
            }

            .eidContainerBtn{
                flex: auto;
                text-align: center;
            }

            .eidBtn{
                height: 60px;
                width: 60px;
            }

            .eidReadingBtnContainer{
                right: 0px;
                float: right;
            }

            #manualEncodingDialog{
                height: 340px;
                width: 500px;
            }

            .manualEncodingContainer{
                display: flex;
            }

            .manualEncodingContainerChild{
                flex: auto;
            }

            paper-button[disabled] {
                background-color: var(--app-secondary-color-dark);
                color: var(--app-text-color-disabled);
                box-shadow: none;
            }


            .he-edit-btn-container{
                background: var(--app-text-color);
                border-radius: 14px;
                display: inline-flex;
                flex-flow: row-reverse wrap;
                justify-content: space-between;
                align-items: center;
                padding: 2px;
                width: 24px;
                height: 24px;
                overflow: hidden;
                transition: width .42s cubic-bezier(0.075, 0.82, 0.165, 1), opacity .33s ease;
                cursor: pointer;
                opacity: 0;
            }
            paper-item:hover .he-edit-btn-container,
            paper-item.iron-selected .he-edit-btn-container {
                opacity: 1;
            }

            .he-edit-btn-container.open{
                width: 90px;
                display:inline-flex;
                flex-flow: row-reverse nowrap;
            }

            paper-item:hover .he-edit-btn-container {
                display:inline-flex;
            }

            paper-item.iron-selected .he-edit-btn-container {
                display:inline-flex;
            }

            .he-edit-btn{
                height: 24px;
                width: 24px;
                padding: 4px;
                color: var(--app-text-color-light);
                margin-right: 2px;
                margin-left: 2px;
                --paper-ink-color:var(--app-text-color-light);
            }

            .he-edit-btn-dark{
                color: var(--app-text-color);
                --paper-ink-color:var(--app-text-color);
            }

            #barCode{
                visibility: hidden;
            }

            paper-item:hover .he-edit-btn-container {
                position: absolute;
                right: 5px;
            }

            paper-item.iron-selected .he-edit-btn-container {
                display:inline-flex;
            }

            .he-edit-btn-container{
                background: var(--app-text-color);
                border-radius: 14px;
                display: none;
                flex-flow: row-reverse wrap;
                justify-content: space-between;
                align-items: center;
                padding: 2px;
                width: 24px;
                height: 24px;
                overflow: hidden;
                transition: width .42s cubic-bezier(0.075, 0.82, 0.165, 1);
                cursor: pointer;
            }

            .he-edit-btn-container.open{
                width: 90px;
                /*display:inline-flex;*/
                flex-flow: row-reverse nowrap;
                position: absolute;
                right: 5px;
            }

            paper-item:hover .he-edit-btn-container {
                display:inline-flex;
            }

            paper-item.iron-selected .he-edit-btn-container {
                display:inline-flex;
            }

            .he-edit-btn-container{
                background: var(--app-text-color);
                border-radius: 14px;
                display: none;
                flex-flow: row-reverse wrap;
                justify-content: space-between;
                align-items: center;
                padding: 2px;
                width: 24px;
                height: 24px;
                overflow: hidden;
                transition: width .42s cubic-bezier(0.075, 0.82, 0.165, 1);
                cursor: pointer;
            }

            .he-edit-btn-container.open{
                width: 90px;
                display:inline-flex;
                flex-flow: row-reverse nowrap;
            }


            .he-edit-btn{
                height: 24px;
                width: 24px;
                padding: 4px;
                color: var(--app-text-color-light);
                margin-right: 2px;
                margin-left: 2px;
                --paper-ink-color:var(--app-text-color-light);
            }

            .he-edit-btn-dark{
                color: var(--app-text-color);
                --paper-ink-color:var(--app-text-color);
            }

            .he-edit-btn-container > paper-icon-button.he-edit-btn:first-child {
                transition: .5s ease;
            }
            .he-edit-btn-container.open > paper-icon-button.he-edit-btn:first-child {
                transform: rotate(180deg)
            }
            paper-spinner.validAndTarif {
                position: absolute;
                top: 10px;
                transform: translateX(-10px);
            }
        </style>

        <paper-dialog id="invoiceDialog" opened="{{opened}}" id="invoicingDialog">
            <div class="invoice-panel">
                <paper-listbox id="_invoice_listbox" focused multi toggle-shift selectable="paper-material" selected="{{selectValue}}">
                    <template is="dom-repeat" items="[[invoices]]">
                        <paper-material class="layout vertical invoice-item invoice--big" on-tap="_selectInvoice" id="[[item.id]]">
                            <paper-item class="invoice-text">
                                <div class="invoice-text-row invoice-text-date">
                                    <label>N° [[item.invoiceReference]]</label>
                                    <label>[[_formatInvoiceDate(item.invoiceDate)]]</label>
                                </div>
                                <div class="invoice-text-row grey">
                                    <h4>[[getInvoiceType(item.invoiceType)]] [[getSentMediumType(item.sentMediumType)]]</h4>
                                    <p>
                                        <template is="dom-repeat" items="[[item.invoicingCodes]]">
                                            [[item.code]],
                                        </template>
                                    </p>
                                    <div class="invoiceDateInfo">
                                        <template is="dom-if" if="[[_ifStatusDateExist(item.printedDate)]]">
                                            <iron-icon icon="vaadin:print" class="invoiceDateInfoIcon"></iron-icon> <span>[[_formatInvoiceDate(item.printedDate)]]</span>
                                        </template>
                                        <template is="dom-if" if="[[_ifStatusDateExist(item.sentDate)]]">
                                            <iron-icon icon="vaadin:paperplane" class="invoiceDateInfoIcon"></iron-icon> <span>[[_formatInvoiceDate(item.sentDate)]]</span>
                                        </template>
                                        <template is="dom-if" if="[[_ifEattestSaved(item)]]">
                                            <div class="he-edit-btn-container">
                                                <paper-icon-button id="he-edit-btn-open_[[item.id]]" class="he-edit-btn" icon="vaadin:chevron-left" on-tap="_toggleEditHE"></paper-icon-button>
                                                <paper-tooltip position="top" for="he-edit-btn-open_[[item.id]]">[[localize('ext','Extend',language)]]</paper-tooltip>
                                                <paper-icon-button id="he-edit-btn-xml_[[item.id]]" class="he-edit-btn" icon="vaadin:file-code" on-tap="openXmlDialog" data-item$="[[item]]"></paper-icon-button>
                                                <paper-tooltip position="top" for="he-edit-btn-xml_[[item.id]]">[[localize('gen_xml','Generate Xml',language)]]</paper-tooltip>
                                                <paper-icon-button id="he-edit-btn-duplicate_[[item.id]]" class="he-edit-btn" icon="vaadin:copy" on-tap="duplicate" data-item$="[[item]]"></paper-icon-button>
                                                <paper-tooltip position="top" for="he-edit-btn-duplicate_[[item.id]]">[[localize('gen_duplicate','Generate duplicata',language)]]</paper-tooltip>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <div class="invoice-text-row label-container">

                                </div>
                            </paper-item>
                        </paper-material>
                    </template>
                </paper-listbox>
            </div>
            <div class="detail-panel">
                <div class="invoice-header">
                    <div class="title">
                        <div class="title-txt">
                            [[localize('header','Header',language)]]
                            <div class="eidReadingBtnContainer">
                                <iron-icon icon="vaadin:user-card" on-tap="_openEidDialog" style="height: 18px;"></iron-icon>
                            </div>
                        </div>
                    </div>
                    <div class="flex-container">
                        <vaadin-combo-box id="invoice-type" filtered-items="[[invoiceType]]"
                                          item-label-path="label.[[language]]" item-value-path="id" on-filter-changed=""
                                          label="[[localize('inv_type','Invoice type',language)]]"
                                          value="{{selectedInvoice.invoiceType}}"
                                          on-value-changed="" readOnly="[[_isInvoiceClosedOrSelectedInvoiceEattest(selectedInvoice.*)]]"></vaadin-combo-box>
                        <vaadin-combo-box id="invoice-mode" filtered-items="[[sentMediumType]]"
                                          item-label-path="label.[[language]]" item-value-path="id" on-filter-changed=""
                                          label="[[localize('inv_smt','Sent Medium Type',language)]]"
                                          value="{{selectedInvoice.sentMediumType}}"
                                          on-value-changed="analyzeMediumType" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                        <paper-input id="invoice-number" label="[[localize('inv_num','Invoice number',language)]]"
                                     value="{{selectedInvoice.invoiceReference}}" readonly always-float-label="true"></paper-input>
                        <vaadin-date-picker id="invoice-date" label="[[localize('inv_date','Invoice date',language)]]"
                                            value="{{invoiceDateAsString}}" i18n="[[i18n]]" readOnly="[[_isInvoiceClosedOrSelectedInvoiceEattest(selectedInvoice.*)]]"></vaadin-date-picker>
                        <template is="dom-if" if="[[!_isSelectedInvoiceEattest(selectedInvoice.*)]]">
                            <vaadin-combo-box id="invoice-period" filtered-items="[[invoicePeriod]]"
                                              item-label-path="label.[[language]]" item-value-path="id" on-filter-changed=""
                                              label="[[localize('inv_per','Invoice period',language)]]"
                                              value="{{selectedInvoice.invoicePeriod}}" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                        </template>
                        <template is="dom-if" if="[[_isSelectedInvoiceEattest(selectedInvoice.*)]]">
                            <vaadin-date-picker id="prescription-date" label="[[localize('prescr_date','prescription date',language)]]"
                                                value="{{prescriptionDateAsString}}" i18n="[[i18n]]" readOnly="[[isInvoiceClosed]]"></vaadin-date-picker>
                        </template>
                    </div>
                    <div class="flex-container">
                        <template is="dom-if" if="[[!_isSelectedInvoiceEattest(selectedInvoice.*)]]">
                            <div id="invoice-creditNote">
                                <template is="dom-if" if="[[!isInvoiceClosed]]">
                                    <vaadin-checkbox on-checked-changed="_isCreditNote" checked="[[selectedInvoice.creditNote]]"></vaadin-checkbox>
                                    [[localize('inv_cr_no','Credit note',language)]]<br/>

                                    <vaadin-checkbox on-checked-changed="_isLiftingLimitationPeriod" checked="[[_handleCheckboxCheckedStatusFromInteger(selectedInvoice.longDelayJustification)]]"></vaadin-checkbox>
                                    [[localize('inv_llp','Lifting limitation period',language)]]
                                </template>

                                <template is="dom-if" if="[[isInvoiceClosed]]">
                                    <vaadin-checkbox on-checked-changed="_isCreditNote" checked="[[selectedInvoice.creditNote]]">[[localize('inv_cr_no','Credit note',language)]]<br/></vaadin-checkbox>
                                    <vaadin-checkbox on-checked-changed="_isLiftingLimitationPeriod" checked="[[_handleCheckboxCheckedStatusFromInteger(selectedInvoice.longDelayJustification)]]">[[localize('inv_llp','Lifting limitation period',language)]]</vaadin-checkbox>
                                </template>


                            </div>
                        </template>
                        <vaadin-combo-box id="invoice-careProviderType" filtered-items="[[careProviderType]]"
                                          item-label-path="label.[[language]]" item-value-path="id"
                                          on-value-changed="analyzeCareProviderType"
                                          label="[[localize('inv_care_prov_ty','Care provider type',language)]]"
                                          value="{{selectedInvoice.careProviderType}}" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                        <template is="dom-if" if="[[_isTrainee(selectedInvoice.careProviderType)]]">
                            <paper-input id="invoice-nihiiTrainee"
                                         label="[[localize('train_nihii','NIHII trainee',language)]]"
                                         value="{{selectedInvoice.internshipNihii}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                        </template>
                        <template is="dom-if" if="[[!_isSelectedInvoiceEattest(selectedInvoice.*)]]">
                            <vaadin-combo-box id="invoice-thirdPartyJustification"
                                              filtered-items="[[thirdPartyJustification]]"
                                              item-label-path="label.[[language]]" item-value-path="id"
                                              on-filter-changed=""
                                              label="[[localize('inv_tpj','Third party justification',language)]]"
                                              value="{{selectedInvoice.override3rdPayerCode}}"
                                              on-value-changed="" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                        </template>
                        <template is="dom-if" if="[[_isSelectedInvoiceEattest(selectedInvoice.*)]]">
                            <vaadin-combo-box id="locationType" class="flex-container-nmcl-row"
                                              label="[[localize('location','Location',language)]]"
                                              filtered-items="[[locationType]]" item-label-path="label.[[language]]"
                                              item-value-path="id" value="{{selectedInvoice.encounterLocationNorm}}"
                                              on-value-changed="_checkIfLocationIsNeeded" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                            <template is="dom-if" if="[[isLocationIsNeeded]]">
                                <vaadin-combo-box id="locations" class="flex-container-nmcl-row"
                                                  label="[[localize('location','Locations',language)]]"
                                                  filtered-items="[[organisationList]]" item-label-path="name"
                                                  selected-item="[[selectedInvoice.encounterLocationName]]" on-selected-item-changed="setLocation"
                                                  on-filter-changed="searchLocations" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                            </template>
                        </template>
                        <paper-input id="invoice-dmg" label="[[localize('inv_dmgOwner','Dmg owner',language)]]"
                                     value="{{selectedInvoice.gnotionNihii}}" readOnly="[[isInvoiceClosed]]">
                            <div slot="suffix">
                                <iron-icon icon="info" id="invoice-dmg-icon"
                                           class="infoDmg"></iron-icon>
                            </div>
                        </paper-input>
                        <paper-tooltip for="invoice-dmg-icon">[[localize('gnotion','Gnotion',language)]]</paper-tooltip>
                    </div>
                </div>
                <div class="invoice-nomenclature-code">
                    <div class="invoice-nomenclature-code-container">
                        <div class="nmcl-descr">
                            <div class="title">
                                <div class="title-txt">
                                    [[localize('nmcl','Nomenclature',language)]]
                                </div>
                            </div>
                            <div class="nmcl-list">
                                <!--<paper-spinner class="spinner chapter-list-spinner" alt="Loading eTar" active=[[isLoadingEattest]]></paper-spinner>-->
                                <vaadin-grid id="nmclGrid" items="[[selectedInvoice.invoicingCodes]]" class="material"
                                             active-item="{{activeNmclItem}}" on-tap="_showDetail">
                                    <vaadin-grid-column width="20px" style="padding: 0;">
                                        <template>
                                            <div class="cell frozen">
                                                <template is="dom-if" if="[[item.valid]]">
                                                    <iron-icon icon="vaadin:check" class="verifiedNmcl"></iron-icon>
                                                </template>
                                            </div>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell frozen">[[localize('co','Code',language)]]</div>
                                        </template>
                                        <template>
                                            <div class="cell frozen">[[item.code]]</div>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="50%">
                                        <template class="header">
                                            <div class="cell frozen">[[localize('lab','Label',language)]]</div>
                                        </template>
                                        <template>
                                            <div class="cell frozen">[[item.label]]</div>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric">[[localize('tot_pat','Patient fees',language)]]
                                            </div>
                                        </template>
                                        <template>
                                            <div class="cell numeric">[[_formatAmount(item.patientIntervention)]]&nbsp€</div>
                                        </template>
                                        <template class="footer"> <div class="cell numeric">[[totalInvoice.patientIntervention]]&nbsp€</div></template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric">[[localize('reimb','Reimbursement',language)]]
                                            </div>
                                        </template>
                                        <template>
                                            <div class="cell numeric">[[_formatAmount(item.reimbursement)]]&nbsp€</div>
                                        </template>
                                        <template class="footer"> <div class="cell numeric">[[totalInvoice.reimbursement]]&nbsp€</div></template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric">[[localize('extra','Extra',language)]]</div>
                                        </template>
                                        <template>
                                            <div class="cell numeric">[[_formatAmount(item.doctorSupplement)]]&nbsp€</div>
                                        </template>
                                        <template class="footer"> <div class="cell numeric">[[totalInvoice.doctorSupplement]]&nbsp€</div></template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric">[[localize('tot','Fees',language)]]</div>
                                        </template>
                                        <template>
                                            <div class="cell numeric">[[_formatAmount(item.totalAmount)]]&nbsp€</div>
                                        </template>
                                        <template class="footer"> <div class="cell numeric">[[totalInvoice.totalAmount]]&nbsp€</div></template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric"></div>
                                        </template>
                                        <template>
                                            <template is="dom-if" if="[[item.prescriberNeeded]]">
                                                <iron-icon class="clearBtn" icon="vaadin:doctor"></iron-icon>
                                            </template>
                                            <template is="dom-if" if="[[item.isRelativePrestation]]">
                                                <!--<related-code-link language="[[language]]" linkables="[[selectedInvoice.invoicingCodes]]" represented-object-id="[[item.id]]" api="[[api]]" on-link-nmcl-to-related-code="linkNmclToRelatedCode"></related-code-link>-->
                                                <template id="dom-if" if="[[!!isInvoiceClosed]]">
                                                    <iron-icon class="clearBtn" icon="vaadin:link" id="[[item.id]]" on-tap="_openlinkRelativePrestationDialog"></iron-icon>
                                                </template>
                                                [[item.relatedCode]]
                                            </template>

                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="20px">
                                        <template>
                                            <div class="cell frozen">
                                                <template is="dom-if" if="[[!isInvoiceClosed]]">
                                                    <iron-icon icon="vaadin:exchange" class="clearBtn"
                                                               on-tap="_openTransfertDialog"></iron-icon>
                                                </template>
                                            </div>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="20px">
                                        <template>
                                            <div class="cell frozen">
                                                <template is="dom-if" if="[[!isInvoiceClosed]]">
                                                    <iron-icon icon="clear" class="clearBtn"
                                                               data-item$="[[item.tarificationId]]"
                                                               on-tap="_deleteNmclCode"></iron-icon>
                                                </template>
                                            </div>
                                        </template>
                                    </vaadin-grid-column>
                                </vaadin-grid>
                            </div>
                            <template is="dom-if" if="[[!isInvoiceClosed]]">
                                <div class="nmcl-favorite">
                                    <span>[[localize('fav','Favorites code',language)]]:</span>
                                    <template is="dom-repeat" items="[[favoriteCode]]">
                                        <paper-button on-tap="_addNmcl" data-item$="[[item]]" class="nmclFavoriteCode">
                                            [[item.code]]
                                            <iron-icon icon="clear" class="clearBtn" data-item$="[[item.id]]"
                                                       on-tap="_deleteFavoriteCode"></iron-icon>
                                        </paper-button>
                                    </template>
                                </div>
                                <div class="invoice-nomenclature-code-option">
                                    <vaadin-combo-box id="nmcl-search" filtered-items="[[nmclListItem]]" item-label-path="descr"
                                                      item-value-path="id" on-filter-changed="_nmclSearch" on-keydown="isEnterPressed"
                                                      label="[[localize('nmcl','Nomenclature',language)]]"
                                                      value="{{nmcl-value}}" autofocus></vaadin-combo-box>
                                    <vaadin-combo-box id="code-type" filtered-items="[[sentMediumType]]"
                                                      item-label-path="label.[[language]]" item-value-path="id" on-filter-changed=""
                                                      label="[[localize('code_type','Code type',language)]]"
                                                      value="{{selectedMediumCodeType}}"></vaadin-combo-box>
                                    <paper-icon-button icon="icons:add-circle-outline" on-tap="_addNmcl"></paper-icon-button>
                                    <paper-icon-button icon="icons:star" on-tap="_addFavoriteCode"></paper-icon-button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="invoice-detail">
                    <div class="title">
                        <div class="title-txt">
                            [[localize('det','Detail',language)]]
                        </div>
                    </div>
                    <template is="dom-if" if="[[isTarificationError]]">
                        <template is="dom-repeat" items="[[tarificationError]]">
                            <div class="tarificationError">[[item.code]]: [[_getErrorMsg(item, language)]]
                                ([[item.value]])
                            </div>
                        </template>
                    </template>
                    <template is="dom-if" if="[[isDetailNmcl]]">
                        <div class="flex-container-nmcl">
                            <paper-input class="flex-container-nmcl-row" label="[[localize('co','Code',language)]]"
                                         value="{{activeNmclItem.code}}" readonly></paper-input>
                            <paper-input class="flex-container-descr-nmcl-row"
                                         label="[[localize('lab','Label',language)]]" value="{{activeNmclItem.label}}"
                                         readonly></paper-input>
                        </div>
                        <div class="flex-container-nmcl">
                            <paper-input prevent-invalid-input allowed-pattern="[.\d]" class="flex-container-nmcl-row"
                                         label="[[localize('tot_pat','Patient fee',language)]]"
                                         value="{{activeNmclItem.patientIntervention}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            <paper-input prevent-invalid-input allowed-pattern="[.\d]" class="flex-container-nmcl-row"
                                         label="[[localize('reimb','Reimbursement',language)]]"
                                         value="{{activeNmclItem.reimbursement}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            <paper-input prevent-invalid-input allowed-pattern="[.\d]" class="flex-container-nmcl-row"
                                         label="[[localize('extra','Extra',language)]]"
                                         value="{{activeNmclItem.doctorSupplement}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            <paper-input prevent-invalid-input allowed-pattern="[.\d]" class="flex-container-nmcl-row"
                                         label="[[localize('tot','Fee',language)]]"
                                         value="{{activeNmclItem.totalAmount}}" readonly></paper-input>
                        </div>
                        <template is="dom-if" if="[[isTravellingExpenses(activeNmclItem.*)]]">
                            <div class="flex-container-nmcl">
                                <paper-input class="flex-container-nmcl-row"
                                             label="[[localize('fraisDepAll','frais de déplacement - aller',language)]]"
                                             value="{{activeNmclItem.qteAll}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                                <paper-input class="flex-container-nmcl-row"
                                             label="[[localize('fraisDepAllRet','frais de déplacement - aller & retour',language)]]"
                                             value="[[quantityAllHasChanged(activeNmclItem.qteAll.*)]]" readOnly></paper-input>
                                <paper-input class="flex-container-nmcl-row"
                                             label="[[localize('fraisDepRemb','frais de déplacement - rembourser',language)]]"
                                             value="{{activeNmclItem.units}}" readOnly></paper-input>
                            </div>
                        </template>
                        <div class="flex-container-nmcl">
                            <vaadin-combo-box id="prescriberType" class="flex-container-nmcl-row"
                                              label="[[localize('prescriber','Prescriber',language)]]"
                                              filtered-items="[[prescriberType]]" item-label-path="label.[[language]]"
                                              item-value-path="id" value="{{activeNmclItem.prescriberNorm}}"
                                              on-value-changed="_checkIfPrescriberIsNeeded" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                            <template is="dom-if" if="[[isPrescriberIsNeeded]]">
                                <paper-input class="flex-container-nmcl-row"
                                             label="[[localize('prescriber_nihii','Prescriber nihii',language)]]"
                                             value="{{activeNmclItem.prescriberNihii}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            </template>
                        </div>
                        <div class="flex-container-nmcl">
                            <paper-input class="flex-container-nmcl-row"
                                         label="[[localize('valid','Validation',language)]]"
                                         value="{{activeNmclItem.valid}}" readonly></paper-input>
                            <paper-input class="flex-container-nmcl-row"
                                         label="[[localize('fin_con','Financial contract',language)]]"
                                         value="{{activeNmclItem.contract}}" readonly></paper-input>
                            <paper-input class="flex-container-nmcl-row"
                                         label="[[localize('inv_tpj','Justification TP',language)]]"
                                         value="{{_getOvveride3PayerCodeAsString(activeNmclItem.override3rdPayerCode)}}" readonly></paper-input>
                        </div>
                    </template>

                </div>
                <div class="buttons">
                    <span>[[errorMessage]]</span>
                    <paper-spinner class="validAndTarif" active="[[isValidate]]"></paper-spinner>
                    <paper-spinner class="validAndTarif" active="[[isJustif]]"></paper-spinner>
                    <paper-button class="modal-button" on-tap="_closeDialog">[[localize('can','Cancel',language)]]</paper-button>

                    <template is="dom-if" if="[[isEattestClosed]]">
                        <paper-button disabled="[[isLoadingEattest]]" class="modal-button modal-button--save invoiceBtnEnable" on-tap="_cancelEattest">
                            [[localize('can_eattest','Cancel eattest',language)]]
                        </paper-button>
                    </template>
                    <template is="dom-if" if="[[!isInvoiceClosed]]">
                        <template is="dom-if" if="[[!isTarificationMcnError]]">
                            <template is="dom-if" if="[[npi]]">
                                <paper-button class="modal-button modal-button--save tarificationBtnEnable" on-tap="_verifyTarification" disabled="[[isValidate]]">
                                    [[localize('eTarif','Validation eTarif',language)]]
                                </paper-button>
                            </template>
                            <template is="dom-if" if="[[!npi]]">
                                <paper-button class="modal-button tarificationBtnDisable" on-tap="">[[localize('eTarif','Validation
                                    eTarif',language)]]
                                </paper-button>
                            </template>
                        </template>

                        <template is="dom-if" if="[[isTarificationMcnError]]">
                            <paper-button on-tap="_verifyTarification" class="tarificationBtnEnableWithWarning" disabled="[[isValidate]]">
                                [[localize('eTarif','Validation eTarif',language)]]
                            </paper-button>
                        </template>

                        <template is="dom-if" if="[[_isSelectedInvoiceEattest(selectedInvoice.*)]]">
                            <paper-button on-tap="_validateAndPrepareInvoiceForBatchSending" class="modal-button modal-button--save invoiceBtnEnable" active="[[isJustif]]">
                                [[localize('val_invoice','Justificatory + create invoice',language)]]
                            </paper-button>
                        </template>
                        <template is="dom-if" if="[[!_isSelectedInvoiceEattest(selectedInvoice.*)]]">
                            <template is="dom-if" if="[[isNmclVerified]]">
                                <paper-button on-tap="_validateAndPrepareInvoiceForBatchSending" class="modal-button modal-button--save invoiceBtnEnable" active="[[isJustif]]">
                                    [[localize('val_invoice','Justificatory + create invoice',language)]]
                                </paper-button>
                            </template>
                            <template is="dom-if" if="[[!isNmclVerified]]">
                                <paper-button on-tap="" class="modal-button invoiceBtnDisable">[[localize('val_invoice','Justificatory +
                                    create invoice',language)]]
                                </paper-button>
                            </template>
                        </template>
                    </template>
                    <template is="dom-if" if="[[isInvoiceClosed]]">
                        <paper-button on-tap="_validateAndPrepareInvoiceForBatchSending" class="modal-button invoiceBtnEnable">
                            [[localize('val_justificatory','Justificatory',language)]]
                        </paper-button>
                    </template>
                </div>
            </div>
            <canvas id="barCode"></canvas>
        </paper-dialog>

        <paper-dialog id="transferDialog">
            <div>
                <vaadin-combo-box id="code-type" filtered-items="[[sentMediumType]]"
                                  item-label-path="label.[[language]]" item-value-path="id"
                                  label="[[localize('code_type','Code type',language)]]"
                                  value="{{bufferTypeCode}}"></vaadin-combo-box>
            </div>
        </paper-dialog>

        <paper-dialog id="relativeCodeDialog">
            <vaadin-combo-box id="related-code" filtered-items="[[selectedInvoice.invoicingCodes]]"
                              item-label-path="code" item-value-path="id"
                              label="Link"
                              value="{{childRelativeCodeId}}"></vaadin-combo-box>
        </paper-dialog>

        <paper-dialog id="eidDialog">
            <h4>Type de lecture</h4>
            <div id="containerEidDialog">
                <div class="eidContainerBtn">
                    <paper-icon-button icon="vaadin:user-card" class="eidBtn" on-tap="_readEidCard"></paper-icon-button>
                    <p>EID</p>
                </div>
                <div class="eidContainerBtn">
                    <paper-icon-button icon="vaadin:qrcode" class="eidBtn" on-tap="_readBarreCode"></paper-icon-button>
                    <p>QR code && code-barre</p>
                </div>
                <div class="eidContainerBtn">
                    <paper-icon-button icon="vaadin:pencil" class="eidBtn" on-tap="_showManualEncodingDialog"></paper-icon-button>
                    <p>Encodage manuel</p>
                </div>
            </div>
            <div class="buttons">
                <paper-button on-tap="_closeEidDialog">[[localize('can','Cancel',language)]]</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="manualEncodingDialog">
            <h4>Encodage manuel</h4>
            <div class="manualEncodingContainer">
                <vaadin-combo-box id="reasonOfManualEncoding" filtered-items="[[reasonOfManualEncoding]]"
                                  item-label-path="label.[[language]]" item-value-path="id"
                                  label="Raison"
                                  value="{{manualEncoding.reason}}" class="manualEncodingContainerChild"></vaadin-combo-box>
            </div>
            <div class="manualEncodingContainer">
                <vaadin-combo-box id="code-type" filtered-items="[[typeOfSupport]]"
                                  item-label-path="label.[[language]]" item-value-path="id"
                                  label="Type de support"
                                  value="{{manualEncoding.supportType}}" class="manualEncodingContainerChild"></vaadin-combo-box>
            </div>
            <div class="manualEncodingContainer">
                <paper-input class="flex-container-nmcl-row"
                             label="N° de serie"
                             value="{{manualEncoding.serialNumber}}" class="manualEncodingContainerChild"></paper-input>
            </div>
            <div class="buttons">
                <paper-button on-tap="_closeManualEncodingDialog">[[localize('can','Cancel',language)]]</paper-button>
                <paper-button on-tap="_closeManualEncodingDialog">[[localize('add','Add',language)]]</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="xml_dialog">
            <div>

            </div>
        </paper-dialog>

    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models'
        import jsPDF from 'jspdf/dist/jspdf.min';
        import moment from 'moment/src/moment'
        import * as evaljs from "evaljs"
        import mustache from "mustache/mustache.js";

        class HtPatInvoicingDialog extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-invoicing-dialog'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    patient: {
                        type: Object,
                        value: null
                    },
                    contact: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                    currentContact: {
                        type: Object,
                        value: null
                    },
                    resources: {
                        type: Object
                    },
                    opened: {
                        type: Boolean,
                        value: false
                    },
                    invoiceType: {
                        type: Array,
                        value: () => [
                            {
                                id: "mutualfund",
                                label: {"fr": "Mutuelle", "nl": "Mutual", "en": "Mutual"}
                            },
                            {
                                id: "patient",
                                label: {"fr": "Patient", "nl": "Patient", "en": "Patient"}
                            },
                            {
                                id: "payingagency",
                                label: {"fr": "Autre organisme", "nl": "Anders", "en": "Paying agency"}
                            }
                        ]
                    },
                    sentMediumType: {
                        type: Array,
                        value: () => [
                            {
                                id: "efact",
                                label: {"fr": "eFact", "nl": "eFact", "en": "eFact"}
                            },
                            {
                                id: "eattest",
                                label: {"fr": "eAttest", "nl": "eAttest", "en": "eAttest"}
                            },
                            {
                                id: "mediprima",
                                label: {"fr": "Mediprima", "nl": "Mediprima", "en": "Mediprima"}
                            },
                            {
                                id: "paper",
                                label: {"fr": "Papier", "nl": "Paper", "en": "Paper"}
                            }
                        ]
                    },
                    invoicePeriod: {
                        type: Array,
                        value: () => [
                            {
                                id: 0,
                                label: {"fr": "Semaine", "nl": "Week", "en": "Week"}
                            },
                            {
                                id: 1,
                                label: {"fr": "Nuit", "nl": "Nacht", "en": "Night"}
                            },
                            {
                                id: 2,
                                label: {"fr": "Weekend", "nl": "Weekend", "en": "Weekend"}
                            },
                            {
                                id: 3,
                                label: {"fr": "Jour férié", "nl": "Vakantie", "en": "Public holiday"}
                            }
                        ]
                    },
                    careProviderType: {
                        type: Array,
                        value: () => [
                            {
                                id: "persphysician",
                                label: {"fr": "Médecin", "nl": "Arts", "en": "Physician"}
                            },
                            {
                                id: "traineesupervised",
                                label: {"fr": "Méd.stag. superv.", "nl": "Stagiair arts", "en": "Superv. trainee"}
                            },
                            {
                                id: "trainee",
                                label: {"fr": "Médecin stagiaire", "nl": "Stagiair arts", "en": "Trainee physician"}
                            }
                        ]
                    },
                    prescriberType: {
                        type: Array,
                        value: () => [
                            {
                                id: 0,
                                label: {"fr": "Pas de prescripteur", "nl": "No prescriber", "en": "No prescriber"},
                                prescriber: false
                            },
                            {
                                id: 1,
                                label: {
                                    "fr": "La prestation peut être attribuée à un prescripteur",
                                    "nl": "The benefit can be attributed to a prescriber",
                                    "en": "The benefit can be attributed to a prescriber physician"
                                },
                                prescriber: true
                            },
                            {
                                id: 3,
                                label: {
                                    "fr": "Les prestations sont effectuées pour ses propres patients",
                                    "nl": "The services are performed for his own patients",
                                    "en": "The services are performed for his own patients"
                                },
                                prescriber: false
                            },
                            {
                                id: 4,
                                label: {
                                    "fr": "Il s'agit de prestations ajoutées",
                                    "nl": "These are added benefits",
                                    "en": "These are added benefits"
                                },
                                prescriber: true
                            },
                            {
                                id: 5,
                                label: {
                                    "fr": "La prestation peut être attribuée à un prescripteur et elle a été substituée",
                                    "nl": "The benefit can be attributed to a prescriber and has been substituted",
                                    "en": "The benefit can be attributed to a prescriber and has been substituted"
                                },
                                prescriber: true
                            },
                            {
                                id: 6,
                                label: {
                                    "fr": "La prestation est prescrite par différents prescripteurs et elle a été substituée",
                                    "nl": "The benefit is prescribed by different prescribers and has been substituted",
                                    "en": "The benefit is prescribed by different prescribers and has been substituted"
                                },
                                prescriber: true
                            }
                        ]
                    },
                    locationType: {
                        type: Array,
                        value: () => [
                            {
                                id: 0,
                                label: {"fr": "Pas de lieu de prestation", "nl": "Geen location", "en": "No location"},
                                location: "",
                                cdHcParty: ""
                            },
                            {
                                id: 1,
                                label: {
                                    "fr": "La prestation est dispensée effectuée dans un hôpital",
                                    "nl": "The benefit is provided at a hospital",
                                    "en": "The benefit is provided at a hospital"
                                },
                                location: "HOSPITAL",
                                cdHcParty: "orghospital"
                            },
                            {
                                id: 2,
                                label: {
                                    "fr": "La prestation est dispensée dans un labo",
                                    "nl": "The benefit is provided at a labo",
                                    "en": "The benefit is provided at a labo"
                                },
                                location: "LABO",
                                cdHcParty: "orglaboratory"
                            }
                        ]
                    },
                    thirdPartyJustification: {
                        type: Array,
                        value: () => [

                            {
                                id: "0",
                                label: {
                                    "fr": "0. Pas de justification",
                                    "nl": "0. No justification",
                                    "en": "0. No justification"
                                }
                            },
                            {
                                id: "1",
                                label: {"fr": "1. Décès, coma", "nl": "1. Death, coma", "en": "1. Death, coma"}
                            },
                            {
                                id: "2",
                                label: {
                                    "fr": "2. Etat d'urgence financière",
                                    "nl": "2. State of financial emergency",
                                    "en": "2. State of financial emergency"
                                }
                            },
                            {
                                id: "3",
                                label: {"fr": "3. BIM", "nl": "3. BIM", "en": "3. BIM"}
                            },
                            {
                                id: "4",
                                label: {
                                    "fr": "4. Prestations dispensées dans le cadre d'un accord prévoyant le paiement forfaitaire de cetaines prestations",
                                    "nl": "4. Benefits provided under an agreement providing for the payment of certain benefits",
                                    "en": "4. Benefits provided under an agreement providing for the payment of certain benefits"
                                }
                            },
                            {
                                id: "5",
                                label: {
                                    "fr": "5. Prestations dispensées dans les centres de santé mentale, centres de planning familial et centres d'accueil pour toxicomanes",
                                    "nl": "5. Services Provided in Mental Health Centers, Family Planning Centers and Addiction Centers",
                                    "en": "5. Services Provided in Mental Health Centers, Family Planning Centers and Addiction Centers"
                                }
                            },
                            {
                                id: "6",
                                label: {
                                    "fr": "6. Prestations dispensées dans des établissements spécialisés dans les soins aux enfants, aux personnes agées ou aux handicapés",
                                    "nl": "6. Services provided in institutions specializing in the care of children, the elderly people or the disabled",
                                    "en": "6. Services provided in institutions specializing in the care of children, the elderly people or the disabled"
                                }
                            },
                            {
                                id: "7",
                                label: {
                                    "fr": "7. Prestations effectuées dans le cadre d'un service de garde de médecine générale",
                                    "nl": "7. Services provided as part of a general medical care service",
                                    "en": "7. Services provided as part of a general medical care service"
                                }
                            },
                            {
                                id: "8",
                                label: {
                                    "fr": "8. Statut affection chronique (sur base d'une attestation fournie par le patient)",
                                    "nl": "8. Chronic condition",
                                    "en": "8. Chronic condition"
                                }
                            },
                            {
                                id: "9",
                                label: {
                                    "fr": "9. Interdiction de facturer en tiers-payant via efact",
                                    "nl": "9. Prohibition of third-party billing via efact",
                                    "en": "9. Prohibition of third-party billing via efact"
                                }
                            },
                            {
                                id: "p",
                                label: {
                                    "fr": "P. Patients palliatifs à domicile",
                                    "nl": "P. Home palliative patients",
                                    "en": "P. Home palliative patients"
                                }
                            }
                        ]
                    },
                    reasonOfManualEncoding:{
                        type: Object,
                        value: () => [
                            {
                                id: 1,
                                label: {
                                    "fr": "Utilisation d’un document d’identité sans puce",
                                    "nl": "Using an identity document without a chip",
                                    "en": "Using an identity document without a chip"
                                }
                            },
                            {
                                id: 2,
                                label: {
                                    "fr": "Indisponibilité du lecteur de carte",
                                    "nl": "Unavailability of the card reader",
                                    "en": "Unavailability of the card reader"
                                }
                            },
                            {
                                id: 3,
                                label: {
                                    "fr": "Panne du système informatique",
                                    "nl": "Computer system failure",
                                    "en": "Computer system failure"
                                }
                            }
                        ]

                    },
                    typeOfSupport:{
                        type: Object,
                        value: () => [
                            {
                                id: 1,
                                label: {
                                    "fr": "Carte d’identité électronique belge (ou Kids-id)",
                                    "nl": "Belgium electronic identity card (or Kids-id)",
                                    "en": "Belgium electronic identity card (or Kids-id)"
                                }
                            },
                            {
                                id: 2,
                                label: {
                                    "fr": "Carte d’identité électronique étranger",
                                    "nl": "Other country electronic identity card",
                                    "en": "Other country electronic identity card"
                                }
                            },
                            {
                                id: 4,
                                label: {
                                    "fr": "Carte ISI+",
                                    "nl": "ISI+ card",
                                    "en": "ISI+ card"
                                }
                            },
                            {
                                id: 5,
                                label: {
                                    "fr": "Document de séjour électronique",
                                    "nl": "Electronic residence document",
                                    "en": "Electronic residence document"
                                }
                            },
                            {
                                id: 7,
                                label: {
                                    "fr": "Vignette avec code-à-barres",
                                    "nl": "Thumbnail with barcode",
                                    "en": "Thumbnail with barcode"
                                }
                            },
                            {
                                id: 8,
                                label: {
                                    "fr": "Attestation d’assuré social",
                                    "nl": "Social insurance certificate",
                                    "en": "Social insurance certificate"
                                }
                            },
                            {
                                id: 9,
                                label: {
                                    "fr": "Attestation de perte ou de vol",
                                    "nl": "Certificate of loss or theft",
                                    "en": "Certificate of loss or theft"
                                }
                            }
                        ]

                    },
                    manualEncoding:{
                        type: Object,
                        value: () => ({
                            reason: "",
                            supportType: "",
                            serialNumber: ""
                        })
                    },
                    selectedInvoice: {
                        type: Object,
                        value: () => {
                        }
                    },
                    invoices: {
                        type: Object,
                        value: () => {
                        }
                    },
                    totalInvoice: {
                        type: Object,
                        value: () => ({
                            reimbursement: Number(0.00).toFixed(2),
                            totalAmount: Number(0.00).toFixed(2),
                            patientIntervention: Number(0.00).toFixed(2),
                            doctorSupplement: Number(0.00).toFixed(2)
                        })
                    },
                    isThirdParty: {
                        type: Boolean,
                        value: true
                    },
                    nmclListItem: {
                        type: Array,
                        value: () => []
                    },
                    nmclFilterValue: {
                        type: String
                    },
                    npi: {
                        type: Boolean,
                        value: false
                    },
                    favoriteCode: {
                        type: Object
                    },
                    isTarificationError: {
                        type: Boolean,
                        value: false
                    },
                    isDetailNmcl: {
                        type: Boolean,
                        value: false
                    },
                    tarificationError: {
                        type: Array
                    },
                    activeNmclItem: {
                        type: Object
                    },
                    isPrescriberIsNeeded: {
                        type: Boolean,
                        value: false
                    },
                    isLocationIsNeeded: {
                        type: Boolean,
                        value: false
                    },
                    isNmclVerified: {
                        type: Boolean,
                        value: false
                    },
                    isTrainee: {
                        type: Boolean,
                        value: false
                    },
                    isTarificationMcnError: {
                        type: Boolean,
                        value: false
                    },
                    hcp: {
                        type: Object,
                        value: () => ({})
                    },
                    selectedMediumCodeType: {
                        type: String
                    },
                    i18n: {
                        type: Object
                    },
                    invoiceDateAsString: {
                        type: String,
                        observer: '_invoiceDateAsStringChanged'
                    },
                    prescriptionDateAsString:{
                        type: String,
                        observer: '_prescriptionDateAsStringChanged'
                    },
                    isInvoiceClosed:{
                        type: Boolean,
                        value: false
                    },
                    bufferTypeCode:{
                        type : String,
                        observer: '_tranferNmcl'
                    },
                    isSelected:{
                        type: Boolean
                    },
                    childRelativeCodeId:{
                        type: String,
                        value: "",
                        observer: '_linkCode'
                    },
                    parentRelatedCodeId: {
                        type: String,
                        value: ""
                    },
                    isEattestClosed:{
                        type:Boolean,
                        value:false
                    },
                    isValidate: {
                        type: Boolean,
                        value: false
                    },
                    isJustif: {
                        type: Boolean,
                        value: false
                    },
                    searchOrgName: {
                        type: String,
                        value: ""
                    },
                    organisationList:{
                        type: Array,
                        value: () => []
                    },
                    errorMessage :{
                        type : String,
                        value :""
                    }
                }

            }

            static get observers() {
                return ['_invoicingCodeChange(activeNmclItem, activeNmclItem.*)','selectedInvoiceChanged(selectedInvoice.*)','conventionAmountChanged(activeNmclItem.*)','varIsEattestClosedChanged(selectedInvoice.*)','locationNormChanged(selectedInvoice.encounterLocationNorm.*)']
            }

            ready() {
                super.ready()
            }


            _selectInvoice(e) {
                console.log('select invoice')
                // Drop all should there be any
                this.shadowRoot.querySelectorAll(".iron-selected").forEach(item => { item && item.classList.remove("iron-selected") });

                this.isSelected=true;
                const invoiceId = (e.currentTarget) ? e.currentTarget.id : e
                this.set("isTarificationError", false)
                this.set("isTarificationMcnError", false)
                this.set('isDetailNmcl', false)
                this.set('isNmclVerified', false)
                this.set('npi', false)

                let selected = this.invoices.find(inv => inv.id === invoiceId)

                this.api.tarification().getTarifications(new models.ListOfIdsDto({ids: selected.invoicingCodes.map(tar => tar.tarificationId)})).then(nmcls =>
                    nmcls.map(nmcl =>{
                        const sn = selected.invoicingCodes.find(n => n.tarificationId === nmcl.id) || null
                        if(sn){
                            sn.prescriberNeeded = nmcl.needsPrescriber
                            sn.isRelativePrestation = nmcl.hasRelatedCode
                        }
                    })
                ).finally(() => {

                    if(!selected.encounterLocationNorm){
                        selected.encounterLocationNorm=0;
                        selected.encounterLocationName=null;
                        selected.encounterLocationNihii=null;
                    }
                    else if(selected.encounterLocationNorm!==0){
                        this.set("isLocationIsNeeded", true)
                    }
                    this.set('selectedInvoice', selected)
                    this.set('selectedMediumCodeType', selected.sentMediumType)
                    this.set('invoiceDateAsString', this.returnDatePickerDate(selected.invoiceDate))

                    invoiceId !== "" ? this.calculateTotalOfInvoice() : null
                    this.selectedInvoice.invoicingCodes.length > 0 ? this.set('npi', true) : this.set('npi', false)
                    this.set('isInvoiceClosed', !!this.selectedInvoice.printedDate)
                    this.isSelected=false;

                    // Ain't set upon first load, target (either we already have one for today or we target the first node)
                    var targetObject = this.shadowRoot.querySelector('[id="' + selected.id + '"]') || this.shadowRoot.querySelector('[class="invoice-text"]').parentElement;

                    // Do set
                    targetObject.classList.add('iron-selected')
                })
            }

            open() {
                if (!this.user) return
                Promise.all([this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId), this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => invoices.map(i => this.api.register(i, 'invoice')))]).then(([hcp, invoices]) => {
                    this.set('hcp', hcp)
                    this.set('invoices',invoices)
                    this.set('nmcl-value','')

                    const invoiceOfDay = invoices.find( i=> i.invoiceDate+'' === moment().format("YYYYMMDD") && !i.printedDate )

                    if(!invoiceOfDay){
                        const newInvoice = {}

                        newInvoice.id = ""
                        newInvoice.invoicingCodes = []
                        newInvoice.invoiceDate = moment().format("YYYYMMDD")
                        newInvoice.invoiceReference = null
                        newInvoice.override3rdPayerCode = (this.patient.insurabilities[0].parameters.tc1 % 2 ===1) ? "3" : "0"
                        newInvoice.invoiceType = (this.patient.insurabilities[0].parameters.tc1 % 2 ===1) ? "mutualfund" : "patient"
                        newInvoice.sentMediumType = (this.patient.insurabilities[0].parameters.tc1 % 2 === 1) ? "efact" : "eattest"
                        newInvoice.invoicePeriod = 0
                        newInvoice.longDelayJustification = 0
                        newInvoice.gnotionNihii = null
                        newInvoice.internshipNihii = null
                        newInvoice.encounterLocationNorm = 0
                        newInvoice.encounterLocationName = null
                        newInvoice.encounterLocationNihii = null
                        newInvoice.creditNote = 0
                        newInvoice.careProviderType = "persphysician"

                        this.push('invoices',newInvoice)

                        this._selectInvoice("")
                    }else{
                        this._selectInvoice(invoiceOfDay.id)
                    }

                    this.set('invoices', _.orderBy(this.invoices, ['invoiceDate'], ['desc']))

                    this.$.invoiceDialog.open()

                    this.getFavoritesCodes()
                })
            }

            _closeDialog() {
                this.$.invoiceDialog.close()
            }

            _isTrainee(careProviderType) {
                return careProviderType && careProviderType === "persphysician" ? false : true
            }

            _checkInvoiceMediumType() {
                return this.selectedInvoice && this.selectedInvoice.sentMediumType && this.selectedInvoice.sentMediumType === "efact" ? true : false
            }

            getFavoritesCodes() {
                const preferedCode = this.user.properties.find(p => p.type && p.type.identifier === "org.taktik.icure.tarification.favorites")

                if (preferedCode && preferedCode.typedValue) {
                    const code = JSON.parse(preferedCode.typedValue.stringValue)

                    this.api.tarification().getTarifications(new models.ListOfIdsDto({ids: code.cs.map(c => c)})).then(t => {
                        this.set("favoriteCode", t)
                    })
                }

            }

            analyzeMediumType(e) {
                this.set('selectedMediumCodeType', e.detail.value)
                return e && e.detail && e.detail.value && e.detail.value === "efact" ? this.set('isThirdParty', true) : this.set('isThirdParty', false)
            }

            _nmclSearch(e) {
                let latestSearchValue = e && e.detail.value
                this.latestSearchValue = latestSearchValue
                if (!latestSearchValue || latestSearchValue.length < 2) {
                    console.log("Cancelling empty search")
                    this.set('nmclListItem', [])
                    return
                }
                this._nmclDataProvider() && this._nmclDataProvider().filter(latestSearchValue).then(res => {
                    if (latestSearchValue !== this.latestSearchValue) {
                        console.log("Cancelling obsolete search")
                        return
                    }
                    this.set('nmclListItem', res.rows)
                })
            }

            _nmclDataProvider() {
                return {
                    filter: function (nmclFilterValue) {
                        let count = 10
                        return Promise.all([this.api.tarification().findPaginatedTarificationsByLabel('be', 'INAMI-RIZIV', 'fr', nmclFilterValue, null, count)]).then(results => {
                            const nmclList = results[0]
                            const filtered = _.flatten(nmclList.rows.map(nmcl => ({
                                id: nmcl.id,
                                descr: nmcl.code + ': ' + nmcl.label[this.language],
                                code: nmcl.code,
                                label: nmcl.label,
                                valorisations: nmcl.valorisations
                            })))
                            return {totalSize: filtered.length, rows: filtered}
                        })

                    }.bind(this)
                }

            }

            _getDescription(label) {
                return label && label[this.language]
            }

            _addNmcl(e) {
                this.set("isTarificationMcnError", false)
                this.set("isTarificationError", false)
                this.set('isDetailNmcl', false)
                this.set('isNmclVerified', false)
                this.set('npi', false)

                if (this.shadowRoot.querySelector("#nmcl-search").selectedItem || e.target.dataset.item) {

                    const nmcl = (e.target.dataset.item) ? JSON.parse(e.target.dataset.item) : this.shadowRoot.querySelector("#nmcl-search").selectedItem

                    const newNmcl = {
                        code: nmcl.code,
                        contactId: this.currentContact.id,
                        tarificationId: nmcl.id,
                        label: nmcl.label[this.language],
                        totalAmount: Number(0.00).toFixed(2),
                        reimbursement: Number(0.00).toFixed(2),
                        patientIntervention: Number(0.00).toFixed(2),
                        doctorSupplement: Number(0.00).toFixed(2),
                        units: 1,
                        canceled: false,
                        accepted: false,
                        pending: false,
                        resent: false,
                        dateCode: this.selectedInvoice.invoiceDate,
                        prescriberNeeded: nmcl.needsPrescriber,
                        isRelativePrestation: nmcl.hasRelatedCode,
                        valid: false,
                        id: this.api.crypto().randomUuid(),
                        prescriberNihii: null,
                        prescriberNorm: 0,

                    }
                    const ins = this.patient.insurabilities.find(i => !i.endDate)
                    const age = moment().diff(this.patient.dateOfBirth, 'years', true)
                    const dmg = this.patient.patientHealthCareParties.find(hcp => !hcp.referral)

                    const trainee = this.hcp.statuses
                    const convention = this.hcp.convention


                    const env = new evaljs.Environment({
                        patient: {
                            preferentialstatus: (ins && ins.parameters) ? !!ins.parameters.preferentialstatus : false,
                            age: age,
                            dmg: (dmg && dmg.referral) ? !!dmg.referral : false,
                            chronical: (ins && ins.parameters && ins.parameters.chronicalDisease) ? !!ins.parameters.chronicalDisease : false
                        },
                        hcp: {
                            trainee: (this.hcp && this.hcp.statuses && this.hcp.statuses.find(st => st === "trainee")) ? true : false,
                            convention: (this.hcp && this.hcp.statuses && this.hcp.statuses.find(st => st === "withconvention")) ? true : false
                        }
                    })

                    nmcl.valorisations.map(val => {
                        const gen = (env.gen(val.predicate)())
                        let status = {done: false}

                        while (!status.done) {
                            status = gen.next()
                        }

                        if (status.value && moment().isBetween(this.api.moment(val.startOfValidity),this.api.moment(val.endOfValidity),"year","[]")) {
                            newNmcl.totalAmount = Number(newNmcl.totalAmount) + Number(val.totalAmount)
                            newNmcl.reimbursement = Number(newNmcl.reimbursement) + Number(val.reimbursement)
                            newNmcl.patientIntervention = Number(newNmcl.patientIntervention) + Number(val.patientIntervention)
                        }
                    })

                    this.api.crypto().extractDelegationsSFKs(this.patient, this.user.healthcarePartyId).then(secretForeignKeys => {

                        const patientKeys = secretForeignKeys.join(",")

                        this.api.invoice().appendCodes(this.user.id, this.selectedInvoice.invoiceType, this.selectedMediumCodeType, this.patient.insurabilities[0].insuranceId, patientKeys, null, 0, [newNmcl]).then(inv => {
                            inv.map(invoice => {
                                if (!invoice.id) {
                                    invoice.invoiceDate = this.selectedInvoice.invoiceDate
                                    invoice.invoiceReference = this.selectedInvoice.invoiceReference
                                    invoice.override3rdPayerCode = this.selectedInvoice.override3rdPayerCode
                                    invoice.invoicePeriod = this.selectedInvoice.invoicePeriod
                                    invoice.longDelayJustification = this.selectedInvoice.longDelayJustification
                                    invoice.gnotionNihii = this.selectedInvoice.gnotionNihii === "" ? null : this.selectedInvoice.gnotionNihii
                                    invoice.internshipNihii = this.selectedInvoice.internshipNihii === "" ? null : this.selectedInvoice.internshipNihii
                                    invoice.creditNote = this.selectedInvoice.creditNote
                                    invoice.careProviderType = this.selectedInvoice.careProviderType

                                    return this.api.invoice().newInstance(this.user, this.patient, invoice)
                                        .then(invoice => this.api.invoice().createInvoice(invoice))
                                        .then(invoice => this.api.register(invoice,'invoice'))
                                        .then(invoice => {
                                            this.$['nmclGrid'].clearCache()
                                            console.log(this.selectedInvoice)
                                            this.api.invoice().findBy(this.user.healthcarePartyId, this.patient)
                                                .then(invoices => invoices.map(i => this.api.register(i, 'invoice')))
                                                .then(invoices => {
                                                    this.set('invoices', invoices)
                                                    this._selectInvoice(invoice.id)

                                                    return invoice
                                                })
                                        })
                                } else {
                                    return this.api.register(invoice, 'invoice')
                                }
                            })
                        })
                    })
                    console.log("test:",newNmcl)
                }

                this.set('nmcl-value','')
                this.shadowRoot.querySelector("#nmcl-search").focus()
            }

            _addFavoriteCode() {
                if (this.shadowRoot.querySelector("#nmcl-search").selectedItem) {

                    const newCode = this.shadowRoot.querySelector("#nmcl-search").selectedItem
                    const preferedCode = this.user.properties.find(p => p.type && p.type.identifier === "org.taktik.icure.tarification.favorites")

                    if (preferedCode && preferedCode.typedValue) {
                        const code = JSON.parse(preferedCode.typedValue.stringValue)

                        let existingCode = code.cs.find(c => c === newCode.id)

                        if (!existingCode) {
                            code.cs.push(newCode.id)

                            preferedCode.typedValue.stringValue = JSON.stringify(code)

                            this.set('user.properties', this.user.properties.map(x => x))

                            console.log(this.user)

                            this.api.user().modifyUser(this.user)
                                .then(user => this.api.register(user,"user"))
                                .then(user => this.dispatchEvent(new CustomEvent('user-saved', {
                                    detail: user,
                                    bubbles: true,
                                    composed: true
                                })))

                            this.getFavoritesCodes()
                        }
                    }
                }
                this.set('nmcl-value','')
                this.shadowRoot.querySelector("#nmcl-search").focus()
            }

            _deleteFavoriteCode(e) {
                const preferedCode = this.user.properties.find(p => p.type && p.type.identifier === "org.taktik.icure.tarification.favorites")

                if (preferedCode && preferedCode.typedValue) {
                    let code = JSON.parse(preferedCode.typedValue.stringValue)

                    const index = code.cs.indexOf(e.target.dataset.item)
                    delete(code.cs[index])
                    code.cs.splice(index, 1)

                    preferedCode.typedValue.stringValue = JSON.stringify(code)

                    this.set('user.properties', this.user.properties.map(x => x))

                    this.api.user().modifyUser(this.user)
                        .then(user => this.api.register(user,'user'))
                        .then(user => this.dispatchEvent(new CustomEvent('user-saved', {
                            detail: user,
                            bubbles: true,
                            composed: true
                        })))

                    this.getFavoritesCodes()
                }

            }

            _verifyTarification() {
                if (this.patient.ssin && this.api.tokenId && this.selectedInvoice.invoiceDate !== "" && this.api.patient().isValidSsin(this.patient.ssin)) {
                    this.set('isValidate',true)
                    this.isLoadingEattest = true
                    this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId)
                        .then(hcp =>
                            this.selectedInvoice.careProviderType === 'traineesupervised' && hcp.supervisorId ?
                                this.api.hcparty().getHealthcareParty(hcp.supervisorId).then(sup =>
                                this.api.fhc().Tarificationcontroller().consultTarificationUsingPOST(
                                    this.patient.ssin, this.api.tokenId, this.api.keystoreId, this.api.credentials.ehpassword,
                                    hcp.firstName, hcp.lastName, hcp.nihii, hcp.ssin,
                                    this.selectedInvoice.invoicingCodes.filter(ic => ic.code!=="109955").map(ic=>ic.code), this.selectedInvoice.invoiceDate, this.selectedInvoice.gnotionNihii === ""  ? null : this.selectedInvoice.gnotionNihii,
                                    this.selectedInvoice.override3rdPayerCode === "0" ? null : this.selectedInvoice.override3rdPayerCode, sup.ssin, sup.nihii, sup.firstName, sup.lastName
                                ).then(r => this.api.logMcn(r, this.user, this.selectedInvoice.id, "eTar", "consult")
                                ))
                                :
                                this.api.fhc().Tarificationcontroller().consultTarificationUsingPOST(
                                this.patient.ssin, this.api.tokenId, this.api.keystoreId, this.api.credentials.ehpassword,
                                hcp.firstName, hcp.lastName, hcp.nihii, hcp.ssin,
                                this.selectedInvoice.invoicingCodes.filter(ic => ic.code!=="109955").map(ic=>ic.code), this.selectedInvoice.invoiceDate, this.selectedInvoice.gnotionNihii === ""  ? null : this.selectedInvoice.gnotionNihii,
                                this.selectedInvoice.override3rdPayerCode === "0" ? null : this.selectedInvoice.override3rdPayerCode
                                ).then(r => this.api.logMcn(r, this.user, this.selectedInvoice.id, "eTar", "consult"))
                        )
                        .then(r => {
                            console.log(r)
                            this.set('isDetailNmcl', false)
                            this.set("tarificationError", null)

                            if (r.errors.length > 0) {
                                const errors = r.errors
                                this.set("tarificationError", errors)
                                this.set("isTarificationError", true)

                                if (errors[0].code === "999999") {
                                    this.set("isTarificationMcnError", true)
                                    this.set("isNmclVerified", true)
                                }

                            } else {
                                this.set("isTarificationError", false)
                                this.set("isNmclVerified", true)
                                this.set("isTarificationMcnError", false)

                                r.codeResults.forEach((c,idx) => {
                                    let invCode = this.selectedInvoice.invoicingCodes[idx]
                                    if (c.code !== invCode.code) {
                                        //Desperate measure
                                        invCode = this.selectedInvoice.invoicingCodes.find(invCode => invCode.code === c.code)
                                        idx = this.selectedInvoice.invoicingCodes.indexOf(invCode)
                                    }

                                    this.set(`selectedInvoice.invoicingCodes.${idx}.reimbursement`, c.reimbursement.amount)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.patientIntervention`, c.patientFee.amount)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.totalAmount`, c.fee.amount)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.contract`, c.contract)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.valid`, true)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.override3rdPayerCode`, c.justification)

                                    //this.$['nmclGrid'].clearCache()
                                })
                                this.calculateTotalOfInvoice()
                                console.log(this.selectedInvoice)
                            }
                            return null
                        }).catch((e) => {
                        console.log("Exception", e)
                    }).finally(() => {
                        this.isLoadingEattest = false
                        this.set('isValidate',false)
                    })

                } else {
                    //Todo manage mandatory fields
                }
            }

            calculateTotalOfInvoice() {
                let totalAmount = 0
                let patientIntervention = 0
                let reimbursement = 0
                let doctorSupplement = 0

                this.selectedInvoice.invoicingCodes.map(n => {
                    totalAmount += Number(n.totalAmount)
                    patientIntervention += Number(n.patientIntervention)
                    reimbursement += Number(n.reimbursement)
                    doctorSupplement += Number(n.doctorSupplement)
                })

                this.set('totalInvoice.totalAmount', Number(totalAmount).toFixed(2))
                this.set('totalInvoice.patientIntervention', Number(patientIntervention).toFixed(2))
                this.set('totalInvoice.reimbursement', Number(reimbursement).toFixed(2))
                this.set('totalInvoice.doctorSupplement', Number(doctorSupplement).toFixed(2))
            }

            _getErrorMsg(item, language) {
                return item && language && language === "fr" ? item.msgFr : item.msgNl
            }

            _showDetail() {
                if (this.activeNmclItem) {
                    const selected = this.activeNmclItem
                    if(selected.code==="109955"){
                        this.set('activeNmclItem.qteAll',(this.activeNmclItem.units+6)/2)
                    }
                    this.set('isDetailNmcl', true)
                    console.log(this.activeNmclItem)
                } else {
                    this.set('isDetailNmcl', false)
                }
            }

            _checkIfPrescriberIsNeeded(e) {
                if (e.detail.value === 0 || e.detail.value === 3) {
                    this.set("isPrescriberIsNeeded", false)
                } else {
                    this.set("isPrescriberIsNeeded", true)
                }

            }

            _checkIfLocationIsNeeded(e) {
                if (e.detail.value === 0) {
                    this.set("isLocationIsNeeded", false)
                } else {
                    this.set("isLocationIsNeeded", true)
                }

            }

            _deleteNmclCode(e) {
                e.stopPropagation()
                if (e.target.dataset.item) {
                    //this.api.invoice().removeCodes(this.user.id, service, this.patient.secretForeignKeys, e.target.item.tarificationId
                    this.set('isDetailNmcl', false)
                    let tabNmcl = this.selectedInvoice.invoicingCodes

                    const item = tabNmcl.find(n => n.tarificationId === e.target.dataset.item)
                    const iindex = tabNmcl.indexOf(item)

                    delete(tabNmcl[iindex])
                    tabNmcl.splice(iindex, 1)

                    this.set("selectedInvoice.invoicingCodes", this.selectedInvoice.invoicingCodes.map(x => x))

                    this.api.invoice().modifyInvoice(this.selectedInvoice)
                        .then(invoice => this.api.register(invoice,'invoice'))
                        .then(invoice => {
                            this.$['nmclGrid'].clearCache()
                            this.calculateTotalOfInvoice()

                            return invoice
                        })
                }
            }

            analyzeCareProviderType(e) {
                if (e.detail.value === "trainee") {
                    this.set("isTrainee", true)
                } else {
                    this.set("isTrainee", false)
                }
            }

            _validateAndPrepareInvoiceForBatchSending() {
                if (this.selectedInvoice.creditNote) {
                    console.log(this.selectedInvoice)
                    this.set('isJustif',true)
                    this.selectedInvoice.invoicingCodes.map(invoiceCode => {
                        this.set("selectedInvoice.invoicingCodes." + this.selectedInvoice.invoicingCodes.indexOf(invoiceCode) + ".reimbursement", 0 - invoiceCode.reimbursement)
                        this.set("selectedInvoice.invoicingCodes." + this.selectedInvoice.invoicingCodes.indexOf(invoiceCode) + ".patientIntervention", 0 - invoiceCode.patientIntervention)
                        this.set("selectedInvoice.invoicingCodes." + this.selectedInvoice.invoicingCodes.indexOf(invoiceCode) + ".doctorSupplement", 0 - invoiceCode.doctorSupplement)
                        this.set("selectedInvoice.invoicingCodes." + this.selectedInvoice.invoicingCodes.indexOf(invoiceCode) + ".totalAmount", 0 - invoiceCode.totalAmount)

                    })
                }

                if(!this._isSelectedInvoiceEattest())
                    this.set('selectedInvoice.printedDate', moment().format("YYYYMMDD"))

                this.api.entityRef().getLatest("Invoice::").then(latest => {
                    console.log(latest)
                    const lastReference = latest.id.replace(/Invoice:[^_]/g, '')
                    const newReference = Number(lastReference) + 1

                    this.set("selectedInvoice.invoiceReference", newReference)
                    this.api.invoice().modifyInvoice(this.selectedInvoice)
                        .then(invoice => this.api.register(invoice, 'invoice'))
                        .then(invoice =>
                            this.api.entityRef().createEntityReference({
                                docId: invoice.id,
                                id: "Invoice::" + newReference
                            }).then(() => {
                                console.log(invoice)
                                if(this.selectedInvoice.sentMediumType==="efact"){
                                    return this.generateJustificatory(invoice)
                                } else if(this.selectedInvoice.sentMediumType==="eattest"){
                                    return this.sendEattest(invoice);
                                }
                            })
                        )
                })
                this.set('isJustif',false)
            }

            _invoicingCodeChange() {
                if (this.activeNmclItem) {
                    const code = this.selectedInvoice.invoicingCodes.find(code => code.id === this.activeNmclItem.id)
                    const codeIdx = this.selectedInvoice.invoicingCodes.indexOf(code)

                    let totalAmount = Number(this.activeNmclItem.patientIntervention) + Number(this.activeNmclItem.reimbursement) + Number(this.activeNmclItem.doctorSupplement)

                    this.set('activeNmclItem.totalAmount', Number(totalAmount).toFixed(2))
                    this.set('selectedInvoice.invoicingCodes.'+codeIdx, this.activeNmclItem)
                    this.$['nmclGrid'].clearCache()
                    this.calculateTotalOfInvoice()
                    this.selectedInvoiceChanged();
                }
            }

            returnDatePickerDate(date) {
                return date ? ("" + date).replace(/([0-9]{4})([0-9]{2})([0-9]{2})/, '$1-$2-$3') : 'N/A'

            }

            _formatInvoiceDate(date) {
                return date ? this.api.moment(date).format("DD/MM/YYYY") : 'N/A'
            }

            _formatAmount(amount) {
                if (amount == 0) {return "0.00"}
                if (amount.toString().length < 3) {
                    let out = // if integer, add the decimals, else just besure it's float
                        (Number(amount)%1 === 0) ? amount+".00" : parseFloat(amount)
                    return out
                }
                return amount
            }

            datePickerChanged() {
                console.log('datePickerChange')
            }

            _invoiceDateAsStringChanged(invoiceDateAsString) {
                const dateNow = parseInt(this.api.moment(Date.now()).format('YYYYMMDD'));
                const dateInt = parseInt(invoiceDateAsString.replace(/(....)-(..)-(..)/, '$1$2$3'))
                if (this.selectedInvoice && (this.selectedInvoice.invoiceDate !== dateInt)) {
                    if (dateInt <= dateNow) {
                        this.set('selectedInvoice.invoiceDate', dateInt)
                    } else {
                        this.$['invoice-date'].set(Date.now())
                    }

                }
            }

            _prescriptionDateAsStringChanged(prescriptionDateAsString) {
                const dateNow = parseInt(this.api.moment(Date.now()).format('YYYYMMDD'));
                const dateInt = parseInt(prescriptionDateAsString.replace(/(....)-(..)-(..)/, '$1$2$3'))
                if (this.selectedInvoice && (this.selectedInvoice.prescriptionDate !== dateInt)) {
                    if ( dateInt <= dateNow) {
                        this.set('selectedInvoice.prescriptionDate', dateInt)
                    } else {
                        if(this.shadowRoot.querySelector('#prescription-date')) {
                            this.shadowRoot.querySelector('#prescription-date').set(Date.now())
                        }
                    }

                }
            }

            findAndReplace(string, target, replacement) {
                if(!(string && target && replacement))return;
                for (let i = 0; i < string.length; i++) { string = string.replace(target, replacement); }
                return string;
            }

            getInvoiceType(invoiceType){
                if(!invoiceType) return;
                const type = this.invoiceType.find(type => type.id === invoiceType)
                return type && type.label && type.label[this.language]
            }

            getSentMediumType(sentMediumType){
                const type = this.sentMediumType.find(type => type.id === sentMediumType)
                return type && type.label && type.label[this.language]
            }

            formatAmount(value) {
                return value && parseFloat(Math.round(value * 100) / 100).toFixed(2);
            }

            generateJustificatory(){
                let template = {
                    "pageOne": {
                        entries: [],
                        tot: {
                            totTotal: 0,
                            totOa: 0,
                            totPers: 0,
                            totSuppr: 0
                        }
                    },
                    "pageTwo": {
                        entries: [],
                        tot: {
                            totTotal: 0,
                            totOa: 0,
                            totPers: 0,
                            totSuppr: 0
                        }
                    }
                }
                let totTotal=0.00,totOA=0.00,totPers=0.00,totSupp=0.00

                console.log("selected Invoice",this.selectedInvoice.invoicingCodes)
                console.log("this patient",this.patient)

                this.selectedInvoice.invoicingCodes.map(code => {
                    const invoiceDate = this._formatInvoiceDate(code.dateCode)
                    const invDate = invoiceDate
                    const thisCode = code.code.toString()
                    const reimbursement = this.formatAmount(code.reimbursement.toString())
                    const patientIntervention = this.formatAmount(code.patientIntervention.toString())
                    const doctorSupplement = this.formatAmount(code.doctorSupplement.toString())
                    const totalAmount = this.formatAmount(code.totalAmount.toString())

                    totTotal+=code.totalAmount;
                    totOA+=code.reimbursement;
                    totPers+=code.patientIntervention;
                    totSupp+=code.doctorSupplement;

                    totTotal = this.formatAmount(totTotal)
                    totOA = this.formatAmount(totOA)
                    totPers = this.formatAmount(totPers)
                    totSupp = this.formatAmount(totSupp)

                    const entry = {
                        "invDate": invoiceDate,
                        "code": thisCode,
                        "reimbursement": reimbursement,
                        "patientIntervention": patientIntervention,
                        "doctorSupplement": doctorSupplement,
                        "totalAmount": totalAmount
                    }
                    template.pageOne.entries.push(entry)
                    template.pageTwo.entries.push(entry)
                })
                template.pageOne.tot.totTotal = totTotal
                template.pageOne.tot.totOa = totOA
                template.pageOne.tot.totPers = totPers
                template.pageOne.tot.totSupp = totSupp

                template.pageTwo.tot.totTotal = totTotal
                template.pageTwo.tot.totOa = totOA
                template.pageTwo.tot.totPers = totPers
                template.pageTwo.tot.totSupp = totSupp

                const html =
                `<html>
                    <head>
                        <style>
                            body {
                                margin: 0;
                            }
                            @page {
                                size: A4;
                                margin: 0;
                            }
                            article.page {
                                width: 210mm;
                                height: 297mm;
                                display: flex;
                                flex-direction: column;
                                padding: 25px;
                                box-sizing: border-box;
                                page-break-after: always;
                                border-bottom: 1px dashed grey;
                            }
                            article.page:last-child {
                                border-bottom: 0;
                            }
                            @media print {
                                article.page {
                                    border-bottom: 0;
                                }
                            }
                            table {
                                display: table;
                                box-sizing: border-box;
                                border-spacing: 0;
                                border-collapse: collapse;
                                width: 100%;
                            }
                            table thead {font-size: 14px}
                            table tr,
                            table td {
                                margin: 0;
                                padding: 0;
                                vertical-align: top;
                            }
                            table td {padding: 5px;}

                            table.border,
                            table.border tr,
                            table.border td {
                                border: 1px solid black;
                            }
                            *.half td {width: 50%;}
                            *.no-border * {border: none !important;}
                            #factBody {
                                display: flex;
                                flex-direction: column;
                                flex: 1;
                                border: 1px solid black;
                            }
                            #factBody * {border: none;}
                            #factBody > * {
                                display: flex;
                                flex-direction: column;
                            }
                            #factBody > * > tr {
                                display: flex;
                                flex-direction: row;
                                border-bottom: 1px solid black;
                            }
                            #factBody > * > tr.border > td {border-right: 1px solid black;}
                            #factBody > * > tr.border > td:last-child {border-right: 0;            }
                            #factBody > * > tr > td {flex: 1 100%;}
                            #factBody > tbody {flex: 1;}
                            #factBody .table-entry,
                            #factBody .table-entry td {
                                border: none;
                                border-bottom: .5px solid lightgrey;
                            }
                            #factBody .table-entry td:last-child {border-bottom: none;}
                            #factBody .table-entry > td {text-align: right;}
                            #factBody .table-entry > td:first-child {text-align: left;}
                            #factBody .row-total > td {text-align: right;}
                            #factBody .row-total > td:first-child {text-align: left;}
                            .txt-center {text-align: center;}
                            .mt20 {margin-top: 20px;}
                            .bleft {border-left:1px solid black !important;}
                            .bleft-light {border-left:1px solid lightgrey !important;}
                            .bbottom-light {border-bottom:1px solid lightgrey !important;}
                            .bbzero {border-bottom: 0 !important;}
                            .nopad {padding: 0;}
                            .fleft {float: left;}
                            .fright {float:right;}
                            td.important {
                                font-weight: bold;
                                font-size: 1.1em;
                            }
                            td.indic {font-weight: 700;}
                            *.min-txt {font-size: 11px;}
                            .table-entry.min-txt {font-size: 16px;}
                        </style>
                    </head>
                    <body>
                        <article id="page-patient" class="page">
                            <table id="docHeader" class="border">
                                <thead>
                                <tr>
                                    <td class="important">Numéro d'ordre: ${this.selectedInvoice.invoiceReference}</td>
                                    <td class="important txt-center">DOCUMENT JUSTIFICATIF DE SOINS DE SANTE DESTINE AU PATIENT</td>
                                </tr>
                                <tr>
                                    <td class="indic txt-center">Patient</td>
                                    <td class="indic txt-center">Dispensateur de soins</td>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td id="patient-info" class="nopad">
                                        <table class="no-border">
                                            <thead>
                                                <tr>
                                                    <td colspan="2">Identification</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            <tr class="bbottom-light">
                                                <td>Nom&nbsp;:</td>
                                                <td class="indic">${this.patient.lastName}</td>
                                            </tr>
                                            <tr class="bbottom-light">
                                                <td>Prénom&nbsp;:</td>
                                                <td class="indic">${this.patient.firstName}</td>
                                            </tr>
                                            <tr>
                                                <td>NISS&nbsp;:</td>
                                                <td class="indic">${this.patient.ssin}</td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                    <td class="nopad">
                                        <table class="no-border half">
                                            <tr>
                                                <td class="nopad">
                                                    <table class="no-border">
                                                        <thead>
                                                        <tr>
                                                            <td colspan="2">Identification</td>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <tr class="bbottom-light">
                                                            <td>Nom&nbsp;:</td>
                                                            <td class="indic">${this.hcp.lastName}</td>
                                                        </tr>
                                                        <tr class="bbottom-light">
                                                            <td>Prénom&nbsp;:</td>
                                                            <td class="indic">${this.hcp.firstName}</td>
                                                        </tr>
                                                        <tr class="bbottom-light">
                                                            <td>Adresse&nbsp;:</td>
                                                            <td class="indic">${this.hcp.firstName}</td>
                                                        </tr>
                                                        </tbody>
                                                        <tfoot>
                                                        <tr class="bbottom-light">
                                                            <td>INAMI&nbsp;:</td>
                                                            <td class="indic">${this.hcp.nihii}</td>
                                                        </tr>
                                                        <tr>
                                                            <td>BCE&nbsp;:</td>
                                                            <td class="indic">${this.hcp.cbe}</td>
                                                        </tr>
                                                        </tfoot>
                                                    </table>
                                                </td>
                                                <td class="bleft nopad">
                                                    <table class="no-border">
                                                        <thead>
                                                        <tr>
                                                            <td class="txt-center">Les prestations de santé ont été effectuées pour le
                                                                compte de :</td>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <table class="no-border">
                                                            <tbody>
                                                            <tr class="bbottom-light">
                                                                <td>Nom&nbsp;:</td>
                                                                <td class="indic">${this.hcp.firstName}</td>
                                                            </tr>
                                                            <tr>
                                                                <td>BCE&nbsp;:</td>
                                                                <td class="indic">${this.hcp.cbe}</td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                        </tbody>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <table id="factBody" class="border mt20">
                                <thead>
                                <tr>
                                    <td colspan="6" class="important txt-center">PRESTATION(S) DE SANTE REMBOURSABLE(S)</td>
                                </tr>
                                <tr class="no-border">
                                    <td style="flex: 1 0 15.15%;"></td>
                                    <td class="indic txt-center bleft-light" colspan="5">Prestation(s) facturée(s) en tiers payant</td>
                                </tr>
                                <tr class="border min-txt">
                                    <td>Date des prestations</td>
                                    <td>Code prestation</td>
                                    <td>Intervention OA</td>
                                    <td>Intervention personnelle</td>
                                    <td>Supplément</td>
                                    <td>Total</td>
                                </tr>
                                </thead>
                                <tbody>
                                {{#pageOne.entries}}
                                <tr class="table-entry min-txt">
                                    <td>{{invDate}}</td>
                                    <td class="bleft-light">{{code}}</td>
                                    <td class="bleft-light">{{reimbursement}}</td>
                                    <td class="bleft-light">{{patientIntervention}}</td>
                                    <td class="bleft-light">{{doctorSupplement}}</td>
                                    <td class="bleft-light">{{totalAmount}}</td>
                                </tr>
                                {{/pageOne.entries}}
                                </tbody>
                                <tfoot>
                                <tr class="no-border row-total">
                                    <td class="important">Total</td>
                                    <td></td>
                                    {{#pageOne.tot}}
                                    <td class="indic">{{totOa}}</td>
                                    <td class="indic">{{totPerso}}</td>
                                    <td class="indic">{{totSupp}}</td>
                                    <td class="indic">{{totTotal}}</td>
                                    {{/pageOne.tot}}
                                </tr>
                                <tr class="no-border">
                                    <td class="indic">
                                        <div class="fleft">Total dû par le patient</div>
                                        <div class="fright">{{pageOne.tot.totPers}}</div>
                                    </td>
                                </tr>
                                <tr class="no-border">
                                    <td class="indic">
                                        <div class="fleft">Montant total facturé à l'organisme assureur (OA)</div>
                                        <div class="fright">{{pageOne.tot.totOa}}</div>
                                    </td>
                                </tr>
                                <tr class="no-border bbzero">
                                    <td class="indic">
                                        <div class="fleft">Montant total à payer par le patient</div>
                                        <div class="fright">{{pageOne.tot.totPers}}</div>
                                    </td>
                                </tr>
                                </tfoot>
                            </table>
                            <small>Le présent document justificatif ne donne aucun droit au remboursement</small>
                        </article>
                        <article id="page-medic" class="page">
                            <table id="docHeader" class="border">
                                <thead>
                                <tr>
                                    <td class="important">Numéro d'ordre&nbsp;: ${this.selectedInvoice.invoiceReference}</td>
                                    <td class="important txt-center" colspan="2">DOCUMENT JUSTIFICATIF DE SOINS DE SANTE DESTINE AU MÉDECIN</td>

                                </tr>
                                <tr>
                                    <td class="indic txt-center" colspan="3">Dispensateur de soins</td>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td class="nopad">
                                        <table class="no-border">
                                            <thead>
                                            <tr>
                                                <td colspan="2">Identification</td>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr class="bbottom-light">
                                                <td>Nom&nbsp;:</td>
                                                <td class="indic">${this.hcp.lastName}</td>
                                            </tr>
                                            <tr class="bbottom-light">
                                                <td>Prénom&nbsp;:</td>
                                                <td class="indic">${this.hcp.firstName}</td>
                                            </tr>
                                            <tr class="bbottom-light">
                                                <td>Adresse&nbsp;:</td>
                                                <td class="indic">${this.hcp.firstName}</td>
                                            </tr>
                                            </tbody>
                                            <tfoot>
                                            <tr class="bbottom-light">
                                                <td>INAMI&nbsp;:</td>
                                                <td class="indic">${this.hcp.nihii}</td>
                                            </tr>
                                            <tr>
                                                <td>BCE&nbsp;:</td>
                                                <td class="indic">${this.hcp.cbe}</td>
                                            </tr>
                                            </tfoot>
                                        </table>
                                    </td>
                                    <td class="bleft nopad">
                                        <table class="no-border">
                                            <thead>
                                            <tr>
                                                <td class="txt-center">Les prestations de santé ont été effectuées pour le
                                                    compte de&nbsp;:</td>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                <table class="no-border">
                                                    <tbody>
                                                    <tr class="bbottom-light">
                                                        <td>Nom&nbsp;:</td>
                                                        <td class="indic">${this.hcp.lastName}</td>
                                                    </tr>
                                                    <tr>
                                                        <td>BCE&nbsp;:</td>
                                                        <td class="indic">${this.hcp.cbe}</td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </tbody>
                                        </table>
                                    </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <table id="factBody" class="border mt20">
                                <thead>
                                <tr>
                                    <td colspan="6" class="important txt-center">PRESTATION(S) DE SANTE REMBOURSABLE(S)</td>
                                </tr>
                                <tr class="no-border">
                                    <td style="flex: 1 0 15.15%;"></td>
                                    <td class="indic txt-center bleft-light" colspan="5">Prestation(s) facturée(s) en tiers payant</td>
                                </tr>
                                <tr class="border min-txt">
                                    <td>Date des prestations</td>
                                    <td>Code prestation</td>
                                    <td>Intervention OA</td>
                                    <td>Intervention personnelle</td>
                                    <td>Supplément</td>
                                    <td>Total</td>
                                </tr>
                                </thead>
                                <tbody>
                                {{#pageTwo.entries}}
                                <tr class="table-entry min-txt">
                                    <td>{{invDate}}</td>
                                    <td class="bleft-light">{{code}}</td>
                                    <td class="bleft-light">{{reimbursement}}</td>
                                    <td class="bleft-light">{{patientIntervention}}</td>
                                    <td class="bleft-light">{{doctorSupplement}}</td>
                                    <td class="bleft-light">{{totalAmount}}</td>
                                </tr>
                                {{/pageTwo.entries}}
                                </tbody>
                                <tfoot>
                                <tr class="no-border row-total">
                                    <td class="important">Total</td>
                                    <td></td>
                                    {{#pageTwo.tot}}
                                    <td class="indic">{{totOa}}</td>
                                    <td class="indic">{{totPerso}}</td>
                                    <td class="indic">{{totSupp}}</td>
                                    <td class="indic">{{totTotal}}</td>
                                    {{/pageTwo.tot}}
                                </tr>
                                <tr class="no-border">
                                    <td class="indic">
                                        <div class="fleft">Total dû par le patient</div>
                                        <div class="fright">{{pageTwo.tot.totPers}}</div>
                                    </td>
                                </tr>
                                <tr class="no-border">
                                    <td class="indic">
                                        <div class="fleft">Montant total facturé à l'organisme assureur (OA)</div>
                                        <div class="fright">{{pageTwo.tot.totOa}}</div>
                                    </td>
                                </tr>
                                <tr class="no-border bbzero">
                                    <td class="indic">
                                        <div class="fleft">Montant total à payer par le patient</div>
                                        <div class="fright">{{pageTwo.tot.totPers}}</div>
                                    </td>
                                </tr>
                                </tfoot>
                            </table>
                            <small>Le présent document justificatif ne donne aucun droit au remboursement</small>
                        </article>
                    </body>
                </html>`;

                this.api.pdfReport(mustache.render(html, template))
                    .then(data =>{
                        let blob = new Blob([data],{type :'application/pdf'});

                        let url = window.URL.createObjectURL(blob)

                        let a = document.createElement("a");
                        document.body.appendChild(a);
                        a.style = "display: none";

                        a.href = url;
                        a.download = this.selectedInvoice.id+moment()+".pdf";
                        a.click();
                        window.URL.revokeObjectURL(url);
                    })
            }

            _ifStatusDateExist(date){
                return (date && date !== "") ? true : false
            }

            _getOvveride3PayerCodeAsString(tp){
                const tpAsString = this.thirdPartyJustification.find(tpRef => tpRef.id == tp)
                return (tpAsString) ? tpAsString.label[this.language] : ""

            }

            _tranferNmcl(){
                if(this.bufferTypeCode!=this.selectedMediumCodeType){
                    this.api.crypto().extractDelegationsSFKs(this.patient, this.user.healthcarePartyId).then(secretForeignKeys => {
                        const patientKeys = secretForeignKeys.join(",")
                        this.api.invoice().appendCodes(this.user.id,this.selectedInvoice.invoiceType, this.bufferTypeCode, this.patient.insurabilities[0].insuranceId, patientKeys, null, 0, [this.activeNmclItem]).then( response => {
                            const invoice = response[0]
                            if (!invoice) {
                                return null
                            }
                            if (!invoice.id) {
                                invoice.invoiceDate = this.selectedInvoice.invoiceDate
                                invoice.invoiceReference = this.selectedInvoice.invoiceReference
                                invoice.override3rdPayerCode = this.selectedInvoice.override3rdPayerCode                                
                                invoice.invoicePeriod = this.selectedInvoice.invoicePeriod
                                invoice.longDelayJustification = this.selectedInvoice.longDelayJustification
                                invoice.gnotionNihii = this.selectedInvoice.gnotionNihii === "" ? null : this.selectedInvoice.gnotionNihii
                                invoice.internshipNihii = this.selectedInvoice.internshipNihii === "" ? null : this.selectedInvoice.internshipNihii
                                invoice.creditNote = this.selectedInvoice.creditNote
                                invoice.careProviderType = this.selectedInvoice.careProviderType

                                return this.api.invoice().newInstance(this.user, this.patient, invoice)
                                    .then(invoice => this.api.invoice().createInvoice(invoice))
                                    .then(invoice => this.api.register(invoice, 'invoice'))
                                    .then(invoice => {
                                        this.$['nmclGrid'].clearCache()
                                        this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => invoices.map(i => this.api.register(i, 'invoice'))).then(invoices => {
                                            this.set('invoices', invoices)
                                            this._selectInvoice(invoice.id)

                                            return invoice
                                        })
                                    })
                            } else {
                                return this.api.register(invoice, 'invoice')
                            }
                        }).then (invoice => {
                            this.set('isDetailNmcl', false)
                            let tabNmcl = this.selectedInvoice.invoicingCodes

                            const item = tabNmcl.find(n => n.tarificationId === this.activeNmclItem)
                            const iindex = tabNmcl.indexOf(item)

                            delete(tabNmcl[iindex])
                            tabNmcl.splice(iindex, 1)

                            this.set("selectedInvoice.invoicingCodes", this.selectedInvoice.invoicingCodes.map(x => x))

                            this.api.invoice().modifyInvoice(this.selectedInvoice)
                                .then(invoice => this.api.register(invoice,'invoice'))
                                .then(invoice => {
                                    //TODO check that it was in the list of invoices or do a findBy and that it was selected or do a select

                                    this.$['nmclGrid'].clearCache()
                                    this.calculateTotalOfInvoice()

                                    return invoice
                                })
                        })
                    })
                }
            }

            _openTransfertDialog(e){
                e.stopPropagation()
                this.$["transferDialog"].open()
            }

            _openlinkRelativePrestationDialog(e){
                e.stopPropagation()
                this.parentRelatedCodeId = e.target.id
                this.$["relativeCodeDialog"].open()
            }

            _linkCode(selectedNmclId){
                if(selectedNmclId != ""){
                    const childNmcl = this.selectedInvoice.invoicingCodes.find(nmcl => selectedNmclId === nmcl.id) || null
                    const parentNmcl = this.selectedInvoice.invoicingCodes.find(nmcl => this.parentRelatedCodeId === nmcl.id) || null

                    if(childNmcl !== null && parentNmcl !== null){
                        parentNmcl.relatedCode = childNmcl.code
                        this.$["relativeCodeDialog"].close()
                    }

                }

            }

            //Obsolete because related-code.html is not supported by vaadin-grid for the moment.
            linkNmclToRelatedCode(e) {
                if (e.detail.relativeCode && e.detail.parentId) {
                    let selectedNmcl = this.selectedInvoice.invoicingCodes.find(n => n.id === e.detail.parentId) || null
                    if (selectedNmcl !== null) {
                        selectedNmcl.relatedCode = e.detail.relativeCode
                    }
                }
            }

            scheduleInvoiceUpdate(){
                if (this.saveTimeout) {
                    clearTimeout(this.saveTimeout);
                }
                this.saveAction = () => {
                    console.log(this.selectedInvoice)
                    this.api.invoice().modifyInvoice(this.selectedInvoice)
                        .then(invoice => this.api.register(invoice,'invoice'))
                        .then(response => {
                            this.api.tarification().getTarifications(new models.ListOfIdsDto({ids: response.invoicingCodes.map(tar => tar.tarificationId)})).then(nmcls =>
                                nmcls.map(nmcl =>{
                                    const sn = response.invoicingCodes.find(n => n.tarificationId === nmcl.id) || null
                                    if(sn){
                                        sn.prescriberNeeded = nmcl.needsPrescriber
                                        sn.isRelativePrestation = nmcl.hasRelatedCode
                                    }
                                })
                            )
                            console.log("saved:",response)
                        })
                };
                this.saveTimeout = setTimeout(this.saveAction, 10000);
            }

            selectedInvoiceChanged(){
                this.scheduleInvoiceUpdate();
            }

            isEnterPressed(e){
                if(e.keyCode==13){
                    this._addNmcl(e);
                }
            }

            /*isLongDelay() {
                return this.selectedInvoice.longDelayJustification ? true : false
            }*/

            _openEidDialog(){
                this.$["eidDialog"].open()
            }

            _readEidCard(){

            }

            _readBarreCode(){

            }

            _showManualEncodingDialog(){
                this.$['eidDialog'].close()
                this.$['manualEncodingDialog'].open()
            }

            _closeEidDialog(){
                this.$['eidDialog'].close()
            }

            _closeManualEncodingDialog(){
                this.$['manualEncodingDialog'].close()
            }

            _isCreditNote(e) {
                this.set('selectedInvoice.creditNote', e.target.checked)
            }

            _isLiftingLimitationPeriod(e) {
                this.set('selectedInvoice.longDelayJustification', e.target.checked ? 1 : 0)
            }

            isTravellingExpenses(){
                return  this.activeNmclItem &&  this.activeNmclItem.code && this.activeNmclItem.code==="109955"
            }

            quantityAllHasChanged(){
                this.set("activeNmclItem.units",Math.round(this.activeNmclItem.qteAll*2)-6)
                if(this.activeNmclItem.units<0)this.set("activeNmclItem.units",0)
                if(this.activeNmclItem.qteAll>20)this.set("activeNmclItem.units",34)

                const total = Math.round(this.activeNmclItem.units*0.92*100)/100
                //entre 1.103 et 1.10 ils ont super mal calculé leurs éléments et ils donnent pas la formule.

                const remb = [0.84,1.67,2.51,3.34,4.17,5.01,5.84,6.67,7.51,8.34,9.17,10.01,10.84,11.68,12.51,13.34,14.18,15.01,15.84,16.68,17.51,18.35,19.18,20.01,20.84,21.68,22.51,23.35,24.18,25.01,25.85,26.68,27.51,28.35]

                this.set("activeNmclItem.patientIntervention",(total-remb[this.activeNmclItem.units-1]).toFixed(2))
                this.set("activeNmclItem.reimbursement",remb[this.activeNmclItem.units-1])

                return  this.activeNmclItem && this.activeNmclItem.gteAll && Math.round(this.activeNmclItem.qteAll*2)
            }

            sendEattest(){
                let eattest = {codes : []};
                this.selectedInvoice.invoicingCodes.map(code =>{
                    let newCode = {
                        date : code.dateCode,
                        doctorSupplement : Number(code.doctorSupplement),
                        fee : Number(code.totalAmount),
                        quantity : code.units,
                        reglementarySupplement : Number(code.patientIntervention),
                        reimbursement: Number(code.reimbursement),
                        requestor : {
                            date: this.selectedInvoice.invoiceDate ,
                            hcp: {
                                cdHcParty: "persphysician",
                                firstName: this.hcp.firstName,
                                idHcParty: this.hcp.nihii,
                                idSsin: this.hcp.ssin,
                                lastName: this.hcp.lastName
                            }
                        },
                        riziv : code.code
                    }

                    if(code.relatedCode){
                        newCode.relativeService = code.relatedCode;
                    }
                    if(this.selectedInvoice.gnotionNihii){
                        newCode.gmdManager={
                            cdHcParty: null,
                            firstName: null,
                            idHcParty: this.selectedInvoice.gnotionNihii,
                            idSsin: null,
                            lastName: null
                        }
                    }

                    if(this.selectedInvoice.internshipNihii){
                        newCode.internship={
                            cdHcParty: "trainee",
                            firstName: null,
                            idHcParty: this.selectedInvoice.internshipNihii,
                            idSsin: null,
                            lastName: null
                        }
                    }

                    if(this.selectedInvoice.encounterLocationNorm!==0){
                        newCode.location={
                            cdHcParty: this.locationType[this.selectedInvoice.encounterLocationNorm].cdHcParty,
                            firstName: null,
                            idHcParty: _.padEnd(this.selectedInvoice.encounterLocationNihii,11, '0'),
                            idSsin: null,
                            lastName: null
                        }
                    }

                    eattest.codes.push(newCode)
                })

                console.log("invoice",eattest)
                console.log("envoie")
                const sentDate=moment().format("YYYYMMDD")
                this.api.fhc().Eattestcontroller().sendAttestUsingPOST(this.patient.ssin, this.api.keystoreId,this.api.tokenId,this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName,this.hcp.cbe,eattest,sentDate)
                    .then(response =>{
                        console.log("recu reponse :",response)
                        if(response.acknowledge.errors.length===0){
                            this.api.logMcn(response, this.user, this.selectedInvoice.id, "eAttest", "invoice")
                            this.set('selectedInvoice.thirdPartyReference',response.invoicingNumber)
                            this.set("selectedInvoice.sentDate",sentDate)
                            this.eattest(this.selectedInvoice)
                        }
                        else{
                            let errorMsg="";
                            response.acknowledge.errors.map(error => {
                                errorMsg.concat(error.code+" "+(this.language==="fr" ? error.msgFr : error.msgNl)+", ")
                            })
                            this.set("errorMessage",errorMsg)
                        }
                    })
            }

            _ifEattestSaved(item){
                return item && item.printedDate && item.sentMediumType && item.sentMediumType==="eattest"
            }

            _toggleEditHE(e) {
                e.stopPropagation();
                e.preventDefault();

                let parentElement = e.target.parentElement;
                if (parentElement.classList.contains('open')) {
                    parentElement.classList.remove('open')
                } else {
                    parentElement.classList.add('open');
                    setTimeout(() => parentElement.classList.remove('open'), 4000);
                }
            }

            openXmlDialog(e){
                e.stopPropagation();
                e.preventDefault();

                const invoice = JSON.parse(e.target.dataset.item)

                this.$['xml_dialog'].open()
            }

            conventionAmountChanged(){
                if(!this.activeNmclItem)return ;
                const tot = Number(this.activeNmclItem.patientIntervention)+Number(this.activeNmclItem.reimbursement);
                this.set('activeNmclItem.conventionAmount',tot)
            }

            _handleCheckboxCheckedStatusFromInteger( inputValue ) { return !!inputValue; }

            duplicate(e){
                e.stopPropagation();
                e.preventDefault();

                console.log(e.target.dataset.item)
                this.eattest(JSON.parse(e.target.dataset.item))
            }

            eattest(invoice){

                console.log("print",invoice)

                //generate jpeg
                const element = this.root.querySelector("#barCode");
                JsBarcode(element,invoice.override3rdPayerCode, { format: "CODE128A", displayValue: false, height: 75 });
                const jpegUrl = element.toDataURL("image/jpeg");

                //totaux
                let totalACharge=0.00;
                let totalSuppl=0.00;
                let totalRemb=0.00;
                let totalConv=0.00;
                let totalDelta=0.00;

                invoice.invoicingCodes.map((code)=>{
                    totalACharge+=code.reimbursement+code.patientIntervention;
                    totalSuppl+=Number(code.doctorSupplement)
                    totalRemb+=Number(code.reimbursement)
                    totalConv+=Number(code.conventionAmount)
                    totalDelta+=Number(code.reimbursement)+Number(code.patientIntervention)+Number(code.doctorSupplement)
                })

                let templatePat = _.clone(this.patient), templateHcp = _.clone(this.hcp)
                templatePat.gender = (this.patient.gender === "male") ? "Mr" : "Mme"
                templatePat.addresses.map(addr=>{addr.telecoms.map(telcom=>{
                    telcom.telecomType = (telcom.telecomType === "phone") ? "Tel" : telcom.telecomType
                })})
                console.log("hcp",templateHcp,typeof templateHcp)
                console.log("pat",templatePat,typeof templatePat)
                templateHcp.addresses.map(addr=>{addr.telecoms.map(telcom=>{
                    telcom.telecomType = (telcom.telecomType === "phone") ? "Tel" : telcom.telecomType
                })})

                const template = {
                    "invoice" : invoice,
                    "patient" : templatePat,
                    "hcp" : templateHcp,
                    "formatDate" : function(){
                        return function(date,render){
                            let format =render(date)
                            return moment(format).format("DD/MM/YYYY")
                        }
                    },
                    "formatNumber" : function(){
                        return function(calcul,render){
                            let termes = render(calcul).split(" ")
                            while(termes.length>2){
                                let first = Number(termes.shift())
                                let operateur = termes.shift()
                                let second = Number(termes.shift())

                                if(operateur=="+"){
                                    termes.unshift(first+second);
                                }
                                else if(operateur==="-"){
                                    termes.unshift(first-second);
                                }
                                else return "erreur dans le calcul"

                            }
                            return Number(termes[0]).toFixed(2)+" €";
                        }
                    },
                    "justif": this.localize('pdf_justif','justif',this.language),
                    "date": this.localize('pdf_date','date',this.language),
                    "patCord": this.localize('pdf_patCord','patCord',this.language),
                    "remboursPrest": this.localize('pdf_remboursPrest','remboursPrest',this.language),
                    "honorPort": this.localize('pdf_honorPort','honorPort',this.language),
                    "intervMut": this.localize('pdf_intervMut','intervMut',this.language),
                    "honorConv": this.localize('pdf_honorConv','honorConv',this.language),
                    "deltaSupp": this.localize('pdf_deltaSupp','deltaSupp',this.language),
                    "subTot": this.localize('pdf_subTot','subTot',this.language),
                    "totOne": this.localize('pdf_totOne','totOne',this.language),
                    "totFinal": this.localize('pdf_totFinal','totFinal',this.language),
                    "totalACharge" : totalACharge,
                    "totalSuppl" : totalSuppl,
                    "totalRemb" : totalRemb,
                    "totalConv" : totalConv,
                    "totalDelta" : totalDelta,
                    "jpegUrl" : jpegUrl
                }

                const html = `
                <html>
                    <head>
                        <meta charset="utf-8">
                        <title></title>
                        <style>
                            .invoice-box {
                                max-width: 800px;
                                min-height:880px;
                                margin: auto;
                                padding: 30px;
                                border: 1px solid #eee;
                                box-shadow: 0 0 10px rgba(0, 0, 0, .15);
                                font-size: 16px;
                                line-height: 24px;
                                font-family: 'Helvetica Neue', 'Helvetica', Helvetica, Arial, sans-serif;
                                color: #555;
                            }
                            .invoice-box table {
                                width: 100%;
                                line-height: inherit;
                                text-align: left;
                            }
                            .p12 {width:12%;}
                            .p50 {width:50%;}
                            .bold {font-weight: bold;}
                            .invoice-box table td {
                                padding: 5px;
                                vertical-align: top;
                            }
                            td.first-col {
                            min-width: 33%;
                            }
                            .invoice-box table tr td.right {text-align: right;}
                            .invoice-box table tr.top table td.title {
                                font-size: 45px;
                                line-height: 45px;
                                color: #333;
                            }
                            .invoice-box table tr.information table td {padding-bottom: 40px;}
                            .invoice-box table tr.heading td {
                                background: #eee;
                                border-bottom: 1px solid #ddd;
                                font-weight: bold;
                            }
                            .invoice-box table tr.details td {padding-bottom: 20px;}
                            .invoice-box table tr.item td{border-bottom: 1px solid #eee;}
                            .invoice-box table tr.item.last td {
                                border-bottom: none;
                                font-weight: bold;
                            }
                            .invoice-box table tr.total td {font-weight: bold;}
                            .invoice-box table tr.total td:nth-child(2) {border-top: 2px solid #eee;}
                            .underline {border-bottom: 1px solid lightgrey;}
                            .underline-dotted {border-bottom: 1px dotted lightgrey;}
                            table.fact-details {
                                border: .5px solid lightgrey;
                                margin-top: 35px;
                            }
                            table.fact-details * {font-size: 12px}
                            td.minw30 {max-width: 30%;}
                            .fleft {
                                float: left;
                                clear: both;
                            }
                            .hidden {display: none;}
                            .txt-center {text-align: center;}
                            .lborder {
                                border-left: 1px solid lightgrey;
                                padding-left: 10px;
                            }
                            .uppercase {text-transform: uppercase !important;}
                            .capitalize {text-transform: capitalize;}
                            .txt-red {color: red;}
                            .mt20{margin-top: 20px;}
                            .mb10{margin-bottom: 10px;}
                            .mb20{margin-bottom:20px;}
                            .m0auto {margin: 0 auto;}
                            table.addr tr td:first-child {
                                border-bottom: 1px solid lightgrey;
                                text-align: right;
                                text-transform: uppercase;
                            }
                            table.addr tr td:nth-child(2) {
                                border-bottom: 1px dotted lightgrey;
                                text-transform: lowercase;
                                word-wrap: break-word;
                            }
                            .txt-underline {text-decoration:underline}
                            .title {font-weight:bold;text-decoration: underline; margin-bottom:15px;}
                            table.top-table {margin-bottom: 50px;}
                        </style>
                    </head>
                    <body>
                    <div class="invoice-box">
                        <table class="toptable">
                            <tr class="top">
                                <td class="p50">
                                    <h1>EATTEST</h1>
                                    <h2 class="mb20">{{#patient}}
                                        <div>{{firstName}} <span class="uppercase">{{lastName}}</span></div>
                                        <div>NISS : {{ssin}}</div>
                                    {{/patient}}</h2>
                                    {{justif}} : {{invoice.invoiceReference}}<br />
                                    {{date}} : {{#formatDate}}{{invoice.invoiceDate}}{{/formatDate}}
                               </td>
                               <td class="p50 txt-center">
                                    <img src="{{jpegUrl}}" alt="barcode" />
                                    <div class="txt-center">{{invoice.thirdPartyReference}}</div>
                                    {{#invoice.printedDate}}
                                        <div class="txt-center"><span class="txt-red">DUPLICATA</span></div>
                                    {{/invoice.printedDate}}
                                </td>
                            </tr>
                        </table>

                        <table>
                            <tr>
                                <td class="p50">
                                    {{#hcp}}
                                        <div class="fleft bold">{{name}}</div>
                                        <div class="fleft title">{{speciality}}</div>
                                        <div class="block-addr">
                                            {{#addresses}}
                                                {{street}} {{houseNumber}} {{#postboxNumber}}b.{{postboxNumber}}{{/postboxNumber}}
                                                {{postalCode}} {{city}}
                                                <table class="addr">
                                                    {{#telecoms}}
                                                        <tr><td>{{telecomType}}</td><td><span class="hidden">:</span> {{telecomNumber}}</td></tr>
                                                    {{/telecoms}}
                                                    {{/addresses}}
                                                    <tr><td>TVA/CBE</td><td><span class="hidden">:</span> {{cbe}}</td></tr>
                                                    <tr><td>IBAN</td><td class="uppercase"><span class="hidden">:</span> {{bankAccount}}</td></tr>
                                                </table>
                                        </div>
                                    {{/hcp}}
                                </td>
                                <td class="lborder">
                                    <div class="title">Coordonnées du patient</div>
                                    {{#patient}}
                                        <div>{{gender}}. {{firstName}} <span class="uppercase">{{lastName}}</span></div>
                                        <div class="block-addr">
                                        {{#addresses}}
                                            {{street}} {{houseNumber}} {{#postboxNumber}}b.{{postboxNumber}}{{/postboxNumber}}
                                            {{postalCode}} {{city}}
                                            <table class="mt20 addr">
                                            {{#telecoms}}
                                                <tr><td>{{telecomType}}</td><td><span class="hidden">:</span> {{telecomNumber}}</td></tr>
                                            {{/telecoms}}
                                            </table>
                                        {{/addresses}}
                                        </div>
                                    {{/patient}}
                                </td>
                            </tr>
                        </table>

                        <table class="fact-details">
                            <tr class="heading">
                                <td class="minw30">{{remboursPrest}}</td>
                                <td class="p12">{{honorPort}}</td>
                                <td class="p12">{{intervMut}}</td>
                                <td class="p12">{{intervMut}}</td>
                                <td class="p12">{{deltaSupp}}</td>
                            </tr>
                            {{#invoice.invoicingCodes}}
                                <tr class="item">
                                    <td class="minw30"> {{unit}} {{code}} : {{label}}</td>
                                    <td class="right">
                                        {{#formatNumber}}{{reimbursement}} + {{patientIntervention}}{{/formatNumber}}
                                    </td>
                                    <td class="right">
                                        {{#formatNumber}}{{reimbursement}}{{/formatNumber}}
                                    </td>
                                    <td class="right">
                                        {{#conventionAmount}}
                                            {{#formatNumber}}{{conventionAmount}}{{/formatNumber}}
                                        {{/conventionAmount}}
                                        {{^conventionAmount}}na{{/conventionAmount}}
                                    </td>
                                    <td class="right">
                                        {{#conventionAmount}}
                                            {{#formatNumber}}{{reimbursement}} + {{patientIntervention}} + {{doctorSupplement}}{{/formatNumber}}
                                        {{/conventionAmount}}
                                        {{^conventionAmount}}na{{/conventionAmount}}
                                    </td>
                                </tr>
                            {{/invoice.invoicingCodes}}
                            <tr class="item bold">
                                <td class="minw30">{{subTot}} :</td>
                                <td class="right">
                                    {{#formatNumber}}{{totalACharge}}{{/formatNumber}}
                                </td>
                                <td class="right">
                                    {{#formatNumber}}{{totalRemb}}{{/formatNumber}}
                                </td>
                                <td class="right">
                                    {{#totalConv}}
                                        {{#formatNumber}}{{totalConv}}{{/formatNumber}}
                                    {{/totalConv}}
                                    {{^totalConv}}na{{/totalConv}}
                                </td>
                                <td class="right">
                                    {{#totalDelta}}
                                        {{#formatNumber}}{{totalDelta}}{{/formatNumber}}
                                    {{/totalDelta}}
                                    {{^totalDelta}}na{{/totalDelta}}
                                </td>
                            </tr>
                            <tr class="item last">
                                <td class="minw30">{{totOne}}</td>
                                <td class="right">
                                    {{#formatNumber}}{{totalSuppl}}{{/formatNumber}}
                                </td>
                                <td></td>
                                <td class="right">
                                    {{#totalConv}}
                                        {{#formatNumber}}{{totalACharge}} - {{totalConv}}{{/formatNumber}}
                                    {{/totalConv}}
                                    {{^totalConv}}na{{/totalConv}}
                                </td>
                                <td class="right">
                                    {{#totalDelta}}
                                        {{#formatNumber}}{{totalDelta}}{{/formatNumber}}
                                    {{/totalDelta}}
                                    {{^totalDelta}}na{{/totalDelta}}
                                </td>
                            </tr>

                            <tr class="total">
                                <td class="minw30">{{totFinal}}</td>
                                <td class="right">
                                    {{#formatNumber}}{{totalACharge}} + {{totalSuppl}}{{/formatNumber}}
                                </td>
                                <td class="right"></td>
                                <td class="right"></td>
                                <td class="right"></td>
                            </tr>
                        </table>
                    </div>
                    </body>
                </html>`;

                this.api.pdfReport(mustache.render(html, template))
                    .then(data =>{
                        let blob = new Blob([data],{type :'application/pdf'});

                        let url = window.URL.createObjectURL(blob)

                        let a = document.createElement("a");
                        document.body.appendChild(a);
                        a.style = "display: none";

                        a.href = url;
                        a.download = invoice.id+moment()+".pdf";
                        a.click();
                        window.URL.revokeObjectURL(url)
                    })
                    .then( rep =>{
                        if(this.selectedInvoice)
                            this.set("selectedInvoice.printedDate",moment().format("YYYYMMDD"))

                        this.api.invoice().modifyInvoice(this.selectedInvoice)
                            .then(invoice => this.api.register(invoice,'invoice'))
                            .then(response => {
                                this.api.tarification().getTarifications(new models.ListOfIdsDto({ids: response.invoicingCodes.map(tar => tar.tarificationId)})).then(nmcls =>
                                    nmcls.map(nmcl =>{
                                        const sn = response.invoicingCodes.find(n => n.tarificationId === nmcl.id) || null
                                        if(sn){
                                            sn.prescriberNeeded = nmcl.needsPrescriber
                                            sn.isRelativePrestation = nmcl.hasRelatedCode
                                        }
                                    })
                                )
                                console.log("saved:",response)
                            })
                    })
            }

            varIsEattestClosedChanged(){
                this.set("isEattestClosed",this.selectedInvoice.sentMediumType==="eattest" && this.selectedInvoice.printedDate)
            }

            _cancelEattest(){
                const url = "https://docs.google.com/forms/d/e/1FAIpQLSfUoc69iwFaTeOteXOaFHEghIv8SHLV5eZwOFRS0FJxVjzObQ/viewform?usp=pp_url&entry.1429469566="+this.hcp.lastName+"&entry.156031164="+this.hcp.firstName+"&entry.1335787920="+this.hcp.nihii+"&entry.1193011163="+this.user.email+"&entry.1773887602="+this.selectedInvoice.invoiceReference
                window.open(url,"cancel");
            }

            _isSelectedInvoiceEattest(){
                return this.selectedInvoice && this.selectedInvoice.sentMediumType && this.selectedInvoice.sentMediumType === 'eattest'
            }

            _isInvoiceClosedOrSelectedInvoiceEattest(){
                return this.selectedInvoice && this.selectedInvoice.sentMediumType &&  this.selectedInvoice.sentMediumType === 'eattest' || this.isInvoiceClosed;

            }

            _getAdressesBookInfo(){
                this.api.fhc().Addressbookcontroller().searchOrgUsingGET(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, '*'+this.searchOrgName+'*',this.locationType[this.selectedInvoice.encounterLocationNorm].location)
                    .then(orgList => this.set('organisationList', orgList))
            }

            searchLocations(e){
                if (this.saveAdressTimeout) {
                    clearTimeout(this.saveAdressTimeout);
                }
                this.getAdresses = () => {
                    if(e.detail.value){
                        this.set("searchOrgName",e.detail.value);
                        this._getAdressesBookInfo();
                    }
                };
                this.saveAdressTimeout = setTimeout(this.getAdresses, 3000);
            }

            setLocation(e){
                console.log("selection :",e.detail.value)
                this.set("selectedInvoice.encounterLocationName",e.detail.value.name)
                const regExp = new RegExp(/\W/,'g')
                this.set("selectedInvoice.encounterLocationNihii",e.detail.value.ehp.replace(regExp,""))
            }

            locationNormChanged(){
                if(!this.isSelected){
                    this.set("selectedInvoice.encounterLocationName","")
                    this.set("selectedInvoice.encounterLocationNihii","")
                }
            }
        }

        customElements.define(HtPatInvoicingDialog.is, HtPatInvoicingDialog)
    </script>
</dom-module>
