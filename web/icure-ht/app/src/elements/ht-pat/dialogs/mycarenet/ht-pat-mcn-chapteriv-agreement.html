<link rel="import" href="../../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">

<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">

<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">


<link rel="import" href="../../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../../../../../bower_components/tk-token-field/tk-token-field.html">

<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="ht-pat-mcn-chapteriv-verse.html">

<dom-module id="ht-pat-mcn-chapteriv-agreement">
    <template>
        <style>
            #dialog {
                min-height: 600px;
                min-width: 800px;
                height: 80%;
                width: 80%;
            }

            .links {
                position: absolute;
                right: 0;
            }

            .pills {
                float: right;
            }

            dynamic-link {
                float: right;
                top: 4px;
            }

            vaadin-combo-box {
                width: 100%;
                height: 72px;
            }

            .container {
                display: grid;
                height: calc(100% - 128px);
                width: calc(100% - 48px);
                grid-template-columns: 25% auto;
                grid-template-rows: 100%;
            }

            .list-panel {
                position: relative;
                height: 100%;
                background: var(--app-background-color-dark);
                box-shadow: var(--shadow-elevation-3dp_-_box-shadow);
                grid-column: 1/2;
                grid-row: 1/1;
                z-index: 3;
                overflow-y: auto;
                margin-top: 0px;
                padding: 8px 24px;
                box-sizing: border-box;
            }

            .detail-panel {
                height: 100%;
                background: var(--app-background-color);
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                margin: 0;
                grid-column: 2/2;
                grid-row: 1/1;
                z-index: 2;
                padding: 8px 24px;
                box-sizing: border-box;
                position: relative;
            }

            .detail-panel div.paragraph-content {
                height: 100%;
                position: relative;
                overflow-y: auto;
                text-align: justify;
            }

            iron-pages {
                height: calc(100% - 256px)
            }

            .chapterDateInfo {
                font-size: 12px;
                display: flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: center;
            }

            .chapterDateInfo span {
                margin-left: 4px;
            }

            .chapterDateInfoIcon {
                height: 14px;
                width: 14px;
            }

            .chapter-text {
                background: transparent;
                flex-direction: column;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
                height: 100%;
                padding: 0;
            }

            .chapter-text:focus::before, .chapter-text:focus::after {
                background: transparent;
            }

            .chapter-text-row p {
                width: 100%;
                text-overflow: ellipsis;
                overflow-x: hidden;
                white-space: nowrap;
            }

            .chapter-text-date {
                justify-content: space-between !important;
                position: relative;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, .1);
                @apply --padding-right-left-16;
                color: var(--app-text-color-disabled);
                height: 24px;
            }

            .chapter--big {
                min-height: 96px;
                /*@apply --padding-16;*/
                /*border-bottom: 1px solid var(--app-background-color-dark);*/
            }

            .chapter--small {
                min-height: 32px;
                /*@apply --padding-right-left-16;*/
                padding-bottom: 8px;
            }

            .chapter--small .chapter-text-row:nth-child(2) {
                justify-content: space-between;
            }

            .chapter--small .chapter-text-row:last-child {
                display: none;
            }

            .chapter--small .he-dots-container {
                display: none;
            }

            .bottom-btn-container {
                width: calc(100% - 48px);
                position: absolute;
                bottom: 6px;
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }

            .bottom-btn {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                background: var(--app-secondary-color);
                color: var(--app-text-color);
                font-weight: bold;
                font-size: 12px;
                height: 40px;
                min-width: 100px;
                @apply --shadow-elevation-2dp;
                padding: 10px 1.2em;
            }

            .message {
                position: absolute;
                width: calc(100% - 320px);
                padding: 8px 24px;
                bottom: 0;
                height: fit-content;
                min-height: 32px;
            }

            .warning {
                color: #c8a100;
            }

            .error {
                color: #ff3139;
            }

            paper-listbox {
                background: transparent;
            }

            .annexes {
                position: absolute;
                top: 16px;
                right: 16px;
            }

            ul {
                list-style: none;
            }

            ul.outer-ul {
                padding-left: 0;
            }

            iron-icon.smaller {
                padding-right: 8px;
                width: 16px;
                height: 16px;
            }

            paper-tabs {
                height: 32px;
                margin-top: -12px;
                background: var(--app-secondary-color);
                --paper-tabs-selection-bar-color: var(--app-text-color-disabled);
                --paper-tabs: {
                    color: var(--app-text-color);
                };
            }

            paper-tab {
                --paper-tab-ink: var(--app-text-color);
            }

            paper-tab.iron-selected {
                font-weight: bold;
            }

            paper-tab.iron-selected iron-icon{
                opacity: 1;
            }

            paper-tab iron-icon{
                opacity: 0.5;
                color: var(--app-text-color);
            }

            .tool-container {
                width: calc(100% - 48px);
                position: absolute;
                bottom: 24px;
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                justify-content: flex-start;
                box-sizing: border-box;
                margin: 0 8px;
            }

            vaadin-date-picker {
                min-width: 132px;
            }

            .tool {
                padding: 0 4px;
                flex-grow: 1;
            }

            tk-token-field.tool {
                min-width: 180px;
                height: 106px;
                flex-grow: 3;
            }

            #appendix-upload-container {
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
                z-index: 1000;
                display: none;
            }

            vaadin-upload{
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
                margin:16px 16px 0;
                min-height:280px;
                background: var(--app-background-color);
                --vaadin-upload-buttons-primary: {
                    padding:16px;
                };
                --vaadin-upload-button-add: {
                    background: var(--app-secondary-color);
                    color:var(--app-text-color);
                };
                --vaadin-upload-file-progress: {
                    --paper-progress-active-color:var(--app-secondary-color);
                };
                --vaadin-upload-file-commands: {
                    color: var(--app-primary-color);
                }

            }

            .close-button-icon{
                position: absolute;
                top: 16px;
                right: 16px;
                margin: 0;
                transform: translate(50%, -50%);
                height: 32px;
                width: 32px;
                padding: 8px;
                background: var(--app-primary-color);
            }

        </style>

        <paper-dialog id="dialog" opened="{{opened}}">
            <h2>[[localize('chap-iv','Chapter IV',language)]]</h2>
            <div class="container">
                <div class="list-panel">
                    <paper-listbox id="_chapter_listbox" focused multi toggle-shift selectable="paper-material" selected="{{selectValue}}">
                        <template is="dom-repeat" items="[[_agreements(medications]]">
                            <paper-material class="layout vertical chapter-item chapter--big" on-tap="_selectInvoice"
                                            id="[[item.id]]">
                                <paper-item class="chapter-text">
                                    <div class="chapter-text-row chapter-text-date">
                                        <label>[[item.chapter]]</label>
                                        <label>[[item.ioDecisionReference]][[item.ioRequestReference]]</label>
                                    </div>
                                    <div class="chapter-text-row grey">
                                        <p>
                                            <template is="dom-repeat" items="[[item.medications]]">
                                                [[item]],
                                            </template>
                                        </p>
                                        <div class="chapterDateInfo">
                                            <iron-icon icon="vaadin:calendar-clock" class="chapterDateInfoIcon"></iron-icon>
                                            <span>[[_formatDate(item.validityDate)]]</span>
                                        </div>
                                    </div>
                                </paper-item>
                            </paper-material>
                        </template>
                    </paper-listbox>
                    <div class="bottom-btn-container">
                        <paper-button class="bottom-btn" on-tap="_loadChapter4">[[localize('load_agr','Load agr.',language)]]</paper-button>
                    </div>
                </div>
                <div class="detail-panel" on-dragover="_onDrag">
                    <vaadin-combo-box id="entities-list" filtered-items="[[searchResults]]" on-filter-changed="_filterChanged" item-label-path="descr"
                                      selected-item="{{selectedParagraph}}" item-value-path="id"
                                      label="[[localize('sea_for_par','Search for paragraph‚ medication‚ pathology...',language)]]"></vaadin-combo-box>
                    <template is="dom-if" if="[[paragraph]]">
                        <paper-tabs selected="{{tabs}}">
                            <paper-tab class="adm-tab">
                                <iron-icon class="smaller" icon="vaadin:clipboard-text"></iron-icon>
                                [[localize('que_form','Query Form',language)]]
                            </paper-tab>
                            <paper-tab class="adm-tab">
                                <iron-icon class="smaller" icon="vaadin:family"></iron-icon>
                                [[localize('agr_res','Agreement response',language)]]
                            </paper-tab>
                        </paper-tabs>

                        <iron-pages selected="[[tabs]]" class="">
                            <page>
                                <div class="paragraph-content">
                                    <h2>[[localize('chapter','Chapter',language)]] [[paragraph.chapterName]], [[localize('paragraph','Paragraph',language)]]
                                        [[paragraph.paragraphName]]</h2>
                                    <template is="dom-if" if="[[annexes.length]]">
                                        <paper-dropdown-menu id="annexes" class="annexes" label="Annexes" on-selected-item-changed="_downloadAnnex">
                                            <paper-listbox slot="dropdown-content" class="dropdown-content">
                                                <template id="annexesDr" is="dom-repeat" items="[[annexes]]">
                                                    <paper-item>
                                                        <template is="dom-if" if="[[_isFrench(language)]]">[[item.descrFr]]</template>
                                                        <template is="dom-if" if="[[_isDutch(language)]]">[[item.descrNl]]</template>
                                                    </paper-item>
                                                </template>
                                            </paper-listbox>
                                        </paper-dropdown-menu>
                                    </template>
                                    <p>
                                        <template is="dom-if" if="[[_isFrench(language)]]">[[paragraph.keyStringFr]]</template>
                                        <template is="dom-if" if="[[_isDutch(language)]]">[[paragraph.keyStringNl]]</template>
                                    </p>
                                    <ul class="outer-ul">
                                        <ht-pat-mcn-chapteriv-verse verse="[[paragraph.headerVerse]]" checked-verses="{{checkedVerses}}"
                                                                    language="[[language]]"></ht-pat-mcn-chapteriv-verse>
                                    </ul>
                                </div>
                            </page>
                            <page>
                                <template is="dom-if" if="[[agreementResponse]]">
                                <template is="dom-if" if="[[agreementResponse.acknowledge]]">
                                    <h3>[[localize('the_req_was_suc', 'The request was successfully transmitted to the IO', language)]]</h3>
                                </template>
                                <template is="dom-if" if="[[agreementResponse.acknowledge]]">
                                    <h3>[[localize('the_req_cou_not', 'The request could not be successfully transmitted to the IO', language)]]</h3>
                                </template>
                                    <template is="dom-if" if="[[agreementResponse.errors.length]]">
                                        <h4>Error(s)</h4>
                                        <template is="dom-repeat" items="[[agreementResponse.errors]]" as="e">
                                            <p class="error">[[localizeObjectKey(e,'msg',language)]] [ code : [[e.code]] ]</p>
                                        </template>
                                    </template>
                                    <template is="dom-if" if="[[agreementResponse.warnings.length]]">
                                        <h4>Warning(s)</h4>
                                        <template is="dom-repeat" items="[[agreementResponse.warnings]]" as="e">
                                            <p class="warning">[[localizeObjectKey(e,'msg',language)]] [ code : [[e.code]] ]</p>
                                        </template>
                                    </template>
                                    <template is="dom-repeat" items="[[agreementResponse.transactions]]" as="t">
                                        <h4>[[localize('agr_res','Agreement response',language)]], [[_formatDateTime(t.timestamp)]]</h4>
                                        <template is="dom-if" if="[[t.isAccepted]]">
                                            <p>[[localize('status','Status',language)]]: [[localize('agreed','Agreement conceded',language)]]</p>
                                        </template>
                                        <template is="dom-if" if="[[t.isIntreatment]]">
                                            <p>[[localize('status','Status',language)]]: [[localize('req_in_tre','Request in treatment',language)]]</p>
                                            <p>[[localize('ref_jus','Justification of refusal',language)]]: [[t.refusalJustification]]</p>
                                        </template>
                                        <template is="dom-if" if="[[_none(t.isAccepted, t.isIntreatment)]]">
                                            <p>[[localize('status','Status',language)]]: [[localize('req_in_tre','Request rejected',language)]]</p>
                                        </template>
                                        <p>[[localize('ref_io','Reference IO',language)]]: [[t.decisionReference]]</p>
                                        <p>[[localize('from','From',language)]]: [[_formatDate(t.start)]]</p>
                                        <p>[[localize('to','to',language)]]: [[_formatDate(t.end)]]</p>
                                        <h4>[[localize('tec_dat','Technical data',language)]]</h4>
                                        <p>[[localize('req_ref_io','Request Reference IO',language)]]: [[t.ioRequestReference]]</p>
                                        <p>[[localize('raw_res','Raw response',language)]]: [[t.responseType]]</p>
                                        <h4>[[localize('medications','Medications',language)]]</h4>
                                        <vaadin-grid id="insurabilities-list" class="material" overflow="bottom" items="[[_mpps(t.paragraph, agreementMpps.*)]]" active-item="{{selectedMedication}}">
                                            <vaadin-grid-column>
                                                <template class="header">
                                                    <vaadin-grid-sorter path="mut">[[localize('medication','Medication',language)]]</vaadin-grid-sorter>
                                                </template>
                                                <template>
                                                    <div class="cell frozen">[[item.name]])</div>
                                                </template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column>
                                                <template class="header">
                                                    <vaadin-grid-sorter path="periodStart">[[localize('selected','Selected',language)]]</vaadin-grid-sorter>
                                                </template>
                                                <template>
                                                    <div class="cell frozen"><vaadincheckbox checked="{{item.selected}}"></vaadincheckbox></div>
                                                </template>
                                            </vaadin-grid-column>
                                        </vaadin-grid>
                                    </template>
                                    <h4>[[localize('tec_dat','Technical data',language)]]</h4>
                                    <p>commonInput: [[agreementResponse.commonOutput.commonInput]]</p>
                                    <p>nipReference: [[agreementResponse.commonOutput.nipReference]]</p>
                                    <p>commonOutput: [[agreementResponse.commonOutput.commonOutput]]</p>
                                </template>
                            </page>
                        </iron-pages>
                        <div class="tool-container">
                            <vaadin-date-picker class="tool" i18n="[[i18n]]" initial-position="[[initialFrom]]" label="[[localize('From','From',language)]]" value="{{fromAsString}}"></vaadin-date-picker>
                            <vaadin-date-picker class="tool" i18n="[[i18n]]" initial-position="[[initialTo]]" label="[[localize('To','To',language)]]" value="{{toAsString}}"></vaadin-date-picker>
                            <tk-token-field class="tool" label="Appendices" value="{{appendicesTokens}}" on-value-splices-change="_localizedValueChanged" data-value-path="id" data-label-path="descr" always-float-label></tk-token-field>
                            <vaadin-checkbox class="tool" checked="{{incomplete}}">[[localize('incomplete request', 'incomplete request', language)]]</vaadin-checkbox>
                        </div>
                        <div class="bottom-btn-container">
                            <paper-button class="bottom-btn" on-tap="_requestChapter4">[[localize('req_agr','Request agreement',language)]]</paper-button>
                        </div>
                    </template>
                    <div id="appendix-upload-container">
                        <vaadin-upload id="appendix-upload" no-auto files="{{appendices}}" accept="image/jpeg,application/pdf" target="[[api.host]]/document/{documentId}/attachment/multipart" method="PUT" form-data-name="attachment" on-upload-success="_fileUploaded"></vaadin-upload>
                        <paper-fab class="close-button-icon" icon="icons:close" on-tap="_hideUpload"></paper-fab>
                    </div>
                </div>
            </div>
            <div class="message">
                <div class="warning">[[warnings]]</div>
                <div class="error">[[errors]]</div>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" dialog-dismiss>[[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>

    </template>
    <script>
        import moment from 'moment/src/moment'

        class HtPatMcnChapterIVAgreement extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-mcn-chapteriv-agreement'
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                    appendices: {
                        type: Array,
                        value: () => []
                    },
                    appendicesTokens: {
                        type: Array,
                        value: () => []
                    },
                    medications: {
                        type: Array,
                        value: () => []
                    },
                    errors: {
                        type: String,
                        value: null
                    },
                    warnings: {
                        type: String,
                        value: null
                    },
                    opened: {
                        type: Boolean,
                        value: false
                    },
                    paragraph: {
                        type: Object,
                        value: () => null
                    },
                    searchResults: {
                        type: Array,
                        value: () => []
                    },
                    selectedParagraph: {
                        type: Object,
                        observer: "_selectedParagraphChanged"
                    },
                    medications: {
                        type: Object,
                        observer: "_selectedParagraphChanged"
                    },
                    tabs: {
                        type: Number,
                        value: 0
                    },
                    initialFrom: {
                        type: String,
                        value: () => moment().startOf('month').format('YYYY-MM-DD')
                    },
                    initialTo: {
                        type: String,
                        value: () => moment().endOf('month').format('YYYY-MM-DD')
                    },
                    fromAsString: {
                        type: String,
                        value: () => moment().startOf('month').format('YYYY-MM-DD')
                    },
                    toAsString: {
                        type: String
                    }

                }
            }

            static get observers() {
                return ['apiReady(api,user,opened)', '_appendicesChanged(appendices.*)', '_appendicesTokenChanged(appendicesToken.*)']
            }

            ready() {
                super.ready()
                this.addEventListener('iron-resize', () => this.onWidthChange())
            }

            apiReady() {
                if (!this.api || !this.user || !this.user.id || !this.opened) return

                try {
                    this.set('plannedAction.HcpId', this.user.healthcarePartyId)
                    this.api.cacheRowsUsingPagination(
                        'CD-HCPARTY-pers',
                        (key, docId) =>
                            this.api.code().findPaginatedCodesByLabel('be', 'CD-HCPARTY', 'fr', 'pers', key && JSON.stringify(key), docId, 100)
                                .then(pl => ({
                                    rows: pl.rows,
                                    nextKey: pl.nextKeyPair && pl.nextKeyPair.startKey,
                                    nextDocId: pl.nextKeyPair && pl.nextKeyPair.startKeyDocId,
                                    done: !pl.nextKeyPair
                                }))
                    ).then(rows => {
                        this.set('hcpartyTypeList', _.orderBy(rows, ['label.fr'], ['asc']))
                        this.set('plannedAction.ProfessionId', this.professionId)
                    })
                } catch (e) {
                    console.log(e)
                }
            }

            attached() {
                super.attached()
                this.async(this.notifyResize, 1)
            }

            _filterChanged(text) {
                if (text.detail && text.detail.value && text.detail.value.length > 2) {
                    const searchString = text.detail.value
                    this.latestSearchString = searchString
                    setTimeout(() => {
                        if (this.latestSearchString !== searchString) {
                            return
                        }
                        this.api.fhc().Chaptercontroller().findParagraphsUsingGET(searchString, this.language).then((paragraphs) => {
                            if (searchString === this.latestSearchString) {
                                this.set('searchResults', paragraphs.map(p => ({id: `${p.paragraphName}/${p.paragraphVersion}`, descr: `${p.paragraphName} - ${p.keyStringFr}`})))
                            }
                        })
                    }, 600)
                } else {
                    this.set('searchResults', [])
                }
            }

            _selectedParagraphChanged() {
                if (this.selectedParagraph && this.selectedParagraph.id) {
                    const paragraph = this.selectedParagraph.id.split('/')[0]
                    this.api.fhc().Chaptercontroller().getParagraphInfosUsingGET('IV', paragraph)
                        .then(pi => {
                            this.set('paragraph', pi)
                            return this.api.fhc().Chaptercontroller().getAddedDocumentsUsingGET('IV', paragraph)
                        })
                        .then(annexes => {
                            console.log(annexes)
                            this.set('annexes', annexes)
                        })

                } else {
                    this.set('paragraph', null)
                }
            }


            onWidthChange() {
                const offsetWidth = this.$.dialog.offsetWidth
                const offsetHeight = this.$.dialog.offsetHeight
                if (!offsetWidth || !offsetHeight) {
                    return
                }
            }

            close() {
                this.set('opened', false)
            }

            open() {
                this.set('opened', true)
            }

            _none(a,b,c) {
                return !a && !b && !c
            }

            _formatDate(d) {
                return this.api.moment(d).format('DD/MM/YYYY')
            }

            _formatDateTime(d) {
                return this.api.moment(d).format('DD/MM/YYYY HH:mm:ss')
            }

            _isFrench(language) {
                return this.language === 'fr'
            }

            _isDutch(language) {
                return this.language === 'nl'
            }

            _agreements(medications) {
                return medications && medications.filter(svc => Object.values(svc.content).some(c => c.medicationValue.options.ioChapter4Paragraph)).map(x=>x)
            }

            _mpps(p) {
                const mpps = this.agreementMpps.find(mpps=>mpps.paragraph===p)
                return mpps && mpps.mpps
            }

            _loadChapter4() {
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp =>
                    this.api.fhc().Chaptercontroller().agreementRequestsConsultationUsingGET(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                        hcp.nihii, hcp.ssin, hcp.firstName, hcp.lastName,
                        this.patient.ssin, this.patient.dateOfBirth, this.patient.firstName, this.patient.lastName, this.patient.gender, null, null, +moment().subtract(6, 'months'))
                ).then(agreements => {
                        if (agreements.warnings.length) {
                            this.set('warnings', agreements.warnings.map(w => w.msgFr).join(', '))
                        }
                        if (agreements.errors.length) {
                            this.set('errors', agreements.errors.map(w => w.msgFr).join(', '))
                        }
                        console.log(agreements)
                    }
                )
            }

            _requestChapter4() {
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp =>
                    this.api.fhc().Chaptercontroller().requestAgreementUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                        hcp.nihii, hcp.ssin, hcp.firstName, hcp.lastName,
                        this.patient.ssin, this.patient.dateOfBirth, this.patient.firstName, this.patient.lastName, this.patient.gender,
                        "newrequest", this.paragraph.paragraphVersion, this.paragraph.paragraphName,
                        this.checkedVerses.join(','), this.appendices, this.incomplete, this.startDate)
                ).then(res => {
                    this.set('agreementResponse',res)
                    this.set('tabs',1)

                    return Promise.all((res.transactions||[]).map(t => this.api.fhc().Chaptercontroller().getMppsForParagraphUsingGET('IV', t.paragraph).then(it => ({paragraph: t.paragraph, mpps: it})))).then( links =>
                        this.set('agreementMpps', links)
                    )
                })
            }

            _downloadAnnex(e) {
                if (e && e.detail && e.detail.value) {
                    const tpl = this.root.querySelector('#annexesDr').modelForElement(e.detail.value)
                    if (tpl.item.addressUrl) {
                        var url = tpl.item.addressUrl.replace('@lng@', this.language)
                        var a = document.createElement('a')
                        a.href = url
                        a.target = "_blank"
                        a.download = `${tpl.item.descrFr}.pdf`
                        document.body.appendChild(a) // we need to append the element to the dom -> otherwise it will not work in firefox
                        a.click()
                        a.remove()  //afterwards we remove the element again
                    }
                }
                this.root.querySelector('#annexes').set('value', null)
            }

            _appendicesTokenChanged() {
                const files = _.clone(this.appendices);
                files.forEach(f =>  { if (!this.appendicesTokens.map(x=>x && x.id).includes(f.doc.id)) { this.splice('appendices', this.appendices.indexOf(f), 1)}})
            }

            _appendicesChanged() {
                const files = _.clone(this.appendices);
                const vaadinUpload = this.$['appendix-upload'];

                Promise.all(files.filter(f => !f.attached).map(f => {
                    f.attached = true;
                    return this.api.document().newInstance(this.user, null, { documentType: 'result', mainUti: this.api.document().uti(f.type), name: f.name }).then(d => this.api.document().createDocument(d)).then(d => {
                        f.doc = d;
                        f.uploadTarget = (f.uploadTarget || vaadinUpload.target).replace(/\{documentId\}/, d.id);
                        return f;
                    });
                })).then(files => {
                    if (files.length) {
                        vaadinUpload.uploadFiles(files)
                        files.forEach(f => this.appendicesTokens.map(x=>x && x.id).includes(f.doc.id) || this.push('appendicesTokens', {descr:f.name.replace(/^(.{5})...+(.{5})$/,'$1…$2'), id:f.doc.id}))
                    }
                });
            }

            _hideUpload() {
                this.$['appendix-upload-container'].style.display = 'none'
            }

            _onDrag() {
                this.$['appendix-upload-container'].style.display = 'block'
            }
        }

        customElements.define(HtPatMcnChapterIVAgreement.is, HtPatMcnChapterIVAgreement)
    </script>
</dom-module>

