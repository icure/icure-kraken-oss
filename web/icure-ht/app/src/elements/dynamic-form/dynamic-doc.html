<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../pdf-element/pdf-element.html">
<link rel="import" href="../ht-spinner/ht-spinner.html">

<dom-module id="dynamic-doc">
	<template>
		<style>
			ht-spinner.center  {
				position: absolute;
				left: calc(50% - 14px);
				top: calc(50% - 14px);
				height: 42px;
				width: 42px;
			}

			paper-card.subform-card {
				min-height: 16px;
				padding: 0 0 8px 0;
				box-shadow: none;
				border-bottom: 1px solid lightgrey;
				margin:0;
				width:100%;
				background:transparent;
			}

			.pat-details-card > .card-content {
				padding: 16px 16px 32px !important;
			}

			.pat-details-card {
				margin: 0 32px 32px;
				padding:0 8px 8px;
				overflow: hidden;
                width: calc(100% - 64px);
			}

			.horizontal {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				flex-basis: 100%;
			}

			.edit-pat-details-btn{
				position:absolute;
				left:50%;
				transform: translate(-50%,0);
				bottom:-20px;
				background: var(--app-secondary-color);
				border-radius:50%;
				@apply --shadow-elevation-4dp;
			}

			.justified {
				justify-content: space-between;
			}

			span{
				color:var(--app-primary-color);
				border-top: 2px solid rgba(231,231,231,1);
				border-radius: 2px 2px 0 0;
				background:rgba(0,0,0,0.1);
				font-size:12px;
				margin:0 0 8px -8px;
				padding:2px 24px;
				display:inline-block;
				width:calc(100% - 32px);
				text-align:left;
                word-break: break-word;
			}

			pdf-element {
				width: 100%;
				margin: auto;
			}
			.img-container{
				width:100%;
				height:100%;
				display:flex;
				justify-content: center;
				align-items: center;
				max-height:400px;
				overflow: hidden;
			}

			img{
				max-width:100%;
				align-self: center;
			}

            .txt-container {
                width: 100%;
                margin: 0;
                min-height: 64px;
                padding: 0;
                box-shadow: none;
                background: 0 0;
                overflow: auto;
            }

            .hoverpointer {
                cursor: pointer;
                text-align: center;
            }

		</style>
        <template is="dom-if" if="[[!_plainMimeType(document.mainUti, document.otherUtis.*, dataUrl)]]">
            <paper-card class="pat-details-card">
                <template is="dom-if" if="[[!_unknownMimeType(document.mainUti, document.otherUtis.*, dataUrl)]]">
                    <template is="dom-if" if="[[!documentId]]">
                        <ht-spinner class="center" active></ht-spinner>
                    </template>
                    <template is="dom-if" if="[[_imageMimeType(document.mainUti, document.otherUtis.*, dataUrl)]]">
                        <span>[[document.name]]</span>
                        <template is="dom-if" if="[[downloadable]]">
                            <div class="hoverpointer" on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]'>
                                [[localize('dl','Download',language)]] <paper-icon-button icon="file-download"></paper-icon-button>
                            </div>
                        </template>
                        <div class="img-container">
                            <img src$="[[dataUrl]]">
                        </div>
                    </template>
                    <template is="dom-if" if="[[_pdfMimeType(document.mainUti, document.otherUtis.*, dataUrl)]]">
                        <span>[[document.name]]</span>
                        <pdf-element src="[[dataUrl]]" elevation="5" downloadable fit-width fit-height enable-text-selection></pdf-element>
                    </template>
                    <template is="dom-if" if="[[_xmlMimeType(document.mainUti, document.otherUtis.*, dataUrl)]]">
                        <span>[[document.name]]</span>
                        <template is="dom-if" if="[[downloadable]]">
                            <div class="hoverpointer" on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]'>
                                [[localize('dl','Download',language)]] <paper-icon-button icon="file-download"></paper-icon-button>
                            </div>
                        </template>
                    </template>
                </template>
                <template is="dom-if" if="[[_unknownMimeType(document.mainUti, document.otherUtis.*, dataUrl)]]">
                    <span>[[document.name]]</span>
                    <template is="dom-if" if="[[downloadable]]">
                        <div class="hoverpointer" on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]'>
                            [[localize('dl','Download',language)]] <paper-icon-button icon="file-download"></paper-icon-button>
                        </div>
                    </template>
                </template>
            </paper-card>
        </template>

        <template is="dom-if" if="[[_plainMimeType(document.mainUti, document.otherUtis.*)]]">
            <template is="dom-if" if="[[downloadable]]">
                <paper-card class="pat-details-card">
                    <span>[[document.name]]</span>
                    <template is="dom-if" if="[[preview]]">
                        <pre class="txt-container">[[attachmentContent]]</pre>
                    </template>
                    <div class="hoverpointer" on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]'>
                        [[localize('dl','Download',language)]] <paper-icon-button icon="file-download"></paper-icon-button>
                    </div>
                </paper-card>
            </template>
            <template is="dom-if" if="[[mailbody]]">
                <div class="txt-container">[[attachmentContent]]</div>
            </template>
        </template>
	</template>

	<script>
        import XML from 'parse-xml/dist/parse-xml';
class DynamicDoc extends Polymer.TkLocalizerMixin(Polymer.Element) {
	static get is() {
		return 'dynamic-doc';
	}

	static get properties() {
		return {
			api: {
				type: Object
			},
			user: {
				type: Object
			},
            documentId: {
				type: String,
				value: null
			},
            downloadable:{
			    type: Boolean
            },
            mailbody:{
			    type: Boolean
            },
            preview:{
                type: Boolean,
                value: false,
            },
			document: {
				type: Object,
				value: null
			},
            documentAttachment:{
			    type: String,
                value: null
			},
			dataUrl: {
				type: String,
				value: null
			},
			title: {
				type: String,
				value: null
			},
			showDetail:{
			    type: Boolean,
				value: false
			},
			type:{
			    type: String,
				value: null
			},
            patient:{
			    type: Object,
				value: null
			}
		};
	}

    static get observers() {
        return ['_documentIdChanged(documentId, api, user)','_dataUrlChanged(dataUrl)']
    }

    constructor() {
		super();
	}

	_documentIdChanged() {
		if (!this.documentId || !this.api || !this.user) {
			return;
		}
		const docId = this.documentId;
		this.api.document().getDocument(docId).then(doc => {
			this.set('document', doc);
			if (doc.delegations && Object.keys(doc.delegations).length) {
				this.api.crypto().decryptAndImportAesHcPartyKeysInDelegations(this.user.healthcarePartyId, doc.encryptionKeys && Object.keys(doc.encryptionKeys).length ? doc.encryptionKeys : doc.delegations).then(function (decryptedAndImportedAesHcPartyKeys) {
					var collatedAesKeys = {};
					decryptedAndImportedAesHcPartyKeys.forEach(k => collatedAesKeys[k.delegatorId] = k.key);
					return this.api.crypto().decryptDelegationsSFKs((doc.encryptionKeys && Object.keys(doc.encryptionKeys).length ? doc.encryptionKeys : doc.delegations)[this.user.healthcarePartyId], collatedAesKeys, doc.id).then(enckeys => {
                        const url = doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, enckeys, this.api.sessionId);
                        console.log('url is', url);
                        this.set('dataUrl', url);
					});
				}.bind(this)).catch(() => {
					const url = doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, undefined, this.api.sessionId);
					console.log('url is', url);
					this.set('dataUrl', url);
				});
			} else {
				const url = doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, undefined, this.api.sessionId);
				console.log('url is', url);
				this.set('dataUrl', url);
			}
		});
	}

    _downloadAnnex(e){
        let url = this.dataUrl;

        // const type = this._imageMimeType(this.document.mainUti, this.document.otherUtis, url) ? 'png' :
        //     this._pdfMimeType(this.document.mainUti, this.document.otherUtis, url) ? 'pdf' :
        //     this._xmlMimeType(this.document.mainUti, this.document.otherUtis) ? 'xml' :
        //     'txt'

        let a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";

        a.href = url;
        a.download = this.document.name;

        a.click();
        window.URL.revokeObjectURL(url);

    }

	_imageMimeType(uti, utis, dataUrl) {
		return dataUrl && (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m && (m.startsWith('image/') || m === 'public/jpeg'));
	}

	_pdfMimeType(uti, utis, dataUrl) {
		return dataUrl && (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m === 'application/pdf');
	}

    _xmlMimeType(uti, utis) {
        return (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m === 'text/xml' || m === 'application/xml');
    }

    _plainMimeType(uti, utis) {
        return (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m === 'text/plain');
    }

    _unknownMimeType(uti, utis, dataUrl) {
        return (!this._imageMimeType(uti, utis, dataUrl) && !this._pdfMimeType(uti, utis, dataUrl) && !this._xmlMimeType(uti, utis) && !this._plainMimeType(uti, utis))
    }

    _dataUrlChanged(dataUrl) {
        if (dataUrl && dataUrl.length) {
            if (this._imageMimeType(this.document.mainUti, this.document.otherUtis)) {
                fetch(dataUrl,{credentials:'include'})
                    .then(response => response.text())
                    .then(img => this.set('attachmentContent', img))
            }
            if (this._pdfMimeType(this.document.mainUti, this.document.otherUtis)) {
                fetch(dataUrl,{credentials:'include'})
                    .then(response => response.text())
                    .then(pdf => this.set('attachmentContent', pdf))
            }
            if (this._xmlMimeType(this.document.mainUti, this.document.otherUtis)) {
                fetch(dataUrl,{credentials:'include'})
                    .then(response => response.text())
                    .then(xml => this.set('attachmentContent', xml.toString()))
            }
            if (this._plainMimeType(this.document.mainUti, this.document.otherUtis)) {
                fetch(dataUrl,{credentials:'include'})
                    .then(response => response.text())
                    .then(text => this.set('attachmentContent', text))
            }
        }
	}
    mimeType(u){
	    return this.api.document().mimeType(u)
	}

	_base64(data) {
		return base64js.fromByteArray(data);
	}

    _getAttachment(){
        this.showDetail = !this.showDetail
	}

}

customElements.define(DynamicDoc.is, DynamicDoc);
</script>
</dom-module>
