<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../dialog-style.html">
<link rel="import" href="../../../atc-styles.html">

<dom-module id="medication-plan-dialog">
    <template>
        <style include="dialog-style atc-styles">
            paper-dialog {
                width: 90%;
                height: 80%;
            }

            .modal-title {
                padding: 0 24px;
                display: flex;
                flex-flow: row wrap;
                justify-content: space-between;
                align-items: center;
            }

            paper-tabs {
                width: 50%;
                max-width: 400px;
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                /* margin: 0 auto; */
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color);
            }

            .patient {
                height: calc(100% - 48px - 48px);
                overflow-y: auto;
                margin-top: 0;
                padding: 24px;
                box-sizing: border-box;
            }

            .table-container {
                margin-bottom: 24px;
            }

            .header {
                background: linear-gradient(to right, var(--app-secondary-color), var(--app-secondary-color-dark));
                color: var(--app-text-color-light);
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                height: 40px;
                width: 100%;
                padding: 0 12px;
                box-sizing: border-box;
            }

            .header h3 {
                font-size: 14;
                font-weight: 400;
                margin: 0;
            }

            .header iron-icon {
                height: 20px;
                width: 20px;
                margin-right: 4px;
            }

            .table-header {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--app-background-color-dark);
                font-size: 11px;
                color: var(--app-text-color-disabled);
                height: 28px;
            }

            .col {
                height: 100%;
                padding: 0 4px;
                box-sizing: border-box;
                display: flex;
                flex-flow: row wrap;
                justify-content: center;
                align-items: center;
            }

            .col--med {
                width: 30%;
                justify-content: flex-start;
            }

            .med--name {
                font-weight: 500;
                margin-right: 4px;
            }

            .col--photo {
                max-width: 56px;
                min-width: 56px;
                text-align: center;
                flex-grow: 1;
            }

            .col--bef, .col--dur, .col--aft {
                max-width: 56px;
                min-width: 56px;
                text-align: center;
                flex-grow: 1;
            }

            .dur-pill {
                background: var(--app-secondary-color);
                color: var(--app-text-color-light);
                font-weight: 500;
                border-radius: 50%;
                padding: 4px;
                display: block;
                height: 12px;
                width: 12px;
                line-height: 1.1;
                text-align: center;
            }

            .col--ed, .col--freq {
                text-align: center;
                width: 12%;
            }

            .col--com {
                width: 40%;
                justify-content: flex-start;
            }

            .table-row {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                font-size: 12px;
                color: var(--app-text-color);
                height: 40px;
            }

            .table-row:nth-child(even) {
                background: var(--app-background-color-light);
            }

            .table-row .col:not(:last-child) {
                border-right: 1px solid var(--app-background-color-dark);
            }

            .general-infos {
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                margin-bottom: 24px;
                background: var(--app-background-color-dark);
                padding: 12px;
                border-radius: 4px;
            }

            .infos-block {
                font-size: 14px;
                font-weight: 400;
                color: var(--app-text-color);
                margin-right: 24px;
            }

            .infos-block span {
                background: var(--app-background-color-light);
                border-radius: 12px;
                font-weight: 500;
                padding: 1px 8px;
                margin-right: 8px;
            }

            /* PRESENT */

            .table {
                display: flex;
                flex-flow: column nowrap;
                font-size: .8rem;
                margin: 0.5rem;
                line-height: 1.5;
                flex: 1 1 auto;
            }

            .th {
                display: none;
                font-weight: 700;
                background-color: var(--app-background-color-light);
            }

            .th > .td {
                white-space: nowrap;
                text-overflow: ellipsis;
                justify-content: center;
            }

            .th .td {
                color: var(--app-text-color);
            }

            .tr {
                position: relative;
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                color: var(--app-text-color);
                z-index: 1;
                height: 24px;
            }

            .tr:not(.category):not(.th):not(.old) .td {
                color: var(--app-text-color-light);
            }

            .tr:not(.th):not(.category)::after {
                display: block;
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                z-index: 0;
            }

            .tr:not(.td):nth-child(odd)::after {
                opacity: 0.6;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .tr:not(.td):nth-child(even)::after {
                opacity: 0.8;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .tr:not(.td):hover::after {
                opacity: 1;
            }

            .tr.old {
                color: var(--app-text-color-disabled);
            }

            .tr.old::after {
                background: var(--app-background-color-light) !important;
            }

            .tr:not(.category) {
                color: var(--app-text-color-white);
            }

            .tr:nth-of-type(even) {
                background-color: var(--app-background-color-light);
            }

            .td {
                position: relative;
                display: flex;
                flex-flow: row nowrap;
                align-items: center;
                justify-content: center;
                flex-grow: 1;
                flex-basis: 0;
                padding: 0.5em;
                overflow: hidden;
                min-width: 0px;
                z-index: 2;
                word-break: break-word;
                white-space: nowrap;
                text-overflow: ellipsis;
                border-right: 1px solid var(--app-background-color-dark);
                font-size: 13px;
            }

            .td--comments, .td--medicine, .td--category {
                justify-content: flex-start;
            }

            .td--category iron-icon {
                height: 14px;
                width: 14px;
                margin-right: 4px;
            }

            .th .td {
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .span-3 {
                padding: 6px 19px; /* 19px because we had the padding of the missings .td padding + their borders */
            }

            .category {
                border-bottom: 1px solid #d0d0d0;
            }

            .reimbursed iron-icon {
                height: 14px;
                width: 14px;
                padding: 2px;
                border-radius: 50%;
                box-shadow: 0 0 0 rgba(0, 0, 0, .2);
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
                background-color: var(--app-text-color-light);

            }

            .reimbursed iron-icon:hover {
                height: 16px;
                width: 16px;
                box-shadow: 0 0 4px rgba(0, 0, 0, .2);
            }

            .reimbursed iron-icon.ok {
                color: var(--app-status-color-ok)
            }

            .reimbursed iron-icon.nok {
                color: var(--app-status-color-nok)
            }

            .reimbursed iron-icon.pending {
                color: var(--app-status-color-pending)
            }

            .add-period-btn {
                height: 16px;
                width: 16px;
                padding: 0;
                color: var(--app-text-color);
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .add-period-btn:hover {
                height: 18px;
                width: 18px;
                color: var(--app-secondary-color);
            }

        </style>

        <paper-dialog id="medication-plan" always-on-top="true" no-cancel-on-outside-click="true">

            <h2 class="modal-title">[[localize('med_plan','Medication plan',language)]]

                <paper-tabs selected="{{selectedTab}}">
                    <paper-tab>History</paper-tab>
                    <paper-tab>Present</paper-tab>
                    <paper-tab>Patient</paper-tab>
                </paper-tabs>
            </h2>


            <template is="dom-if" if="{{_isEqual(selectedTab,0)}}">
                <div class="history">
                    <h2>History</h2>
                </div>
            </template>

            <template is="dom-if" if="{{_isEqual(selectedTab,1)}}">
                <div class="present">
                    <div class="table">
                        <div class="tr th">
                            <div class="td">

                            </div>
                            <div class="td"
                                 style="flex-grow: 3;">

                            </div>
                            <div class="td" style="flex-grow: 2;">

                            </div>
                            <div class="td span-3" style="flex-grow: 3;">
                                Breakfast
                            </div>
                            <div class="td span-3" style="flex-grow: 3;">
                                Lunch
                            </div>
                            <div class="td span-3" style="flex-grow: 3;">
                                Dinner
                            </div>
                            <div class="td" style="flex-grow: 2;">

                            </div>
                            <div class="td" style="flex-grow: 4;">

                            </div>
                        </div>
                        <div class="tr th">
                            <div class="td">

                            </div>
                            <div class="td td--medicine"
                                 style="flex-grow: 3; justify-content: flex-start">
                                Medicine
                            </div>
                            <div class="td" style="flex-grow: 2;">
                                Frequency
                            </div>
                            <div class="td bf-bef">
                                Before
                            </div>
                            <div class="td bf-dur">
                                During
                            </div>
                            <div class="td bf-aft">
                                After
                            </div>
                            <div class="td lu-bef">
                                Before
                            </div>
                            <div class="td lu-dur">
                                During
                            </div>
                            <div class="td lu-aft">
                                After
                            </div>
                            <div class="td di-bef">
                                Before
                            </div>
                            <div class="td di-dur">
                                During
                            </div>
                            <div class="td di-aft">
                                After
                            </div>
                            <div class="td" style="flex-grow: 2;">
                                End Date
                            </div>
                            <div class="td td-comments" style="flex-grow: 4; justify-content: space-between;">
                                Comments
                                <paper-icon-button class="add-period-btn" on-tap="" icon="add-circle"></paper-icon-button>
                            </div>
                        </div>
                        <!-- END HEADER -->
                        <!-- START BODY -->
                        <template is="dom-repeat" items="[[medicationClassesWithPosology]]" as="medicationsWithPosology">
                            <div class="tr category">
                                <div class="td"></div>
                                <div class="td td--category" style="flex-grow: 3;">
                                    <iron-icon icon="history"></iron-icon>
                                    <b>[[_localizedTitle(medicationsWithPosology)]]</b>
                                </div>
                                <div class="td" style="flex-grow: 2;"></div>
                                <div class="td"></div>
                                <div class="td"></div>
                                <div class="td"></div>
                                <div class="td"></div>
                                <div class="td"></div>
                                <div class="td"></div>
                                <div class="td"></div>
                                <div class="td"></div>
                                <div class="td"></div>
                                <div class="td" style="flex-grow: 2;"></div>
                                <div class="td" style="flex-grow: 4;"></div>
                            </div>
                            <template is="dom-repeat" items="[[medicationsWithPosology.meds]]" as="m">
                            <div class$="tr [[_medicationClass(m.medication)]]">
                                <div class$="td reimbursed">
                                    <iron-icon id="reimbursedStatus" icon="icons:euro-symbol" class$="[[_hasValidChap4Class(m.medication)]]"></iron-icon>
                                    <paper-tooltip for="reimbursedStatus">[[_chap4Status(m.medication)]]</paper-tooltip>
                                </div>
                                <div class="td td--medicine" style="flex-grow: 3;">
                                    <span>[[_serviceDescription(m.medication)]]</span>
                                </div>
                                <div class="td" style="flex-grow: 2;"><span>[[_servicePosology(m.medication)]]</span></div>
                                <template is="dom-repeat" items="[[m.regimenTable.0]]" as="regimen">
                                    <div class="td bf-bef">[[regimen.administratedQuantity.quantity]]</div>
                                </template>
                                <div class="td bf-bef">[[m.regimenTable.1.0.administratedQuantity.quantity]]</div>
                                <div class="td bf-dur">[[m.regimenTable.2.0.administratedQuantity.quantity]]</div>
                                <div class="td bf-aft">[[m.regimenTable.3.0.administratedQuantity.quantity]]</div>
                                <template is="dom-repeat" items="[[m.regimenTable.4]]" as="regimen">
                                    <div class="td bf-bef">[[regimen.administratedQuantity.quantity]]</div>
                                </template>
                                <div class="td lu-bef">[[m.regimenTable.5.0.administratedQuantity.quantity]]</div>
                                <div class="td lu-dur">[[m.regimenTable.6.0.administratedQuantity.quantity]]</div>
                                <div class="td lu-aft">[[m.regimenTable.7.0.administratedQuantity.quantity]]</div>
                                <template is="dom-repeat" items="[[m.regimenTable.8]]" as="regimen">
                                    <div class="td bf-bef">[[regimen.administratedQuantity.quantity]]</div>
                                </template>
                                <div class="td di-bef">[[m.regimenTable.9.0.administratedQuantity.quantity]]</div>
                                <div class="td di-dur">[[m.regimenTable.10.0.administratedQuantity.quantity]]</div>
                                <div class="td di-aft">[[m.regimenTable.11.0.administratedQuantity.quantity]]</div>
                                <template is="dom-repeat" items="[[m.regimenTable.12]]" as="regimen">
                                    <div class="td bf-bef">[[regimen.administratedQuantity.quantity]]</div>
                                </template>
                                <div class="td" style="flex-grow: 2;">10/02/2019</div>
                                <div class="td td--comments" style="flex-grow: 4;"></div>
                            </div>
                        </template>
                        </template>

                        <div class="tr ICD-10--XII-bg">
                            <div class="td reimbursed">
                                <iron-icon id="reimbursedStatus" icon="icons:euro-symbol" class="ok"></iron-icon>
                                <paper-tooltip for="reimbursedStatus">reimbursed</paper-tooltip>
                            </div>
                            <div class="td td--medicine" style="flex-grow: 3;">
                                <span>Amlor 200mg</span>
                            </div>
                            <div class="td" style="flex-grow: 2;"><span>2x/d</span></div>
                            <div class="td bf-bef">1</div>
                            <div class="td bf-dur"></div>
                            <div class="td bf-aft"></div>
                            <div class="td lu-bef"></div>
                            <div class="td lu-dur"></div>
                            <div class="td lu-aft"></div>
                            <div class="td di-bef">1</div>
                            <div class="td di-dur"></div>
                            <div class="td di-aft"></div>
                            <div class="td" style="flex-grow: 2;">10/02/2019</div>
                            <div class="td td--comments" style="flex-grow: 4;"></div>
                        </div>
                        <div class="tr category">
                            <div class="td"></div>
                            <div class="td td--category" style="flex-grow: 3;">
                                <iron-icon icon="history"></iron-icon>
                                <b>Anti-douleurs</b>
                            </div>
                            <div class="td" style="flex-grow: 2;"></div>
                            <div class="td"></div>
                            <div class="td"></div>
                            <div class="td"></div>
                            <div class="td"></div>
                            <div class="td"></div>
                            <div class="td"></div>
                            <div class="td"></div>
                            <div class="td"></div>
                            <div class="td"></div>
                            <div class="td" style="flex-grow: 2;"></div>
                            <div class="td td--comments" style="flex-grow: 4;"></div>
                        </div>
                        <div class="tr ICD-10--XI-bg">
                            <div class="td reimbursed">
                                <iron-icon icon="icons:euro-symbol" class="nok"></iron-icon>
                            </div>
                            <div class="td td--medicine" style="flex-grow: 3;">
                                <span>Paracétamol Téva 200mg </span>
                            </div>
                            <div class="td" style="flex-grow: 2;">
                                <span>2x/d</span>
                            </div>
                            <div class="td bf-bef"></div>
                            <div class="td bf-dur"></div>
                            <div class="td bf-aft"></div>
                            <div class="td lu-bef">1</div>
                            <div class="td lu-dur"></div>
                            <div class="td lu-aft"></div>
                            <div class="td di-bef">1</div>
                            <div class="td di-dur"></div>
                            <div class="td di-aft"></div>
                            <div class="td" style="flex-grow: 2;"></div>
                            <div class="td td--comments" style="flex-grow: 4;"> Take with a glass of milk</div>
                        </div>
                        <div class="tr ICD-10--XI-bg">
                            <div class="td reimbursed">
                                <iron-icon icon="icons:euro-symbol" class="pending"></iron-icon>
                            </div>
                            <div class="td td--medicine"
                                 style="flex-grow: 3;">
                                <span>Claradol Codéine 20mg </span>
                            </div>
                            <div class="td"
                                 style="justify-content: center; flex-grow: 2;">
                                <span>3x/d</span>
                            </div>
                            <div class="td bf-bef"></div>
                            <div class="td bf-dur">1</div>
                            <div class="td bf-aft"></div>
                            <div class="td lu-bef">1</div>
                            <div class="td lu-dur"></div>
                            <div class="td lu-aft"></div>
                            <div class="td di-bef"></div>
                            <div class="td di-dur">1</div>
                            <div class="td di-aft"></div>
                            <div class="td" style="flex-grow: 2;"></div>
                            <div class="td td--comments" style="flex-grow: 4;"> Take with a glass of brandy</div>
                        </div>
                    </div>
                    <!-- END BODY -->
                    <!-- END TABLE -->
                </div>

                </div>
            </template>

            <template is="dom-if" if="{{_isEqual(selectedTab,2)}}">
                <div class="patient">
                    <div class="general-infos">
                        <div class="infos-block">
                            <div class="infos--name"><span>GP</span>Dr. FirstName LastName</div>
                            <div class="infos--address"><span>Address</span>50 street StreetName</div>
                        </div>

                        <div class="infos-block">
                            <div class="infos--name"><span>Pharmacist</span>FirstName LastName</div>
                            <div class="infos--address"><span>Address</span>250 street StreetName</div>
                        </div>
                    </div>
                    <div id="breakfast" class="table-container">
                        <div class="header">
                            <iron-icon icon="icure-svg-icons:breakfast"></iron-icon>
                            <h3>breakfast</h3>
                        </div>
                        <div class="table-header">
                            <div class="col col--med">Medicine</div>
                            <div class="col col--photo">Photo</div>
                            <div class="col col--ed">End Date</div>
                            <div class="col col--freq">Frequency</div>
                            <div class="col col--bef">Before</div>
                            <div class="col col--dur">During</div>
                            <div class="col col--aft">After</div>
                            <div class="col col--com">Comments</div>
                        </div>
                        <div class="table-body">
                            <div class="table-row">
                                <div class="col col--med"><span class="med--name">Burinex Leo</span><span class="med--comp">comp 30x 1mg</span></div>
                                <div class="col col--photo">Photo</div>
                                <div class="col col--ed">30/03/2018</div>
                                <div class="col col--freq">Everyday</div>
                                <div class="col col--bef"><span class="dur-pill">1</span></div>
                                <div class="col col--dur"></div>
                                <div class="col col--aft"></div>
                                <div class="col col--com">Drink with a glass of milk</div>
                            </div>
                            <div class="table-row">
                                <div class="col col--med"><span class="med--name">Omeprazole Mylan</span><span class="med--comp">caps 100 x 2mg</span></div>
                                <div class="col col--photo">Photo</div>
                                <div class="col col--ed"></div>
                                <div class="col col--freq">Once a week</div>
                                <div class="col col--bef"></div>
                                <div class="col col--dur"><span class="dur-pill">1</span></div>
                                <div class="col col--aft"></div>
                                <div class="col col--com"></div>
                            </div>
                        </div>
                    </div>
                    <div id="lunch" class="table-container">
                        <div class="header">
                            <iron-icon icon="icure-svg-icons:lunch"></iron-icon>
                            <h3>Lunch</h3>
                        </div>
                        <div class="table-header">
                            <div class="col col--med">Medicine</div>
                            <div class="col col--photo">Photo</div>
                            <div class="col col--ed">End Date</div>
                            <div class="col col--freq">Frequency</div>
                            <div class="col col--bef">Before</div>
                            <div class="col col--dur">During</div>
                            <div class="col col--aft">After</div>
                            <div class="col col--com">Comments</div>
                        </div>
                        <div class="table-body">
                            <div class="table-row">
                                <div class="col col--med"><span class="med--name">Burinex Leo</span><span class="med--comp">comp 30x 1mg</span></div>
                                <div class="col col--photo">Photo</div>
                                <div class="col col--ed">30/03/2018</div>
                                <div class="col col--freq">Everyday</div>
                                <div class="col col--bef"><span class="dur-pill">1</span></div>
                                <div class="col col--dur"></div>
                                <div class="col col--aft"></div>
                                <div class="col col--com">Drink with a glass of milk</div>
                            </div>
                            <div class="table-row">
                                <div class="col col--med"><span class="med--name">Omeprazole Mylan</span><span class="med--comp">caps 100 x 2mg</span></div>
                                <div class="col col--photo">Photo</div>
                                <div class="col col--ed"></div>
                                <div class="col col--freq">Once a week</div>
                                <div class="col col--bef"></div>
                                <div class="col col--dur"><span class="dur-pill">1</span></div>
                                <div class="col col--aft"></div>
                                <div class="col col--com"></div>
                            </div>
                        </div>
                    </div>
                    <div id="dinner" class="table-container">
                        <div class="header">
                            <iron-icon icon="icure-svg-icons:dinner"></iron-icon>
                            <h3>Dinner</h3>
                        </div>
                        <div class="table-header">
                            <div class="col col--med">Medicine</div>
                            <div class="col col--photo">Photo</div>
                            <div class="col col--ed">End Date</div>
                            <div class="col col--freq">Frequency</div>
                            <div class="col col--bef">Before</div>
                            <div class="col col--dur">During</div>
                            <div class="col col--aft">After</div>
                            <div class="col col--com">Comments</div>
                        </div>
                        <div class="table-body">
                            <div class="table-row">
                                <div class="col col--med"><span class="med--name">Burinex Leo</span><span class="med--comp">comp 30x 1mg</span></div>
                                <div class="col col--photo">Photo</div>
                                <div class="col col--ed">30/03/2018</div>
                                <div class="col col--freq">Everyday</div>
                                <div class="col col--bef"><span class="dur-pill">1</span></div>
                                <div class="col col--dur"></div>
                                <div class="col col--aft"></div>
                                <div class="col col--com">Drink with a glass of milk</div>
                            </div>
                            <div class="table-row">
                                <div class="col col--med"><span class="med--name">Omeprazole Mylan</span><span class="med--comp">caps 100 x 2mg</span></div>
                                <div class="col col--photo">Photo</div>
                                <div class="col col--ed"></div>
                                <div class="col col--freq">Once a week</div>
                                <div class="col col--bef"></div>
                                <div class="col col--dur"><span class="dur-pill">1</span></div>
                                <div class="col col--aft"></div>
                                <div class="col col--com"></div>
                            </div>
                        </div>
                    </div>
                    <div id="beforeBed" class="table-container">
                        <div class="header">
                            <iron-icon icon="icure-svg-icons:bed"></iron-icon>
                            <h3>Before Bed</h3>
                        </div>
                        <div class="table-header">
                            <div class="col col--med">Medicine</div>
                            <div class="col col--photo">Photo</div>
                            <div class="col col--ed">End Date</div>
                            <div class="col col--freq">Frequency</div>
                            <div class="col col--bef">Before</div>
                            <div class="col col--dur">During</div>
                            <div class="col col--aft">After</div>
                            <div class="col col--com">Comments</div>
                        </div>
                        <div class="table-body">
                            <div class="table-row">
                                <div class="col col--med"><span class="med--name">Burinex Leo</span><span class="med--comp">comp 30x 1mg</span></div>
                                <div class="col col--photo">Photo</div>
                                <div class="col col--ed">30/03/2018</div>
                                <div class="col col--freq">Everyday</div>
                                <div class="col col--bef"><span class="dur-pill">1</span></div>
                                <div class="col col--dur"></div>
                                <div class="col col--aft"></div>
                                <div class="col col--com">Drink with a glass of milk</div>
                            </div>
                            <div class="table-row">
                                <div class="col col--med"><span class="med--name">Omeprazole Mylan</span><span class="med--comp">caps 100 x 2mg</span></div>
                                <div class="col col--photo">Photo</div>
                                <div class="col col--ed"></div>
                                <div class="col col--freq">Once a week</div>
                                <div class="col col--bef"></div>
                                <div class="col col--dur"><span class="dur-pill">1</span></div>
                                <div class="col col--aft"></div>
                                <div class="col col--com"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>


            <div class="buttons">
                <paper-button dialog-confirm autofocus on-tap="cancel" class="modal-button modal-button--cancel">Close</paper-button>

                <paper-button dialog-confirm autofocus on-tap="" class="modal-button modal-button--save">Add medication</paper-button>

            </div>
        </paper-dialog>
    </template>
    <script>

        import _ from 'lodash/lodash'

        class MedicationPlanDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'medication-plan-dialog'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    selectedMedicationContentWithId: {
                        type: Object,
                        value: null,
                        notify: true
                    },
                    selectedTab: {
                        type: Number,
                        value: 0
                    },
                    medications: {
                        type: Array,
                        value: () => []
                    },
                    medicationClassesWithPosology: {
                        type: Array,
                        value: () => []
                    }
                }
            }

            static get observers() {
                return ['_medicationsChanged(medications.*)']
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
            }

            setSelectedTab(e) {
                this.set('selectedTab', e)
            }

            _isEqual(a, b) {
                console.log(a + ' ?= ' + b)
                return (a === b)
            }

            open(medicationPlan, selectedMedicationContentWithId) {
                this.$['medication-plan'].open()
            }

            _localize(s) {
                return this.api.contact().medication().localize(s, this.language)
            }

            cancel() {
                this.close()
            }

            saveAndClose() {
                this.save() // instant save
                this.close()
            }

            close() {
                this.set("selectedMedicationContentWithId", null)
            }

            _closeAndNew() {
                const target = this.parentNode
                this._valueChanged() // instant save
                this.close()
                // this.parentNode.dispatchEvent(new CustomEvent('newMedicFromChild',{}) )
            }

            save() {
                this._valueChanged()
            }

            _regimenTableDataProvider(frequency) {
                function getMeal(regimens, daytime, frequency="daily") {
                    return regimens.find(rg => rg.dayPeriod && rg.dayPeriod.code === daytime && rg.frequency === frequency) || {
                        administratedQuantity: { quantity: 0 },
                        dayPeriod: {type: "CD-DAYPERIOD", code: daytime},
                        frequency: "daily"
                    }
                }

                return (params, callback) => {
                    if (!this.get('selectedMedicationContentWithId.medicationValue')) { callback([], 0); return }

                    const startIndex = params.page * params.pageSize
                    const regs = this.selectedMedicationContentWithId.medicationValue.regimen
                    const {morningRegimens, middayRegimens, eveningRegimens} = this.extractRegimenSlices(regs, frequency)

                    const extraColsBefore = []
                    const extraColsAfter = []

                    const scores = this.api.contact().medication().regimenScores()

                    this.regimenTable = [
                        {moment:this.localize('breakfast','breakfast'), regimens: morningRegimens, beforeMeal: getMeal(morningRegimens,'beforebreakfast', frequency)
                            , duringMeal: getMeal(morningRegimens,'duringbreakfast', frequency), afterMeal: getMeal(morningRegimens,'afterbreakfast', frequency)},
                        {moment:this.localize('lunch','lunch'), regimens: middayRegimens, beforeMeal: getMeal(middayRegimens,'beforelunch', frequency)
                            , duringMeal: getMeal(middayRegimens,'duringlunch', frequency), afterMeal: getMeal(middayRegimens,'afterlunch', frequency)},
                        {moment:this.localize('dinner','dinner'), regimens: eveningRegimens, beforeMeal: getMeal(eveningRegimens,'beforedinner', frequency)
                            , duringMeal: getMeal(eveningRegimens, 'duringdinner', frequency), afterMeal: getMeal(eveningRegimens,'afterdinner', frequency)}
                    ]


                    ;[[0,scores.beforebreakfast-1,scores.duringbreakfast,scores.afterbreakfast+1,105959], [110000,scores.beforelunch-1,scores.duringlunch,scores.afterlunch+1,155959], [160000,scores.beforedinner-1,scores.duringdinner,scores.afterdinner+1,240000]].forEach((quad,idx) => {
                        const l  = this.regimenTable[idx]
                        l.extraBefore = extraColsBefore.map(() => null).concat((l.regimens || []).filter(r => this.selectRegimen(scores, r, quad[0],  quad[1]) || r.timeOfDay && r.timeOfDay < quad[2]))
                        extraColsBefore.push(..._.sortBy(l.extraBefore.filter(x => !!x), rg => rg.timeOfDay || rg.dayPeriod && rg.dayPeriod.code && scores[rg.dayPeriod.code] || 0))
                        l.extraAfter = extraColsAfter.map(() => null).concat((l.regimens || []).filter(r => this.selectRegimen(scores, r, quad[3],  quad[4]) || r.timeOfDay && r.timeOfDay > quad[2]))
                        extraColsAfter.push(..._.sortBy(l.extraAfter.filter(x => !!x), rg => rg.timeOfDay || rg.dayPeriod && rg.dayPeriod.code && scores[rg.dayPeriod.code] || 0))
                    })

                    this.set('extraColsBefore', extraColsBefore.map(rg =>  rg.timeOfDay ? this._formatTime(rg.timeOfDay) : rg.dayPeriod && rg.dayPeriod.code ))
                    this.set('extraColsAfter', extraColsAfter.map(rg => rg.timeOfDay ? this._formatTime(rg.timeOfDay) : rg.dayPeriod && rg.dayPeriod.code  ))


                    ;[0,1,2,3].forEach(idx => idx>=this.extraColsBefore.length && (this.root.querySelector(`#extracol_before_${idx}`).hidden = true))
                    this.extraColsBefore.forEach((val,idx) => {
                        const el = this.root.querySelector(`#extracol_before_${idx}`)
                        el && (el.hidden = false)
                    })

                    ;[0,1,2,3].forEach(idx => idx>=this.extraColsAfter.length && (this.root.querySelector(`#extracol_after_${idx}`).hidden = true))
                    this.extraColsAfter.forEach((val,idx) => {
                        const el = this.root.querySelector(`#extracol_after_${idx}`)
                        el && (el.hidden = false)
                    })

                    callback(this.regimenTable.slice(startIndex, startIndex + params.pageSize), this.regimenTable.length)
                }
            }

            extractRegimenSlices(regimen, frequency, conditions) {
                const scores = this.api.contact().medication().regimenScores()
                return conditions.map(c => (regimen || []).filter(r => r.frequency === frequency && c(rg.timeOfDay || rg.dayPeriod && rg.dayPeriod.code && scores[rg.dayPeriod.code] ||  0)))
            }

            _medicationsChanged() {
                const scores = this.api.contact().medication().regimenScores()
                this.medicationClassesWithPosology =  _.sortBy(Object.values(this.medications.map( m => ({
                    medication:m, regimenTable: this.extractRegimenSlices(((this.api.contact().preferredContent(m, this.language) || {}).medicationValue || {}).regimen, 'daily', [
                        x => x < scores.beforebreakfast,
                        x => x === scores.beforebreakfast,
                        x => x === scores.duringbreakfast,
                        x => x === scores.afterbreakfast,
                        x => x < scores.beforelunch,
                        x => x === scores.beforelunch,
                        x => x === scores.duringlunch,
                        x => x === scores.afterlunch,
                        x => x < scores.beforedinner,
                        x => x === scores.beforedinner,
                        x => x === scores.duringdinner,
                        x => x === scores.afterdinner,
                        x => x > scores.afterdinner
                    ])
                })).reduce((acc,m) => {
                    const letter = (m.medication && m.medication.codes && m.medication.codes.find(c => c.type === 'CD-ATC') || {code: 'V'}).code.substr(0,1)
                    ;(acc[letter] || (acc[letter] = {letter:letter, meds:[]})).meds.push(m)
                    return acc
                }, {})), 'letter')
            }

            _serviceDescription(s) {
                return this.api.contact().medication().medicationNameToString((this.api.contact().preferredContent(s, this.language) || {}).medicationValue, this.language)
            }

            _servicePosology(s) {
                return this.api.contact().medication().posologyToString((this.api.contact().preferredContent(s, this.language) || {}).medicationValue, this.language)
            }

            _chap4Status(s) {
                return this._hasValidChap4() ? 'reimbursed' : ''
            }

            _hasValidChap4(s) {
                (((this.api.contact().preferredContent(s, this.language) || {}).medicationValue || {}).agreements || []).some(z => z.accepted && (!!z.end || this.api.moment(z.end).isAfter(moment())))
            }

            _hasPendingChap4(s) {
                (((this.api.contact().preferredContent(s, this.language) || {}).medicationValue || {}).agreements || []).some(z => z.inTreatment)
            }

            _hasValidChap4Class(s) {
                return this._hasValidChap4(s) ? 'ok' : this._hasPendingChap4(s) ? 'pending' : this._hasChap4 (s) ? 'nok' : 'hidden'
            }

            _hasChap4(s) {
                return !!(((this.api.contact().preferredContent(s, this.language) || {}).medicationValue || {}).agreements || []).length
            }

            _medicationClass(m) {
                return m.colour && (m.colour + '-back') || ''
            }

            _localizedTitle(medicationsWithPosology) {
                return this.atcCat(medicationsWithPosology.letter)
            }

            atcCat(l) {
                return l === 'A' ? this.localize('ali_trac_meta','Alimentary tract and metabolism') :
                    l === 'B' ? this.localize('blo_blo_for','Blood and blood forming organs') :
                    l === 'C' ? this.localize('car_sys','Cardiovascular system') :
                    l === 'D' ? this.localize('dermatologicals','Dermatologicals') :
                    l === 'G' ? this.localize('gen_uri_sys','Genito-urinary system and sex hormones') :
                    l === 'H' ? this.localize('sys_hor_pre','Systemic hormonal preparations, excluding sex hormones and insulins') :
                    l === 'J' ? this.localize('anti_inf_sys','Antiinfectives for systemic use') :
                    l === 'L' ? this.localize('anti_neo_imm','Antineoplastic and immunomodulating agents') :
                    l === 'M' ? this.localize('mus_ske_sys','Musculo-skeletal system') :
                    l === 'N' ? this.localize('ner_sys','Nervous system') :
                    l === 'P' ? this.localize('Anti_para_pro','Antiparasitic products, insecticides and repellents') :
                    l === 'R' ? this.localize('res_sys','Respiratory system') :
                    l === 'S' ? this.localize('sens_org','Sensory organs') :
                    l === 'V' ? this.localize('various','Various') : this.localize('unk','Unknown')
            }
        }

        customElements.define(MedicationPlanDialog.is, MedicationPlanDialog)
    </script>
</dom-module>
