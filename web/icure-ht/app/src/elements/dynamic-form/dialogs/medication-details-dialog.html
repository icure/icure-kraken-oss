<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">


<dom-module id="medication-details-dialog">
    <template>
        <style>
            paper-dialog {
                width: 80%;
                top: 50vh !important;
                transform: translateY(-50%);
                max-height: initial !important;
            }

            #medication-detail .save-line {
                height: 20px;
            }

            .save-line > .buttons {
                bottom: 10px;
            }

            .medication-line > span {
                padding: 0 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 90%;
                white-space: nowrap;
            }

            .regimen-line {
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: flex-end;

            }

            .regimen-line paper-icon-button {
                margin-left: 12px;
                margin-bottom: 12px;
                height: 20px;
                width: 20px;
                padding: 2px;
            }

            .regimen--frequency {
                flex-grow: 3;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            .regimen--tod {
                flex-grow: 3;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            .regimen--quantity {
                flex-grow: 1;
                margin: auto;
                padding: 0 8px 0 8px;
                max-width: 80px;

            }

            .regimen--units {
                flex-grow: 3;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            .regimen--datepicker {
                width: 132px;
                margin: auto;
                padding: 0 8px 2px 8px;
                cursor: pointer;
            }
            .regimen--priority {
                width: 96px;
            }

            paper-input {
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            .buttons {
                position: absolute;
                bottom: 0;
                right: 12px;
            }

            .modal-title {
                background: var(--app-background-color-dark);
                margin-top: 0;
                padding: 16px 24px;
            }

            .modal-button {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--save {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;
            }

            .buttons {
                position: absolute;
                bottom: 0;
            }

            .modal-button {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--save {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;

            }

            #filter {
                width: 50%;
            }

            .dropdown-priority {
                cursor: pointer;
            }

            .scrollbox {
                max-height: 50vh;
                overflow-y: auto;
                overflow-x: auto;
                margin-top: 0;
                border-top: 1px solid var(--app-background-color-dark);
                border-bottom: 1px solid var(--app-background-color-dark);
            }
            .force-left {
                left: 12px;
            }
            .force-right {
                right: 12px;
            }

            .posology-btn {
                left: 100%;
                transform: translateX(-100%);
                padding-right: 3px;
            }

            .marginRight10 {
                margin-right: 10px;
            }

            iron-input#medicNameInput {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            span.regimen-txt {
                height: 36px;
            }

            .display-type-regimen {margin-top: 0;}
            .display-type-regimen .regimen-txt {flex:1;text-align: right;}
            #medication-name {flex: 3;}

            h4 {margin-bottom: 0;}

        </style>

        <paper-dialog id="medication-detail" always-on-top="true" no-cancel-on-outside-click="true">

            <h2 class="modal-title">[[localize('med_det','Medication detail',language)]]</h2>

            <div class="regimen-line display-type-regimen">
                <template is="dom-if" if="[[selectedMedicationContentWithId.medicationValue.medicinalProduct]]">
                    <paper-input id="medication-name" label="Medication" value="{{selectedMedicationContentWithId.medicationValue.medicinalProduct.intendedname}}"
                                 disabled="true"></paper-input>
                </template>
                <template is="dom-if" if="[[selectedMedicationContentWithId.medicationValue.substanceProduct]]">
                    <paper-input id="medication-name" label="Medication" value="{{selectedMedicationContentWithId.medicationValue.substanceProduct.intendedname}}"
                                 disabled="true"></paper-input>
                </template>
                <template is="dom-if" if="[[selectedMedicationContentWithId.medicationValue.compoundPrescription]]">
                    <paper-input id="medication-name" label="Medication" value="{{selectedMedicationContentWithId.medicationValue.compoundPrescription}}"
                                 disabled="true"></paper-input>
                </template>

                <vaadin-date-picker id="beginMoment" label="[[localize('start-date', 'Start date', language)]]" value="{{beginMomentAsString}}"
                                    class="regimen--datepicker"></vaadin-date-picker>
                <vaadin-date-picker id="endMoment" label="[[localize('end-date', 'End date', language)]]" value="{{endMomentAsString}}"
                                    class="regimen--datepicker"></vaadin-date-picker>

                <paper-dropdown-menu id="medicPriority" label="Priority" class="regimen--priority">
                    <paper-listbox slot="dropdown-content" class="dropdown-priority" selected="{{medicPriority}}" on-iron-select="_selectFrequency">
                        <paper-item id="low">[[localize('low','Low',language)]]</paper-item>
                        <paper-item id="middle">[[localize('middle','Middle',language)]]</paper-item>
                        <paper-item id="high">[[localize('high','High',language)]]</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <span class="regimen-txt">Display by</span>
                <paper-tabs selected="{{selectedTab}}">
                    <paper-tab>
                        <iron-icon icon="vaadin:list" class="marginRight10"></iron-icon>Lignes
                    </paper-tab>
                    <paper-tab>
                        <iron-icon icon="vaadin:table" class="marginRight10"></iron-icon>Tableau
                    </paper-tab>
                </paper-tabs>
            </div>


            <template is="dom-if" if="{{_isEqual(selectedTab,0)}}">
                <div class="scrollbox">
                    <h4>[[localize('prefill','Préremplir les détails',language)]]</h4>
                    <div class="regimen-line">
                        <paper-input label="Nombre de " id="numberByFrequency" type="number" min="0" step="1" class="regimen--frequency first-freq" value="{{bufferNumberByFrequency}}" on-change="_setFrequencyList">
                            <div slot="suffix">prises</div>
                        </paper-input>
                        <paper-dropdown-menu id="generalFrequency" label="[[localize('freq','Frequency',language)]]" class="regimen--frequency">
                            <paper-listbox slot="dropdown-content" selected="[[bufferGeneralFrequency]]" on-iron-select="_selectFrequency">
                                <paper-item id="daily">[[localize('dai','Daily',language)]]</paper-item>
                                <paper-item id="weekly">[[localize('wee','Weekly',language)]]</paper-item>
                                <paper-item id="monthly">[[localize('mon','Monthly',language)]]</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <paper-input id="generalQuantity" label="[[localize('qua', 'Quantity', language)]]" value="{{bufferQuantity}}" type="number" class="regimen--quantity" on-change="_setFrequencyList"
                                     min="0"></paper-input>
                        <paper-input id="generalUnit" label="[[localize('uni', 'Units', language)]]" value="{{bufferUnit}}" class="regimen--units" on-keyup="_setUnits"></paper-input>
                    </div>
                    <h4>[[localize('med_det','Détails',language)]]</h4>
                    <template id="rgRepeat" is="dom-repeat" items="[[selectedMedicationContentWithId.medicationValue.regimen]]" as="rg">
                        <div class="regimen-line regimen-details">
                            <!--<paper-dropdown-menu label="Frequency" class="regimen&#45;&#45;frequency">-->
                                <!--<paper-listbox slot="dropdown-content" selected="[[_selectedFrequency(rg, rg.weekday, rg.date)]]" on-tap="_setFrequencyList">-->
                                    <!--<paper-item id="daily" on-tap="_setFrequencyList">[[localize('dai','Daily',language)]]</paper-item>-->
                                    <!--<paper-item id="weekly" on-tap="_setFrequencyList">[[localize('wee','Weekly',language)]]</paper-item>-->
                                    <!--<paper-item id="monthly" on-tap="_setFrequencyList">[[localize('mon','Monthly',language)]]</paper-item>-->
                                <!--</paper-listbox>-->
                            <!--</paper-dropdown-menu>-->
                            <template is="dom-if" if="[[_isEqual(rg.freqType,'daily')]]">
                                <paper-dropdown-menu label="Time of day" class="regimen--tod">
                                    <paper-listbox slot="dropdown-content" selected="[[rg.dayPeriod.code]]" attr-for-selected="id" on-iron-select="_selectDayPeriod">
                                        <paper-item id="beforebreakfast">[[_localize("Beforebreakfast")]]</paper-item>
                                        <paper-item id="duringbreakfast">[[_localize("Duringbreakfast")]]</paper-item>
                                        <paper-item id="afterbreakfast">[[_localize("Afterbreakfast")]]</paper-item>
                                        <paper-item id="morning">[[_localize("Morning")]]</paper-item>
                                        <paper-item id="beforelunch">[[_localize("Beforelunch")]]</paper-item>
                                        <paper-item id="afternoon">[[_localize("Afternoon")]]</paper-item>
                                        <paper-item id="duringlunch">[[_localize("Duringlunch")]]</paper-item>
                                        <paper-item id="afterlunch">[[_localize("Afterlunch")]]</paper-item>
                                        <paper-item id="beforedinner">[[_localize("Beforedinner")]]</paper-item>
                                        <paper-item id="duringdinner">[[_localize("Duringdinner")]]</paper-item>
                                        <paper-item id="afterdinner">[[_localize("Afterdinner")]]</paper-item>
                                        <paper-item id="evening">[[_localize("Evening")]]</paper-item>
                                        <paper-item id="night">[[_localize("Night")]]</paper-item>
                                        <hr>
                                        <paper-item>[[_localize("Precise hour")]]</paper-item>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-input id="quantity" label="[[localize('qua', 'Quantity', language)]]" value="{{rg.administratedQuantity.quantity}}" type="number"
                                             class="regimen--quantity" min="0"></paper-input>
                                <!--<paper-input id="quantity" label="[[localize('uni', 'Units', language)]]" value="{{rg.administratedQuantity.unit}}" class="regimen--units"-->
                                <span class="regimen-txt">[[bufferUnit]]</span>
                            </template>
                            <template is="dom-if" if="[[_isEqual(rg.freqType,'weekly')]]">
                                <paper-dropdown-menu label="Day of week" class="regimen--tod">
                                    <paper-listbox slot="dropdown-content" selected="[[rg.dayPeriod.code]]" attr-for-selected="id" on-iron-select="_selectDayPeriod">
                                        <paper-item id="beforebreakfast">Monday</paper-item>
                                        <paper-item id="duringbreakfast">Tuesday</paper-item>
                                        <paper-item id="afterbreakfast">Wednesday</paper-item>
                                        <paper-item id="morning">Thursday</paper-item>
                                        <paper-item id="beforelunch">Friday</paper-item>
                                        <paper-item id="afternoon">Saturday</paper-item>
                                        <paper-item id="duringlunch">Sunday</paper-item>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-input id="quantity" label="[[localize('qua', 'Quantity', language)]]" value="{{rg.administratedQuantity.quantity}}" type="number"
                                             class="regimen--quantity" min="0"></paper-input>
                            </template>
                            <template is="dom-if" if="[[_isEqual(rg.freqType,'monthly')]]">
                                <!--<template is="dom-if" if="[[!rg.date]]">-->
                                    <!--<paper-dropdown-menu label="Time of day" class="regimen&#45;&#45;tod">-->
                                        <!--<paper-listbox slot="dropdown-content" selected="[[rg.dayPeriod.code]]" attr-for-selected="id" on-iron-select="_selectDayPeriod">-->
                                            <!--<paper-item id="beforebreakfast">[[_localize("Beforebreakfast")]]</paper-item>-->
                                            <!--<paper-item id="duringbreakfast">[[_localize("Duringbreakfast")]]</paper-item>-->
                                            <!--<paper-item id="afterbreakfast">[[_localize("Afterbreakfast")]]</paper-item>-->
                                            <!--<paper-item id="morning">[[_localize("Morning")]]</paper-item>-->
                                            <!--<paper-item id="beforelunch">[[_localize("Beforelunch")]]</paper-item>-->
                                            <!--<paper-item id="afternoon">[[_localize("Afternoon")]]</paper-item>-->
                                            <!--<paper-item id="duringlunch">[[_localize("Duringlunch")]]</paper-item>-->
                                            <!--<paper-item id="afterlunch">[[_localize("Afterlunch")]]</paper-item>-->
                                            <!--<paper-item id="beforedinner">[[_localize("Beforedinner")]]</paper-item>-->
                                            <!--<paper-item id="duringdinner">[[_localize("Duringdinner")]]</paper-item>-->
                                            <!--<paper-item id="afterdinner">[[_localize("Afterdinner")]]</paper-item>-->
                                            <!--<paper-item id="evening">[[_localize("Evening")]]</paper-item>-->
                                            <!--<paper-item id="night">[[_localize("Night")]]</paper-item>-->
                                            <!--<hr>-->
                                            <!--<paper-item>[[_localize("Precise hour")]]</paper-item>-->
                                        <!--</paper-listbox>-->
                                    <!--</paper-dropdown-menu>-->
                                <!--</template>-->
                                Mois ???
                            </template>
                            <!--<template is="dom-if" if="[[!rg.weekday]]">-->
                                <!--<template is="dom-if" if="[[rg.date]]">-->
                                <!--</template>-->
                                <!--<template is="dom-if" if="[[!rg.date]]">-->
                                    <!--<paper-dropdown-menu label="Time of day" class="regimen&#45;&#45;tod">-->
                                        <!--<paper-listbox slot="dropdown-content" selected="[[rg.dayPeriod.code]]" attr-for-selected="id" on-iron-select="_selectDayPeriod">-->
                                            <!--<paper-item id="beforebreakfast">[[_localize("Beforebreakfast")]]</paper-item>-->
                                            <!--<paper-item id="duringbreakfast">[[_localize("Duringbreakfast")]]</paper-item>-->
                                            <!--<paper-item id="afterbreakfast">[[_localize("Afterbreakfast")]]</paper-item>-->
                                            <!--<paper-item id="morning">[[_localize("Morning")]]</paper-item>-->
                                            <!--<paper-item id="beforelunch">[[_localize("Beforelunch")]]</paper-item>-->
                                            <!--<paper-item id="afternoon">[[_localize("Afternoon")]]</paper-item>-->
                                            <!--<paper-item id="duringlunch">[[_localize("Duringlunch")]]</paper-item>-->
                                            <!--<paper-item id="afterlunch">[[_localize("Afterlunch")]]</paper-item>-->
                                            <!--<paper-item id="beforedinner">[[_localize("Beforedinner")]]</paper-item>-->
                                            <!--<paper-item id="duringdinner">[[_localize("Duringdinner")]]</paper-item>-->
                                            <!--<paper-item id="afterdinner">[[_localize("Afterdinner")]]</paper-item>-->
                                            <!--<paper-item id="evening">[[_localize("Evening")]]</paper-item>-->
                                            <!--<paper-item id="night">[[_localize("Night")]]</paper-item>-->
                                            <!--<hr>-->
                                            <!--<paper-item>[[_localize("Precise hour")]]</paper-item>-->
                                        <!--</paper-listbox>-->
                                    <!--</paper-dropdown-menu>-->
                                <!--</template>-->
                            <!--</template>-->
                            <paper-icon-button icon="clear" on-tap="clearPosologyRegimen"></paper-icon-button>
                        </div>
                    </template>
                    <template is="dom-if" if="[[rg.date]]">
                        <paper-button class="posology-btn" on-tap="addPosologyRegimen">
                            [[localize('add_pos_reg','Add posology regimen',language)]]
                            <iron-icon icon="add"></iron-icon>
                        </paper-button>
                    </template>
                    <paper-button class="posology-btn" on-tap="addPosologyRegimen">
                        [[localize('add_pos_reg','Add posology regimen',language)]]
                        <iron-icon icon="add"></iron-icon>
                    </paper-button>
                </div>
            </template>

            <template is="dom-if" if="{{_isEqual(selectedTab,1)}}">
                <vaadin-grid id="selectedMedicationTable" items="[[selectedMedicationContentWithId.medicationValue.regimen]]">
                    <template is="dom-if" if="[[_isEqual(item.freqType,'daily')]]">
                        <vaadin-grid-column>
                            <template class="header">Daily</template>
                            <template></template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="160px">
                            <template class="header">Prescr</template>
                            <template><div>this is a single column</div></template>
                        </vaadin-grid-column>

                        <vaadin-grid-column-group class="med-det-moment">
                            <template class="header">Morning</template>
                            <vaadin-grid-column width="50px">
                                <template class="header">Before</template>
                                <template>1</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="50px">
                                <template class="header">During</template>
                                <template>2</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="50px">
                                <template class="header">After</template>
                                <template>3</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>

                        <vaadin-grid-column-group class="med-det-moment">
                            <template class="header">Midday</template>
                            <vaadin-grid-column width="50px">
                                <template class="header">Before</template>
                                <template>1</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="50px">
                                <template class="header">During</template>
                                <template>2</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="50px">
                                <template class="header">After</template>
                                <template>3</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>

                        <vaadin-grid-column-group>
                            <template class="header">Evening</template>
                            <vaadin-grid-column width="50px">
                                <template class="header">Before</template>
                                <template>1</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="50px">
                                <template class="header">During</template>
                                <template>2</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="50px">
                                <template class="header">After</template>
                                <template>3</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>

                        <vaadin-grid-column flex-grow="0" width="200px">
                            <template class="header">Comments</template>
                            <template><div>this is a single column</div></template>
                        </vaadin-grid-column>
                    </template>
                    <template is="dom-if" if="[[_isEqual(item.freqType,'weekly')]]">
                        <vaadin-grid-column flex-grow="0" width="calc(100% / 7)">
                            <template class="header">Weekly</template>
                            <template></template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="calc(100% / 7)">
                            <template class="header">Mon</template>
                            <template>1</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="calc(100% / 7)">
                            <template class="header">Tue</template>
                            <template>1</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="calc(100% / 7)">
                            <template class="header">Wed</template>
                            <template>1</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="calc(100% / 7)">
                            <template class="header">Thu</template>
                            <template>1</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="calc(100% / 7)">
                            <template class="header">Fri</template>
                            <template>1</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="calc(100% / 7)">
                            <template class="header">Sat</template>
                            <template>1</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="calc(100% / 7)">
                            <template class="header">Sun</template>
                            <template>1</template>
                        </vaadin-grid-column>
                    </template>
                    <template is="dom-if" if="[[_isEqual(item.freqType,'monthly')]]">
                        <vaadin-grid-column flex-grow="0" width="100%">
                            <template class="header">Monthly</template>
                            <template>Calendar</template>
                        </vaadin-grid-column>
                    </template>
                </vaadin-grid>

                <!--<paper-button class="posology-btn" on-tap="addPosologyRegimen">-->
                    <!--[[localize('add_pos_reg','Add posology regimen',language)]]-->
                    <!--<iron-icon icon="add"></iron-icon>-->
                <!--</paper-button>-->
            </template>
            <div class="regimen-line save-line">
                <!--<template is="dom-if" if="[[!existingMedicine]]">-->
                <!--<div class="buttons force-left">-->
                <!--<paper-button dialog-confirm autofocus on-tap="cancelAndDelete" class="modal-button modal-button&#45;&#45;cancel">[[localize('cancel','Cancel',language)]]</paper-button>-->
                <!--</div>-->
                <!--</template>-->
                <!--<template is="dom-if" if="[[existingMedicine]]">-->
                <!--<div class="buttons force-left">-->
                <!--<paper-button dialog-confirm autofocus on-tap="removeMedic" class="modal-button modal-button&#45;&#45;delete">[[localize('del','Delete',language)]]</paper-button>-->
                <!--<paper-button dialog-confirm autofocus on-tap="cancelEdits" class="modal-button modal-button&#45;&#45;save">[[localize('cancel','Cancel',language)]]</paper-button>-->
                <!--</div>-->
                <!--</template>-->
                <div class="buttons">
                    <!--<paper-button dialog-confirm autofocus on-tap="_closeAndNew" class="modal-button modal-button--save">[[localize('saveandadd','Save and add another',language)]]</paper-button>-->
                    <paper-button dialog-confirm autofocus on-tap="close" class="modal-button modal-button--cancel">[[localize('can','Cancel',language)]]</paper-button>
                    <paper-button dialog-confirm autofocus on-tap="save" class="modal-button modal-button--save">[[localize('save','Save',language)]]</paper-button>
                </div>
            </div>
        </paper-dialog>
    </template>
    <script>

        import _ from 'lodash/lodash'

        class MedicationDetailsDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'medication-details-dialog'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    selectedMedicationContentWithId: {
                        type: Object,
                        value: null,
                        notify: true
                    },
                    flagTableFrequency: {
                        type: Boolean,
                        value: false
                    },
                    _dayPeriods: {
                        type: Array,
                        value: () => [
                            "beforebreakfast",
                            "duringbreakfast",
                            "afterbreakfast",
                            "morning",
                            "beforelunch",
                            "afternoon",
                            "duringlunch",
                            "afterlunch",
                            "beforedinner",
                            "duringdinner",
                            "afterdinner",
                            "evening",
                            "night"
                        ]
                    },
                    bufferUnit: {
                        type: String,
                        value: "loading ..."
                    },
                    bufferQuantity: {
                        type: Number,
                        value: 1
                    },
                    bufferNumberByFrequency: {
                        type: Number,
                        value: 1
                    },
                    bufferFrequency: {
                        type: String,
                        value: "daily"
                    },
                    bufferGeneralFrequency: {
                        type: Number,
                        value: 0
                    },
                    customFrequencyTable: {
                        type: Boolean,
                        value: false
                    },
                    beginMomentAsString: {
                        type: String,
                        value: "",
                        observer: "changeBeginMoment"
                    },
                    endMomentAsString: {
                        type: String,
                        value: "",
                        observer: "changeEndMoment"
                    },
                    medicPriority: {
                        type: String,
                        value: "low",
                        observer: "changeMedicPriority"
                    },
                    selectedTab: {
                        type: Number,
                        value: 0
                    }
                }
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
            }

            hasCustomFrequencyTable(regimen) {
                if (regimen.length <= 1) {
                    return false
                } else {
                    let reg1 = regimen[0]
                    let allEqual = false
                    const difReg = regimen.find(reg => !_.isEqual(reg1, reg))
                    return difReg ? true : false
                }
            }

            _isEqual(a,b) {
                return (a == b)
            }
            setSelectedTab(e) {
                this.set('selectedTab',e)
            }

            formatRegimenToMomentArray(regimen) {

            }

            open(medicationDetail, selectedMedicationContentWithId) {
                if (selectedMedicationContentWithId) {
                    this.set('selectedMedicationContentWithId', selectedMedicationContentWithId)
                    console.log("open",selectedMedicationContentWithId)
                    this.set('medicationDetail', medicationDetail)
                    console.log("med details",medicationDetail)

                    const isCustom = this.hasCustomFrequencyTable(selectedMedicationContentWithId.medicationValue.regimen)
                    this.set('customFrequencyTable', isCustom)
                    this.set('flagTableFrequency', isCustom)

                    this.set('bufferUnit', selectedMedicationContentWithId.medicationValue.regimen[0] ? selectedMedicationContentWithId.medicationValue.regimen[0].administratedQuantity.unit : "not found :(")
                    this.set('bufferQuantity', selectedMedicationContentWithId.medicationValue.regimen[0] ? selectedMedicationContentWithId.medicationValue.regimen[0].administratedQuantity.quantity : 1)
                    this.set('bufferNumberByFrequency', selectedMedicationContentWithId.medicationValue.regimen.length > 0 ? selectedMedicationContentWithId.medicationValue.regimen.length : 1)
                    this.set('bufferGeneralFrequency', selectedMedicationContentWithId.medicationValue.regimen[0] ? this._selectedFrequency(selectedMedicationContentWithId.medicationValue.regimen[0]) : 0)
                    const previousPriority = selectedMedicationContentWithId.medicationValue.medicinalProduct.priority
                    this.set('medicPriority', previousPriority == "high" ? 2 : previousPriority == "middle" ? 1 : 0 )

                    this.set("beginMomentAsString", this.dateLongToStr(selectedMedicationContentWithId.medicationValue.medicinalProduct.beginMoment))
                    this.set("endMomentAsString", this.dateLongToStr(selectedMedicationContentWithId.medicationValue.medicinalProduct.endMoment))
                }
                this.$['medication-detail'].open()
            }

            addPosologyRegimen() {
                const reg = this.selectedMedicationContentWithId.medicationValue.regimen
                this.set("bufferNumberByFrequency",parseInt(this.bufferNumberByFrequency)+1)

                this.push('selectedMedicationContentWithId.medicationValue.regimen', {
                    weekday: this.bufferGeneralFrequency === "weekly" ? {} : null,
                    date: this.bufferGeneralFrequency === "monthly" ? -1 : null,
                    freqType: this.bufferGeneralFrequency == 2 ? 'monthly' : this.bufferGeneralFrequency == 1 ? 'weekly' : 'daily',
                    administratedQuantity: {
                        quantity: this.bufferQuantity,//quantity: !reg[0] || reg[0].administratedQuantity.quantity === 0 ? this.bufferQuantity : reg[0].administratedQuantity.quantity,
                        unit: this.bufferUnit//unit: !reg[0] || reg[0].administratedQuantity.unit==="" ? this.bufferUnit : reg[0].administratedQuantity.unit
                    }
                })
            }

            clearPosologyRegimen(event, target) {
                const rgModel = this.root.querySelector("#rgRepeat").modelForElement(event.target)
                if (this.selectedMedicationContentWithId.medicationValue.regimen.length > 1) {
                    this.set("bufferNumberByFrequency",parseInt(this.bufferNumberByFrequency)-1)
                    this.splice('selectedMedicationContentWithId.medicationValue.regimen', this.selectedMedicationContentWithId.medicationValue.regimen.indexOf(rgModel.rg), 1)
                }
            }

            _localize(s) {
                return this.api.contact().medication().localize(s, this.language)
            }

            _selectedFrequency(rg) {
                return rg.weekday !== null && rg.weekday !== undefined ? 1 : rg.date ? 2 : 0
            }

            _selectFrequency(event, target) {
                console.log(event,target)
                // const rgModel = this.root.querySelector("#rgRepeat").modelForElement(event.target)
                // if (!rgModel) {
                //     return
                // }
                if (target.item.id === 'daily') {
                    // rgModel.set('rg.weekday', null)
                    // rgModel.set('rg.date', null)
                    this.set('bufferGeneralFrequency',0)
                } else if (target.item.id === 'weekly') {
                    // rgModel.set('rg.weekday', {})
                    // rgModel.set('rg.date', null)
                    this.set('bufferGeneralFrequency',1)
                } else if (target.item.id === 'monthly') {
                    // rgModel.set('rg.weekday', null)
                    // rgModel.set('rg.date', -1)
                    this.set('bufferGeneralFrequency',2)
                }
                // this._valueChanged()
                this._setFrequencyList()
            }

            _selectDayPeriod(event, target) {
                const rgModel = this.root.querySelector("#rgRepeat").modelForElement(event.target)
                if (!rgModel) {
                    return
                }
                rgModel.set('rg.dayPeriod', {type: "CD-DAYPERIOD", code: target.item.id})
            }

            _valueChanged() {
                this.dispatchEvent(new CustomEvent('value-changed', {detail: this.medicationDetail, bubbles: true, composed: true}))
                console.log("_valueChanged()")
            }

            _selectQuantity() {
                let papers = this.shadowRoot.querySelectorAll(".quantity-paper")
                console.log("papers",papers)
                Array.prototype.slice.call(papers).map(that=>{
                    that.value = this.bufferUnit
                })
            }

            _setFrequencyList() {
                let bufferTable = []
                if (this.bufferNumberByFrequency == 0) {
                    this.set('bufferNumberByFrequency',1)
                }
                console.log(this.bufferGeneralFrequency )
                // this._setUnits()

                for (let cpt = 0; cpt < this.bufferNumberByFrequency; cpt++) {
                    bufferTable.push({
                        weekday: this.bufferGeneralFrequency === "weekly" ? {} : null,
                        date: this.bufferGeneralFrequency === "monthly" ? -1 : null,
                        freqType: this.bufferGeneralFrequency == 2 ? 'monthly' : this.bufferGeneralFrequency == 1 ? 'weekly' : 'daily',
                        administratedQuantity: {
                            quantity: this.bufferQuantity,//quantity: !reg[0] || reg[0].administratedQuantity.quantity === 0 ? this.bufferQuantity : reg[0].administratedQuantity.quantity,
                            unit: this.bufferUnit//unit: !reg[0] || reg[0].administratedQuantity.unit==="" ? this.bufferUnit : reg[0].administratedQuantity.unit
                        }
                    })
                }
                console.log("bufferTable",bufferTable)

                this.set("customFrequencyTable", true)
                this.set("selectedMedicationContentWithId.medicationValue.regimen", bufferTable)
                this.set("flagTableFrequency", true)
            }
            _setUnits() {
                const str = this.bufferUnit
                let lines = this.shadowRoot.querySelectorAll('.regimen-details')
                Array.prototype.slice.call(lines).map(line=>{
                    let field = line.querySelector(".quantity-paper")
                    let input = field.shadowRoot.querySelector("#container > iron-input.input-element > input")
                    input.value = str
                })
            }

            _addFrequency() {
                this.push("selectedMedicationContentWithId.medicationValue.regimen", {
                    weekday: this.$.generalFrequency.selectedItem.id === "weekly" ? {} : null,
                    date: this.$.generalFrequency.selectedItem.id === "monthly" ? -1 : null,
                    administratedQuantity: {
                        quantity: 1,
                        unit: this.bufferUnit
                    }
                })
            }

            dateLongToStr(numberDate) {
                if (numberDate) {
                    const str = (typeof numberDate != "string") ? numberDate.toString() : numberDate
                    const Y = str.substring(0,4), M = str.substring(4,6), D = str.substring(6,8)
                    return `${Y}-${M}-${D}`
                }
            }

            changeBeginMoment() {
                if (this.selectedMedicationContentWithId && this.beginMomentAsString) {
                    const beginMoment = parseInt(this.beginMomentAsString.replace(/(....)-(..)-(..)/, '$1$2$3'))
                    this.set("selectedMedicationContentWithId.medicationValue.medicinalProduct.beginMoment", beginMoment)
                    // this._valueChanged()
                }
            }

            changeEndMoment() {
                if (this.selectedMedicationContentWithId && this.endMomentAsString) {
                    const endMoment = parseInt(this.endMomentAsString.replace(/(....)-(..)-(..)/, '$1$2$3'))
                    this.set("selectedMedicationContentWithId.medicationValue.medicinalProduct.endMoment", endMoment)
                    // this._valueChanged()
                }
            }

            changeMedicPriority() {
                if (this.selectedMedicationContentWithId) {
                    const priority = this.medicPriority ? this.medicPriority === 2 ? 'high' : this.medicPriority === 1 ? 'middle' : 'low' : 'low'
                    this.set("selectedMedicationContentWithId.medicationValue.medicinalProduct.priority", priority)
                    // this._valueChanged()
                }
            }
            close() {

            }
            _closeAndNew() {
                const target = this.parentNode
                console.log("target",target)
                this._valueChanged()
                this.close()
                // this.parentNode.dispatchEvent(new CustomEvent('newMedicFromChild',{}) )
            }

            save() {
                this._valueChanged()
            }
        }

        customElements.define(MedicationDetailsDialog.is, MedicationDetailsDialog)
    </script>
</dom-module>
