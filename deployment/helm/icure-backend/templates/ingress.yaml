apiVersion: voyager.appscode.com/v1beta1
kind: Ingress
metadata:
    name: "{{ template "fullname" . }}-ingress"
    annotations:
        kubernetes.io/ingress.class: "voyager"
        #ingress.appscode.com/stats: "true"
        #ingress.appscode.com/stats-port: "1936"
        #ingress.appscode.com/stats-secret-name: basicauth
        #ingress.appscode.com/default-timeout: '{"connect": "5s", "client": "5m", "server": "1d"}'
        #ingress.appscode.com/max-connections: "10000"
      {{- if .Values.ingressIP }}
        ingress.appscode.com/load-balancer-ip: {{ .Values.ingressIP }}
      {{- end }}
spec:
    {{- if .Values.tls }}
    tls:
        {{- range .Values.tls }}
        -   hosts:
                {{- range .hosts }}
                - "{{ . }}"
                - "backend.{{ . }}"
                - "ht.{{ . }}"
                - "couch.{{ . }}"
                {{- end }}
            ref:
                kind: Secret
                name: {{ .refName }}
        {{- end }}
    frontendRules:
        -   port: 443
            rules:
                - option httplog
                - option forwardfor
                - http-request set-header X-Forwarded-Proto https
    {{- end }}
    rules:
        {{- $root := . -}}
        {{- range .Values.tls }}
        {{- range .hosts }}
        -   host: "ht.{{ . }}"
            http:
                paths:
                    -   path: /
                        backend:
                            serviceName: "{{ template "fullname" $ }}-frontend"
                            servicePort: {{ $root.Values.images.frontend.servicePort }}
        -   host: "backend.{{ . }}"
            http:
                paths:
                    -   path: /
                        backend:
                            serviceName: "{{ template "fullname" $ }}-backend"
                            servicePort: {{ $root.Values.images.backend.servicePort }}
        -   host: "{{ . }}"
            http:
                paths:
                    -   path: /
                        backend:
                            serviceName: "{{ template "fullname" $ }}-backend"
                            servicePort: {{ $root.Values.images.backend.servicePort }}

        -   host: "couch.{{ . }}"
            http:
                paths:
                    -   path: /
                        backend:
                            serviceName: {{ $root.Values.couchdbServiceName }}
                            servicePort: {{ $root.Values.couchdbPortNumber }}
                            backendRules:
                                - 'option httpchk GET /_up HTTP/1.0\r\nAuthorization:\ Basic\ {{ $root.Values.couchdbCredentialsBase64 }}'
        {{- end }}
        {{- end }}